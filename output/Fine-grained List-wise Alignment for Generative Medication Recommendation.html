<!DOCTYPE html>
<html lang="en">
<head>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<title>Fine-grained List-wise Alignment for Generative Medication Recommendation</title>
<!--Generated on Mon May 26 16:44:42 2025 by LaTeXML (version 0.8.8) http://dlmf.nist.gov/LaTeXML/.-->
<meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
<link href="/static/browse/0.3.4/css/ar5iv.0.7.9.min.css" rel="stylesheet" type="text/css"/>
<link href="/static/browse/0.3.4/css/ar5iv-fonts.0.7.9.min.css" rel="stylesheet" type="text/css"/>
<link href="/static/browse/0.3.4/css/latexml_styles.css" rel="stylesheet" type="text/css"/>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.3/html2canvas.min.js"></script>
<script src="/static/browse/0.3.4/js/addons_new.js"></script>
<script src="/static/browse/0.3.4/js/feedbackOverlay.js"></script>
<base href="/html/2505.20218v1/"/></head>
<body>
<nav class="ltx_page_navbar">
<nav class="ltx_TOC">
<ol class="ltx_toclist">
<li class="ltx_tocentry ltx_tocentry_section"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S1" title="In Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">1 </span>Introduction</span></a></li>
<li class="ltx_tocentry ltx_tocentry_section">
<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S2" title="In Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">2 </span>Related Work</span></a>
<ol class="ltx_toclist ltx_toclist_section">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S2.SS1" title="In 2 Related Work ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">2.1 </span>Medication Recommendation</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S2.SS2" title="In 2 Related Work ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">2.2 </span>LLM Fine-Tuning Approaches</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_section">
<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S3" title="In Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">3 </span>Preliminary</span></a>
<ol class="ltx_toclist ltx_toclist_section">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S3.SS1" title="In 3 Preliminary ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">3.1 </span>Medication Recommendation</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S3.SS2" title="In 3 Preliminary ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">3.2 </span>Group Relative Policy Optimization (GRPO)</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_section">
<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S4" title="In Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4 </span>Method: FLAME</span></a>
<ol class="ltx_toclist ltx_toclist_section">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S4.SS1" title="In 4 Method: FLAME ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.1 </span>Step-wise GRPO</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S4.SS2" title="In 4 Method: FLAME ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.2 </span>Fine-grained Alignment for Medication Recommendation</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S4.SS3" title="In 4 Method: FLAME ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.3 </span>Two-stage Recommendation Framework</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S4.SS4" title="In 4 Method: FLAME ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">4.4 </span>Multi-source Knowledge Fusion</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_section">
<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S5" title="In Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5 </span>Experiments</span></a>
<ol class="ltx_toclist ltx_toclist_section">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S5.SS1" title="In 5 Experiments ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5.1 </span>Experimental Settings</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S5.SS2" title="In 5 Experiments ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5.2 </span>Overall Performance Comparison</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S5.SS3" title="In 5 Experiments ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">5.3 </span>Ablation Study</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_section"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S6" title="In Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">6 </span>Conclusion</span></a></li>
<li class="ltx_tocentry ltx_tocentry_appendix"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#A1" title="In Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">A </span>Theoretical Analysis</span></a></li>
<li class="ltx_tocentry ltx_tocentry_appendix">
<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#A2" title="In Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">B </span>Dataset Details</span></a>
<ol class="ltx_toclist ltx_toclist_appendix">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#A2.SS1" title="In Appendix B Dataset Details ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">B.1 </span>Data Preprocessing</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#A2.SS2" title="In Appendix B Dataset Details ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">B.2 </span>Dataset Statistics</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_appendix">
<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#A3" title="In Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">C </span>Experimental Setup</span></a>
<ol class="ltx_toclist ltx_toclist_appendix">
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#A3.SS1" title="In Appendix C Experimental Setup ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">C.1 </span>Training Details and Hyperparameters</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#A3.SS2" title="In Appendix C Experimental Setup ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">C.2 </span>Baseline Methods and Evaluation Metrics</span></a></li>
<li class="ltx_tocentry ltx_tocentry_subsection"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#A3.SS3" title="In Appendix C Experimental Setup ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">C.3 </span>Prompt Templates</span></a></li>
</ol>
</li>
<li class="ltx_tocentry ltx_tocentry_appendix"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#A4" title="In Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">D </span>Limitations</span></a></li>
<li class="ltx_tocentry ltx_tocentry_appendix"><a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#A5" title="In Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_title"><span class="ltx_tag ltx_tag_ref">E </span>Broader Impacts</span></a></li>
</ol></nav>
</nav>
<div class="ltx_page_main">
<div class="ltx_page_content">
<article class="ltx_document ltx_authors_1line">
<h1 class="ltx_title ltx_title_document">Fine-grained List-wise Alignment for Generative Medication Recommendation</h1>
<div class="ltx_authors">
<span class="ltx_creator ltx_role_author">
<span class="ltx_personname">
<span class="ltx_text ltx_font_bold" id="id1.1.1">Chenxiao Fan<sup class="ltx_sup" id="id1.1.1.1"><span class="ltx_text ltx_font_medium ltx_font_italic" id="id1.1.1.1.1">1</span></sup></span>  <span class="ltx_text ltx_font_bold" id="id2.2.2">Chongming Gao<sup class="ltx_sup" id="id2.2.2.1"><span class="ltx_text ltx_font_medium ltx_font_italic" id="id2.2.2.1.1">1</span></sup></span>  <span class="ltx_text ltx_font_bold" id="id4.4.4">Wentao Shi<sup class="ltx_sup" id="id4.4.4.1"><span class="ltx_text ltx_font_medium ltx_font_italic" id="id4.4.4.1.1">1</span></sup>
<br class="ltx_break"/>Yaxin Gong<sup class="ltx_sup" id="id4.4.4.2"><span class="ltx_text ltx_font_medium ltx_font_italic" id="id4.4.4.2.1">1</span></sup></span>  <span class="ltx_text ltx_font_bold" id="id5.5.5">Zihao Zhao<sup class="ltx_sup" id="id5.5.5.1"><span class="ltx_text ltx_font_medium ltx_font_italic" id="id5.5.5.1.1">1</span></sup></span>  <span class="ltx_text ltx_font_bold" id="id7.7.7">Fuli Feng<sup class="ltx_sup" id="id7.7.7.1"><span class="ltx_text ltx_font_medium ltx_font_italic" id="id7.7.7.1.1">1</span></sup><span class="ltx_note ltx_role_footnotemark" id="footnotex1"><sup class="ltx_note_mark">1</sup><span class="ltx_note_outer"><span class="ltx_note_content"><sup class="ltx_note_mark">1</sup><span class="ltx_note_type">footnotemark: </span><span class="ltx_tag ltx_tag_note"><span class="ltx_text ltx_font_medium" id="footnotex1.1.1.1">1</span></span></span></span></span>
<br class="ltx_break"/><sup class="ltx_sup" id="id7.7.7.2"><span class="ltx_text ltx_font_medium" id="id7.7.7.2.1">1</span></sup></span>University of Science and Technology of China
<br class="ltx_break"/><span class="ltx_text ltx_font_typewriter" id="id8.8.id1">{simonfan, shiwentao123, gyx2022, zzh1998}@mail.ustc.edu.cn
<br class="ltx_break"/>chongminggao@ustc.edu.cn</span>,  <span class="ltx_text ltx_font_typewriter" id="id9.9.id2">fulifeng93@gmail.com</span>
</span><span class="ltx_author_notes">Corresponding author</span></span>
</div>
<div class="ltx_abstract">
<h6 class="ltx_title ltx_title_abstract">Abstract</h6>
<p class="ltx_p" id="id10.id1">Accurate and safe medication recommendations are critical for effective clinical decision-making, especially in multimorbidity cases.
However, existing systems rely on point-wise prediction paradigms that overlook synergistic drug effects and potential adverse drug-drug interactions (DDIs).
We propose FLAME, a fine-grained list-wise alignment framework for large language models (LLMs), enabling <span class="ltx_text ltx_font_italic" id="id10.id1.1">drug-by-drug generation</span> of drug lists.
FLAME formulates recommendation as a sequential decision process, where each step adds or removes a single drug.
To provide fine-grained learning signals,
we devise step-wise Group Relative Policy Optimization (GRPO) with potential-based reward shaping, which explicitly models DDIs and optimizes the contribution of each drug to the overall prescription.
Furthermore, FLAME enhances patient modeling by integrating structured clinical knowledge and collaborative information into the
representation space of LLMs.
Experiments on benchmark datasets demonstrate that FLAME achieves state-of-the-art performance, delivering superior accuracy, controllable safety–accuracy trade-offs, and strong generalization across diverse clinical scenarios.
Our code is available at <span class="ltx_text ltx_font_typewriter" id="id10.id1.2">https://github.com/cxfann/Flame</span>.</p>
</div>
<section class="ltx_section" id="S1">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">1 </span>Introduction</h2>
<div class="ltx_para" id="S1.p1">
<p class="ltx_p" id="S1.p1.1">Accurate and safe medication recommendation is essential for clinical decision-making, especially in complex cases involving multimorbidity <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib1" title="">1</a>, <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib2" title="">2</a>]</cite>. In these scenarios, clinicians must consider not only the therapeutic effects of individual drugs, but also their potential interactions and cumulative safety risks. Recent advances in AI have led to the development of automated medication recommendation systems <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib3" title="">3</a>, <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib4" title="">4</a>, <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib5" title="">5</a>]</cite>, yet their effectiveness remains limited in practice.</p>
</div>
<div class="ltx_para" id="S1.p2">
<p class="ltx_p" id="S1.p2.1">Traditional approaches typically adopt a point-wise prediction paradigm, where each drug is evaluated independently based on structured patient data such as diagnoses, procedures, and drug codes <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib6" title="">6</a>, <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib7" title="">7</a>]</cite>. While longitudinal models <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib8" title="">8</a>]</cite> attempt to capture patient history, they are still constrained by their reliance on discrete labels and lack the capacity to represent unstructured clinical context. More recently, large language models (LLMs) have emerged as a promising solution, due to their strong language understanding and ability to incorporate free-text information such as clinical notes <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib9" title="">9</a>, <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib10" title="">10</a>]</cite>. However, most LLM-based methods still follow the point-wise formulation, constructing the final drug set by aggregating drugs with high predicted scores.</p>
</div>
<div class="ltx_para" id="S1.p3">
<p class="ltx_p" id="S1.p3.1">This formulation introduces a fundamental limitation: it overlooks the <span class="ltx_text ltx_font_italic" id="S1.p3.1.1">synergistic effects and safety constraints</span> that exist between
drugs.
In practice, effective prescriptions must balance therapeutic efficacy with the risk of adverse drug-drug interactions (DDIs) <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib11" title="">11</a>]</cite>. Point-wise models, by design, cannot account for this interplay. To address this, we argue that medication recommendation should be viewed as a <span class="ltx_text ltx_font_bold" id="S1.p3.1.2">list-wise decision-making problem</span>, where the goal is to generate a coherent set of drugs that jointly optimize accuracy and safety.</p>
</div>
<div class="ltx_para" id="S1.p4">
<p class="ltx_p" id="S1.p4.1">Existing list-wise methods in NLP often rely on reinforcement learning (RL) techniques to align model outputs with desired properties <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib12" title="">12</a>]</cite>. One promising approach is Group Relative Policy Optimization (GRPO), which updates model preferences based on relative advantages among a group of candidate outputs. Yet standard GRPO operates at the sequence level (Fig. <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S1.F1" title="Figure 1 ‣ 1 Introduction ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">1</span></a> (a))—assigning a single scalar reward to the entire output—making it difficult to assign credit to individual actions.</p>
</div>
<div class="ltx_para" id="S1.p5">
<p class="ltx_p" id="S1.p5.1">To this end, we propose FLAME (<span class="ltx_text ltx_font_bold ltx_framed ltx_framed_underline" id="S1.p5.1.1">F</span>ine-grained <span class="ltx_text ltx_font_bold ltx_framed ltx_framed_underline" id="S1.p5.1.2">L</span>ist-wise <span class="ltx_text ltx_font_bold ltx_framed ltx_framed_underline" id="S1.p5.1.3">A</span>lignment for generative <span class="ltx_text ltx_font_bold ltx_framed ltx_framed_underline" id="S1.p5.1.4">M</span>edication r<span class="ltx_text ltx_font_bold ltx_framed ltx_framed_underline" id="S1.p5.1.5">E</span>commendation), an LLM-based framework that formulates drug generation as a <span class="ltx_text ltx_font_italic" id="S1.p5.1.6">drug-by-drug</span> decision process. At its core is a novel extension of GRPO—<span class="ltx_text ltx_font_bold" id="S1.p5.1.7">step-wise GRPO</span>—which models the generation as a sequence of state transitions. Each step adds or removes a drug, and reward shaping is applied via a potential function to provide token-level feedback (Fig. <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S1.F1" title="Figure 1 ‣ 1 Introduction ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">1</span></a> (b)) throughout the generation process. This structure enables FLAME to learn nuanced and controllable decision policies.</p>
</div>
<figure class="ltx_figure" id="S1.F1"><img alt="Refer to caption" class="ltx_graphics ltx_centering ltx_img_landscape" height="166" id="S1.F1.g1" src="x1.png" width="831"/>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure">Figure 1: </span>Contrasting advantage computation in GRPO and step-wise GRPO. (a) Outcome-based advantages in GRPO assign uniform rewards to all drugs in a completion. (b) Step-wise GRPO treats responses as sequential steps, where potential function variations at each step provide temporal signals, enabling finer-grained advantage allocation.</figcaption>
</figure>
<div class="ltx_para" id="S1.p6">
<p class="ltx_p" id="S1.p6.1">To support comprehensive patient modeling, FLAME incorporates multi-source medical knowledge into the LLM via hybrid representations. In addition to the LLM’s natural language inputs, we inject structured clinical features (e.g., codes, embeddings from prior models) into the token space, enabling the model to capture both textual context and collaborative signals. We build on Llama3.1-Aloe-Beta-8B <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib13" title="">13</a>]</cite>, a domain-specific LLM with enriched medical knowledge.</p>
</div>
<div class="ltx_para" id="S1.p7">
<p class="ltx_p" id="S1.p7.1">We evaluate FLAME on benchmark datasets including MIMIC-III <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib14" title="">14</a>]</cite>, MIMIC-IV <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib15" title="">15</a>]</cite>, and eICU <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib16" title="">16</a>]</cite>. Experimental results show that FLAME achieves state-of-the-art accuracy while maintaining controllable safety trade-offs. Moreover, FLAME exhibits strong generalization across time and institutions, validating its adaptability to real-world clinical scenarios.</p>
</div>
<div class="ltx_para" id="S1.p8">
<p class="ltx_p" id="S1.p8.1">Our contributions are summarized as follows:</p>
<ul class="ltx_itemize" id="S1.I1">
<li class="ltx_item" id="S1.I1.i1" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="S1.I1.i1.p1">
<p class="ltx_p" id="S1.I1.i1.p1.1">We propose FLAME, an LLM-based list-wise medication recommendation framework that generates prescriptions <span class="ltx_text ltx_font_italic" id="S1.I1.i1.p1.1.1">drug-by-drug</span>, explicitly modeling drug interactions and integrating multi-source medical knowledge via hybrid representations.
</p>
</div>
</li>
<li class="ltx_item" id="S1.I1.i2" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="S1.I1.i2.p1">
<p class="ltx_p" id="S1.I1.i2.p1.1">We introduce step-wise GRPO, which models medication recommendation as a sequential state transition process and leverages potential-based reward shaping to provide fine-grained feedback for each drug-level decision, enabling controllable and clinically safer recommendations.</p>
</div>
</li>
<li class="ltx_item" id="S1.I1.i3" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="S1.I1.i3.p1">
<p class="ltx_p" id="S1.I1.i3.p1.1">Extensive experiments on benchmark datasets demonstrate that FLAME achieves state-of-the-art performance in accuracy, safety–accuracy trade-offs, and cross-dataset generalization, validating its effectiveness in diverse clinical settings.</p>
</div>
</li>
</ul>
</div>
</section>
<section class="ltx_section" id="S2">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">2 </span>Related Work</h2>
<div class="ltx_para" id="S2.p1">
<p class="ltx_p" id="S2.p1.1">In this section, we provide a brief review of medication recommender systems and LLM fine-tuning methods, highlighting their respective strengths and limitations.</p>
</div>
<section class="ltx_subsection" id="S2.SS1">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">2.1 </span>Medication Recommendation</h3>
<div class="ltx_para" id="S2.SS1.p1">
<p class="ltx_p" id="S2.SS1.p1.1">Existing medication recommendation methods can be broadly categorized into <span class="ltx_text ltx_font_italic" id="S2.SS1.p1.1.1">instance-based</span> and <span class="ltx_text ltx_font_italic" id="S2.SS1.p1.1.2">longitudinal</span> approaches, based on how patient information is modeled.</p>
</div>
<div class="ltx_para" id="S2.SS1.p2">
<p class="ltx_p" id="S2.SS1.p2.1"><span class="ltx_text ltx_font_bold" id="S2.SS1.p2.1.1">Instance-based methods</span>, such as LEAP <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib6" title="">6</a>]</cite>, treat the medication recommendation task as a multi-instance multi-label learning problem. These approaches typically rely on structured features extracted from a single patient visit.
In contrast, <span class="ltx_text ltx_font_bold" id="S2.SS1.p2.1.2">longitudinal methods</span> incorporate temporal information from patients’ hospitalization histories to model long-term disease progression and treatment trajectories.
For example,
GameNet <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib7" title="">7</a>]</cite> utilizes hospitalization records and a graph augmented memory module to model DDIs.
SafeDrug <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib3" title="">3</a>]</cite> enhances this by using dual molecular graph encoders to capture drug structural information.
COGNet <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib4" title="">4</a>]</cite> introduces a copy-or-predict mechanism for medication recommendation from historical data, while MoleRec <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib8" title="">8</a>]</cite> focuses on the relationship between health status and molecular substructures.
RAREMed <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib5" title="">5</a>]</cite> uses a pretrain-finetune framework for structured representation extraction, and NLA-MMR <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib17" title="">17</a>]</cite> applies a multimodal alignment framework to jointly learn from patient and drug views.</p>
</div>
<div class="ltx_para" id="S2.SS1.p3">
<p class="ltx_p" id="S2.SS1.p3.1">Recently, the development of LLMs has brought new possibilities for medication recommendation.
Instead of relying solely on structured codes, these approaches leverage natural language to represent patient conditions more comprehensively.
For example, LAMO <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib10" title="">10</a>]</cite> integrates structured diagnoses and procedures with unstructured textual descriptions of patients, enabling LLMs to model clinical context in a semantically rich manner and generate more personalized drug suggestions.</p>
</div>
<div class="ltx_para" id="S2.SS1.p4">
<p class="ltx_p" id="S2.SS1.p4.1">Many existing methods, including recent LLM-based approaches, still adopt a point-wise prediction format, assigning scores or binary labels to individual drugs and failing to capture inter-drug dependencies.
In contrast, we propose a list-wise decision model that utilizes step-wise GRPO for fine-grained reward modeling, integrating medical knowledge, collaborative knowledge, and LLM text-level understanding.</p>
</div>
</section>
<section class="ltx_subsection" id="S2.SS2">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">2.2 </span>LLM Fine-Tuning Approaches</h3>
<div class="ltx_para" id="S2.SS2.p1">
<p class="ltx_p" id="S2.SS2.p1.1">Fine-tuning LLMs for complex decision tasks has evolved from supervised fine-tuning (SFT) to preference-based reinforcement learning approaches such as reinforcement learning-based fine-tuning (RLHF). While RLHF methods like Proximal Policy Optimization (PPO) <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib18" title="">18</a>]</cite> offer online adaptability, they incur high overhead due to their multi-component design. Recent advances such as Direct Preference Optimization (DPO) <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib19" title="">19</a>]</cite> reduce this complexity by leveraging static preference data, but struggle with dynamic optimization.</p>
</div>
<div class="ltx_para" id="S2.SS2.p2">
<p class="ltx_p" id="S2.SS2.p2.1">GRPO <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib12" title="">12</a>]</cite> further improves training efficiency and policy stability by introducing group-wise relative preference comparisons, achieving strong performance in structured reasoning tasks. However, GRPO remains outcome-based—assigning rewards only to complete outputs—thus failing to capture step-level quality variations within structured decision processes.</p>
</div>
<div class="ltx_para" id="S2.SS2.p3">
<p class="ltx_p" id="S2.SS2.p3.1">On the contrary, step-wise GRPO is a fine-grained alignment method that decomposes generation into decision steps and applies a potential-based reward mechanism to guide each sub-decision. This enables LLMs to better learn the internal logic of complex tasks such as medication recommendation.</p>
</div>
</section>
</section>
<section class="ltx_section" id="S3">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">3 </span>Preliminary</h2>
<div class="ltx_para" id="S3.p1">
<p class="ltx_p" id="S3.p1.1">This section formulates the medication recommendation problem through three components: electronic health record, DDI graph, and the optimization goal. We then introduce Group Relative Policy Optimization, a reinforcement learning framework that models outcome-based advantages.</p>
</div>
<section class="ltx_subsection" id="S3.SS1">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">3.1 </span>Medication Recommendation</h3>
<div class="ltx_para" id="S3.SS1.p1">
<p class="ltx_p" id="S3.SS1.p1.11"><span class="ltx_text ltx_font_bold" id="S3.SS1.p1.11.1">Electronic Health Records (EHRs).</span>
Each patient’s EHR  <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib20" title="">20</a>]</cite> contains both structured and unstructured clinical information and is represented as a sequence of multivariate visits.
For a patient <math alttext="j" class="ltx_Math" display="inline" id="S3.SS1.p1.1.m1.1"><semantics id="S3.SS1.p1.1.m1.1a"><mi id="S3.SS1.p1.1.m1.1.1" xref="S3.SS1.p1.1.m1.1.1.cmml">j</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.1.m1.1b"><ci id="S3.SS1.p1.1.m1.1.1.cmml" xref="S3.SS1.p1.1.m1.1.1">𝑗</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.1.m1.1c">j</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.1.m1.1d">italic_j</annotation></semantics></math> with <math alttext="V" class="ltx_Math" display="inline" id="S3.SS1.p1.2.m2.1"><semantics id="S3.SS1.p1.2.m2.1a"><mi id="S3.SS1.p1.2.m2.1.1" xref="S3.SS1.p1.2.m2.1.1.cmml">V</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.2.m2.1b"><ci id="S3.SS1.p1.2.m2.1.1.cmml" xref="S3.SS1.p1.2.m2.1.1">𝑉</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.2.m2.1c">V</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.2.m2.1d">italic_V</annotation></semantics></math> historical visits, the EHR is denoted as
<math alttext="\bm{X}^{(j)}_{V}=[\mathbf{x}_{1}^{(j)},\mathbf{x}_{2}^{(j)},\dots,\mathbf{x}_{%
V}^{(j)}]." class="ltx_Math" display="inline" id="S3.SS1.p1.3.m3.6"><semantics id="S3.SS1.p1.3.m3.6a"><mrow id="S3.SS1.p1.3.m3.6.6.1" xref="S3.SS1.p1.3.m3.6.6.1.1.cmml"><mrow id="S3.SS1.p1.3.m3.6.6.1.1" xref="S3.SS1.p1.3.m3.6.6.1.1.cmml"><msubsup id="S3.SS1.p1.3.m3.6.6.1.1.5" xref="S3.SS1.p1.3.m3.6.6.1.1.5.cmml"><mi id="S3.SS1.p1.3.m3.6.6.1.1.5.2.2" xref="S3.SS1.p1.3.m3.6.6.1.1.5.2.2.cmml">𝑿</mi><mi id="S3.SS1.p1.3.m3.6.6.1.1.5.3" xref="S3.SS1.p1.3.m3.6.6.1.1.5.3.cmml">V</mi><mrow id="S3.SS1.p1.3.m3.1.1.1.3" xref="S3.SS1.p1.3.m3.6.6.1.1.5.cmml"><mo id="S3.SS1.p1.3.m3.1.1.1.3.1" stretchy="false" xref="S3.SS1.p1.3.m3.6.6.1.1.5.cmml">(</mo><mi id="S3.SS1.p1.3.m3.1.1.1.1" xref="S3.SS1.p1.3.m3.1.1.1.1.cmml">j</mi><mo id="S3.SS1.p1.3.m3.1.1.1.3.2" stretchy="false" xref="S3.SS1.p1.3.m3.6.6.1.1.5.cmml">)</mo></mrow></msubsup><mo id="S3.SS1.p1.3.m3.6.6.1.1.4" xref="S3.SS1.p1.3.m3.6.6.1.1.4.cmml">=</mo><mrow id="S3.SS1.p1.3.m3.6.6.1.1.3.3" xref="S3.SS1.p1.3.m3.6.6.1.1.3.4.cmml"><mo id="S3.SS1.p1.3.m3.6.6.1.1.3.3.4" stretchy="false" xref="S3.SS1.p1.3.m3.6.6.1.1.3.4.cmml">[</mo><msubsup id="S3.SS1.p1.3.m3.6.6.1.1.1.1.1" xref="S3.SS1.p1.3.m3.6.6.1.1.1.1.1.cmml"><mi id="S3.SS1.p1.3.m3.6.6.1.1.1.1.1.2.2" xref="S3.SS1.p1.3.m3.6.6.1.1.1.1.1.2.2.cmml">𝐱</mi><mn id="S3.SS1.p1.3.m3.6.6.1.1.1.1.1.2.3" xref="S3.SS1.p1.3.m3.6.6.1.1.1.1.1.2.3.cmml">1</mn><mrow id="S3.SS1.p1.3.m3.2.2.1.3" xref="S3.SS1.p1.3.m3.6.6.1.1.1.1.1.cmml"><mo id="S3.SS1.p1.3.m3.2.2.1.3.1" stretchy="false" xref="S3.SS1.p1.3.m3.6.6.1.1.1.1.1.cmml">(</mo><mi id="S3.SS1.p1.3.m3.2.2.1.1" xref="S3.SS1.p1.3.m3.2.2.1.1.cmml">j</mi><mo id="S3.SS1.p1.3.m3.2.2.1.3.2" stretchy="false" xref="S3.SS1.p1.3.m3.6.6.1.1.1.1.1.cmml">)</mo></mrow></msubsup><mo id="S3.SS1.p1.3.m3.6.6.1.1.3.3.5" xref="S3.SS1.p1.3.m3.6.6.1.1.3.4.cmml">,</mo><msubsup id="S3.SS1.p1.3.m3.6.6.1.1.2.2.2" xref="S3.SS1.p1.3.m3.6.6.1.1.2.2.2.cmml"><mi id="S3.SS1.p1.3.m3.6.6.1.1.2.2.2.2.2" xref="S3.SS1.p1.3.m3.6.6.1.1.2.2.2.2.2.cmml">𝐱</mi><mn id="S3.SS1.p1.3.m3.6.6.1.1.2.2.2.2.3" xref="S3.SS1.p1.3.m3.6.6.1.1.2.2.2.2.3.cmml">2</mn><mrow id="S3.SS1.p1.3.m3.3.3.1.3" xref="S3.SS1.p1.3.m3.6.6.1.1.2.2.2.cmml"><mo id="S3.SS1.p1.3.m3.3.3.1.3.1" stretchy="false" xref="S3.SS1.p1.3.m3.6.6.1.1.2.2.2.cmml">(</mo><mi id="S3.SS1.p1.3.m3.3.3.1.1" xref="S3.SS1.p1.3.m3.3.3.1.1.cmml">j</mi><mo id="S3.SS1.p1.3.m3.3.3.1.3.2" stretchy="false" xref="S3.SS1.p1.3.m3.6.6.1.1.2.2.2.cmml">)</mo></mrow></msubsup><mo id="S3.SS1.p1.3.m3.6.6.1.1.3.3.6" xref="S3.SS1.p1.3.m3.6.6.1.1.3.4.cmml">,</mo><mi id="S3.SS1.p1.3.m3.5.5" mathvariant="normal" xref="S3.SS1.p1.3.m3.5.5.cmml">…</mi><mo id="S3.SS1.p1.3.m3.6.6.1.1.3.3.7" xref="S3.SS1.p1.3.m3.6.6.1.1.3.4.cmml">,</mo><msubsup id="S3.SS1.p1.3.m3.6.6.1.1.3.3.3" xref="S3.SS1.p1.3.m3.6.6.1.1.3.3.3.cmml"><mi id="S3.SS1.p1.3.m3.6.6.1.1.3.3.3.2.2" xref="S3.SS1.p1.3.m3.6.6.1.1.3.3.3.2.2.cmml">𝐱</mi><mi id="S3.SS1.p1.3.m3.6.6.1.1.3.3.3.2.3" xref="S3.SS1.p1.3.m3.6.6.1.1.3.3.3.2.3.cmml">V</mi><mrow id="S3.SS1.p1.3.m3.4.4.1.3" xref="S3.SS1.p1.3.m3.6.6.1.1.3.3.3.cmml"><mo id="S3.SS1.p1.3.m3.4.4.1.3.1" stretchy="false" xref="S3.SS1.p1.3.m3.6.6.1.1.3.3.3.cmml">(</mo><mi id="S3.SS1.p1.3.m3.4.4.1.1" xref="S3.SS1.p1.3.m3.4.4.1.1.cmml">j</mi><mo id="S3.SS1.p1.3.m3.4.4.1.3.2" stretchy="false" xref="S3.SS1.p1.3.m3.6.6.1.1.3.3.3.cmml">)</mo></mrow></msubsup><mo id="S3.SS1.p1.3.m3.6.6.1.1.3.3.8" stretchy="false" xref="S3.SS1.p1.3.m3.6.6.1.1.3.4.cmml">]</mo></mrow></mrow><mo id="S3.SS1.p1.3.m3.6.6.1.2" lspace="0em" xref="S3.SS1.p1.3.m3.6.6.1.1.cmml">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.3.m3.6b"><apply id="S3.SS1.p1.3.m3.6.6.1.1.cmml" xref="S3.SS1.p1.3.m3.6.6.1"><eq id="S3.SS1.p1.3.m3.6.6.1.1.4.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.4"></eq><apply id="S3.SS1.p1.3.m3.6.6.1.1.5.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.5"><csymbol cd="ambiguous" id="S3.SS1.p1.3.m3.6.6.1.1.5.1.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.5">subscript</csymbol><apply id="S3.SS1.p1.3.m3.6.6.1.1.5.2.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.5"><csymbol cd="ambiguous" id="S3.SS1.p1.3.m3.6.6.1.1.5.2.1.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.5">superscript</csymbol><ci id="S3.SS1.p1.3.m3.6.6.1.1.5.2.2.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.5.2.2">𝑿</ci><ci id="S3.SS1.p1.3.m3.1.1.1.1.cmml" xref="S3.SS1.p1.3.m3.1.1.1.1">𝑗</ci></apply><ci id="S3.SS1.p1.3.m3.6.6.1.1.5.3.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.5.3">𝑉</ci></apply><list id="S3.SS1.p1.3.m3.6.6.1.1.3.4.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.3.3"><apply id="S3.SS1.p1.3.m3.6.6.1.1.1.1.1.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.1.1.1"><csymbol cd="ambiguous" id="S3.SS1.p1.3.m3.6.6.1.1.1.1.1.1.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.1.1.1">superscript</csymbol><apply id="S3.SS1.p1.3.m3.6.6.1.1.1.1.1.2.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.1.1.1"><csymbol cd="ambiguous" id="S3.SS1.p1.3.m3.6.6.1.1.1.1.1.2.1.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.1.1.1">subscript</csymbol><ci id="S3.SS1.p1.3.m3.6.6.1.1.1.1.1.2.2.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.1.1.1.2.2">𝐱</ci><cn id="S3.SS1.p1.3.m3.6.6.1.1.1.1.1.2.3.cmml" type="integer" xref="S3.SS1.p1.3.m3.6.6.1.1.1.1.1.2.3">1</cn></apply><ci id="S3.SS1.p1.3.m3.2.2.1.1.cmml" xref="S3.SS1.p1.3.m3.2.2.1.1">𝑗</ci></apply><apply id="S3.SS1.p1.3.m3.6.6.1.1.2.2.2.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.2.2.2"><csymbol cd="ambiguous" id="S3.SS1.p1.3.m3.6.6.1.1.2.2.2.1.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.2.2.2">superscript</csymbol><apply id="S3.SS1.p1.3.m3.6.6.1.1.2.2.2.2.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.2.2.2"><csymbol cd="ambiguous" id="S3.SS1.p1.3.m3.6.6.1.1.2.2.2.2.1.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.2.2.2">subscript</csymbol><ci id="S3.SS1.p1.3.m3.6.6.1.1.2.2.2.2.2.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.2.2.2.2.2">𝐱</ci><cn id="S3.SS1.p1.3.m3.6.6.1.1.2.2.2.2.3.cmml" type="integer" xref="S3.SS1.p1.3.m3.6.6.1.1.2.2.2.2.3">2</cn></apply><ci id="S3.SS1.p1.3.m3.3.3.1.1.cmml" xref="S3.SS1.p1.3.m3.3.3.1.1">𝑗</ci></apply><ci id="S3.SS1.p1.3.m3.5.5.cmml" xref="S3.SS1.p1.3.m3.5.5">…</ci><apply id="S3.SS1.p1.3.m3.6.6.1.1.3.3.3.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.3.3.3"><csymbol cd="ambiguous" id="S3.SS1.p1.3.m3.6.6.1.1.3.3.3.1.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.3.3.3">superscript</csymbol><apply id="S3.SS1.p1.3.m3.6.6.1.1.3.3.3.2.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.3.3.3"><csymbol cd="ambiguous" id="S3.SS1.p1.3.m3.6.6.1.1.3.3.3.2.1.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.3.3.3">subscript</csymbol><ci id="S3.SS1.p1.3.m3.6.6.1.1.3.3.3.2.2.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.3.3.3.2.2">𝐱</ci><ci id="S3.SS1.p1.3.m3.6.6.1.1.3.3.3.2.3.cmml" xref="S3.SS1.p1.3.m3.6.6.1.1.3.3.3.2.3">𝑉</ci></apply><ci id="S3.SS1.p1.3.m3.4.4.1.1.cmml" xref="S3.SS1.p1.3.m3.4.4.1.1">𝑗</ci></apply></list></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.3.m3.6c">\bm{X}^{(j)}_{V}=[\mathbf{x}_{1}^{(j)},\mathbf{x}_{2}^{(j)},\dots,\mathbf{x}_{%
V}^{(j)}].</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.3.m3.6d">bold_italic_X start_POSTSUPERSCRIPT ( italic_j ) end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_V end_POSTSUBSCRIPT = [ bold_x start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ( italic_j ) end_POSTSUPERSCRIPT , bold_x start_POSTSUBSCRIPT 2 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ( italic_j ) end_POSTSUPERSCRIPT , … , bold_x start_POSTSUBSCRIPT italic_V end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ( italic_j ) end_POSTSUPERSCRIPT ] .</annotation></semantics></math>
Each visit <math alttext="\mathbf{x}_{v}^{(j)}\in\bm{X}^{(j)}_{V}" class="ltx_Math" display="inline" id="S3.SS1.p1.4.m4.2"><semantics id="S3.SS1.p1.4.m4.2a"><mrow id="S3.SS1.p1.4.m4.2.3" xref="S3.SS1.p1.4.m4.2.3.cmml"><msubsup id="S3.SS1.p1.4.m4.2.3.2" xref="S3.SS1.p1.4.m4.2.3.2.cmml"><mi id="S3.SS1.p1.4.m4.2.3.2.2.2" xref="S3.SS1.p1.4.m4.2.3.2.2.2.cmml">𝐱</mi><mi id="S3.SS1.p1.4.m4.2.3.2.2.3" xref="S3.SS1.p1.4.m4.2.3.2.2.3.cmml">v</mi><mrow id="S3.SS1.p1.4.m4.1.1.1.3" xref="S3.SS1.p1.4.m4.2.3.2.cmml"><mo id="S3.SS1.p1.4.m4.1.1.1.3.1" stretchy="false" xref="S3.SS1.p1.4.m4.2.3.2.cmml">(</mo><mi id="S3.SS1.p1.4.m4.1.1.1.1" xref="S3.SS1.p1.4.m4.1.1.1.1.cmml">j</mi><mo id="S3.SS1.p1.4.m4.1.1.1.3.2" stretchy="false" xref="S3.SS1.p1.4.m4.2.3.2.cmml">)</mo></mrow></msubsup><mo id="S3.SS1.p1.4.m4.2.3.1" xref="S3.SS1.p1.4.m4.2.3.1.cmml">∈</mo><msubsup id="S3.SS1.p1.4.m4.2.3.3" xref="S3.SS1.p1.4.m4.2.3.3.cmml"><mi id="S3.SS1.p1.4.m4.2.3.3.2.2" xref="S3.SS1.p1.4.m4.2.3.3.2.2.cmml">𝑿</mi><mi id="S3.SS1.p1.4.m4.2.3.3.3" xref="S3.SS1.p1.4.m4.2.3.3.3.cmml">V</mi><mrow id="S3.SS1.p1.4.m4.2.2.1.3" xref="S3.SS1.p1.4.m4.2.3.3.cmml"><mo id="S3.SS1.p1.4.m4.2.2.1.3.1" stretchy="false" xref="S3.SS1.p1.4.m4.2.3.3.cmml">(</mo><mi id="S3.SS1.p1.4.m4.2.2.1.1" xref="S3.SS1.p1.4.m4.2.2.1.1.cmml">j</mi><mo id="S3.SS1.p1.4.m4.2.2.1.3.2" stretchy="false" xref="S3.SS1.p1.4.m4.2.3.3.cmml">)</mo></mrow></msubsup></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.4.m4.2b"><apply id="S3.SS1.p1.4.m4.2.3.cmml" xref="S3.SS1.p1.4.m4.2.3"><in id="S3.SS1.p1.4.m4.2.3.1.cmml" xref="S3.SS1.p1.4.m4.2.3.1"></in><apply id="S3.SS1.p1.4.m4.2.3.2.cmml" xref="S3.SS1.p1.4.m4.2.3.2"><csymbol cd="ambiguous" id="S3.SS1.p1.4.m4.2.3.2.1.cmml" xref="S3.SS1.p1.4.m4.2.3.2">superscript</csymbol><apply id="S3.SS1.p1.4.m4.2.3.2.2.cmml" xref="S3.SS1.p1.4.m4.2.3.2"><csymbol cd="ambiguous" id="S3.SS1.p1.4.m4.2.3.2.2.1.cmml" xref="S3.SS1.p1.4.m4.2.3.2">subscript</csymbol><ci id="S3.SS1.p1.4.m4.2.3.2.2.2.cmml" xref="S3.SS1.p1.4.m4.2.3.2.2.2">𝐱</ci><ci id="S3.SS1.p1.4.m4.2.3.2.2.3.cmml" xref="S3.SS1.p1.4.m4.2.3.2.2.3">𝑣</ci></apply><ci id="S3.SS1.p1.4.m4.1.1.1.1.cmml" xref="S3.SS1.p1.4.m4.1.1.1.1">𝑗</ci></apply><apply id="S3.SS1.p1.4.m4.2.3.3.cmml" xref="S3.SS1.p1.4.m4.2.3.3"><csymbol cd="ambiguous" id="S3.SS1.p1.4.m4.2.3.3.1.cmml" xref="S3.SS1.p1.4.m4.2.3.3">subscript</csymbol><apply id="S3.SS1.p1.4.m4.2.3.3.2.cmml" xref="S3.SS1.p1.4.m4.2.3.3"><csymbol cd="ambiguous" id="S3.SS1.p1.4.m4.2.3.3.2.1.cmml" xref="S3.SS1.p1.4.m4.2.3.3">superscript</csymbol><ci id="S3.SS1.p1.4.m4.2.3.3.2.2.cmml" xref="S3.SS1.p1.4.m4.2.3.3.2.2">𝑿</ci><ci id="S3.SS1.p1.4.m4.2.2.1.1.cmml" xref="S3.SS1.p1.4.m4.2.2.1.1">𝑗</ci></apply><ci id="S3.SS1.p1.4.m4.2.3.3.3.cmml" xref="S3.SS1.p1.4.m4.2.3.3.3">𝑉</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.4.m4.2c">\mathbf{x}_{v}^{(j)}\in\bm{X}^{(j)}_{V}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.4.m4.2d">bold_x start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ( italic_j ) end_POSTSUPERSCRIPT ∈ bold_italic_X start_POSTSUPERSCRIPT ( italic_j ) end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_V end_POSTSUBSCRIPT</annotation></semantics></math> consists of the following components:
<math alttext="\mathbf{x}_{v}^{(j)}=[(\mathbf{f}_{v}^{(j)},\mathbf{n}_{v}^{(j)}),\mathcal{M}_%
{v}^{(j)}]" class="ltx_Math" display="inline" id="S3.SS1.p1.5.m5.6"><semantics id="S3.SS1.p1.5.m5.6a"><mrow id="S3.SS1.p1.5.m5.6.6" xref="S3.SS1.p1.5.m5.6.6.cmml"><msubsup id="S3.SS1.p1.5.m5.6.6.4" xref="S3.SS1.p1.5.m5.6.6.4.cmml"><mi id="S3.SS1.p1.5.m5.6.6.4.2.2" xref="S3.SS1.p1.5.m5.6.6.4.2.2.cmml">𝐱</mi><mi id="S3.SS1.p1.5.m5.6.6.4.2.3" xref="S3.SS1.p1.5.m5.6.6.4.2.3.cmml">v</mi><mrow id="S3.SS1.p1.5.m5.1.1.1.3" xref="S3.SS1.p1.5.m5.6.6.4.cmml"><mo id="S3.SS1.p1.5.m5.1.1.1.3.1" stretchy="false" xref="S3.SS1.p1.5.m5.6.6.4.cmml">(</mo><mi id="S3.SS1.p1.5.m5.1.1.1.1" xref="S3.SS1.p1.5.m5.1.1.1.1.cmml">j</mi><mo id="S3.SS1.p1.5.m5.1.1.1.3.2" stretchy="false" xref="S3.SS1.p1.5.m5.6.6.4.cmml">)</mo></mrow></msubsup><mo id="S3.SS1.p1.5.m5.6.6.3" xref="S3.SS1.p1.5.m5.6.6.3.cmml">=</mo><mrow id="S3.SS1.p1.5.m5.6.6.2.2" xref="S3.SS1.p1.5.m5.6.6.2.3.cmml"><mo id="S3.SS1.p1.5.m5.6.6.2.2.3" stretchy="false" xref="S3.SS1.p1.5.m5.6.6.2.3.cmml">[</mo><mrow id="S3.SS1.p1.5.m5.5.5.1.1.1.2" xref="S3.SS1.p1.5.m5.5.5.1.1.1.3.cmml"><mo id="S3.SS1.p1.5.m5.5.5.1.1.1.2.3" stretchy="false" xref="S3.SS1.p1.5.m5.5.5.1.1.1.3.cmml">(</mo><msubsup id="S3.SS1.p1.5.m5.5.5.1.1.1.1.1" xref="S3.SS1.p1.5.m5.5.5.1.1.1.1.1.cmml"><mi id="S3.SS1.p1.5.m5.5.5.1.1.1.1.1.2.2" xref="S3.SS1.p1.5.m5.5.5.1.1.1.1.1.2.2.cmml">𝐟</mi><mi id="S3.SS1.p1.5.m5.5.5.1.1.1.1.1.2.3" xref="S3.SS1.p1.5.m5.5.5.1.1.1.1.1.2.3.cmml">v</mi><mrow id="S3.SS1.p1.5.m5.2.2.1.3" xref="S3.SS1.p1.5.m5.5.5.1.1.1.1.1.cmml"><mo id="S3.SS1.p1.5.m5.2.2.1.3.1" stretchy="false" xref="S3.SS1.p1.5.m5.5.5.1.1.1.1.1.cmml">(</mo><mi id="S3.SS1.p1.5.m5.2.2.1.1" xref="S3.SS1.p1.5.m5.2.2.1.1.cmml">j</mi><mo id="S3.SS1.p1.5.m5.2.2.1.3.2" stretchy="false" xref="S3.SS1.p1.5.m5.5.5.1.1.1.1.1.cmml">)</mo></mrow></msubsup><mo id="S3.SS1.p1.5.m5.5.5.1.1.1.2.4" xref="S3.SS1.p1.5.m5.5.5.1.1.1.3.cmml">,</mo><msubsup id="S3.SS1.p1.5.m5.5.5.1.1.1.2.2" xref="S3.SS1.p1.5.m5.5.5.1.1.1.2.2.cmml"><mi id="S3.SS1.p1.5.m5.5.5.1.1.1.2.2.2.2" xref="S3.SS1.p1.5.m5.5.5.1.1.1.2.2.2.2.cmml">𝐧</mi><mi id="S3.SS1.p1.5.m5.5.5.1.1.1.2.2.2.3" xref="S3.SS1.p1.5.m5.5.5.1.1.1.2.2.2.3.cmml">v</mi><mrow id="S3.SS1.p1.5.m5.3.3.1.3" xref="S3.SS1.p1.5.m5.5.5.1.1.1.2.2.cmml"><mo id="S3.SS1.p1.5.m5.3.3.1.3.1" stretchy="false" xref="S3.SS1.p1.5.m5.5.5.1.1.1.2.2.cmml">(</mo><mi id="S3.SS1.p1.5.m5.3.3.1.1" xref="S3.SS1.p1.5.m5.3.3.1.1.cmml">j</mi><mo id="S3.SS1.p1.5.m5.3.3.1.3.2" stretchy="false" xref="S3.SS1.p1.5.m5.5.5.1.1.1.2.2.cmml">)</mo></mrow></msubsup><mo id="S3.SS1.p1.5.m5.5.5.1.1.1.2.5" stretchy="false" xref="S3.SS1.p1.5.m5.5.5.1.1.1.3.cmml">)</mo></mrow><mo id="S3.SS1.p1.5.m5.6.6.2.2.4" xref="S3.SS1.p1.5.m5.6.6.2.3.cmml">,</mo><msubsup id="S3.SS1.p1.5.m5.6.6.2.2.2" xref="S3.SS1.p1.5.m5.6.6.2.2.2.cmml"><mi class="ltx_font_mathcaligraphic" id="S3.SS1.p1.5.m5.6.6.2.2.2.2.2" xref="S3.SS1.p1.5.m5.6.6.2.2.2.2.2.cmml">ℳ</mi><mi id="S3.SS1.p1.5.m5.6.6.2.2.2.2.3" xref="S3.SS1.p1.5.m5.6.6.2.2.2.2.3.cmml">v</mi><mrow id="S3.SS1.p1.5.m5.4.4.1.3" xref="S3.SS1.p1.5.m5.6.6.2.2.2.cmml"><mo id="S3.SS1.p1.5.m5.4.4.1.3.1" stretchy="false" xref="S3.SS1.p1.5.m5.6.6.2.2.2.cmml">(</mo><mi id="S3.SS1.p1.5.m5.4.4.1.1" xref="S3.SS1.p1.5.m5.4.4.1.1.cmml">j</mi><mo id="S3.SS1.p1.5.m5.4.4.1.3.2" stretchy="false" xref="S3.SS1.p1.5.m5.6.6.2.2.2.cmml">)</mo></mrow></msubsup><mo id="S3.SS1.p1.5.m5.6.6.2.2.5" stretchy="false" xref="S3.SS1.p1.5.m5.6.6.2.3.cmml">]</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.5.m5.6b"><apply id="S3.SS1.p1.5.m5.6.6.cmml" xref="S3.SS1.p1.5.m5.6.6"><eq id="S3.SS1.p1.5.m5.6.6.3.cmml" xref="S3.SS1.p1.5.m5.6.6.3"></eq><apply id="S3.SS1.p1.5.m5.6.6.4.cmml" xref="S3.SS1.p1.5.m5.6.6.4"><csymbol cd="ambiguous" id="S3.SS1.p1.5.m5.6.6.4.1.cmml" xref="S3.SS1.p1.5.m5.6.6.4">superscript</csymbol><apply id="S3.SS1.p1.5.m5.6.6.4.2.cmml" xref="S3.SS1.p1.5.m5.6.6.4"><csymbol cd="ambiguous" id="S3.SS1.p1.5.m5.6.6.4.2.1.cmml" xref="S3.SS1.p1.5.m5.6.6.4">subscript</csymbol><ci id="S3.SS1.p1.5.m5.6.6.4.2.2.cmml" xref="S3.SS1.p1.5.m5.6.6.4.2.2">𝐱</ci><ci id="S3.SS1.p1.5.m5.6.6.4.2.3.cmml" xref="S3.SS1.p1.5.m5.6.6.4.2.3">𝑣</ci></apply><ci id="S3.SS1.p1.5.m5.1.1.1.1.cmml" xref="S3.SS1.p1.5.m5.1.1.1.1">𝑗</ci></apply><interval closure="closed" id="S3.SS1.p1.5.m5.6.6.2.3.cmml" xref="S3.SS1.p1.5.m5.6.6.2.2"><interval closure="open" id="S3.SS1.p1.5.m5.5.5.1.1.1.3.cmml" xref="S3.SS1.p1.5.m5.5.5.1.1.1.2"><apply id="S3.SS1.p1.5.m5.5.5.1.1.1.1.1.cmml" xref="S3.SS1.p1.5.m5.5.5.1.1.1.1.1"><csymbol cd="ambiguous" id="S3.SS1.p1.5.m5.5.5.1.1.1.1.1.1.cmml" xref="S3.SS1.p1.5.m5.5.5.1.1.1.1.1">superscript</csymbol><apply id="S3.SS1.p1.5.m5.5.5.1.1.1.1.1.2.cmml" xref="S3.SS1.p1.5.m5.5.5.1.1.1.1.1"><csymbol cd="ambiguous" id="S3.SS1.p1.5.m5.5.5.1.1.1.1.1.2.1.cmml" xref="S3.SS1.p1.5.m5.5.5.1.1.1.1.1">subscript</csymbol><ci id="S3.SS1.p1.5.m5.5.5.1.1.1.1.1.2.2.cmml" xref="S3.SS1.p1.5.m5.5.5.1.1.1.1.1.2.2">𝐟</ci><ci id="S3.SS1.p1.5.m5.5.5.1.1.1.1.1.2.3.cmml" xref="S3.SS1.p1.5.m5.5.5.1.1.1.1.1.2.3">𝑣</ci></apply><ci id="S3.SS1.p1.5.m5.2.2.1.1.cmml" xref="S3.SS1.p1.5.m5.2.2.1.1">𝑗</ci></apply><apply id="S3.SS1.p1.5.m5.5.5.1.1.1.2.2.cmml" xref="S3.SS1.p1.5.m5.5.5.1.1.1.2.2"><csymbol cd="ambiguous" id="S3.SS1.p1.5.m5.5.5.1.1.1.2.2.1.cmml" xref="S3.SS1.p1.5.m5.5.5.1.1.1.2.2">superscript</csymbol><apply id="S3.SS1.p1.5.m5.5.5.1.1.1.2.2.2.cmml" xref="S3.SS1.p1.5.m5.5.5.1.1.1.2.2"><csymbol cd="ambiguous" id="S3.SS1.p1.5.m5.5.5.1.1.1.2.2.2.1.cmml" xref="S3.SS1.p1.5.m5.5.5.1.1.1.2.2">subscript</csymbol><ci id="S3.SS1.p1.5.m5.5.5.1.1.1.2.2.2.2.cmml" xref="S3.SS1.p1.5.m5.5.5.1.1.1.2.2.2.2">𝐧</ci><ci id="S3.SS1.p1.5.m5.5.5.1.1.1.2.2.2.3.cmml" xref="S3.SS1.p1.5.m5.5.5.1.1.1.2.2.2.3">𝑣</ci></apply><ci id="S3.SS1.p1.5.m5.3.3.1.1.cmml" xref="S3.SS1.p1.5.m5.3.3.1.1">𝑗</ci></apply></interval><apply id="S3.SS1.p1.5.m5.6.6.2.2.2.cmml" xref="S3.SS1.p1.5.m5.6.6.2.2.2"><csymbol cd="ambiguous" id="S3.SS1.p1.5.m5.6.6.2.2.2.1.cmml" xref="S3.SS1.p1.5.m5.6.6.2.2.2">superscript</csymbol><apply id="S3.SS1.p1.5.m5.6.6.2.2.2.2.cmml" xref="S3.SS1.p1.5.m5.6.6.2.2.2"><csymbol cd="ambiguous" id="S3.SS1.p1.5.m5.6.6.2.2.2.2.1.cmml" xref="S3.SS1.p1.5.m5.6.6.2.2.2">subscript</csymbol><ci id="S3.SS1.p1.5.m5.6.6.2.2.2.2.2.cmml" xref="S3.SS1.p1.5.m5.6.6.2.2.2.2.2">ℳ</ci><ci id="S3.SS1.p1.5.m5.6.6.2.2.2.2.3.cmml" xref="S3.SS1.p1.5.m5.6.6.2.2.2.2.3">𝑣</ci></apply><ci id="S3.SS1.p1.5.m5.4.4.1.1.cmml" xref="S3.SS1.p1.5.m5.4.4.1.1">𝑗</ci></apply></interval></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.5.m5.6c">\mathbf{x}_{v}^{(j)}=[(\mathbf{f}_{v}^{(j)},\mathbf{n}_{v}^{(j)}),\mathcal{M}_%
{v}^{(j)}]</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.5.m5.6d">bold_x start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ( italic_j ) end_POSTSUPERSCRIPT = [ ( bold_f start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ( italic_j ) end_POSTSUPERSCRIPT , bold_n start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ( italic_j ) end_POSTSUPERSCRIPT ) , caligraphic_M start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ( italic_j ) end_POSTSUPERSCRIPT ]</annotation></semantics></math>.
where <math alttext="\mathbf{f}_{v}^{(j)}\in\{0,1\}^{|\mathcal{F}|}" class="ltx_Math" display="inline" id="S3.SS1.p1.6.m6.4"><semantics id="S3.SS1.p1.6.m6.4a"><mrow id="S3.SS1.p1.6.m6.4.5" xref="S3.SS1.p1.6.m6.4.5.cmml"><msubsup id="S3.SS1.p1.6.m6.4.5.2" xref="S3.SS1.p1.6.m6.4.5.2.cmml"><mi id="S3.SS1.p1.6.m6.4.5.2.2.2" xref="S3.SS1.p1.6.m6.4.5.2.2.2.cmml">𝐟</mi><mi id="S3.SS1.p1.6.m6.4.5.2.2.3" xref="S3.SS1.p1.6.m6.4.5.2.2.3.cmml">v</mi><mrow id="S3.SS1.p1.6.m6.1.1.1.3" xref="S3.SS1.p1.6.m6.4.5.2.cmml"><mo id="S3.SS1.p1.6.m6.1.1.1.3.1" stretchy="false" xref="S3.SS1.p1.6.m6.4.5.2.cmml">(</mo><mi id="S3.SS1.p1.6.m6.1.1.1.1" xref="S3.SS1.p1.6.m6.1.1.1.1.cmml">j</mi><mo id="S3.SS1.p1.6.m6.1.1.1.3.2" stretchy="false" xref="S3.SS1.p1.6.m6.4.5.2.cmml">)</mo></mrow></msubsup><mo id="S3.SS1.p1.6.m6.4.5.1" xref="S3.SS1.p1.6.m6.4.5.1.cmml">∈</mo><msup id="S3.SS1.p1.6.m6.4.5.3" xref="S3.SS1.p1.6.m6.4.5.3.cmml"><mrow id="S3.SS1.p1.6.m6.4.5.3.2.2" xref="S3.SS1.p1.6.m6.4.5.3.2.1.cmml"><mo id="S3.SS1.p1.6.m6.4.5.3.2.2.1" stretchy="false" xref="S3.SS1.p1.6.m6.4.5.3.2.1.cmml">{</mo><mn id="S3.SS1.p1.6.m6.3.3" xref="S3.SS1.p1.6.m6.3.3.cmml">0</mn><mo id="S3.SS1.p1.6.m6.4.5.3.2.2.2" xref="S3.SS1.p1.6.m6.4.5.3.2.1.cmml">,</mo><mn id="S3.SS1.p1.6.m6.4.4" xref="S3.SS1.p1.6.m6.4.4.cmml">1</mn><mo id="S3.SS1.p1.6.m6.4.5.3.2.2.3" stretchy="false" xref="S3.SS1.p1.6.m6.4.5.3.2.1.cmml">}</mo></mrow><mrow id="S3.SS1.p1.6.m6.2.2.1.3" xref="S3.SS1.p1.6.m6.2.2.1.2.cmml"><mo id="S3.SS1.p1.6.m6.2.2.1.3.1" stretchy="false" xref="S3.SS1.p1.6.m6.2.2.1.2.1.cmml">|</mo><mi class="ltx_font_mathcaligraphic" id="S3.SS1.p1.6.m6.2.2.1.1" xref="S3.SS1.p1.6.m6.2.2.1.1.cmml">ℱ</mi><mo id="S3.SS1.p1.6.m6.2.2.1.3.2" stretchy="false" xref="S3.SS1.p1.6.m6.2.2.1.2.1.cmml">|</mo></mrow></msup></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.6.m6.4b"><apply id="S3.SS1.p1.6.m6.4.5.cmml" xref="S3.SS1.p1.6.m6.4.5"><in id="S3.SS1.p1.6.m6.4.5.1.cmml" xref="S3.SS1.p1.6.m6.4.5.1"></in><apply id="S3.SS1.p1.6.m6.4.5.2.cmml" xref="S3.SS1.p1.6.m6.4.5.2"><csymbol cd="ambiguous" id="S3.SS1.p1.6.m6.4.5.2.1.cmml" xref="S3.SS1.p1.6.m6.4.5.2">superscript</csymbol><apply id="S3.SS1.p1.6.m6.4.5.2.2.cmml" xref="S3.SS1.p1.6.m6.4.5.2"><csymbol cd="ambiguous" id="S3.SS1.p1.6.m6.4.5.2.2.1.cmml" xref="S3.SS1.p1.6.m6.4.5.2">subscript</csymbol><ci id="S3.SS1.p1.6.m6.4.5.2.2.2.cmml" xref="S3.SS1.p1.6.m6.4.5.2.2.2">𝐟</ci><ci id="S3.SS1.p1.6.m6.4.5.2.2.3.cmml" xref="S3.SS1.p1.6.m6.4.5.2.2.3">𝑣</ci></apply><ci id="S3.SS1.p1.6.m6.1.1.1.1.cmml" xref="S3.SS1.p1.6.m6.1.1.1.1">𝑗</ci></apply><apply id="S3.SS1.p1.6.m6.4.5.3.cmml" xref="S3.SS1.p1.6.m6.4.5.3"><csymbol cd="ambiguous" id="S3.SS1.p1.6.m6.4.5.3.1.cmml" xref="S3.SS1.p1.6.m6.4.5.3">superscript</csymbol><set id="S3.SS1.p1.6.m6.4.5.3.2.1.cmml" xref="S3.SS1.p1.6.m6.4.5.3.2.2"><cn id="S3.SS1.p1.6.m6.3.3.cmml" type="integer" xref="S3.SS1.p1.6.m6.3.3">0</cn><cn id="S3.SS1.p1.6.m6.4.4.cmml" type="integer" xref="S3.SS1.p1.6.m6.4.4">1</cn></set><apply id="S3.SS1.p1.6.m6.2.2.1.2.cmml" xref="S3.SS1.p1.6.m6.2.2.1.3"><abs id="S3.SS1.p1.6.m6.2.2.1.2.1.cmml" xref="S3.SS1.p1.6.m6.2.2.1.3.1"></abs><ci id="S3.SS1.p1.6.m6.2.2.1.1.cmml" xref="S3.SS1.p1.6.m6.2.2.1.1">ℱ</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.6.m6.4c">\mathbf{f}_{v}^{(j)}\in\{0,1\}^{|\mathcal{F}|}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.6.m6.4d">bold_f start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ( italic_j ) end_POSTSUPERSCRIPT ∈ { 0 , 1 } start_POSTSUPERSCRIPT | caligraphic_F | end_POSTSUPERSCRIPT</annotation></semantics></math> is a multi-hot vector encoding structured features from the set <math alttext="\mathcal{F}" class="ltx_Math" display="inline" id="S3.SS1.p1.7.m7.1"><semantics id="S3.SS1.p1.7.m7.1a"><mi class="ltx_font_mathcaligraphic" id="S3.SS1.p1.7.m7.1.1" xref="S3.SS1.p1.7.m7.1.1.cmml">ℱ</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.7.m7.1b"><ci id="S3.SS1.p1.7.m7.1.1.cmml" xref="S3.SS1.p1.7.m7.1.1">ℱ</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.7.m7.1c">\mathcal{F}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.7.m7.1d">caligraphic_F</annotation></semantics></math> (e.g., demographics, diagnoses, and procedures), and <math alttext="\mathbf{n}_{v}^{(j)}" class="ltx_Math" display="inline" id="S3.SS1.p1.8.m8.1"><semantics id="S3.SS1.p1.8.m8.1a"><msubsup id="S3.SS1.p1.8.m8.1.2" xref="S3.SS1.p1.8.m8.1.2.cmml"><mi id="S3.SS1.p1.8.m8.1.2.2.2" xref="S3.SS1.p1.8.m8.1.2.2.2.cmml">𝐧</mi><mi id="S3.SS1.p1.8.m8.1.2.2.3" xref="S3.SS1.p1.8.m8.1.2.2.3.cmml">v</mi><mrow id="S3.SS1.p1.8.m8.1.1.1.3" xref="S3.SS1.p1.8.m8.1.2.cmml"><mo id="S3.SS1.p1.8.m8.1.1.1.3.1" stretchy="false" xref="S3.SS1.p1.8.m8.1.2.cmml">(</mo><mi id="S3.SS1.p1.8.m8.1.1.1.1" xref="S3.SS1.p1.8.m8.1.1.1.1.cmml">j</mi><mo id="S3.SS1.p1.8.m8.1.1.1.3.2" stretchy="false" xref="S3.SS1.p1.8.m8.1.2.cmml">)</mo></mrow></msubsup><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.8.m8.1b"><apply id="S3.SS1.p1.8.m8.1.2.cmml" xref="S3.SS1.p1.8.m8.1.2"><csymbol cd="ambiguous" id="S3.SS1.p1.8.m8.1.2.1.cmml" xref="S3.SS1.p1.8.m8.1.2">superscript</csymbol><apply id="S3.SS1.p1.8.m8.1.2.2.cmml" xref="S3.SS1.p1.8.m8.1.2"><csymbol cd="ambiguous" id="S3.SS1.p1.8.m8.1.2.2.1.cmml" xref="S3.SS1.p1.8.m8.1.2">subscript</csymbol><ci id="S3.SS1.p1.8.m8.1.2.2.2.cmml" xref="S3.SS1.p1.8.m8.1.2.2.2">𝐧</ci><ci id="S3.SS1.p1.8.m8.1.2.2.3.cmml" xref="S3.SS1.p1.8.m8.1.2.2.3">𝑣</ci></apply><ci id="S3.SS1.p1.8.m8.1.1.1.1.cmml" xref="S3.SS1.p1.8.m8.1.1.1.1">𝑗</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.8.m8.1c">\mathbf{n}_{v}^{(j)}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.8.m8.1d">bold_n start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ( italic_j ) end_POSTSUPERSCRIPT</annotation></semantics></math> is the corresponding unstructured clinical note in natural language.
The set <math alttext="\mathcal{M}_{v}^{(j)}" class="ltx_Math" display="inline" id="S3.SS1.p1.9.m9.1"><semantics id="S3.SS1.p1.9.m9.1a"><msubsup id="S3.SS1.p1.9.m9.1.2" xref="S3.SS1.p1.9.m9.1.2.cmml"><mi class="ltx_font_mathcaligraphic" id="S3.SS1.p1.9.m9.1.2.2.2" xref="S3.SS1.p1.9.m9.1.2.2.2.cmml">ℳ</mi><mi id="S3.SS1.p1.9.m9.1.2.2.3" xref="S3.SS1.p1.9.m9.1.2.2.3.cmml">v</mi><mrow id="S3.SS1.p1.9.m9.1.1.1.3" xref="S3.SS1.p1.9.m9.1.2.cmml"><mo id="S3.SS1.p1.9.m9.1.1.1.3.1" stretchy="false" xref="S3.SS1.p1.9.m9.1.2.cmml">(</mo><mi id="S3.SS1.p1.9.m9.1.1.1.1" xref="S3.SS1.p1.9.m9.1.1.1.1.cmml">j</mi><mo id="S3.SS1.p1.9.m9.1.1.1.3.2" stretchy="false" xref="S3.SS1.p1.9.m9.1.2.cmml">)</mo></mrow></msubsup><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.9.m9.1b"><apply id="S3.SS1.p1.9.m9.1.2.cmml" xref="S3.SS1.p1.9.m9.1.2"><csymbol cd="ambiguous" id="S3.SS1.p1.9.m9.1.2.1.cmml" xref="S3.SS1.p1.9.m9.1.2">superscript</csymbol><apply id="S3.SS1.p1.9.m9.1.2.2.cmml" xref="S3.SS1.p1.9.m9.1.2"><csymbol cd="ambiguous" id="S3.SS1.p1.9.m9.1.2.2.1.cmml" xref="S3.SS1.p1.9.m9.1.2">subscript</csymbol><ci id="S3.SS1.p1.9.m9.1.2.2.2.cmml" xref="S3.SS1.p1.9.m9.1.2.2.2">ℳ</ci><ci id="S3.SS1.p1.9.m9.1.2.2.3.cmml" xref="S3.SS1.p1.9.m9.1.2.2.3">𝑣</ci></apply><ci id="S3.SS1.p1.9.m9.1.1.1.1.cmml" xref="S3.SS1.p1.9.m9.1.1.1.1">𝑗</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.9.m9.1c">\mathcal{M}_{v}^{(j)}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.9.m9.1d">caligraphic_M start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ( italic_j ) end_POSTSUPERSCRIPT</annotation></semantics></math> denotes the medications prescribed during the <math alttext="v" class="ltx_Math" display="inline" id="S3.SS1.p1.10.m10.1"><semantics id="S3.SS1.p1.10.m10.1a"><mi id="S3.SS1.p1.10.m10.1.1" xref="S3.SS1.p1.10.m10.1.1.cmml">v</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.10.m10.1b"><ci id="S3.SS1.p1.10.m10.1.1.cmml" xref="S3.SS1.p1.10.m10.1.1">𝑣</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.10.m10.1c">v</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.10.m10.1d">italic_v</annotation></semantics></math>-th visit.
For simplicity, we omit the patient index <math alttext="j" class="ltx_Math" display="inline" id="S3.SS1.p1.11.m11.1"><semantics id="S3.SS1.p1.11.m11.1a"><mi id="S3.SS1.p1.11.m11.1.1" xref="S3.SS1.p1.11.m11.1.1.cmml">j</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p1.11.m11.1b"><ci id="S3.SS1.p1.11.m11.1.1.cmml" xref="S3.SS1.p1.11.m11.1.1">𝑗</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p1.11.m11.1c">j</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p1.11.m11.1d">italic_j</annotation></semantics></math> when it is clear from context.</p>
</div>
<div class="ltx_para" id="S3.SS1.p2">
<p class="ltx_p" id="S3.SS1.p2.4"><span class="ltx_text ltx_font_bold" id="S3.SS1.p2.4.1">Drug-Drug Interaction (DDI) Graph.</span>
The DDI graph <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib11" title="">11</a>]</cite> models harmful pairwise interactions between medications and is represented as a symmetric binary adjacency matrix <math alttext="\bm{D}\in\{0,1\}^{|\mathcal{M}|\times|\mathcal{M}|}" class="ltx_Math" display="inline" id="S3.SS1.p2.1.m1.4"><semantics id="S3.SS1.p2.1.m1.4a"><mrow id="S3.SS1.p2.1.m1.4.5" xref="S3.SS1.p2.1.m1.4.5.cmml"><mi id="S3.SS1.p2.1.m1.4.5.2" xref="S3.SS1.p2.1.m1.4.5.2.cmml">𝑫</mi><mo id="S3.SS1.p2.1.m1.4.5.1" xref="S3.SS1.p2.1.m1.4.5.1.cmml">∈</mo><msup id="S3.SS1.p2.1.m1.4.5.3" xref="S3.SS1.p2.1.m1.4.5.3.cmml"><mrow id="S3.SS1.p2.1.m1.4.5.3.2.2" xref="S3.SS1.p2.1.m1.4.5.3.2.1.cmml"><mo id="S3.SS1.p2.1.m1.4.5.3.2.2.1" stretchy="false" xref="S3.SS1.p2.1.m1.4.5.3.2.1.cmml">{</mo><mn id="S3.SS1.p2.1.m1.3.3" xref="S3.SS1.p2.1.m1.3.3.cmml">0</mn><mo id="S3.SS1.p2.1.m1.4.5.3.2.2.2" xref="S3.SS1.p2.1.m1.4.5.3.2.1.cmml">,</mo><mn id="S3.SS1.p2.1.m1.4.4" xref="S3.SS1.p2.1.m1.4.4.cmml">1</mn><mo id="S3.SS1.p2.1.m1.4.5.3.2.2.3" stretchy="false" xref="S3.SS1.p2.1.m1.4.5.3.2.1.cmml">}</mo></mrow><mrow id="S3.SS1.p2.1.m1.2.2.2" xref="S3.SS1.p2.1.m1.2.2.2.cmml"><mrow id="S3.SS1.p2.1.m1.2.2.2.4.2" xref="S3.SS1.p2.1.m1.2.2.2.4.1.cmml"><mo id="S3.SS1.p2.1.m1.2.2.2.4.2.1" stretchy="false" xref="S3.SS1.p2.1.m1.2.2.2.4.1.1.cmml">|</mo><mi class="ltx_font_mathcaligraphic" id="S3.SS1.p2.1.m1.1.1.1.1" xref="S3.SS1.p2.1.m1.1.1.1.1.cmml">ℳ</mi><mo id="S3.SS1.p2.1.m1.2.2.2.4.2.2" rspace="0.055em" stretchy="false" xref="S3.SS1.p2.1.m1.2.2.2.4.1.1.cmml">|</mo></mrow><mo id="S3.SS1.p2.1.m1.2.2.2.3" rspace="0.222em" xref="S3.SS1.p2.1.m1.2.2.2.3.cmml">×</mo><mrow id="S3.SS1.p2.1.m1.2.2.2.5.2" xref="S3.SS1.p2.1.m1.2.2.2.5.1.cmml"><mo id="S3.SS1.p2.1.m1.2.2.2.5.2.1" stretchy="false" xref="S3.SS1.p2.1.m1.2.2.2.5.1.1.cmml">|</mo><mi class="ltx_font_mathcaligraphic" id="S3.SS1.p2.1.m1.2.2.2.2" xref="S3.SS1.p2.1.m1.2.2.2.2.cmml">ℳ</mi><mo id="S3.SS1.p2.1.m1.2.2.2.5.2.2" stretchy="false" xref="S3.SS1.p2.1.m1.2.2.2.5.1.1.cmml">|</mo></mrow></mrow></msup></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p2.1.m1.4b"><apply id="S3.SS1.p2.1.m1.4.5.cmml" xref="S3.SS1.p2.1.m1.4.5"><in id="S3.SS1.p2.1.m1.4.5.1.cmml" xref="S3.SS1.p2.1.m1.4.5.1"></in><ci id="S3.SS1.p2.1.m1.4.5.2.cmml" xref="S3.SS1.p2.1.m1.4.5.2">𝑫</ci><apply id="S3.SS1.p2.1.m1.4.5.3.cmml" xref="S3.SS1.p2.1.m1.4.5.3"><csymbol cd="ambiguous" id="S3.SS1.p2.1.m1.4.5.3.1.cmml" xref="S3.SS1.p2.1.m1.4.5.3">superscript</csymbol><set id="S3.SS1.p2.1.m1.4.5.3.2.1.cmml" xref="S3.SS1.p2.1.m1.4.5.3.2.2"><cn id="S3.SS1.p2.1.m1.3.3.cmml" type="integer" xref="S3.SS1.p2.1.m1.3.3">0</cn><cn id="S3.SS1.p2.1.m1.4.4.cmml" type="integer" xref="S3.SS1.p2.1.m1.4.4">1</cn></set><apply id="S3.SS1.p2.1.m1.2.2.2.cmml" xref="S3.SS1.p2.1.m1.2.2.2"><times id="S3.SS1.p2.1.m1.2.2.2.3.cmml" xref="S3.SS1.p2.1.m1.2.2.2.3"></times><apply id="S3.SS1.p2.1.m1.2.2.2.4.1.cmml" xref="S3.SS1.p2.1.m1.2.2.2.4.2"><abs id="S3.SS1.p2.1.m1.2.2.2.4.1.1.cmml" xref="S3.SS1.p2.1.m1.2.2.2.4.2.1"></abs><ci id="S3.SS1.p2.1.m1.1.1.1.1.cmml" xref="S3.SS1.p2.1.m1.1.1.1.1">ℳ</ci></apply><apply id="S3.SS1.p2.1.m1.2.2.2.5.1.cmml" xref="S3.SS1.p2.1.m1.2.2.2.5.2"><abs id="S3.SS1.p2.1.m1.2.2.2.5.1.1.cmml" xref="S3.SS1.p2.1.m1.2.2.2.5.2.1"></abs><ci id="S3.SS1.p2.1.m1.2.2.2.2.cmml" xref="S3.SS1.p2.1.m1.2.2.2.2">ℳ</ci></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p2.1.m1.4c">\bm{D}\in\{0,1\}^{|\mathcal{M}|\times|\mathcal{M}|}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p2.1.m1.4d">bold_italic_D ∈ { 0 , 1 } start_POSTSUPERSCRIPT | caligraphic_M | × | caligraphic_M | end_POSTSUPERSCRIPT</annotation></semantics></math>, where <math alttext="\bm{D}_{ij}=1" class="ltx_Math" display="inline" id="S3.SS1.p2.2.m2.1"><semantics id="S3.SS1.p2.2.m2.1a"><mrow id="S3.SS1.p2.2.m2.1.1" xref="S3.SS1.p2.2.m2.1.1.cmml"><msub id="S3.SS1.p2.2.m2.1.1.2" xref="S3.SS1.p2.2.m2.1.1.2.cmml"><mi id="S3.SS1.p2.2.m2.1.1.2.2" xref="S3.SS1.p2.2.m2.1.1.2.2.cmml">𝑫</mi><mrow id="S3.SS1.p2.2.m2.1.1.2.3" xref="S3.SS1.p2.2.m2.1.1.2.3.cmml"><mi id="S3.SS1.p2.2.m2.1.1.2.3.2" xref="S3.SS1.p2.2.m2.1.1.2.3.2.cmml">i</mi><mo id="S3.SS1.p2.2.m2.1.1.2.3.1" xref="S3.SS1.p2.2.m2.1.1.2.3.1.cmml">⁢</mo><mi id="S3.SS1.p2.2.m2.1.1.2.3.3" xref="S3.SS1.p2.2.m2.1.1.2.3.3.cmml">j</mi></mrow></msub><mo id="S3.SS1.p2.2.m2.1.1.1" xref="S3.SS1.p2.2.m2.1.1.1.cmml">=</mo><mn id="S3.SS1.p2.2.m2.1.1.3" xref="S3.SS1.p2.2.m2.1.1.3.cmml">1</mn></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p2.2.m2.1b"><apply id="S3.SS1.p2.2.m2.1.1.cmml" xref="S3.SS1.p2.2.m2.1.1"><eq id="S3.SS1.p2.2.m2.1.1.1.cmml" xref="S3.SS1.p2.2.m2.1.1.1"></eq><apply id="S3.SS1.p2.2.m2.1.1.2.cmml" xref="S3.SS1.p2.2.m2.1.1.2"><csymbol cd="ambiguous" id="S3.SS1.p2.2.m2.1.1.2.1.cmml" xref="S3.SS1.p2.2.m2.1.1.2">subscript</csymbol><ci id="S3.SS1.p2.2.m2.1.1.2.2.cmml" xref="S3.SS1.p2.2.m2.1.1.2.2">𝑫</ci><apply id="S3.SS1.p2.2.m2.1.1.2.3.cmml" xref="S3.SS1.p2.2.m2.1.1.2.3"><times id="S3.SS1.p2.2.m2.1.1.2.3.1.cmml" xref="S3.SS1.p2.2.m2.1.1.2.3.1"></times><ci id="S3.SS1.p2.2.m2.1.1.2.3.2.cmml" xref="S3.SS1.p2.2.m2.1.1.2.3.2">𝑖</ci><ci id="S3.SS1.p2.2.m2.1.1.2.3.3.cmml" xref="S3.SS1.p2.2.m2.1.1.2.3.3">𝑗</ci></apply></apply><cn id="S3.SS1.p2.2.m2.1.1.3.cmml" type="integer" xref="S3.SS1.p2.2.m2.1.1.3">1</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p2.2.m2.1c">\bm{D}_{ij}=1</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p2.2.m2.1d">bold_italic_D start_POSTSUBSCRIPT italic_i italic_j end_POSTSUBSCRIPT = 1</annotation></semantics></math> indicates a known adverse interaction between medications <math alttext="m_{i}" class="ltx_Math" display="inline" id="S3.SS1.p2.3.m3.1"><semantics id="S3.SS1.p2.3.m3.1a"><msub id="S3.SS1.p2.3.m3.1.1" xref="S3.SS1.p2.3.m3.1.1.cmml"><mi id="S3.SS1.p2.3.m3.1.1.2" xref="S3.SS1.p2.3.m3.1.1.2.cmml">m</mi><mi id="S3.SS1.p2.3.m3.1.1.3" xref="S3.SS1.p2.3.m3.1.1.3.cmml">i</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS1.p2.3.m3.1b"><apply id="S3.SS1.p2.3.m3.1.1.cmml" xref="S3.SS1.p2.3.m3.1.1"><csymbol cd="ambiguous" id="S3.SS1.p2.3.m3.1.1.1.cmml" xref="S3.SS1.p2.3.m3.1.1">subscript</csymbol><ci id="S3.SS1.p2.3.m3.1.1.2.cmml" xref="S3.SS1.p2.3.m3.1.1.2">𝑚</ci><ci id="S3.SS1.p2.3.m3.1.1.3.cmml" xref="S3.SS1.p2.3.m3.1.1.3">𝑖</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p2.3.m3.1c">m_{i}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p2.3.m3.1d">italic_m start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT</annotation></semantics></math> and <math alttext="m_{j}" class="ltx_Math" display="inline" id="S3.SS1.p2.4.m4.1"><semantics id="S3.SS1.p2.4.m4.1a"><msub id="S3.SS1.p2.4.m4.1.1" xref="S3.SS1.p2.4.m4.1.1.cmml"><mi id="S3.SS1.p2.4.m4.1.1.2" xref="S3.SS1.p2.4.m4.1.1.2.cmml">m</mi><mi id="S3.SS1.p2.4.m4.1.1.3" xref="S3.SS1.p2.4.m4.1.1.3.cmml">j</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS1.p2.4.m4.1b"><apply id="S3.SS1.p2.4.m4.1.1.cmml" xref="S3.SS1.p2.4.m4.1.1"><csymbol cd="ambiguous" id="S3.SS1.p2.4.m4.1.1.1.cmml" xref="S3.SS1.p2.4.m4.1.1">subscript</csymbol><ci id="S3.SS1.p2.4.m4.1.1.2.cmml" xref="S3.SS1.p2.4.m4.1.1.2">𝑚</ci><ci id="S3.SS1.p2.4.m4.1.1.3.cmml" xref="S3.SS1.p2.4.m4.1.1.3">𝑗</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p2.4.m4.1c">m_{j}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p2.4.m4.1d">italic_m start_POSTSUBSCRIPT italic_j end_POSTSUBSCRIPT</annotation></semantics></math>.</p>
</div>
<div class="ltx_para" id="S3.SS1.p3">
<p class="ltx_p" id="S3.SS1.p3.6"><span class="ltx_text ltx_font_bold" id="S3.SS1.p3.6.1">Task Definition.</span>
Given a patient’s historical visit records <math alttext="\bm{X}_{V-1}" class="ltx_Math" display="inline" id="S3.SS1.p3.1.m1.1"><semantics id="S3.SS1.p3.1.m1.1a"><msub id="S3.SS1.p3.1.m1.1.1" xref="S3.SS1.p3.1.m1.1.1.cmml"><mi id="S3.SS1.p3.1.m1.1.1.2" xref="S3.SS1.p3.1.m1.1.1.2.cmml">𝑿</mi><mrow id="S3.SS1.p3.1.m1.1.1.3" xref="S3.SS1.p3.1.m1.1.1.3.cmml"><mi id="S3.SS1.p3.1.m1.1.1.3.2" xref="S3.SS1.p3.1.m1.1.1.3.2.cmml">V</mi><mo id="S3.SS1.p3.1.m1.1.1.3.1" xref="S3.SS1.p3.1.m1.1.1.3.1.cmml">−</mo><mn id="S3.SS1.p3.1.m1.1.1.3.3" xref="S3.SS1.p3.1.m1.1.1.3.3.cmml">1</mn></mrow></msub><annotation-xml encoding="MathML-Content" id="S3.SS1.p3.1.m1.1b"><apply id="S3.SS1.p3.1.m1.1.1.cmml" xref="S3.SS1.p3.1.m1.1.1"><csymbol cd="ambiguous" id="S3.SS1.p3.1.m1.1.1.1.cmml" xref="S3.SS1.p3.1.m1.1.1">subscript</csymbol><ci id="S3.SS1.p3.1.m1.1.1.2.cmml" xref="S3.SS1.p3.1.m1.1.1.2">𝑿</ci><apply id="S3.SS1.p3.1.m1.1.1.3.cmml" xref="S3.SS1.p3.1.m1.1.1.3"><minus id="S3.SS1.p3.1.m1.1.1.3.1.cmml" xref="S3.SS1.p3.1.m1.1.1.3.1"></minus><ci id="S3.SS1.p3.1.m1.1.1.3.2.cmml" xref="S3.SS1.p3.1.m1.1.1.3.2">𝑉</ci><cn id="S3.SS1.p3.1.m1.1.1.3.3.cmml" type="integer" xref="S3.SS1.p3.1.m1.1.1.3.3">1</cn></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p3.1.m1.1c">\bm{X}_{V-1}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p3.1.m1.1d">bold_italic_X start_POSTSUBSCRIPT italic_V - 1 end_POSTSUBSCRIPT</annotation></semantics></math>, as well as the structured fields and unstructured note of the current visit <math alttext="(\mathbf{f}_{V},\mathbf{n}_{V})" class="ltx_Math" display="inline" id="S3.SS1.p3.2.m2.2"><semantics id="S3.SS1.p3.2.m2.2a"><mrow id="S3.SS1.p3.2.m2.2.2.2" xref="S3.SS1.p3.2.m2.2.2.3.cmml"><mo id="S3.SS1.p3.2.m2.2.2.2.3" stretchy="false" xref="S3.SS1.p3.2.m2.2.2.3.cmml">(</mo><msub id="S3.SS1.p3.2.m2.1.1.1.1" xref="S3.SS1.p3.2.m2.1.1.1.1.cmml"><mi id="S3.SS1.p3.2.m2.1.1.1.1.2" xref="S3.SS1.p3.2.m2.1.1.1.1.2.cmml">𝐟</mi><mi id="S3.SS1.p3.2.m2.1.1.1.1.3" xref="S3.SS1.p3.2.m2.1.1.1.1.3.cmml">V</mi></msub><mo id="S3.SS1.p3.2.m2.2.2.2.4" xref="S3.SS1.p3.2.m2.2.2.3.cmml">,</mo><msub id="S3.SS1.p3.2.m2.2.2.2.2" xref="S3.SS1.p3.2.m2.2.2.2.2.cmml"><mi id="S3.SS1.p3.2.m2.2.2.2.2.2" xref="S3.SS1.p3.2.m2.2.2.2.2.2.cmml">𝐧</mi><mi id="S3.SS1.p3.2.m2.2.2.2.2.3" xref="S3.SS1.p3.2.m2.2.2.2.2.3.cmml">V</mi></msub><mo id="S3.SS1.p3.2.m2.2.2.2.5" stretchy="false" xref="S3.SS1.p3.2.m2.2.2.3.cmml">)</mo></mrow><annotation-xml encoding="MathML-Content" id="S3.SS1.p3.2.m2.2b"><interval closure="open" id="S3.SS1.p3.2.m2.2.2.3.cmml" xref="S3.SS1.p3.2.m2.2.2.2"><apply id="S3.SS1.p3.2.m2.1.1.1.1.cmml" xref="S3.SS1.p3.2.m2.1.1.1.1"><csymbol cd="ambiguous" id="S3.SS1.p3.2.m2.1.1.1.1.1.cmml" xref="S3.SS1.p3.2.m2.1.1.1.1">subscript</csymbol><ci id="S3.SS1.p3.2.m2.1.1.1.1.2.cmml" xref="S3.SS1.p3.2.m2.1.1.1.1.2">𝐟</ci><ci id="S3.SS1.p3.2.m2.1.1.1.1.3.cmml" xref="S3.SS1.p3.2.m2.1.1.1.1.3">𝑉</ci></apply><apply id="S3.SS1.p3.2.m2.2.2.2.2.cmml" xref="S3.SS1.p3.2.m2.2.2.2.2"><csymbol cd="ambiguous" id="S3.SS1.p3.2.m2.2.2.2.2.1.cmml" xref="S3.SS1.p3.2.m2.2.2.2.2">subscript</csymbol><ci id="S3.SS1.p3.2.m2.2.2.2.2.2.cmml" xref="S3.SS1.p3.2.m2.2.2.2.2.2">𝐧</ci><ci id="S3.SS1.p3.2.m2.2.2.2.2.3.cmml" xref="S3.SS1.p3.2.m2.2.2.2.2.3">𝑉</ci></apply></interval></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p3.2.m2.2c">(\mathbf{f}_{V},\mathbf{n}_{V})</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p3.2.m2.2d">( bold_f start_POSTSUBSCRIPT italic_V end_POSTSUBSCRIPT , bold_n start_POSTSUBSCRIPT italic_V end_POSTSUBSCRIPT )</annotation></semantics></math>, the objective is to generate an output <math alttext="\mathbf{o}_{V}" class="ltx_Math" display="inline" id="S3.SS1.p3.3.m3.1"><semantics id="S3.SS1.p3.3.m3.1a"><msub id="S3.SS1.p3.3.m3.1.1" xref="S3.SS1.p3.3.m3.1.1.cmml"><mi id="S3.SS1.p3.3.m3.1.1.2" xref="S3.SS1.p3.3.m3.1.1.2.cmml">𝐨</mi><mi id="S3.SS1.p3.3.m3.1.1.3" xref="S3.SS1.p3.3.m3.1.1.3.cmml">V</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS1.p3.3.m3.1b"><apply id="S3.SS1.p3.3.m3.1.1.cmml" xref="S3.SS1.p3.3.m3.1.1"><csymbol cd="ambiguous" id="S3.SS1.p3.3.m3.1.1.1.cmml" xref="S3.SS1.p3.3.m3.1.1">subscript</csymbol><ci id="S3.SS1.p3.3.m3.1.1.2.cmml" xref="S3.SS1.p3.3.m3.1.1.2">𝐨</ci><ci id="S3.SS1.p3.3.m3.1.1.3.cmml" xref="S3.SS1.p3.3.m3.1.1.3">𝑉</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p3.3.m3.1c">\mathbf{o}_{V}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p3.3.m3.1d">bold_o start_POSTSUBSCRIPT italic_V end_POSTSUBSCRIPT</annotation></semantics></math>, representing the recommended medication set <math alttext="\mathcal{M}_{V}" class="ltx_Math" display="inline" id="S3.SS1.p3.4.m4.1"><semantics id="S3.SS1.p3.4.m4.1a"><msub id="S3.SS1.p3.4.m4.1.1" xref="S3.SS1.p3.4.m4.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S3.SS1.p3.4.m4.1.1.2" xref="S3.SS1.p3.4.m4.1.1.2.cmml">ℳ</mi><mi id="S3.SS1.p3.4.m4.1.1.3" xref="S3.SS1.p3.4.m4.1.1.3.cmml">V</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS1.p3.4.m4.1b"><apply id="S3.SS1.p3.4.m4.1.1.cmml" xref="S3.SS1.p3.4.m4.1.1"><csymbol cd="ambiguous" id="S3.SS1.p3.4.m4.1.1.1.cmml" xref="S3.SS1.p3.4.m4.1.1">subscript</csymbol><ci id="S3.SS1.p3.4.m4.1.1.2.cmml" xref="S3.SS1.p3.4.m4.1.1.2">ℳ</ci><ci id="S3.SS1.p3.4.m4.1.1.3.cmml" xref="S3.SS1.p3.4.m4.1.1.3">𝑉</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p3.4.m4.1c">\mathcal{M}_{V}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p3.4.m4.1d">caligraphic_M start_POSTSUBSCRIPT italic_V end_POSTSUBSCRIPT</annotation></semantics></math>, such that:
(1) it closely approximates the ground-truth prescription <math alttext="\mathcal{M}_{GT}" class="ltx_Math" display="inline" id="S3.SS1.p3.5.m5.1"><semantics id="S3.SS1.p3.5.m5.1a"><msub id="S3.SS1.p3.5.m5.1.1" xref="S3.SS1.p3.5.m5.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S3.SS1.p3.5.m5.1.1.2" xref="S3.SS1.p3.5.m5.1.1.2.cmml">ℳ</mi><mrow id="S3.SS1.p3.5.m5.1.1.3" xref="S3.SS1.p3.5.m5.1.1.3.cmml"><mi id="S3.SS1.p3.5.m5.1.1.3.2" xref="S3.SS1.p3.5.m5.1.1.3.2.cmml">G</mi><mo id="S3.SS1.p3.5.m5.1.1.3.1" xref="S3.SS1.p3.5.m5.1.1.3.1.cmml">⁢</mo><mi id="S3.SS1.p3.5.m5.1.1.3.3" xref="S3.SS1.p3.5.m5.1.1.3.3.cmml">T</mi></mrow></msub><annotation-xml encoding="MathML-Content" id="S3.SS1.p3.5.m5.1b"><apply id="S3.SS1.p3.5.m5.1.1.cmml" xref="S3.SS1.p3.5.m5.1.1"><csymbol cd="ambiguous" id="S3.SS1.p3.5.m5.1.1.1.cmml" xref="S3.SS1.p3.5.m5.1.1">subscript</csymbol><ci id="S3.SS1.p3.5.m5.1.1.2.cmml" xref="S3.SS1.p3.5.m5.1.1.2">ℳ</ci><apply id="S3.SS1.p3.5.m5.1.1.3.cmml" xref="S3.SS1.p3.5.m5.1.1.3"><times id="S3.SS1.p3.5.m5.1.1.3.1.cmml" xref="S3.SS1.p3.5.m5.1.1.3.1"></times><ci id="S3.SS1.p3.5.m5.1.1.3.2.cmml" xref="S3.SS1.p3.5.m5.1.1.3.2">𝐺</ci><ci id="S3.SS1.p3.5.m5.1.1.3.3.cmml" xref="S3.SS1.p3.5.m5.1.1.3.3">𝑇</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p3.5.m5.1c">\mathcal{M}_{GT}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p3.5.m5.1d">caligraphic_M start_POSTSUBSCRIPT italic_G italic_T end_POSTSUBSCRIPT</annotation></semantics></math>; and
(2) it minimizes the risk of harmful drug-drug interactions as defined by the DDI graph <math alttext="\bm{D}" class="ltx_Math" display="inline" id="S3.SS1.p3.6.m6.1"><semantics id="S3.SS1.p3.6.m6.1a"><mi id="S3.SS1.p3.6.m6.1.1" xref="S3.SS1.p3.6.m6.1.1.cmml">𝑫</mi><annotation-xml encoding="MathML-Content" id="S3.SS1.p3.6.m6.1b"><ci id="S3.SS1.p3.6.m6.1.1.cmml" xref="S3.SS1.p3.6.m6.1.1">𝑫</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS1.p3.6.m6.1c">\bm{D}</annotation><annotation encoding="application/x-llamapun" id="S3.SS1.p3.6.m6.1d">bold_italic_D</annotation></semantics></math>.</p>
</div>
</section>
<section class="ltx_subsection" id="S3.SS2">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">3.2 </span>Group Relative Policy Optimization (GRPO)</h3>
<div class="ltx_para" id="S3.SS2.p1">
<p class="ltx_p" id="S3.SS2.p1.5">GRPO <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib12" title="">12</a>]</cite> is a reinforcement learning algorithm that improves policies via group-wise reward normalization.
Given a prompt <math alttext="q\sim P(Q)" class="ltx_Math" display="inline" id="S3.SS2.p1.1.m1.1"><semantics id="S3.SS2.p1.1.m1.1a"><mrow id="S3.SS2.p1.1.m1.1.2" xref="S3.SS2.p1.1.m1.1.2.cmml"><mi id="S3.SS2.p1.1.m1.1.2.2" xref="S3.SS2.p1.1.m1.1.2.2.cmml">q</mi><mo id="S3.SS2.p1.1.m1.1.2.1" xref="S3.SS2.p1.1.m1.1.2.1.cmml">∼</mo><mrow id="S3.SS2.p1.1.m1.1.2.3" xref="S3.SS2.p1.1.m1.1.2.3.cmml"><mi id="S3.SS2.p1.1.m1.1.2.3.2" xref="S3.SS2.p1.1.m1.1.2.3.2.cmml">P</mi><mo id="S3.SS2.p1.1.m1.1.2.3.1" xref="S3.SS2.p1.1.m1.1.2.3.1.cmml">⁢</mo><mrow id="S3.SS2.p1.1.m1.1.2.3.3.2" xref="S3.SS2.p1.1.m1.1.2.3.cmml"><mo id="S3.SS2.p1.1.m1.1.2.3.3.2.1" stretchy="false" xref="S3.SS2.p1.1.m1.1.2.3.cmml">(</mo><mi id="S3.SS2.p1.1.m1.1.1" xref="S3.SS2.p1.1.m1.1.1.cmml">Q</mi><mo id="S3.SS2.p1.1.m1.1.2.3.3.2.2" stretchy="false" xref="S3.SS2.p1.1.m1.1.2.3.cmml">)</mo></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.SS2.p1.1.m1.1b"><apply id="S3.SS2.p1.1.m1.1.2.cmml" xref="S3.SS2.p1.1.m1.1.2"><csymbol cd="latexml" id="S3.SS2.p1.1.m1.1.2.1.cmml" xref="S3.SS2.p1.1.m1.1.2.1">similar-to</csymbol><ci id="S3.SS2.p1.1.m1.1.2.2.cmml" xref="S3.SS2.p1.1.m1.1.2.2">𝑞</ci><apply id="S3.SS2.p1.1.m1.1.2.3.cmml" xref="S3.SS2.p1.1.m1.1.2.3"><times id="S3.SS2.p1.1.m1.1.2.3.1.cmml" xref="S3.SS2.p1.1.m1.1.2.3.1"></times><ci id="S3.SS2.p1.1.m1.1.2.3.2.cmml" xref="S3.SS2.p1.1.m1.1.2.3.2">𝑃</ci><ci id="S3.SS2.p1.1.m1.1.1.cmml" xref="S3.SS2.p1.1.m1.1.1">𝑄</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p1.1.m1.1c">q\sim P(Q)</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p1.1.m1.1d">italic_q ∼ italic_P ( italic_Q )</annotation></semantics></math> from the task distribution, GRPO samples a group of <math alttext="G" class="ltx_Math" display="inline" id="S3.SS2.p1.2.m2.1"><semantics id="S3.SS2.p1.2.m2.1a"><mi id="S3.SS2.p1.2.m2.1.1" xref="S3.SS2.p1.2.m2.1.1.cmml">G</mi><annotation-xml encoding="MathML-Content" id="S3.SS2.p1.2.m2.1b"><ci id="S3.SS2.p1.2.m2.1.1.cmml" xref="S3.SS2.p1.2.m2.1.1">𝐺</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p1.2.m2.1c">G</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p1.2.m2.1d">italic_G</annotation></semantics></math> candidate outputs <math alttext="\{\mathbf{o}_{i}\}_{i=1}^{G}" class="ltx_Math" display="inline" id="S3.SS2.p1.3.m3.1"><semantics id="S3.SS2.p1.3.m3.1a"><msubsup id="S3.SS2.p1.3.m3.1.1" xref="S3.SS2.p1.3.m3.1.1.cmml"><mrow id="S3.SS2.p1.3.m3.1.1.1.1.1" xref="S3.SS2.p1.3.m3.1.1.1.1.2.cmml"><mo id="S3.SS2.p1.3.m3.1.1.1.1.1.2" stretchy="false" xref="S3.SS2.p1.3.m3.1.1.1.1.2.cmml">{</mo><msub id="S3.SS2.p1.3.m3.1.1.1.1.1.1" xref="S3.SS2.p1.3.m3.1.1.1.1.1.1.cmml"><mi id="S3.SS2.p1.3.m3.1.1.1.1.1.1.2" xref="S3.SS2.p1.3.m3.1.1.1.1.1.1.2.cmml">𝐨</mi><mi id="S3.SS2.p1.3.m3.1.1.1.1.1.1.3" xref="S3.SS2.p1.3.m3.1.1.1.1.1.1.3.cmml">i</mi></msub><mo id="S3.SS2.p1.3.m3.1.1.1.1.1.3" stretchy="false" xref="S3.SS2.p1.3.m3.1.1.1.1.2.cmml">}</mo></mrow><mrow id="S3.SS2.p1.3.m3.1.1.1.3" xref="S3.SS2.p1.3.m3.1.1.1.3.cmml"><mi id="S3.SS2.p1.3.m3.1.1.1.3.2" xref="S3.SS2.p1.3.m3.1.1.1.3.2.cmml">i</mi><mo id="S3.SS2.p1.3.m3.1.1.1.3.1" xref="S3.SS2.p1.3.m3.1.1.1.3.1.cmml">=</mo><mn id="S3.SS2.p1.3.m3.1.1.1.3.3" xref="S3.SS2.p1.3.m3.1.1.1.3.3.cmml">1</mn></mrow><mi id="S3.SS2.p1.3.m3.1.1.3" xref="S3.SS2.p1.3.m3.1.1.3.cmml">G</mi></msubsup><annotation-xml encoding="MathML-Content" id="S3.SS2.p1.3.m3.1b"><apply id="S3.SS2.p1.3.m3.1.1.cmml" xref="S3.SS2.p1.3.m3.1.1"><csymbol cd="ambiguous" id="S3.SS2.p1.3.m3.1.1.2.cmml" xref="S3.SS2.p1.3.m3.1.1">superscript</csymbol><apply id="S3.SS2.p1.3.m3.1.1.1.cmml" xref="S3.SS2.p1.3.m3.1.1"><csymbol cd="ambiguous" id="S3.SS2.p1.3.m3.1.1.1.2.cmml" xref="S3.SS2.p1.3.m3.1.1">subscript</csymbol><set id="S3.SS2.p1.3.m3.1.1.1.1.2.cmml" xref="S3.SS2.p1.3.m3.1.1.1.1.1"><apply id="S3.SS2.p1.3.m3.1.1.1.1.1.1.cmml" xref="S3.SS2.p1.3.m3.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S3.SS2.p1.3.m3.1.1.1.1.1.1.1.cmml" xref="S3.SS2.p1.3.m3.1.1.1.1.1.1">subscript</csymbol><ci id="S3.SS2.p1.3.m3.1.1.1.1.1.1.2.cmml" xref="S3.SS2.p1.3.m3.1.1.1.1.1.1.2">𝐨</ci><ci id="S3.SS2.p1.3.m3.1.1.1.1.1.1.3.cmml" xref="S3.SS2.p1.3.m3.1.1.1.1.1.1.3">𝑖</ci></apply></set><apply id="S3.SS2.p1.3.m3.1.1.1.3.cmml" xref="S3.SS2.p1.3.m3.1.1.1.3"><eq id="S3.SS2.p1.3.m3.1.1.1.3.1.cmml" xref="S3.SS2.p1.3.m3.1.1.1.3.1"></eq><ci id="S3.SS2.p1.3.m3.1.1.1.3.2.cmml" xref="S3.SS2.p1.3.m3.1.1.1.3.2">𝑖</ci><cn id="S3.SS2.p1.3.m3.1.1.1.3.3.cmml" type="integer" xref="S3.SS2.p1.3.m3.1.1.1.3.3">1</cn></apply></apply><ci id="S3.SS2.p1.3.m3.1.1.3.cmml" xref="S3.SS2.p1.3.m3.1.1.3">𝐺</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p1.3.m3.1c">\{\mathbf{o}_{i}\}_{i=1}^{G}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p1.3.m3.1d">{ bold_o start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT } start_POSTSUBSCRIPT italic_i = 1 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_G end_POSTSUPERSCRIPT</annotation></semantics></math> from the current policy <math alttext="\pi_{\theta_{old}}" class="ltx_Math" display="inline" id="S3.SS2.p1.4.m4.1"><semantics id="S3.SS2.p1.4.m4.1a"><msub id="S3.SS2.p1.4.m4.1.1" xref="S3.SS2.p1.4.m4.1.1.cmml"><mi id="S3.SS2.p1.4.m4.1.1.2" xref="S3.SS2.p1.4.m4.1.1.2.cmml">π</mi><msub id="S3.SS2.p1.4.m4.1.1.3" xref="S3.SS2.p1.4.m4.1.1.3.cmml"><mi id="S3.SS2.p1.4.m4.1.1.3.2" xref="S3.SS2.p1.4.m4.1.1.3.2.cmml">θ</mi><mrow id="S3.SS2.p1.4.m4.1.1.3.3" xref="S3.SS2.p1.4.m4.1.1.3.3.cmml"><mi id="S3.SS2.p1.4.m4.1.1.3.3.2" xref="S3.SS2.p1.4.m4.1.1.3.3.2.cmml">o</mi><mo id="S3.SS2.p1.4.m4.1.1.3.3.1" xref="S3.SS2.p1.4.m4.1.1.3.3.1.cmml">⁢</mo><mi id="S3.SS2.p1.4.m4.1.1.3.3.3" xref="S3.SS2.p1.4.m4.1.1.3.3.3.cmml">l</mi><mo id="S3.SS2.p1.4.m4.1.1.3.3.1a" xref="S3.SS2.p1.4.m4.1.1.3.3.1.cmml">⁢</mo><mi id="S3.SS2.p1.4.m4.1.1.3.3.4" xref="S3.SS2.p1.4.m4.1.1.3.3.4.cmml">d</mi></mrow></msub></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p1.4.m4.1b"><apply id="S3.SS2.p1.4.m4.1.1.cmml" xref="S3.SS2.p1.4.m4.1.1"><csymbol cd="ambiguous" id="S3.SS2.p1.4.m4.1.1.1.cmml" xref="S3.SS2.p1.4.m4.1.1">subscript</csymbol><ci id="S3.SS2.p1.4.m4.1.1.2.cmml" xref="S3.SS2.p1.4.m4.1.1.2">𝜋</ci><apply id="S3.SS2.p1.4.m4.1.1.3.cmml" xref="S3.SS2.p1.4.m4.1.1.3"><csymbol cd="ambiguous" id="S3.SS2.p1.4.m4.1.1.3.1.cmml" xref="S3.SS2.p1.4.m4.1.1.3">subscript</csymbol><ci id="S3.SS2.p1.4.m4.1.1.3.2.cmml" xref="S3.SS2.p1.4.m4.1.1.3.2">𝜃</ci><apply id="S3.SS2.p1.4.m4.1.1.3.3.cmml" xref="S3.SS2.p1.4.m4.1.1.3.3"><times id="S3.SS2.p1.4.m4.1.1.3.3.1.cmml" xref="S3.SS2.p1.4.m4.1.1.3.3.1"></times><ci id="S3.SS2.p1.4.m4.1.1.3.3.2.cmml" xref="S3.SS2.p1.4.m4.1.1.3.3.2">𝑜</ci><ci id="S3.SS2.p1.4.m4.1.1.3.3.3.cmml" xref="S3.SS2.p1.4.m4.1.1.3.3.3">𝑙</ci><ci id="S3.SS2.p1.4.m4.1.1.3.3.4.cmml" xref="S3.SS2.p1.4.m4.1.1.3.3.4">𝑑</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p1.4.m4.1c">\pi_{\theta_{old}}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p1.4.m4.1d">italic_π start_POSTSUBSCRIPT italic_θ start_POSTSUBSCRIPT italic_o italic_l italic_d end_POSTSUBSCRIPT end_POSTSUBSCRIPT</annotation></semantics></math>.
Each output is assigned a scalar reward, and the updated policy <math alttext="\pi_{\theta}" class="ltx_Math" display="inline" id="S3.SS2.p1.5.m5.1"><semantics id="S3.SS2.p1.5.m5.1a"><msub id="S3.SS2.p1.5.m5.1.1" xref="S3.SS2.p1.5.m5.1.1.cmml"><mi id="S3.SS2.p1.5.m5.1.1.2" xref="S3.SS2.p1.5.m5.1.1.2.cmml">π</mi><mi id="S3.SS2.p1.5.m5.1.1.3" xref="S3.SS2.p1.5.m5.1.1.3.cmml">θ</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p1.5.m5.1b"><apply id="S3.SS2.p1.5.m5.1.1.cmml" xref="S3.SS2.p1.5.m5.1.1"><csymbol cd="ambiguous" id="S3.SS2.p1.5.m5.1.1.1.cmml" xref="S3.SS2.p1.5.m5.1.1">subscript</csymbol><ci id="S3.SS2.p1.5.m5.1.1.2.cmml" xref="S3.SS2.p1.5.m5.1.1.2">𝜋</ci><ci id="S3.SS2.p1.5.m5.1.1.3.cmml" xref="S3.SS2.p1.5.m5.1.1.3">𝜃</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p1.5.m5.1c">\pi_{\theta}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p1.5.m5.1d">italic_π start_POSTSUBSCRIPT italic_θ end_POSTSUBSCRIPT</annotation></semantics></math> is optimized to favor relatively better responses within the group.</p>
</div>
<div class="ltx_para" id="S3.SS2.p2">
<p class="ltx_p" id="S3.SS2.p2.3">The training objective (omitting clipping for brevity) is:</p>
<table class="ltx_equation ltx_eqn_table" id="S3.E1">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\mathcal{J}_{GRPO}(\theta)=\mathbb{E}_{q,\{\mathbf{o}_{i}\}}\left[\frac{1}{G}%
\sum_{i=1}^{G}\frac{1}{|\mathbf{o}_{i}|}\sum_{t=1}^{|\mathbf{o}_{i}|}\left(%
\frac{\pi_{\theta}(\mathbf{o}_{i,t}|\mathbf{o}_{i,&lt;t},q)}{\pi_{\theta_{old}}(%
\mathbf{o}_{i,t}|\mathbf{o}_{i,&lt;t},q)}\hat{A}_{i,t}-\beta D_{KL}[\pi_{\theta}%
\|\pi_{ref}]\right)\right]," class="ltx_Math" display="block" id="S3.E1.m1.20"><semantics id="S3.E1.m1.20a"><mrow id="S3.E1.m1.20.20.1" xref="S3.E1.m1.20.20.1.1.cmml"><mrow id="S3.E1.m1.20.20.1.1" xref="S3.E1.m1.20.20.1.1.cmml"><mrow id="S3.E1.m1.20.20.1.1.3" xref="S3.E1.m1.20.20.1.1.3.cmml"><msub id="S3.E1.m1.20.20.1.1.3.2" xref="S3.E1.m1.20.20.1.1.3.2.cmml"><mi class="ltx_font_mathcaligraphic" id="S3.E1.m1.20.20.1.1.3.2.2" xref="S3.E1.m1.20.20.1.1.3.2.2.cmml">𝒥</mi><mrow id="S3.E1.m1.20.20.1.1.3.2.3" xref="S3.E1.m1.20.20.1.1.3.2.3.cmml"><mi id="S3.E1.m1.20.20.1.1.3.2.3.2" xref="S3.E1.m1.20.20.1.1.3.2.3.2.cmml">G</mi><mo id="S3.E1.m1.20.20.1.1.3.2.3.1" xref="S3.E1.m1.20.20.1.1.3.2.3.1.cmml">⁢</mo><mi id="S3.E1.m1.20.20.1.1.3.2.3.3" xref="S3.E1.m1.20.20.1.1.3.2.3.3.cmml">R</mi><mo id="S3.E1.m1.20.20.1.1.3.2.3.1a" xref="S3.E1.m1.20.20.1.1.3.2.3.1.cmml">⁢</mo><mi id="S3.E1.m1.20.20.1.1.3.2.3.4" xref="S3.E1.m1.20.20.1.1.3.2.3.4.cmml">P</mi><mo id="S3.E1.m1.20.20.1.1.3.2.3.1b" xref="S3.E1.m1.20.20.1.1.3.2.3.1.cmml">⁢</mo><mi id="S3.E1.m1.20.20.1.1.3.2.3.5" xref="S3.E1.m1.20.20.1.1.3.2.3.5.cmml">O</mi></mrow></msub><mo id="S3.E1.m1.20.20.1.1.3.1" xref="S3.E1.m1.20.20.1.1.3.1.cmml">⁢</mo><mrow id="S3.E1.m1.20.20.1.1.3.3.2" xref="S3.E1.m1.20.20.1.1.3.cmml"><mo id="S3.E1.m1.20.20.1.1.3.3.2.1" stretchy="false" xref="S3.E1.m1.20.20.1.1.3.cmml">(</mo><mi id="S3.E1.m1.19.19" xref="S3.E1.m1.19.19.cmml">θ</mi><mo id="S3.E1.m1.20.20.1.1.3.3.2.2" stretchy="false" xref="S3.E1.m1.20.20.1.1.3.cmml">)</mo></mrow></mrow><mo id="S3.E1.m1.20.20.1.1.2" xref="S3.E1.m1.20.20.1.1.2.cmml">=</mo><mrow id="S3.E1.m1.20.20.1.1.1" xref="S3.E1.m1.20.20.1.1.1.cmml"><msub id="S3.E1.m1.20.20.1.1.1.3" xref="S3.E1.m1.20.20.1.1.1.3.cmml"><mi id="S3.E1.m1.20.20.1.1.1.3.2" xref="S3.E1.m1.20.20.1.1.1.3.2.cmml">𝔼</mi><mrow id="S3.E1.m1.2.2.2.2" xref="S3.E1.m1.2.2.2.3.cmml"><mi id="S3.E1.m1.1.1.1.1" xref="S3.E1.m1.1.1.1.1.cmml">q</mi><mo id="S3.E1.m1.2.2.2.2.2" xref="S3.E1.m1.2.2.2.3.cmml">,</mo><mrow id="S3.E1.m1.2.2.2.2.1.1" xref="S3.E1.m1.2.2.2.2.1.2.cmml"><mo id="S3.E1.m1.2.2.2.2.1.1.2" stretchy="false" xref="S3.E1.m1.2.2.2.2.1.2.cmml">{</mo><msub id="S3.E1.m1.2.2.2.2.1.1.1" xref="S3.E1.m1.2.2.2.2.1.1.1.cmml"><mi id="S3.E1.m1.2.2.2.2.1.1.1.2" xref="S3.E1.m1.2.2.2.2.1.1.1.2.cmml">𝐨</mi><mi id="S3.E1.m1.2.2.2.2.1.1.1.3" xref="S3.E1.m1.2.2.2.2.1.1.1.3.cmml">i</mi></msub><mo id="S3.E1.m1.2.2.2.2.1.1.3" stretchy="false" xref="S3.E1.m1.2.2.2.2.1.2.cmml">}</mo></mrow></mrow></msub><mo id="S3.E1.m1.20.20.1.1.1.2" xref="S3.E1.m1.20.20.1.1.1.2.cmml">⁢</mo><mrow id="S3.E1.m1.20.20.1.1.1.1.1" xref="S3.E1.m1.20.20.1.1.1.1.2.cmml"><mo id="S3.E1.m1.20.20.1.1.1.1.1.2" xref="S3.E1.m1.20.20.1.1.1.1.2.1.cmml">[</mo><mrow id="S3.E1.m1.20.20.1.1.1.1.1.1" xref="S3.E1.m1.20.20.1.1.1.1.1.1.cmml"><mfrac id="S3.E1.m1.20.20.1.1.1.1.1.1.3" xref="S3.E1.m1.20.20.1.1.1.1.1.1.3.cmml"><mn id="S3.E1.m1.20.20.1.1.1.1.1.1.3.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.3.2.cmml">1</mn><mi id="S3.E1.m1.20.20.1.1.1.1.1.1.3.3" xref="S3.E1.m1.20.20.1.1.1.1.1.1.3.3.cmml">G</mi></mfrac><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.2.cmml">⁢</mo><mrow id="S3.E1.m1.20.20.1.1.1.1.1.1.1" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.cmml"><munderover id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.cmml"><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.2" movablelimits="false" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.2.cmml">∑</mo><mrow id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.3" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.3.cmml"><mi id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.3.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.3.2.cmml">i</mi><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.3.1" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.3.1.cmml">=</mo><mn id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.3.3" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.3.3.cmml">1</mn></mrow><mi id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.3" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.3.cmml">G</mi></munderover><mrow id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.cmml"><mfrac id="S3.E1.m1.3.3" xref="S3.E1.m1.3.3.cmml"><mn id="S3.E1.m1.3.3.3" xref="S3.E1.m1.3.3.3.cmml">1</mn><mrow id="S3.E1.m1.3.3.1.1" xref="S3.E1.m1.3.3.1.2.cmml"><mo id="S3.E1.m1.3.3.1.1.2" stretchy="false" xref="S3.E1.m1.3.3.1.2.1.cmml">|</mo><msub id="S3.E1.m1.3.3.1.1.1" xref="S3.E1.m1.3.3.1.1.1.cmml"><mi id="S3.E1.m1.3.3.1.1.1.2" xref="S3.E1.m1.3.3.1.1.1.2.cmml">𝐨</mi><mi id="S3.E1.m1.3.3.1.1.1.3" xref="S3.E1.m1.3.3.1.1.1.3.cmml">i</mi></msub><mo id="S3.E1.m1.3.3.1.1.3" stretchy="false" xref="S3.E1.m1.3.3.1.2.1.cmml">|</mo></mrow></mfrac><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.2.cmml">⁢</mo><mrow id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.cmml"><munderover id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.cmml"><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.2" movablelimits="false" rspace="0em" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.2.cmml">∑</mo><mrow id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.3" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.3.cmml"><mi id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.3.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.3.2.cmml">t</mi><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.3.1" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.3.1.cmml">=</mo><mn id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.3.3" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.3.3.cmml">1</mn></mrow><mrow id="S3.E1.m1.4.4.1.1" xref="S3.E1.m1.4.4.1.2.cmml"><mo id="S3.E1.m1.4.4.1.1.2" stretchy="false" xref="S3.E1.m1.4.4.1.2.1.cmml">|</mo><msub id="S3.E1.m1.4.4.1.1.1" xref="S3.E1.m1.4.4.1.1.1.cmml"><mi id="S3.E1.m1.4.4.1.1.1.2" xref="S3.E1.m1.4.4.1.1.1.2.cmml">𝐨</mi><mi id="S3.E1.m1.4.4.1.1.1.3" xref="S3.E1.m1.4.4.1.1.1.3.cmml">i</mi></msub><mo id="S3.E1.m1.4.4.1.1.3" stretchy="false" xref="S3.E1.m1.4.4.1.2.1.cmml">|</mo></mrow></munderover><mrow id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.cmml"><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.cmml">(</mo><mrow id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.cmml"><mrow id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.cmml"><mfrac id="S3.E1.m1.16.16" xref="S3.E1.m1.16.16.cmml"><mrow id="S3.E1.m1.10.10.6" xref="S3.E1.m1.10.10.6.cmml"><msub id="S3.E1.m1.10.10.6.8" xref="S3.E1.m1.10.10.6.8.cmml"><mi id="S3.E1.m1.10.10.6.8.2" xref="S3.E1.m1.10.10.6.8.2.cmml">π</mi><mi id="S3.E1.m1.10.10.6.8.3" xref="S3.E1.m1.10.10.6.8.3.cmml">θ</mi></msub><mo id="S3.E1.m1.10.10.6.7" xref="S3.E1.m1.10.10.6.7.cmml">⁢</mo><mrow id="S3.E1.m1.10.10.6.6.1" xref="S3.E1.m1.10.10.6.6.1.1.cmml"><mo id="S3.E1.m1.10.10.6.6.1.2" stretchy="false" xref="S3.E1.m1.10.10.6.6.1.1.cmml">(</mo><mrow id="S3.E1.m1.10.10.6.6.1.1" xref="S3.E1.m1.10.10.6.6.1.1.cmml"><msub id="S3.E1.m1.10.10.6.6.1.1.3" xref="S3.E1.m1.10.10.6.6.1.1.3.cmml"><mi id="S3.E1.m1.10.10.6.6.1.1.3.2" xref="S3.E1.m1.10.10.6.6.1.1.3.2.cmml">𝐨</mi><mrow id="S3.E1.m1.6.6.2.2.2.4" xref="S3.E1.m1.6.6.2.2.2.3.cmml"><mi id="S3.E1.m1.5.5.1.1.1.1" xref="S3.E1.m1.5.5.1.1.1.1.cmml">i</mi><mo id="S3.E1.m1.6.6.2.2.2.4.1" xref="S3.E1.m1.6.6.2.2.2.3.cmml">,</mo><mi id="S3.E1.m1.6.6.2.2.2.2" xref="S3.E1.m1.6.6.2.2.2.2.cmml">t</mi></mrow></msub><mo fence="false" id="S3.E1.m1.10.10.6.6.1.1.2" xref="S3.E1.m1.10.10.6.6.1.1.2.cmml">|</mo><mrow id="S3.E1.m1.10.10.6.6.1.1.1.1" xref="S3.E1.m1.10.10.6.6.1.1.1.2.cmml"><msub id="S3.E1.m1.10.10.6.6.1.1.1.1.1" xref="S3.E1.m1.10.10.6.6.1.1.1.1.1.cmml"><mi id="S3.E1.m1.10.10.6.6.1.1.1.1.1.2" xref="S3.E1.m1.10.10.6.6.1.1.1.1.1.2.cmml">𝐨</mi><mrow id="S3.E1.m1.8.8.4.4.2.2" xref="S3.E1.m1.8.8.4.4.2.3.cmml"><mi id="S3.E1.m1.7.7.3.3.1.1" xref="S3.E1.m1.7.7.3.3.1.1.cmml">i</mi><mo id="S3.E1.m1.8.8.4.4.2.2.2" xref="S3.E1.m1.8.8.4.4.2.3.cmml">,</mo><mrow id="S3.E1.m1.8.8.4.4.2.2.1" xref="S3.E1.m1.8.8.4.4.2.2.1.cmml"><mi id="S3.E1.m1.8.8.4.4.2.2.1.2" xref="S3.E1.m1.8.8.4.4.2.2.1.2.cmml"></mi><mo id="S3.E1.m1.8.8.4.4.2.2.1.1" xref="S3.E1.m1.8.8.4.4.2.2.1.1.cmml">&lt;</mo><mi id="S3.E1.m1.8.8.4.4.2.2.1.3" xref="S3.E1.m1.8.8.4.4.2.2.1.3.cmml">t</mi></mrow></mrow></msub><mo id="S3.E1.m1.10.10.6.6.1.1.1.1.2" xref="S3.E1.m1.10.10.6.6.1.1.1.2.cmml">,</mo><mi id="S3.E1.m1.9.9.5.5" xref="S3.E1.m1.9.9.5.5.cmml">q</mi></mrow></mrow><mo id="S3.E1.m1.10.10.6.6.1.3" stretchy="false" xref="S3.E1.m1.10.10.6.6.1.1.cmml">)</mo></mrow></mrow><mrow id="S3.E1.m1.16.16.12" xref="S3.E1.m1.16.16.12.cmml"><msub id="S3.E1.m1.16.16.12.8" xref="S3.E1.m1.16.16.12.8.cmml"><mi id="S3.E1.m1.16.16.12.8.2" xref="S3.E1.m1.16.16.12.8.2.cmml">π</mi><msub id="S3.E1.m1.16.16.12.8.3" xref="S3.E1.m1.16.16.12.8.3.cmml"><mi id="S3.E1.m1.16.16.12.8.3.2" xref="S3.E1.m1.16.16.12.8.3.2.cmml">θ</mi><mrow id="S3.E1.m1.16.16.12.8.3.3" xref="S3.E1.m1.16.16.12.8.3.3.cmml"><mi id="S3.E1.m1.16.16.12.8.3.3.2" xref="S3.E1.m1.16.16.12.8.3.3.2.cmml">o</mi><mo id="S3.E1.m1.16.16.12.8.3.3.1" xref="S3.E1.m1.16.16.12.8.3.3.1.cmml">⁢</mo><mi id="S3.E1.m1.16.16.12.8.3.3.3" xref="S3.E1.m1.16.16.12.8.3.3.3.cmml">l</mi><mo id="S3.E1.m1.16.16.12.8.3.3.1a" xref="S3.E1.m1.16.16.12.8.3.3.1.cmml">⁢</mo><mi id="S3.E1.m1.16.16.12.8.3.3.4" xref="S3.E1.m1.16.16.12.8.3.3.4.cmml">d</mi></mrow></msub></msub><mo id="S3.E1.m1.16.16.12.7" xref="S3.E1.m1.16.16.12.7.cmml">⁢</mo><mrow id="S3.E1.m1.16.16.12.6.1" xref="S3.E1.m1.16.16.12.6.1.1.cmml"><mo id="S3.E1.m1.16.16.12.6.1.2" stretchy="false" xref="S3.E1.m1.16.16.12.6.1.1.cmml">(</mo><mrow id="S3.E1.m1.16.16.12.6.1.1" xref="S3.E1.m1.16.16.12.6.1.1.cmml"><msub id="S3.E1.m1.16.16.12.6.1.1.3" xref="S3.E1.m1.16.16.12.6.1.1.3.cmml"><mi id="S3.E1.m1.16.16.12.6.1.1.3.2" xref="S3.E1.m1.16.16.12.6.1.1.3.2.cmml">𝐨</mi><mrow id="S3.E1.m1.12.12.8.2.2.4" xref="S3.E1.m1.12.12.8.2.2.3.cmml"><mi id="S3.E1.m1.11.11.7.1.1.1" xref="S3.E1.m1.11.11.7.1.1.1.cmml">i</mi><mo id="S3.E1.m1.12.12.8.2.2.4.1" xref="S3.E1.m1.12.12.8.2.2.3.cmml">,</mo><mi id="S3.E1.m1.12.12.8.2.2.2" xref="S3.E1.m1.12.12.8.2.2.2.cmml">t</mi></mrow></msub><mo fence="false" id="S3.E1.m1.16.16.12.6.1.1.2" xref="S3.E1.m1.16.16.12.6.1.1.2.cmml">|</mo><mrow id="S3.E1.m1.16.16.12.6.1.1.1.1" xref="S3.E1.m1.16.16.12.6.1.1.1.2.cmml"><msub id="S3.E1.m1.16.16.12.6.1.1.1.1.1" xref="S3.E1.m1.16.16.12.6.1.1.1.1.1.cmml"><mi id="S3.E1.m1.16.16.12.6.1.1.1.1.1.2" xref="S3.E1.m1.16.16.12.6.1.1.1.1.1.2.cmml">𝐨</mi><mrow id="S3.E1.m1.14.14.10.4.2.2" xref="S3.E1.m1.14.14.10.4.2.3.cmml"><mi id="S3.E1.m1.13.13.9.3.1.1" xref="S3.E1.m1.13.13.9.3.1.1.cmml">i</mi><mo id="S3.E1.m1.14.14.10.4.2.2.2" xref="S3.E1.m1.14.14.10.4.2.3.cmml">,</mo><mrow id="S3.E1.m1.14.14.10.4.2.2.1" xref="S3.E1.m1.14.14.10.4.2.2.1.cmml"><mi id="S3.E1.m1.14.14.10.4.2.2.1.2" xref="S3.E1.m1.14.14.10.4.2.2.1.2.cmml"></mi><mo id="S3.E1.m1.14.14.10.4.2.2.1.1" xref="S3.E1.m1.14.14.10.4.2.2.1.1.cmml">&lt;</mo><mi id="S3.E1.m1.14.14.10.4.2.2.1.3" xref="S3.E1.m1.14.14.10.4.2.2.1.3.cmml">t</mi></mrow></mrow></msub><mo id="S3.E1.m1.16.16.12.6.1.1.1.1.2" xref="S3.E1.m1.16.16.12.6.1.1.1.2.cmml">,</mo><mi id="S3.E1.m1.15.15.11.5" xref="S3.E1.m1.15.15.11.5.cmml">q</mi></mrow></mrow><mo id="S3.E1.m1.16.16.12.6.1.3" stretchy="false" xref="S3.E1.m1.16.16.12.6.1.1.cmml">)</mo></mrow></mrow></mfrac><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.1" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.1.cmml">⁢</mo><msub id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2.cmml"><mover accent="true" id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2.2.cmml"><mi id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2.2.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2.2.2.cmml">A</mi><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2.2.1" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2.2.1.cmml">^</mo></mover><mrow id="S3.E1.m1.18.18.2.4" xref="S3.E1.m1.18.18.2.3.cmml"><mi id="S3.E1.m1.17.17.1.1" xref="S3.E1.m1.17.17.1.1.cmml">i</mi><mo id="S3.E1.m1.18.18.2.4.1" xref="S3.E1.m1.18.18.2.3.cmml">,</mo><mi id="S3.E1.m1.18.18.2.2" xref="S3.E1.m1.18.18.2.2.cmml">t</mi></mrow></msub></mrow><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.2.cmml">−</mo><mrow id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.cmml"><mi id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.3" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.3.cmml">β</mi><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.2.cmml">⁢</mo><msub id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.cmml"><mi id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.2.cmml">D</mi><mrow id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.3" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.3.cmml"><mi id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.3.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.3.2.cmml">K</mi><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.3.1" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.3.1.cmml">⁢</mo><mi id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.3.3" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.3.3.cmml">L</mi></mrow></msub><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.2a" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.2.cmml">⁢</mo><mrow id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2.cmml"><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2" stretchy="false" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2.1.cmml">[</mo><mrow id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.cmml"><msub id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2.cmml"><mi id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2.2.cmml">π</mi><mi id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2.3" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2.3.cmml">θ</mi></msub><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.cmml">∥</mo><msub id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.cmml"><mi id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.2.cmml">π</mi><mrow id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.cmml"><mi id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.2" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.2.cmml">r</mi><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.1" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.1.cmml">⁢</mo><mi id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.3" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.3.cmml">e</mi><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.1a" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.1.cmml">⁢</mo><mi id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.4" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.4.cmml">f</mi></mrow></msub></mrow><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3" stretchy="false" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2.1.cmml">]</mo></mrow></mrow></mrow><mo id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.3" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.cmml">)</mo></mrow></mrow></mrow></mrow></mrow><mo id="S3.E1.m1.20.20.1.1.1.1.1.3" xref="S3.E1.m1.20.20.1.1.1.1.2.1.cmml">]</mo></mrow></mrow></mrow><mo id="S3.E1.m1.20.20.1.2" xref="S3.E1.m1.20.20.1.1.cmml">,</mo></mrow><annotation-xml encoding="MathML-Content" id="S3.E1.m1.20b"><apply id="S3.E1.m1.20.20.1.1.cmml" xref="S3.E1.m1.20.20.1"><eq id="S3.E1.m1.20.20.1.1.2.cmml" xref="S3.E1.m1.20.20.1.1.2"></eq><apply id="S3.E1.m1.20.20.1.1.3.cmml" xref="S3.E1.m1.20.20.1.1.3"><times id="S3.E1.m1.20.20.1.1.3.1.cmml" xref="S3.E1.m1.20.20.1.1.3.1"></times><apply id="S3.E1.m1.20.20.1.1.3.2.cmml" xref="S3.E1.m1.20.20.1.1.3.2"><csymbol cd="ambiguous" id="S3.E1.m1.20.20.1.1.3.2.1.cmml" xref="S3.E1.m1.20.20.1.1.3.2">subscript</csymbol><ci id="S3.E1.m1.20.20.1.1.3.2.2.cmml" xref="S3.E1.m1.20.20.1.1.3.2.2">𝒥</ci><apply id="S3.E1.m1.20.20.1.1.3.2.3.cmml" xref="S3.E1.m1.20.20.1.1.3.2.3"><times id="S3.E1.m1.20.20.1.1.3.2.3.1.cmml" xref="S3.E1.m1.20.20.1.1.3.2.3.1"></times><ci id="S3.E1.m1.20.20.1.1.3.2.3.2.cmml" xref="S3.E1.m1.20.20.1.1.3.2.3.2">𝐺</ci><ci id="S3.E1.m1.20.20.1.1.3.2.3.3.cmml" xref="S3.E1.m1.20.20.1.1.3.2.3.3">𝑅</ci><ci id="S3.E1.m1.20.20.1.1.3.2.3.4.cmml" xref="S3.E1.m1.20.20.1.1.3.2.3.4">𝑃</ci><ci id="S3.E1.m1.20.20.1.1.3.2.3.5.cmml" xref="S3.E1.m1.20.20.1.1.3.2.3.5">𝑂</ci></apply></apply><ci id="S3.E1.m1.19.19.cmml" xref="S3.E1.m1.19.19">𝜃</ci></apply><apply id="S3.E1.m1.20.20.1.1.1.cmml" xref="S3.E1.m1.20.20.1.1.1"><times id="S3.E1.m1.20.20.1.1.1.2.cmml" xref="S3.E1.m1.20.20.1.1.1.2"></times><apply id="S3.E1.m1.20.20.1.1.1.3.cmml" xref="S3.E1.m1.20.20.1.1.1.3"><csymbol cd="ambiguous" id="S3.E1.m1.20.20.1.1.1.3.1.cmml" xref="S3.E1.m1.20.20.1.1.1.3">subscript</csymbol><ci id="S3.E1.m1.20.20.1.1.1.3.2.cmml" xref="S3.E1.m1.20.20.1.1.1.3.2">𝔼</ci><list id="S3.E1.m1.2.2.2.3.cmml" xref="S3.E1.m1.2.2.2.2"><ci id="S3.E1.m1.1.1.1.1.cmml" xref="S3.E1.m1.1.1.1.1">𝑞</ci><set id="S3.E1.m1.2.2.2.2.1.2.cmml" xref="S3.E1.m1.2.2.2.2.1.1"><apply id="S3.E1.m1.2.2.2.2.1.1.1.cmml" xref="S3.E1.m1.2.2.2.2.1.1.1"><csymbol cd="ambiguous" id="S3.E1.m1.2.2.2.2.1.1.1.1.cmml" xref="S3.E1.m1.2.2.2.2.1.1.1">subscript</csymbol><ci id="S3.E1.m1.2.2.2.2.1.1.1.2.cmml" xref="S3.E1.m1.2.2.2.2.1.1.1.2">𝐨</ci><ci id="S3.E1.m1.2.2.2.2.1.1.1.3.cmml" xref="S3.E1.m1.2.2.2.2.1.1.1.3">𝑖</ci></apply></set></list></apply><apply id="S3.E1.m1.20.20.1.1.1.1.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1"><csymbol cd="latexml" id="S3.E1.m1.20.20.1.1.1.1.2.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.2">delimited-[]</csymbol><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1"><times id="S3.E1.m1.20.20.1.1.1.1.1.1.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.2"></times><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.3.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.3"><divide id="S3.E1.m1.20.20.1.1.1.1.1.1.3.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.3"></divide><cn id="S3.E1.m1.20.20.1.1.1.1.1.1.3.2.cmml" type="integer" xref="S3.E1.m1.20.20.1.1.1.1.1.1.3.2">1</cn><ci id="S3.E1.m1.20.20.1.1.1.1.1.1.3.3.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.3.3">𝐺</ci></apply><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1"><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2">superscript</csymbol><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2">subscript</csymbol><sum id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.2"></sum><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.3.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.3"><eq id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.3.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.3.1"></eq><ci id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.3.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.3.2">𝑖</ci><cn id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.3.3.cmml" type="integer" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.2.3.3">1</cn></apply></apply><ci id="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.3.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.2.3">𝐺</ci></apply><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1"><times id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.2"></times><apply id="S3.E1.m1.3.3.cmml" xref="S3.E1.m1.3.3"><divide id="S3.E1.m1.3.3.2.cmml" xref="S3.E1.m1.3.3"></divide><cn id="S3.E1.m1.3.3.3.cmml" type="integer" xref="S3.E1.m1.3.3.3">1</cn><apply id="S3.E1.m1.3.3.1.2.cmml" xref="S3.E1.m1.3.3.1.1"><abs id="S3.E1.m1.3.3.1.2.1.cmml" xref="S3.E1.m1.3.3.1.1.2"></abs><apply id="S3.E1.m1.3.3.1.1.1.cmml" xref="S3.E1.m1.3.3.1.1.1"><csymbol cd="ambiguous" id="S3.E1.m1.3.3.1.1.1.1.cmml" xref="S3.E1.m1.3.3.1.1.1">subscript</csymbol><ci id="S3.E1.m1.3.3.1.1.1.2.cmml" xref="S3.E1.m1.3.3.1.1.1.2">𝐨</ci><ci id="S3.E1.m1.3.3.1.1.1.3.cmml" xref="S3.E1.m1.3.3.1.1.1.3">𝑖</ci></apply></apply></apply><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1"><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2">superscript</csymbol><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2">subscript</csymbol><sum id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.2"></sum><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.3.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.3"><eq id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.3.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.3.1"></eq><ci id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.3.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.3.2">𝑡</ci><cn id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.3.3.cmml" type="integer" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.2.2.3.3">1</cn></apply></apply><apply id="S3.E1.m1.4.4.1.2.cmml" xref="S3.E1.m1.4.4.1.1"><abs id="S3.E1.m1.4.4.1.2.1.cmml" xref="S3.E1.m1.4.4.1.1.2"></abs><apply id="S3.E1.m1.4.4.1.1.1.cmml" xref="S3.E1.m1.4.4.1.1.1"><csymbol cd="ambiguous" id="S3.E1.m1.4.4.1.1.1.1.cmml" xref="S3.E1.m1.4.4.1.1.1">subscript</csymbol><ci id="S3.E1.m1.4.4.1.1.1.2.cmml" xref="S3.E1.m1.4.4.1.1.1.2">𝐨</ci><ci id="S3.E1.m1.4.4.1.1.1.3.cmml" xref="S3.E1.m1.4.4.1.1.1.3">𝑖</ci></apply></apply></apply><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1"><minus id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.2"></minus><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3"><times id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.1"></times><apply id="S3.E1.m1.16.16.cmml" xref="S3.E1.m1.16.16"><divide id="S3.E1.m1.16.16.13.cmml" xref="S3.E1.m1.16.16"></divide><apply id="S3.E1.m1.10.10.6.cmml" xref="S3.E1.m1.10.10.6"><times id="S3.E1.m1.10.10.6.7.cmml" xref="S3.E1.m1.10.10.6.7"></times><apply id="S3.E1.m1.10.10.6.8.cmml" xref="S3.E1.m1.10.10.6.8"><csymbol cd="ambiguous" id="S3.E1.m1.10.10.6.8.1.cmml" xref="S3.E1.m1.10.10.6.8">subscript</csymbol><ci id="S3.E1.m1.10.10.6.8.2.cmml" xref="S3.E1.m1.10.10.6.8.2">𝜋</ci><ci id="S3.E1.m1.10.10.6.8.3.cmml" xref="S3.E1.m1.10.10.6.8.3">𝜃</ci></apply><apply id="S3.E1.m1.10.10.6.6.1.1.cmml" xref="S3.E1.m1.10.10.6.6.1"><csymbol cd="latexml" id="S3.E1.m1.10.10.6.6.1.1.2.cmml" xref="S3.E1.m1.10.10.6.6.1.1.2">conditional</csymbol><apply id="S3.E1.m1.10.10.6.6.1.1.3.cmml" xref="S3.E1.m1.10.10.6.6.1.1.3"><csymbol cd="ambiguous" id="S3.E1.m1.10.10.6.6.1.1.3.1.cmml" xref="S3.E1.m1.10.10.6.6.1.1.3">subscript</csymbol><ci id="S3.E1.m1.10.10.6.6.1.1.3.2.cmml" xref="S3.E1.m1.10.10.6.6.1.1.3.2">𝐨</ci><list id="S3.E1.m1.6.6.2.2.2.3.cmml" xref="S3.E1.m1.6.6.2.2.2.4"><ci id="S3.E1.m1.5.5.1.1.1.1.cmml" xref="S3.E1.m1.5.5.1.1.1.1">𝑖</ci><ci id="S3.E1.m1.6.6.2.2.2.2.cmml" xref="S3.E1.m1.6.6.2.2.2.2">𝑡</ci></list></apply><list id="S3.E1.m1.10.10.6.6.1.1.1.2.cmml" xref="S3.E1.m1.10.10.6.6.1.1.1.1"><apply id="S3.E1.m1.10.10.6.6.1.1.1.1.1.cmml" xref="S3.E1.m1.10.10.6.6.1.1.1.1.1"><csymbol cd="ambiguous" id="S3.E1.m1.10.10.6.6.1.1.1.1.1.1.cmml" xref="S3.E1.m1.10.10.6.6.1.1.1.1.1">subscript</csymbol><ci id="S3.E1.m1.10.10.6.6.1.1.1.1.1.2.cmml" xref="S3.E1.m1.10.10.6.6.1.1.1.1.1.2">𝐨</ci><list id="S3.E1.m1.8.8.4.4.2.3.cmml" xref="S3.E1.m1.8.8.4.4.2.2"><ci id="S3.E1.m1.7.7.3.3.1.1.cmml" xref="S3.E1.m1.7.7.3.3.1.1">𝑖</ci><apply id="S3.E1.m1.8.8.4.4.2.2.1.cmml" xref="S3.E1.m1.8.8.4.4.2.2.1"><lt id="S3.E1.m1.8.8.4.4.2.2.1.1.cmml" xref="S3.E1.m1.8.8.4.4.2.2.1.1"></lt><csymbol cd="latexml" id="S3.E1.m1.8.8.4.4.2.2.1.2.cmml" xref="S3.E1.m1.8.8.4.4.2.2.1.2">absent</csymbol><ci id="S3.E1.m1.8.8.4.4.2.2.1.3.cmml" xref="S3.E1.m1.8.8.4.4.2.2.1.3">𝑡</ci></apply></list></apply><ci id="S3.E1.m1.9.9.5.5.cmml" xref="S3.E1.m1.9.9.5.5">𝑞</ci></list></apply></apply><apply id="S3.E1.m1.16.16.12.cmml" xref="S3.E1.m1.16.16.12"><times id="S3.E1.m1.16.16.12.7.cmml" xref="S3.E1.m1.16.16.12.7"></times><apply id="S3.E1.m1.16.16.12.8.cmml" xref="S3.E1.m1.16.16.12.8"><csymbol cd="ambiguous" id="S3.E1.m1.16.16.12.8.1.cmml" xref="S3.E1.m1.16.16.12.8">subscript</csymbol><ci id="S3.E1.m1.16.16.12.8.2.cmml" xref="S3.E1.m1.16.16.12.8.2">𝜋</ci><apply id="S3.E1.m1.16.16.12.8.3.cmml" xref="S3.E1.m1.16.16.12.8.3"><csymbol cd="ambiguous" id="S3.E1.m1.16.16.12.8.3.1.cmml" xref="S3.E1.m1.16.16.12.8.3">subscript</csymbol><ci id="S3.E1.m1.16.16.12.8.3.2.cmml" xref="S3.E1.m1.16.16.12.8.3.2">𝜃</ci><apply id="S3.E1.m1.16.16.12.8.3.3.cmml" xref="S3.E1.m1.16.16.12.8.3.3"><times id="S3.E1.m1.16.16.12.8.3.3.1.cmml" xref="S3.E1.m1.16.16.12.8.3.3.1"></times><ci id="S3.E1.m1.16.16.12.8.3.3.2.cmml" xref="S3.E1.m1.16.16.12.8.3.3.2">𝑜</ci><ci id="S3.E1.m1.16.16.12.8.3.3.3.cmml" xref="S3.E1.m1.16.16.12.8.3.3.3">𝑙</ci><ci id="S3.E1.m1.16.16.12.8.3.3.4.cmml" xref="S3.E1.m1.16.16.12.8.3.3.4">𝑑</ci></apply></apply></apply><apply id="S3.E1.m1.16.16.12.6.1.1.cmml" xref="S3.E1.m1.16.16.12.6.1"><csymbol cd="latexml" id="S3.E1.m1.16.16.12.6.1.1.2.cmml" xref="S3.E1.m1.16.16.12.6.1.1.2">conditional</csymbol><apply id="S3.E1.m1.16.16.12.6.1.1.3.cmml" xref="S3.E1.m1.16.16.12.6.1.1.3"><csymbol cd="ambiguous" id="S3.E1.m1.16.16.12.6.1.1.3.1.cmml" xref="S3.E1.m1.16.16.12.6.1.1.3">subscript</csymbol><ci id="S3.E1.m1.16.16.12.6.1.1.3.2.cmml" xref="S3.E1.m1.16.16.12.6.1.1.3.2">𝐨</ci><list id="S3.E1.m1.12.12.8.2.2.3.cmml" xref="S3.E1.m1.12.12.8.2.2.4"><ci id="S3.E1.m1.11.11.7.1.1.1.cmml" xref="S3.E1.m1.11.11.7.1.1.1">𝑖</ci><ci id="S3.E1.m1.12.12.8.2.2.2.cmml" xref="S3.E1.m1.12.12.8.2.2.2">𝑡</ci></list></apply><list id="S3.E1.m1.16.16.12.6.1.1.1.2.cmml" xref="S3.E1.m1.16.16.12.6.1.1.1.1"><apply id="S3.E1.m1.16.16.12.6.1.1.1.1.1.cmml" xref="S3.E1.m1.16.16.12.6.1.1.1.1.1"><csymbol cd="ambiguous" id="S3.E1.m1.16.16.12.6.1.1.1.1.1.1.cmml" xref="S3.E1.m1.16.16.12.6.1.1.1.1.1">subscript</csymbol><ci id="S3.E1.m1.16.16.12.6.1.1.1.1.1.2.cmml" xref="S3.E1.m1.16.16.12.6.1.1.1.1.1.2">𝐨</ci><list id="S3.E1.m1.14.14.10.4.2.3.cmml" xref="S3.E1.m1.14.14.10.4.2.2"><ci id="S3.E1.m1.13.13.9.3.1.1.cmml" xref="S3.E1.m1.13.13.9.3.1.1">𝑖</ci><apply id="S3.E1.m1.14.14.10.4.2.2.1.cmml" xref="S3.E1.m1.14.14.10.4.2.2.1"><lt id="S3.E1.m1.14.14.10.4.2.2.1.1.cmml" xref="S3.E1.m1.14.14.10.4.2.2.1.1"></lt><csymbol cd="latexml" id="S3.E1.m1.14.14.10.4.2.2.1.2.cmml" xref="S3.E1.m1.14.14.10.4.2.2.1.2">absent</csymbol><ci id="S3.E1.m1.14.14.10.4.2.2.1.3.cmml" xref="S3.E1.m1.14.14.10.4.2.2.1.3">𝑡</ci></apply></list></apply><ci id="S3.E1.m1.15.15.11.5.cmml" xref="S3.E1.m1.15.15.11.5">𝑞</ci></list></apply></apply></apply><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2"><csymbol cd="ambiguous" id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2">subscript</csymbol><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2.2"><ci id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2.2.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2.2.1">^</ci><ci id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2.2.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.3.2.2.2">𝐴</ci></apply><list id="S3.E1.m1.18.18.2.3.cmml" xref="S3.E1.m1.18.18.2.4"><ci id="S3.E1.m1.17.17.1.1.cmml" xref="S3.E1.m1.17.17.1.1">𝑖</ci><ci id="S3.E1.m1.18.18.2.2.cmml" xref="S3.E1.m1.18.18.2.2">𝑡</ci></list></apply></apply><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1"><times id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.2"></times><ci id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.3.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.3">𝛽</ci><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4"><csymbol cd="ambiguous" id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4">subscript</csymbol><ci id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.2">𝐷</ci><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.3.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.3"><times id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.3.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.3.1"></times><ci id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.3.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.3.2">𝐾</ci><ci id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.3.3.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.4.3.3">𝐿</ci></apply></apply><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1"><csymbol cd="latexml" id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2">delimited-[]</csymbol><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1"><csymbol cd="latexml" id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1">conditional</csymbol><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2">subscript</csymbol><ci id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2.2">𝜋</ci><ci id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2.3.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2.3">𝜃</ci></apply><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3"><csymbol cd="ambiguous" id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3">subscript</csymbol><ci id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.2">𝜋</ci><apply id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3"><times id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.1.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.1"></times><ci id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.2.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.2">𝑟</ci><ci id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.3.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.3">𝑒</ci><ci id="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.4.cmml" xref="S3.E1.m1.20.20.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.3.4">𝑓</ci></apply></apply></apply></apply></apply></apply></apply></apply></apply></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.E1.m1.20c">\mathcal{J}_{GRPO}(\theta)=\mathbb{E}_{q,\{\mathbf{o}_{i}\}}\left[\frac{1}{G}%
\sum_{i=1}^{G}\frac{1}{|\mathbf{o}_{i}|}\sum_{t=1}^{|\mathbf{o}_{i}|}\left(%
\frac{\pi_{\theta}(\mathbf{o}_{i,t}|\mathbf{o}_{i,&lt;t},q)}{\pi_{\theta_{old}}(%
\mathbf{o}_{i,t}|\mathbf{o}_{i,&lt;t},q)}\hat{A}_{i,t}-\beta D_{KL}[\pi_{\theta}%
\|\pi_{ref}]\right)\right],</annotation><annotation encoding="application/x-llamapun" id="S3.E1.m1.20d">caligraphic_J start_POSTSUBSCRIPT italic_G italic_R italic_P italic_O end_POSTSUBSCRIPT ( italic_θ ) = blackboard_E start_POSTSUBSCRIPT italic_q , { bold_o start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT } end_POSTSUBSCRIPT [ divide start_ARG 1 end_ARG start_ARG italic_G end_ARG ∑ start_POSTSUBSCRIPT italic_i = 1 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_G end_POSTSUPERSCRIPT divide start_ARG 1 end_ARG start_ARG | bold_o start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT | end_ARG ∑ start_POSTSUBSCRIPT italic_t = 1 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT | bold_o start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT | end_POSTSUPERSCRIPT ( divide start_ARG italic_π start_POSTSUBSCRIPT italic_θ end_POSTSUBSCRIPT ( bold_o start_POSTSUBSCRIPT italic_i , italic_t end_POSTSUBSCRIPT | bold_o start_POSTSUBSCRIPT italic_i , &lt; italic_t end_POSTSUBSCRIPT , italic_q ) end_ARG start_ARG italic_π start_POSTSUBSCRIPT italic_θ start_POSTSUBSCRIPT italic_o italic_l italic_d end_POSTSUBSCRIPT end_POSTSUBSCRIPT ( bold_o start_POSTSUBSCRIPT italic_i , italic_t end_POSTSUBSCRIPT | bold_o start_POSTSUBSCRIPT italic_i , &lt; italic_t end_POSTSUBSCRIPT , italic_q ) end_ARG over^ start_ARG italic_A end_ARG start_POSTSUBSCRIPT italic_i , italic_t end_POSTSUBSCRIPT - italic_β italic_D start_POSTSUBSCRIPT italic_K italic_L end_POSTSUBSCRIPT [ italic_π start_POSTSUBSCRIPT italic_θ end_POSTSUBSCRIPT ∥ italic_π start_POSTSUBSCRIPT italic_r italic_e italic_f end_POSTSUBSCRIPT ] ) ] ,</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(1)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S3.SS2.p2.2">where <math alttext="\beta" class="ltx_Math" display="inline" id="S3.SS2.p2.1.m1.1"><semantics id="S3.SS2.p2.1.m1.1a"><mi id="S3.SS2.p2.1.m1.1.1" xref="S3.SS2.p2.1.m1.1.1.cmml">β</mi><annotation-xml encoding="MathML-Content" id="S3.SS2.p2.1.m1.1b"><ci id="S3.SS2.p2.1.m1.1.1.cmml" xref="S3.SS2.p2.1.m1.1.1">𝛽</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p2.1.m1.1c">\beta</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p2.1.m1.1d">italic_β</annotation></semantics></math> controls the KL divergence regularization toward a reference policy <math alttext="\pi_{ref}" class="ltx_Math" display="inline" id="S3.SS2.p2.2.m2.1"><semantics id="S3.SS2.p2.2.m2.1a"><msub id="S3.SS2.p2.2.m2.1.1" xref="S3.SS2.p2.2.m2.1.1.cmml"><mi id="S3.SS2.p2.2.m2.1.1.2" xref="S3.SS2.p2.2.m2.1.1.2.cmml">π</mi><mrow id="S3.SS2.p2.2.m2.1.1.3" xref="S3.SS2.p2.2.m2.1.1.3.cmml"><mi id="S3.SS2.p2.2.m2.1.1.3.2" xref="S3.SS2.p2.2.m2.1.1.3.2.cmml">r</mi><mo id="S3.SS2.p2.2.m2.1.1.3.1" xref="S3.SS2.p2.2.m2.1.1.3.1.cmml">⁢</mo><mi id="S3.SS2.p2.2.m2.1.1.3.3" xref="S3.SS2.p2.2.m2.1.1.3.3.cmml">e</mi><mo id="S3.SS2.p2.2.m2.1.1.3.1a" xref="S3.SS2.p2.2.m2.1.1.3.1.cmml">⁢</mo><mi id="S3.SS2.p2.2.m2.1.1.3.4" xref="S3.SS2.p2.2.m2.1.1.3.4.cmml">f</mi></mrow></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p2.2.m2.1b"><apply id="S3.SS2.p2.2.m2.1.1.cmml" xref="S3.SS2.p2.2.m2.1.1"><csymbol cd="ambiguous" id="S3.SS2.p2.2.m2.1.1.1.cmml" xref="S3.SS2.p2.2.m2.1.1">subscript</csymbol><ci id="S3.SS2.p2.2.m2.1.1.2.cmml" xref="S3.SS2.p2.2.m2.1.1.2">𝜋</ci><apply id="S3.SS2.p2.2.m2.1.1.3.cmml" xref="S3.SS2.p2.2.m2.1.1.3"><times id="S3.SS2.p2.2.m2.1.1.3.1.cmml" xref="S3.SS2.p2.2.m2.1.1.3.1"></times><ci id="S3.SS2.p2.2.m2.1.1.3.2.cmml" xref="S3.SS2.p2.2.m2.1.1.3.2">𝑟</ci><ci id="S3.SS2.p2.2.m2.1.1.3.3.cmml" xref="S3.SS2.p2.2.m2.1.1.3.3">𝑒</ci><ci id="S3.SS2.p2.2.m2.1.1.3.4.cmml" xref="S3.SS2.p2.2.m2.1.1.3.4">𝑓</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p2.2.m2.1c">\pi_{ref}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p2.2.m2.1d">italic_π start_POSTSUBSCRIPT italic_r italic_e italic_f end_POSTSUBSCRIPT</annotation></semantics></math>.</p>
</div>
<div class="ltx_para" id="S3.SS2.p3">
<p class="ltx_p" id="S3.SS2.p3.1">The token-level advantage <math alttext="\hat{A}_{i,t}" class="ltx_Math" display="inline" id="S3.SS2.p3.1.m1.2"><semantics id="S3.SS2.p3.1.m1.2a"><msub id="S3.SS2.p3.1.m1.2.3" xref="S3.SS2.p3.1.m1.2.3.cmml"><mover accent="true" id="S3.SS2.p3.1.m1.2.3.2" xref="S3.SS2.p3.1.m1.2.3.2.cmml"><mi id="S3.SS2.p3.1.m1.2.3.2.2" xref="S3.SS2.p3.1.m1.2.3.2.2.cmml">A</mi><mo id="S3.SS2.p3.1.m1.2.3.2.1" xref="S3.SS2.p3.1.m1.2.3.2.1.cmml">^</mo></mover><mrow id="S3.SS2.p3.1.m1.2.2.2.4" xref="S3.SS2.p3.1.m1.2.2.2.3.cmml"><mi id="S3.SS2.p3.1.m1.1.1.1.1" xref="S3.SS2.p3.1.m1.1.1.1.1.cmml">i</mi><mo id="S3.SS2.p3.1.m1.2.2.2.4.1" xref="S3.SS2.p3.1.m1.2.2.2.3.cmml">,</mo><mi id="S3.SS2.p3.1.m1.2.2.2.2" xref="S3.SS2.p3.1.m1.2.2.2.2.cmml">t</mi></mrow></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.1.m1.2b"><apply id="S3.SS2.p3.1.m1.2.3.cmml" xref="S3.SS2.p3.1.m1.2.3"><csymbol cd="ambiguous" id="S3.SS2.p3.1.m1.2.3.1.cmml" xref="S3.SS2.p3.1.m1.2.3">subscript</csymbol><apply id="S3.SS2.p3.1.m1.2.3.2.cmml" xref="S3.SS2.p3.1.m1.2.3.2"><ci id="S3.SS2.p3.1.m1.2.3.2.1.cmml" xref="S3.SS2.p3.1.m1.2.3.2.1">^</ci><ci id="S3.SS2.p3.1.m1.2.3.2.2.cmml" xref="S3.SS2.p3.1.m1.2.3.2.2">𝐴</ci></apply><list id="S3.SS2.p3.1.m1.2.2.2.3.cmml" xref="S3.SS2.p3.1.m1.2.2.2.4"><ci id="S3.SS2.p3.1.m1.1.1.1.1.cmml" xref="S3.SS2.p3.1.m1.1.1.1.1">𝑖</ci><ci id="S3.SS2.p3.1.m1.2.2.2.2.cmml" xref="S3.SS2.p3.1.m1.2.2.2.2">𝑡</ci></list></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.1.m1.2c">\hat{A}_{i,t}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.1.m1.2d">over^ start_ARG italic_A end_ARG start_POSTSUBSCRIPT italic_i , italic_t end_POSTSUBSCRIPT</annotation></semantics></math> is uniformly derived from the normalized reward of the full response:</p>
<table class="ltx_equation ltx_eqn_table" id="S3.E2">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\hat{A}_{i,t}=\tilde{r}_{i}=\frac{r_{i}-\text{mean}(\mathbf{r})}{\text{std}(%
\mathbf{r})}," class="ltx_Math" display="block" id="S3.E2.m1.5"><semantics id="S3.E2.m1.5a"><mrow id="S3.E2.m1.5.5.1" xref="S3.E2.m1.5.5.1.1.cmml"><mrow id="S3.E2.m1.5.5.1.1" xref="S3.E2.m1.5.5.1.1.cmml"><msub id="S3.E2.m1.5.5.1.1.2" xref="S3.E2.m1.5.5.1.1.2.cmml"><mover accent="true" id="S3.E2.m1.5.5.1.1.2.2" xref="S3.E2.m1.5.5.1.1.2.2.cmml"><mi id="S3.E2.m1.5.5.1.1.2.2.2" xref="S3.E2.m1.5.5.1.1.2.2.2.cmml">A</mi><mo id="S3.E2.m1.5.5.1.1.2.2.1" xref="S3.E2.m1.5.5.1.1.2.2.1.cmml">^</mo></mover><mrow id="S3.E2.m1.2.2.2.4" xref="S3.E2.m1.2.2.2.3.cmml"><mi id="S3.E2.m1.1.1.1.1" xref="S3.E2.m1.1.1.1.1.cmml">i</mi><mo id="S3.E2.m1.2.2.2.4.1" xref="S3.E2.m1.2.2.2.3.cmml">,</mo><mi id="S3.E2.m1.2.2.2.2" xref="S3.E2.m1.2.2.2.2.cmml">t</mi></mrow></msub><mo id="S3.E2.m1.5.5.1.1.3" xref="S3.E2.m1.5.5.1.1.3.cmml">=</mo><msub id="S3.E2.m1.5.5.1.1.4" xref="S3.E2.m1.5.5.1.1.4.cmml"><mover accent="true" id="S3.E2.m1.5.5.1.1.4.2" xref="S3.E2.m1.5.5.1.1.4.2.cmml"><mi id="S3.E2.m1.5.5.1.1.4.2.2" xref="S3.E2.m1.5.5.1.1.4.2.2.cmml">r</mi><mo id="S3.E2.m1.5.5.1.1.4.2.1" xref="S3.E2.m1.5.5.1.1.4.2.1.cmml">~</mo></mover><mi id="S3.E2.m1.5.5.1.1.4.3" xref="S3.E2.m1.5.5.1.1.4.3.cmml">i</mi></msub><mo id="S3.E2.m1.5.5.1.1.5" xref="S3.E2.m1.5.5.1.1.5.cmml">=</mo><mfrac id="S3.E2.m1.4.4" xref="S3.E2.m1.4.4.cmml"><mrow id="S3.E2.m1.3.3.1" xref="S3.E2.m1.3.3.1.cmml"><msub id="S3.E2.m1.3.3.1.3" xref="S3.E2.m1.3.3.1.3.cmml"><mi id="S3.E2.m1.3.3.1.3.2" xref="S3.E2.m1.3.3.1.3.2.cmml">r</mi><mi id="S3.E2.m1.3.3.1.3.3" xref="S3.E2.m1.3.3.1.3.3.cmml">i</mi></msub><mo id="S3.E2.m1.3.3.1.2" xref="S3.E2.m1.3.3.1.2.cmml">−</mo><mrow id="S3.E2.m1.3.3.1.4" xref="S3.E2.m1.3.3.1.4.cmml"><mtext id="S3.E2.m1.3.3.1.4.2" xref="S3.E2.m1.3.3.1.4.2a.cmml">mean</mtext><mo id="S3.E2.m1.3.3.1.4.1" xref="S3.E2.m1.3.3.1.4.1.cmml">⁢</mo><mrow id="S3.E2.m1.3.3.1.4.3.2" xref="S3.E2.m1.3.3.1.4.cmml"><mo id="S3.E2.m1.3.3.1.4.3.2.1" stretchy="false" xref="S3.E2.m1.3.3.1.4.cmml">(</mo><mi id="S3.E2.m1.3.3.1.1" xref="S3.E2.m1.3.3.1.1.cmml">𝐫</mi><mo id="S3.E2.m1.3.3.1.4.3.2.2" stretchy="false" xref="S3.E2.m1.3.3.1.4.cmml">)</mo></mrow></mrow></mrow><mrow id="S3.E2.m1.4.4.2" xref="S3.E2.m1.4.4.2.cmml"><mtext id="S3.E2.m1.4.4.2.3" xref="S3.E2.m1.4.4.2.3a.cmml">std</mtext><mo id="S3.E2.m1.4.4.2.2" xref="S3.E2.m1.4.4.2.2.cmml">⁢</mo><mrow id="S3.E2.m1.4.4.2.4.2" xref="S3.E2.m1.4.4.2.cmml"><mo id="S3.E2.m1.4.4.2.4.2.1" stretchy="false" xref="S3.E2.m1.4.4.2.cmml">(</mo><mi id="S3.E2.m1.4.4.2.1" xref="S3.E2.m1.4.4.2.1.cmml">𝐫</mi><mo id="S3.E2.m1.4.4.2.4.2.2" stretchy="false" xref="S3.E2.m1.4.4.2.cmml">)</mo></mrow></mrow></mfrac></mrow><mo id="S3.E2.m1.5.5.1.2" xref="S3.E2.m1.5.5.1.1.cmml">,</mo></mrow><annotation-xml encoding="MathML-Content" id="S3.E2.m1.5b"><apply id="S3.E2.m1.5.5.1.1.cmml" xref="S3.E2.m1.5.5.1"><and id="S3.E2.m1.5.5.1.1a.cmml" xref="S3.E2.m1.5.5.1"></and><apply id="S3.E2.m1.5.5.1.1b.cmml" xref="S3.E2.m1.5.5.1"><eq id="S3.E2.m1.5.5.1.1.3.cmml" xref="S3.E2.m1.5.5.1.1.3"></eq><apply id="S3.E2.m1.5.5.1.1.2.cmml" xref="S3.E2.m1.5.5.1.1.2"><csymbol cd="ambiguous" id="S3.E2.m1.5.5.1.1.2.1.cmml" xref="S3.E2.m1.5.5.1.1.2">subscript</csymbol><apply id="S3.E2.m1.5.5.1.1.2.2.cmml" xref="S3.E2.m1.5.5.1.1.2.2"><ci id="S3.E2.m1.5.5.1.1.2.2.1.cmml" xref="S3.E2.m1.5.5.1.1.2.2.1">^</ci><ci id="S3.E2.m1.5.5.1.1.2.2.2.cmml" xref="S3.E2.m1.5.5.1.1.2.2.2">𝐴</ci></apply><list id="S3.E2.m1.2.2.2.3.cmml" xref="S3.E2.m1.2.2.2.4"><ci id="S3.E2.m1.1.1.1.1.cmml" xref="S3.E2.m1.1.1.1.1">𝑖</ci><ci id="S3.E2.m1.2.2.2.2.cmml" xref="S3.E2.m1.2.2.2.2">𝑡</ci></list></apply><apply id="S3.E2.m1.5.5.1.1.4.cmml" xref="S3.E2.m1.5.5.1.1.4"><csymbol cd="ambiguous" id="S3.E2.m1.5.5.1.1.4.1.cmml" xref="S3.E2.m1.5.5.1.1.4">subscript</csymbol><apply id="S3.E2.m1.5.5.1.1.4.2.cmml" xref="S3.E2.m1.5.5.1.1.4.2"><ci id="S3.E2.m1.5.5.1.1.4.2.1.cmml" xref="S3.E2.m1.5.5.1.1.4.2.1">~</ci><ci id="S3.E2.m1.5.5.1.1.4.2.2.cmml" xref="S3.E2.m1.5.5.1.1.4.2.2">𝑟</ci></apply><ci id="S3.E2.m1.5.5.1.1.4.3.cmml" xref="S3.E2.m1.5.5.1.1.4.3">𝑖</ci></apply></apply><apply id="S3.E2.m1.5.5.1.1c.cmml" xref="S3.E2.m1.5.5.1"><eq id="S3.E2.m1.5.5.1.1.5.cmml" xref="S3.E2.m1.5.5.1.1.5"></eq><share href="https://arxiv.org/html/2505.20218v1#S3.E2.m1.5.5.1.1.4.cmml" id="S3.E2.m1.5.5.1.1d.cmml" xref="S3.E2.m1.5.5.1"></share><apply id="S3.E2.m1.4.4.cmml" xref="S3.E2.m1.4.4"><divide id="S3.E2.m1.4.4.3.cmml" xref="S3.E2.m1.4.4"></divide><apply id="S3.E2.m1.3.3.1.cmml" xref="S3.E2.m1.3.3.1"><minus id="S3.E2.m1.3.3.1.2.cmml" xref="S3.E2.m1.3.3.1.2"></minus><apply id="S3.E2.m1.3.3.1.3.cmml" xref="S3.E2.m1.3.3.1.3"><csymbol cd="ambiguous" id="S3.E2.m1.3.3.1.3.1.cmml" xref="S3.E2.m1.3.3.1.3">subscript</csymbol><ci id="S3.E2.m1.3.3.1.3.2.cmml" xref="S3.E2.m1.3.3.1.3.2">𝑟</ci><ci id="S3.E2.m1.3.3.1.3.3.cmml" xref="S3.E2.m1.3.3.1.3.3">𝑖</ci></apply><apply id="S3.E2.m1.3.3.1.4.cmml" xref="S3.E2.m1.3.3.1.4"><times id="S3.E2.m1.3.3.1.4.1.cmml" xref="S3.E2.m1.3.3.1.4.1"></times><ci id="S3.E2.m1.3.3.1.4.2a.cmml" xref="S3.E2.m1.3.3.1.4.2"><mtext id="S3.E2.m1.3.3.1.4.2.cmml" xref="S3.E2.m1.3.3.1.4.2">mean</mtext></ci><ci id="S3.E2.m1.3.3.1.1.cmml" xref="S3.E2.m1.3.3.1.1">𝐫</ci></apply></apply><apply id="S3.E2.m1.4.4.2.cmml" xref="S3.E2.m1.4.4.2"><times id="S3.E2.m1.4.4.2.2.cmml" xref="S3.E2.m1.4.4.2.2"></times><ci id="S3.E2.m1.4.4.2.3a.cmml" xref="S3.E2.m1.4.4.2.3"><mtext id="S3.E2.m1.4.4.2.3.cmml" xref="S3.E2.m1.4.4.2.3">std</mtext></ci><ci id="S3.E2.m1.4.4.2.1.cmml" xref="S3.E2.m1.4.4.2.1">𝐫</ci></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.E2.m1.5c">\hat{A}_{i,t}=\tilde{r}_{i}=\frac{r_{i}-\text{mean}(\mathbf{r})}{\text{std}(%
\mathbf{r})},</annotation><annotation encoding="application/x-llamapun" id="S3.E2.m1.5d">over^ start_ARG italic_A end_ARG start_POSTSUBSCRIPT italic_i , italic_t end_POSTSUBSCRIPT = over~ start_ARG italic_r end_ARG start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT = divide start_ARG italic_r start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT - mean ( bold_r ) end_ARG start_ARG std ( bold_r ) end_ARG ,</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(2)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S3.SS2.p3.4">where <math alttext="r_{i}" class="ltx_Math" display="inline" id="S3.SS2.p3.2.m1.1"><semantics id="S3.SS2.p3.2.m1.1a"><msub id="S3.SS2.p3.2.m1.1.1" xref="S3.SS2.p3.2.m1.1.1.cmml"><mi id="S3.SS2.p3.2.m1.1.1.2" xref="S3.SS2.p3.2.m1.1.1.2.cmml">r</mi><mi id="S3.SS2.p3.2.m1.1.1.3" xref="S3.SS2.p3.2.m1.1.1.3.cmml">i</mi></msub><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.2.m1.1b"><apply id="S3.SS2.p3.2.m1.1.1.cmml" xref="S3.SS2.p3.2.m1.1.1"><csymbol cd="ambiguous" id="S3.SS2.p3.2.m1.1.1.1.cmml" xref="S3.SS2.p3.2.m1.1.1">subscript</csymbol><ci id="S3.SS2.p3.2.m1.1.1.2.cmml" xref="S3.SS2.p3.2.m1.1.1.2">𝑟</ci><ci id="S3.SS2.p3.2.m1.1.1.3.cmml" xref="S3.SS2.p3.2.m1.1.1.3">𝑖</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.2.m1.1c">r_{i}</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.2.m1.1d">italic_r start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT</annotation></semantics></math> is the scalar reward for the <math alttext="i" class="ltx_Math" display="inline" id="S3.SS2.p3.3.m2.1"><semantics id="S3.SS2.p3.3.m2.1a"><mi id="S3.SS2.p3.3.m2.1.1" xref="S3.SS2.p3.3.m2.1.1.cmml">i</mi><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.3.m2.1b"><ci id="S3.SS2.p3.3.m2.1.1.cmml" xref="S3.SS2.p3.3.m2.1.1">𝑖</ci></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.3.m2.1c">i</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.3.m2.1d">italic_i</annotation></semantics></math>-th output, <math alttext="\mathbf{r}=[r_{1},\dots,r_{G}]" class="ltx_Math" display="inline" id="S3.SS2.p3.4.m3.3"><semantics id="S3.SS2.p3.4.m3.3a"><mrow id="S3.SS2.p3.4.m3.3.3" xref="S3.SS2.p3.4.m3.3.3.cmml"><mi id="S3.SS2.p3.4.m3.3.3.4" xref="S3.SS2.p3.4.m3.3.3.4.cmml">𝐫</mi><mo id="S3.SS2.p3.4.m3.3.3.3" xref="S3.SS2.p3.4.m3.3.3.3.cmml">=</mo><mrow id="S3.SS2.p3.4.m3.3.3.2.2" xref="S3.SS2.p3.4.m3.3.3.2.3.cmml"><mo id="S3.SS2.p3.4.m3.3.3.2.2.3" stretchy="false" xref="S3.SS2.p3.4.m3.3.3.2.3.cmml">[</mo><msub id="S3.SS2.p3.4.m3.2.2.1.1.1" xref="S3.SS2.p3.4.m3.2.2.1.1.1.cmml"><mi id="S3.SS2.p3.4.m3.2.2.1.1.1.2" xref="S3.SS2.p3.4.m3.2.2.1.1.1.2.cmml">r</mi><mn id="S3.SS2.p3.4.m3.2.2.1.1.1.3" xref="S3.SS2.p3.4.m3.2.2.1.1.1.3.cmml">1</mn></msub><mo id="S3.SS2.p3.4.m3.3.3.2.2.4" xref="S3.SS2.p3.4.m3.3.3.2.3.cmml">,</mo><mi id="S3.SS2.p3.4.m3.1.1" mathvariant="normal" xref="S3.SS2.p3.4.m3.1.1.cmml">…</mi><mo id="S3.SS2.p3.4.m3.3.3.2.2.5" xref="S3.SS2.p3.4.m3.3.3.2.3.cmml">,</mo><msub id="S3.SS2.p3.4.m3.3.3.2.2.2" xref="S3.SS2.p3.4.m3.3.3.2.2.2.cmml"><mi id="S3.SS2.p3.4.m3.3.3.2.2.2.2" xref="S3.SS2.p3.4.m3.3.3.2.2.2.2.cmml">r</mi><mi id="S3.SS2.p3.4.m3.3.3.2.2.2.3" xref="S3.SS2.p3.4.m3.3.3.2.2.2.3.cmml">G</mi></msub><mo id="S3.SS2.p3.4.m3.3.3.2.2.6" stretchy="false" xref="S3.SS2.p3.4.m3.3.3.2.3.cmml">]</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S3.SS2.p3.4.m3.3b"><apply id="S3.SS2.p3.4.m3.3.3.cmml" xref="S3.SS2.p3.4.m3.3.3"><eq id="S3.SS2.p3.4.m3.3.3.3.cmml" xref="S3.SS2.p3.4.m3.3.3.3"></eq><ci id="S3.SS2.p3.4.m3.3.3.4.cmml" xref="S3.SS2.p3.4.m3.3.3.4">𝐫</ci><list id="S3.SS2.p3.4.m3.3.3.2.3.cmml" xref="S3.SS2.p3.4.m3.3.3.2.2"><apply id="S3.SS2.p3.4.m3.2.2.1.1.1.cmml" xref="S3.SS2.p3.4.m3.2.2.1.1.1"><csymbol cd="ambiguous" id="S3.SS2.p3.4.m3.2.2.1.1.1.1.cmml" xref="S3.SS2.p3.4.m3.2.2.1.1.1">subscript</csymbol><ci id="S3.SS2.p3.4.m3.2.2.1.1.1.2.cmml" xref="S3.SS2.p3.4.m3.2.2.1.1.1.2">𝑟</ci><cn id="S3.SS2.p3.4.m3.2.2.1.1.1.3.cmml" type="integer" xref="S3.SS2.p3.4.m3.2.2.1.1.1.3">1</cn></apply><ci id="S3.SS2.p3.4.m3.1.1.cmml" xref="S3.SS2.p3.4.m3.1.1">…</ci><apply id="S3.SS2.p3.4.m3.3.3.2.2.2.cmml" xref="S3.SS2.p3.4.m3.3.3.2.2.2"><csymbol cd="ambiguous" id="S3.SS2.p3.4.m3.3.3.2.2.2.1.cmml" xref="S3.SS2.p3.4.m3.3.3.2.2.2">subscript</csymbol><ci id="S3.SS2.p3.4.m3.3.3.2.2.2.2.cmml" xref="S3.SS2.p3.4.m3.3.3.2.2.2.2">𝑟</ci><ci id="S3.SS2.p3.4.m3.3.3.2.2.2.3.cmml" xref="S3.SS2.p3.4.m3.3.3.2.2.2.3">𝐺</ci></apply></list></apply></annotation-xml><annotation encoding="application/x-tex" id="S3.SS2.p3.4.m3.3c">\mathbf{r}=[r_{1},\dots,r_{G}]</annotation><annotation encoding="application/x-llamapun" id="S3.SS2.p3.4.m3.3d">bold_r = [ italic_r start_POSTSUBSCRIPT 1 end_POSTSUBSCRIPT , … , italic_r start_POSTSUBSCRIPT italic_G end_POSTSUBSCRIPT ]</annotation></semantics></math> is the reward vector for the group.</p>
</div>
<div class="ltx_para" id="S3.SS2.p4">
<p class="ltx_p" id="S3.SS2.p4.1">Although GRPO effectively promotes group-wise preference learning, its outcome-level reward is applied uniformly across all tokens, ignoring variation in token-level quality.
This coarse credit assignment hinders fine-grained learning and limits optimization efficiency.</p>
</div>
</section>
</section>
<section class="ltx_section" id="S4">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">4 </span>Method: FLAME</h2>
<div class="ltx_para" id="S4.p1">
<p class="ltx_p" id="S4.p1.1">We first introduce step-wise GRPO, the core of FLAME’s fine-grained alignment.
We then describe the optimization process, followed by the two-stage recommendation framework.
Finally, we present the multi-source knowledge fusion strategy.</p>
</div>
<section class="ltx_subsection" id="S4.SS1">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.1 </span>Step-wise GRPO</h3>
<div class="ltx_para" id="S4.SS1.p1">
<p class="ltx_p" id="S4.SS1.p1.2"><span class="ltx_text ltx_font_bold" id="S4.SS1.p1.2.1">Output Segmentation.</span>
To enable fine-grained credit assignment, we decompose the LLM output into multiple decision steps <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib21" title="">21</a>]</cite>, each corresponding to a semantically coherent token span (e.g., a single medication).
Given a generated sequence <math alttext="\mathbf{o}_{i}=[o_{i}^{1},o_{i}^{2},\ldots,o_{i}^{|\mathbf{o}_{i}|}]" class="ltx_Math" display="inline" id="S4.SS1.p1.1.m1.5"><semantics id="S4.SS1.p1.1.m1.5a"><mrow id="S4.SS1.p1.1.m1.5.5" xref="S4.SS1.p1.1.m1.5.5.cmml"><msub id="S4.SS1.p1.1.m1.5.5.5" xref="S4.SS1.p1.1.m1.5.5.5.cmml"><mi id="S4.SS1.p1.1.m1.5.5.5.2" xref="S4.SS1.p1.1.m1.5.5.5.2.cmml">𝐨</mi><mi id="S4.SS1.p1.1.m1.5.5.5.3" xref="S4.SS1.p1.1.m1.5.5.5.3.cmml">i</mi></msub><mo id="S4.SS1.p1.1.m1.5.5.4" xref="S4.SS1.p1.1.m1.5.5.4.cmml">=</mo><mrow id="S4.SS1.p1.1.m1.5.5.3.3" xref="S4.SS1.p1.1.m1.5.5.3.4.cmml"><mo id="S4.SS1.p1.1.m1.5.5.3.3.4" stretchy="false" xref="S4.SS1.p1.1.m1.5.5.3.4.cmml">[</mo><msubsup id="S4.SS1.p1.1.m1.3.3.1.1.1" xref="S4.SS1.p1.1.m1.3.3.1.1.1.cmml"><mi id="S4.SS1.p1.1.m1.3.3.1.1.1.2.2" xref="S4.SS1.p1.1.m1.3.3.1.1.1.2.2.cmml">o</mi><mi id="S4.SS1.p1.1.m1.3.3.1.1.1.2.3" xref="S4.SS1.p1.1.m1.3.3.1.1.1.2.3.cmml">i</mi><mn id="S4.SS1.p1.1.m1.3.3.1.1.1.3" xref="S4.SS1.p1.1.m1.3.3.1.1.1.3.cmml">1</mn></msubsup><mo id="S4.SS1.p1.1.m1.5.5.3.3.5" xref="S4.SS1.p1.1.m1.5.5.3.4.cmml">,</mo><msubsup id="S4.SS1.p1.1.m1.4.4.2.2.2" xref="S4.SS1.p1.1.m1.4.4.2.2.2.cmml"><mi id="S4.SS1.p1.1.m1.4.4.2.2.2.2.2" xref="S4.SS1.p1.1.m1.4.4.2.2.2.2.2.cmml">o</mi><mi id="S4.SS1.p1.1.m1.4.4.2.2.2.2.3" xref="S4.SS1.p1.1.m1.4.4.2.2.2.2.3.cmml">i</mi><mn id="S4.SS1.p1.1.m1.4.4.2.2.2.3" xref="S4.SS1.p1.1.m1.4.4.2.2.2.3.cmml">2</mn></msubsup><mo id="S4.SS1.p1.1.m1.5.5.3.3.6" xref="S4.SS1.p1.1.m1.5.5.3.4.cmml">,</mo><mi id="S4.SS1.p1.1.m1.2.2" mathvariant="normal" xref="S4.SS1.p1.1.m1.2.2.cmml">…</mi><mo id="S4.SS1.p1.1.m1.5.5.3.3.7" xref="S4.SS1.p1.1.m1.5.5.3.4.cmml">,</mo><msubsup id="S4.SS1.p1.1.m1.5.5.3.3.3" xref="S4.SS1.p1.1.m1.5.5.3.3.3.cmml"><mi id="S4.SS1.p1.1.m1.5.5.3.3.3.2.2" xref="S4.SS1.p1.1.m1.5.5.3.3.3.2.2.cmml">o</mi><mi id="S4.SS1.p1.1.m1.5.5.3.3.3.2.3" xref="S4.SS1.p1.1.m1.5.5.3.3.3.2.3.cmml">i</mi><mrow id="S4.SS1.p1.1.m1.1.1.1.1" xref="S4.SS1.p1.1.m1.1.1.1.2.cmml"><mo id="S4.SS1.p1.1.m1.1.1.1.1.2" stretchy="false" xref="S4.SS1.p1.1.m1.1.1.1.2.1.cmml">|</mo><msub id="S4.SS1.p1.1.m1.1.1.1.1.1" xref="S4.SS1.p1.1.m1.1.1.1.1.1.cmml"><mi id="S4.SS1.p1.1.m1.1.1.1.1.1.2" xref="S4.SS1.p1.1.m1.1.1.1.1.1.2.cmml">𝐨</mi><mi id="S4.SS1.p1.1.m1.1.1.1.1.1.3" xref="S4.SS1.p1.1.m1.1.1.1.1.1.3.cmml">i</mi></msub><mo id="S4.SS1.p1.1.m1.1.1.1.1.3" stretchy="false" xref="S4.SS1.p1.1.m1.1.1.1.2.1.cmml">|</mo></mrow></msubsup><mo id="S4.SS1.p1.1.m1.5.5.3.3.8" stretchy="false" xref="S4.SS1.p1.1.m1.5.5.3.4.cmml">]</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.SS1.p1.1.m1.5b"><apply id="S4.SS1.p1.1.m1.5.5.cmml" xref="S4.SS1.p1.1.m1.5.5"><eq id="S4.SS1.p1.1.m1.5.5.4.cmml" xref="S4.SS1.p1.1.m1.5.5.4"></eq><apply id="S4.SS1.p1.1.m1.5.5.5.cmml" xref="S4.SS1.p1.1.m1.5.5.5"><csymbol cd="ambiguous" id="S4.SS1.p1.1.m1.5.5.5.1.cmml" xref="S4.SS1.p1.1.m1.5.5.5">subscript</csymbol><ci id="S4.SS1.p1.1.m1.5.5.5.2.cmml" xref="S4.SS1.p1.1.m1.5.5.5.2">𝐨</ci><ci id="S4.SS1.p1.1.m1.5.5.5.3.cmml" xref="S4.SS1.p1.1.m1.5.5.5.3">𝑖</ci></apply><list id="S4.SS1.p1.1.m1.5.5.3.4.cmml" xref="S4.SS1.p1.1.m1.5.5.3.3"><apply id="S4.SS1.p1.1.m1.3.3.1.1.1.cmml" xref="S4.SS1.p1.1.m1.3.3.1.1.1"><csymbol cd="ambiguous" id="S4.SS1.p1.1.m1.3.3.1.1.1.1.cmml" xref="S4.SS1.p1.1.m1.3.3.1.1.1">superscript</csymbol><apply id="S4.SS1.p1.1.m1.3.3.1.1.1.2.cmml" xref="S4.SS1.p1.1.m1.3.3.1.1.1"><csymbol cd="ambiguous" id="S4.SS1.p1.1.m1.3.3.1.1.1.2.1.cmml" xref="S4.SS1.p1.1.m1.3.3.1.1.1">subscript</csymbol><ci id="S4.SS1.p1.1.m1.3.3.1.1.1.2.2.cmml" xref="S4.SS1.p1.1.m1.3.3.1.1.1.2.2">𝑜</ci><ci id="S4.SS1.p1.1.m1.3.3.1.1.1.2.3.cmml" xref="S4.SS1.p1.1.m1.3.3.1.1.1.2.3">𝑖</ci></apply><cn id="S4.SS1.p1.1.m1.3.3.1.1.1.3.cmml" type="integer" xref="S4.SS1.p1.1.m1.3.3.1.1.1.3">1</cn></apply><apply id="S4.SS1.p1.1.m1.4.4.2.2.2.cmml" xref="S4.SS1.p1.1.m1.4.4.2.2.2"><csymbol cd="ambiguous" id="S4.SS1.p1.1.m1.4.4.2.2.2.1.cmml" xref="S4.SS1.p1.1.m1.4.4.2.2.2">superscript</csymbol><apply id="S4.SS1.p1.1.m1.4.4.2.2.2.2.cmml" xref="S4.SS1.p1.1.m1.4.4.2.2.2"><csymbol cd="ambiguous" id="S4.SS1.p1.1.m1.4.4.2.2.2.2.1.cmml" xref="S4.SS1.p1.1.m1.4.4.2.2.2">subscript</csymbol><ci id="S4.SS1.p1.1.m1.4.4.2.2.2.2.2.cmml" xref="S4.SS1.p1.1.m1.4.4.2.2.2.2.2">𝑜</ci><ci id="S4.SS1.p1.1.m1.4.4.2.2.2.2.3.cmml" xref="S4.SS1.p1.1.m1.4.4.2.2.2.2.3">𝑖</ci></apply><cn id="S4.SS1.p1.1.m1.4.4.2.2.2.3.cmml" type="integer" xref="S4.SS1.p1.1.m1.4.4.2.2.2.3">2</cn></apply><ci id="S4.SS1.p1.1.m1.2.2.cmml" xref="S4.SS1.p1.1.m1.2.2">…</ci><apply id="S4.SS1.p1.1.m1.5.5.3.3.3.cmml" xref="S4.SS1.p1.1.m1.5.5.3.3.3"><csymbol cd="ambiguous" id="S4.SS1.p1.1.m1.5.5.3.3.3.1.cmml" xref="S4.SS1.p1.1.m1.5.5.3.3.3">superscript</csymbol><apply id="S4.SS1.p1.1.m1.5.5.3.3.3.2.cmml" xref="S4.SS1.p1.1.m1.5.5.3.3.3"><csymbol cd="ambiguous" id="S4.SS1.p1.1.m1.5.5.3.3.3.2.1.cmml" xref="S4.SS1.p1.1.m1.5.5.3.3.3">subscript</csymbol><ci id="S4.SS1.p1.1.m1.5.5.3.3.3.2.2.cmml" xref="S4.SS1.p1.1.m1.5.5.3.3.3.2.2">𝑜</ci><ci id="S4.SS1.p1.1.m1.5.5.3.3.3.2.3.cmml" xref="S4.SS1.p1.1.m1.5.5.3.3.3.2.3">𝑖</ci></apply><apply id="S4.SS1.p1.1.m1.1.1.1.2.cmml" xref="S4.SS1.p1.1.m1.1.1.1.1"><abs id="S4.SS1.p1.1.m1.1.1.1.2.1.cmml" xref="S4.SS1.p1.1.m1.1.1.1.1.2"></abs><apply id="S4.SS1.p1.1.m1.1.1.1.1.1.cmml" xref="S4.SS1.p1.1.m1.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.SS1.p1.1.m1.1.1.1.1.1.1.cmml" xref="S4.SS1.p1.1.m1.1.1.1.1.1">subscript</csymbol><ci id="S4.SS1.p1.1.m1.1.1.1.1.1.2.cmml" xref="S4.SS1.p1.1.m1.1.1.1.1.1.2">𝐨</ci><ci id="S4.SS1.p1.1.m1.1.1.1.1.1.3.cmml" xref="S4.SS1.p1.1.m1.1.1.1.1.1.3">𝑖</ci></apply></apply></apply></list></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p1.1.m1.5c">\mathbf{o}_{i}=[o_{i}^{1},o_{i}^{2},\ldots,o_{i}^{|\mathbf{o}_{i}|}]</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p1.1.m1.5d">bold_o start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT = [ italic_o start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT start_POSTSUPERSCRIPT 1 end_POSTSUPERSCRIPT , italic_o start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT start_POSTSUPERSCRIPT 2 end_POSTSUPERSCRIPT , … , italic_o start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT start_POSTSUPERSCRIPT | bold_o start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT | end_POSTSUPERSCRIPT ]</annotation></semantics></math>, we segment it into <math alttext="N_{i}" class="ltx_Math" display="inline" id="S4.SS1.p1.2.m2.1"><semantics id="S4.SS1.p1.2.m2.1a"><msub id="S4.SS1.p1.2.m2.1.1" xref="S4.SS1.p1.2.m2.1.1.cmml"><mi id="S4.SS1.p1.2.m2.1.1.2" xref="S4.SS1.p1.2.m2.1.1.2.cmml">N</mi><mi id="S4.SS1.p1.2.m2.1.1.3" xref="S4.SS1.p1.2.m2.1.1.3.cmml">i</mi></msub><annotation-xml encoding="MathML-Content" id="S4.SS1.p1.2.m2.1b"><apply id="S4.SS1.p1.2.m2.1.1.cmml" xref="S4.SS1.p1.2.m2.1.1"><csymbol cd="ambiguous" id="S4.SS1.p1.2.m2.1.1.1.cmml" xref="S4.SS1.p1.2.m2.1.1">subscript</csymbol><ci id="S4.SS1.p1.2.m2.1.1.2.cmml" xref="S4.SS1.p1.2.m2.1.1.2">𝑁</ci><ci id="S4.SS1.p1.2.m2.1.1.3.cmml" xref="S4.SS1.p1.2.m2.1.1.3">𝑖</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p1.2.m2.1c">N_{i}</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p1.2.m2.1d">italic_N start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT</annotation></semantics></math> steps:</p>
<table class="ltx_equation ltx_eqn_table" id="S4.E3">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\mathbf{o}_{i}=\bigcup_{n=1}^{N_{i}}\mathbf{o}_{i}^{(n)},\quad\text{where }%
\mathbf{o}_{i}^{(n)}=[o_{i}^{b_{n}},\ldots,o_{i}^{e_{n}}]." class="ltx_Math" display="block" id="S4.E3.m1.4"><semantics id="S4.E3.m1.4a"><mrow id="S4.E3.m1.4.4.1"><mrow id="S4.E3.m1.4.4.1.1.2" xref="S4.E3.m1.4.4.1.1.3.cmml"><mrow id="S4.E3.m1.4.4.1.1.1.1" xref="S4.E3.m1.4.4.1.1.1.1.cmml"><msub id="S4.E3.m1.4.4.1.1.1.1.2" xref="S4.E3.m1.4.4.1.1.1.1.2.cmml"><mi id="S4.E3.m1.4.4.1.1.1.1.2.2" xref="S4.E3.m1.4.4.1.1.1.1.2.2.cmml">𝐨</mi><mi id="S4.E3.m1.4.4.1.1.1.1.2.3" xref="S4.E3.m1.4.4.1.1.1.1.2.3.cmml">i</mi></msub><mo id="S4.E3.m1.4.4.1.1.1.1.1" rspace="0.111em" xref="S4.E3.m1.4.4.1.1.1.1.1.cmml">=</mo><mrow id="S4.E3.m1.4.4.1.1.1.1.3" xref="S4.E3.m1.4.4.1.1.1.1.3.cmml"><munderover id="S4.E3.m1.4.4.1.1.1.1.3.1" xref="S4.E3.m1.4.4.1.1.1.1.3.1.cmml"><mo id="S4.E3.m1.4.4.1.1.1.1.3.1.2.2" movablelimits="false" xref="S4.E3.m1.4.4.1.1.1.1.3.1.2.2.cmml">⋃</mo><mrow id="S4.E3.m1.4.4.1.1.1.1.3.1.2.3" xref="S4.E3.m1.4.4.1.1.1.1.3.1.2.3.cmml"><mi id="S4.E3.m1.4.4.1.1.1.1.3.1.2.3.2" xref="S4.E3.m1.4.4.1.1.1.1.3.1.2.3.2.cmml">n</mi><mo id="S4.E3.m1.4.4.1.1.1.1.3.1.2.3.1" xref="S4.E3.m1.4.4.1.1.1.1.3.1.2.3.1.cmml">=</mo><mn id="S4.E3.m1.4.4.1.1.1.1.3.1.2.3.3" xref="S4.E3.m1.4.4.1.1.1.1.3.1.2.3.3.cmml">1</mn></mrow><msub id="S4.E3.m1.4.4.1.1.1.1.3.1.3" xref="S4.E3.m1.4.4.1.1.1.1.3.1.3.cmml"><mi id="S4.E3.m1.4.4.1.1.1.1.3.1.3.2" xref="S4.E3.m1.4.4.1.1.1.1.3.1.3.2.cmml">N</mi><mi id="S4.E3.m1.4.4.1.1.1.1.3.1.3.3" xref="S4.E3.m1.4.4.1.1.1.1.3.1.3.3.cmml">i</mi></msub></munderover><msubsup id="S4.E3.m1.4.4.1.1.1.1.3.2" xref="S4.E3.m1.4.4.1.1.1.1.3.2.cmml"><mi id="S4.E3.m1.4.4.1.1.1.1.3.2.2.2" xref="S4.E3.m1.4.4.1.1.1.1.3.2.2.2.cmml">𝐨</mi><mi id="S4.E3.m1.4.4.1.1.1.1.3.2.2.3" xref="S4.E3.m1.4.4.1.1.1.1.3.2.2.3.cmml">i</mi><mrow id="S4.E3.m1.1.1.1.3" xref="S4.E3.m1.4.4.1.1.1.1.3.2.cmml"><mo id="S4.E3.m1.1.1.1.3.1" stretchy="false" xref="S4.E3.m1.4.4.1.1.1.1.3.2.cmml">(</mo><mi id="S4.E3.m1.1.1.1.1" xref="S4.E3.m1.1.1.1.1.cmml">n</mi><mo id="S4.E3.m1.1.1.1.3.2" stretchy="false" xref="S4.E3.m1.4.4.1.1.1.1.3.2.cmml">)</mo></mrow></msubsup></mrow></mrow><mo id="S4.E3.m1.4.4.1.1.2.3" rspace="1.167em" xref="S4.E3.m1.4.4.1.1.3a.cmml">,</mo><mrow id="S4.E3.m1.4.4.1.1.2.2" xref="S4.E3.m1.4.4.1.1.2.2.cmml"><mrow id="S4.E3.m1.4.4.1.1.2.2.4" xref="S4.E3.m1.4.4.1.1.2.2.4.cmml"><mtext id="S4.E3.m1.4.4.1.1.2.2.4.2" xref="S4.E3.m1.4.4.1.1.2.2.4.2a.cmml">where </mtext><mo id="S4.E3.m1.4.4.1.1.2.2.4.1" xref="S4.E3.m1.4.4.1.1.2.2.4.1.cmml">⁢</mo><msubsup id="S4.E3.m1.4.4.1.1.2.2.4.3" xref="S4.E3.m1.4.4.1.1.2.2.4.3.cmml"><mi id="S4.E3.m1.4.4.1.1.2.2.4.3.2.2" xref="S4.E3.m1.4.4.1.1.2.2.4.3.2.2.cmml">𝐨</mi><mi id="S4.E3.m1.4.4.1.1.2.2.4.3.2.3" xref="S4.E3.m1.4.4.1.1.2.2.4.3.2.3.cmml">i</mi><mrow id="S4.E3.m1.2.2.1.3" xref="S4.E3.m1.4.4.1.1.2.2.4.3.cmml"><mo id="S4.E3.m1.2.2.1.3.1" stretchy="false" xref="S4.E3.m1.4.4.1.1.2.2.4.3.cmml">(</mo><mi id="S4.E3.m1.2.2.1.1" xref="S4.E3.m1.2.2.1.1.cmml">n</mi><mo id="S4.E3.m1.2.2.1.3.2" stretchy="false" xref="S4.E3.m1.4.4.1.1.2.2.4.3.cmml">)</mo></mrow></msubsup></mrow><mo id="S4.E3.m1.4.4.1.1.2.2.3" xref="S4.E3.m1.4.4.1.1.2.2.3.cmml">=</mo><mrow id="S4.E3.m1.4.4.1.1.2.2.2.2" xref="S4.E3.m1.4.4.1.1.2.2.2.3.cmml"><mo id="S4.E3.m1.4.4.1.1.2.2.2.2.3" stretchy="false" xref="S4.E3.m1.4.4.1.1.2.2.2.3.cmml">[</mo><msubsup id="S4.E3.m1.4.4.1.1.2.2.1.1.1" xref="S4.E3.m1.4.4.1.1.2.2.1.1.1.cmml"><mi id="S4.E3.m1.4.4.1.1.2.2.1.1.1.2.2" xref="S4.E3.m1.4.4.1.1.2.2.1.1.1.2.2.cmml">o</mi><mi id="S4.E3.m1.4.4.1.1.2.2.1.1.1.2.3" xref="S4.E3.m1.4.4.1.1.2.2.1.1.1.2.3.cmml">i</mi><msub id="S4.E3.m1.4.4.1.1.2.2.1.1.1.3" xref="S4.E3.m1.4.4.1.1.2.2.1.1.1.3.cmml"><mi id="S4.E3.m1.4.4.1.1.2.2.1.1.1.3.2" xref="S4.E3.m1.4.4.1.1.2.2.1.1.1.3.2.cmml">b</mi><mi id="S4.E3.m1.4.4.1.1.2.2.1.1.1.3.3" xref="S4.E3.m1.4.4.1.1.2.2.1.1.1.3.3.cmml">n</mi></msub></msubsup><mo id="S4.E3.m1.4.4.1.1.2.2.2.2.4" xref="S4.E3.m1.4.4.1.1.2.2.2.3.cmml">,</mo><mi id="S4.E3.m1.3.3" mathvariant="normal" xref="S4.E3.m1.3.3.cmml">…</mi><mo id="S4.E3.m1.4.4.1.1.2.2.2.2.5" xref="S4.E3.m1.4.4.1.1.2.2.2.3.cmml">,</mo><msubsup id="S4.E3.m1.4.4.1.1.2.2.2.2.2" xref="S4.E3.m1.4.4.1.1.2.2.2.2.2.cmml"><mi id="S4.E3.m1.4.4.1.1.2.2.2.2.2.2.2" xref="S4.E3.m1.4.4.1.1.2.2.2.2.2.2.2.cmml">o</mi><mi id="S4.E3.m1.4.4.1.1.2.2.2.2.2.2.3" xref="S4.E3.m1.4.4.1.1.2.2.2.2.2.2.3.cmml">i</mi><msub id="S4.E3.m1.4.4.1.1.2.2.2.2.2.3" xref="S4.E3.m1.4.4.1.1.2.2.2.2.2.3.cmml"><mi id="S4.E3.m1.4.4.1.1.2.2.2.2.2.3.2" xref="S4.E3.m1.4.4.1.1.2.2.2.2.2.3.2.cmml">e</mi><mi id="S4.E3.m1.4.4.1.1.2.2.2.2.2.3.3" xref="S4.E3.m1.4.4.1.1.2.2.2.2.2.3.3.cmml">n</mi></msub></msubsup><mo id="S4.E3.m1.4.4.1.1.2.2.2.2.6" stretchy="false" xref="S4.E3.m1.4.4.1.1.2.2.2.3.cmml">]</mo></mrow></mrow></mrow><mo id="S4.E3.m1.4.4.1.2" lspace="0em">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.E3.m1.4b"><apply id="S4.E3.m1.4.4.1.1.3.cmml" xref="S4.E3.m1.4.4.1.1.2"><csymbol cd="ambiguous" id="S4.E3.m1.4.4.1.1.3a.cmml" xref="S4.E3.m1.4.4.1.1.2.3">formulae-sequence</csymbol><apply id="S4.E3.m1.4.4.1.1.1.1.cmml" xref="S4.E3.m1.4.4.1.1.1.1"><eq id="S4.E3.m1.4.4.1.1.1.1.1.cmml" xref="S4.E3.m1.4.4.1.1.1.1.1"></eq><apply id="S4.E3.m1.4.4.1.1.1.1.2.cmml" xref="S4.E3.m1.4.4.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.E3.m1.4.4.1.1.1.1.2.1.cmml" xref="S4.E3.m1.4.4.1.1.1.1.2">subscript</csymbol><ci id="S4.E3.m1.4.4.1.1.1.1.2.2.cmml" xref="S4.E3.m1.4.4.1.1.1.1.2.2">𝐨</ci><ci id="S4.E3.m1.4.4.1.1.1.1.2.3.cmml" xref="S4.E3.m1.4.4.1.1.1.1.2.3">𝑖</ci></apply><apply id="S4.E3.m1.4.4.1.1.1.1.3.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3"><apply id="S4.E3.m1.4.4.1.1.1.1.3.1.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.1"><csymbol cd="ambiguous" id="S4.E3.m1.4.4.1.1.1.1.3.1.1.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.1">superscript</csymbol><apply id="S4.E3.m1.4.4.1.1.1.1.3.1.2.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.1"><csymbol cd="ambiguous" id="S4.E3.m1.4.4.1.1.1.1.3.1.2.1.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.1">subscript</csymbol><union id="S4.E3.m1.4.4.1.1.1.1.3.1.2.2.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.1.2.2"></union><apply id="S4.E3.m1.4.4.1.1.1.1.3.1.2.3.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.1.2.3"><eq id="S4.E3.m1.4.4.1.1.1.1.3.1.2.3.1.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.1.2.3.1"></eq><ci id="S4.E3.m1.4.4.1.1.1.1.3.1.2.3.2.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.1.2.3.2">𝑛</ci><cn id="S4.E3.m1.4.4.1.1.1.1.3.1.2.3.3.cmml" type="integer" xref="S4.E3.m1.4.4.1.1.1.1.3.1.2.3.3">1</cn></apply></apply><apply id="S4.E3.m1.4.4.1.1.1.1.3.1.3.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.1.3"><csymbol cd="ambiguous" id="S4.E3.m1.4.4.1.1.1.1.3.1.3.1.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.1.3">subscript</csymbol><ci id="S4.E3.m1.4.4.1.1.1.1.3.1.3.2.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.1.3.2">𝑁</ci><ci id="S4.E3.m1.4.4.1.1.1.1.3.1.3.3.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.1.3.3">𝑖</ci></apply></apply><apply id="S4.E3.m1.4.4.1.1.1.1.3.2.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.2"><csymbol cd="ambiguous" id="S4.E3.m1.4.4.1.1.1.1.3.2.1.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.2">superscript</csymbol><apply id="S4.E3.m1.4.4.1.1.1.1.3.2.2.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.2"><csymbol cd="ambiguous" id="S4.E3.m1.4.4.1.1.1.1.3.2.2.1.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.2">subscript</csymbol><ci id="S4.E3.m1.4.4.1.1.1.1.3.2.2.2.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.2.2.2">𝐨</ci><ci id="S4.E3.m1.4.4.1.1.1.1.3.2.2.3.cmml" xref="S4.E3.m1.4.4.1.1.1.1.3.2.2.3">𝑖</ci></apply><ci id="S4.E3.m1.1.1.1.1.cmml" xref="S4.E3.m1.1.1.1.1">𝑛</ci></apply></apply></apply><apply id="S4.E3.m1.4.4.1.1.2.2.cmml" xref="S4.E3.m1.4.4.1.1.2.2"><eq id="S4.E3.m1.4.4.1.1.2.2.3.cmml" xref="S4.E3.m1.4.4.1.1.2.2.3"></eq><apply id="S4.E3.m1.4.4.1.1.2.2.4.cmml" xref="S4.E3.m1.4.4.1.1.2.2.4"><times id="S4.E3.m1.4.4.1.1.2.2.4.1.cmml" xref="S4.E3.m1.4.4.1.1.2.2.4.1"></times><ci id="S4.E3.m1.4.4.1.1.2.2.4.2a.cmml" xref="S4.E3.m1.4.4.1.1.2.2.4.2"><mtext id="S4.E3.m1.4.4.1.1.2.2.4.2.cmml" xref="S4.E3.m1.4.4.1.1.2.2.4.2">where </mtext></ci><apply id="S4.E3.m1.4.4.1.1.2.2.4.3.cmml" xref="S4.E3.m1.4.4.1.1.2.2.4.3"><csymbol cd="ambiguous" id="S4.E3.m1.4.4.1.1.2.2.4.3.1.cmml" xref="S4.E3.m1.4.4.1.1.2.2.4.3">superscript</csymbol><apply id="S4.E3.m1.4.4.1.1.2.2.4.3.2.cmml" xref="S4.E3.m1.4.4.1.1.2.2.4.3"><csymbol cd="ambiguous" id="S4.E3.m1.4.4.1.1.2.2.4.3.2.1.cmml" xref="S4.E3.m1.4.4.1.1.2.2.4.3">subscript</csymbol><ci id="S4.E3.m1.4.4.1.1.2.2.4.3.2.2.cmml" xref="S4.E3.m1.4.4.1.1.2.2.4.3.2.2">𝐨</ci><ci id="S4.E3.m1.4.4.1.1.2.2.4.3.2.3.cmml" xref="S4.E3.m1.4.4.1.1.2.2.4.3.2.3">𝑖</ci></apply><ci id="S4.E3.m1.2.2.1.1.cmml" xref="S4.E3.m1.2.2.1.1">𝑛</ci></apply></apply><list id="S4.E3.m1.4.4.1.1.2.2.2.3.cmml" xref="S4.E3.m1.4.4.1.1.2.2.2.2"><apply id="S4.E3.m1.4.4.1.1.2.2.1.1.1.cmml" xref="S4.E3.m1.4.4.1.1.2.2.1.1.1"><csymbol cd="ambiguous" id="S4.E3.m1.4.4.1.1.2.2.1.1.1.1.cmml" xref="S4.E3.m1.4.4.1.1.2.2.1.1.1">superscript</csymbol><apply id="S4.E3.m1.4.4.1.1.2.2.1.1.1.2.cmml" xref="S4.E3.m1.4.4.1.1.2.2.1.1.1"><csymbol cd="ambiguous" id="S4.E3.m1.4.4.1.1.2.2.1.1.1.2.1.cmml" xref="S4.E3.m1.4.4.1.1.2.2.1.1.1">subscript</csymbol><ci id="S4.E3.m1.4.4.1.1.2.2.1.1.1.2.2.cmml" xref="S4.E3.m1.4.4.1.1.2.2.1.1.1.2.2">𝑜</ci><ci id="S4.E3.m1.4.4.1.1.2.2.1.1.1.2.3.cmml" xref="S4.E3.m1.4.4.1.1.2.2.1.1.1.2.3">𝑖</ci></apply><apply id="S4.E3.m1.4.4.1.1.2.2.1.1.1.3.cmml" xref="S4.E3.m1.4.4.1.1.2.2.1.1.1.3"><csymbol cd="ambiguous" id="S4.E3.m1.4.4.1.1.2.2.1.1.1.3.1.cmml" xref="S4.E3.m1.4.4.1.1.2.2.1.1.1.3">subscript</csymbol><ci id="S4.E3.m1.4.4.1.1.2.2.1.1.1.3.2.cmml" xref="S4.E3.m1.4.4.1.1.2.2.1.1.1.3.2">𝑏</ci><ci id="S4.E3.m1.4.4.1.1.2.2.1.1.1.3.3.cmml" xref="S4.E3.m1.4.4.1.1.2.2.1.1.1.3.3">𝑛</ci></apply></apply><ci id="S4.E3.m1.3.3.cmml" xref="S4.E3.m1.3.3">…</ci><apply id="S4.E3.m1.4.4.1.1.2.2.2.2.2.cmml" xref="S4.E3.m1.4.4.1.1.2.2.2.2.2"><csymbol cd="ambiguous" id="S4.E3.m1.4.4.1.1.2.2.2.2.2.1.cmml" xref="S4.E3.m1.4.4.1.1.2.2.2.2.2">superscript</csymbol><apply id="S4.E3.m1.4.4.1.1.2.2.2.2.2.2.cmml" xref="S4.E3.m1.4.4.1.1.2.2.2.2.2"><csymbol cd="ambiguous" id="S4.E3.m1.4.4.1.1.2.2.2.2.2.2.1.cmml" xref="S4.E3.m1.4.4.1.1.2.2.2.2.2">subscript</csymbol><ci id="S4.E3.m1.4.4.1.1.2.2.2.2.2.2.2.cmml" xref="S4.E3.m1.4.4.1.1.2.2.2.2.2.2.2">𝑜</ci><ci id="S4.E3.m1.4.4.1.1.2.2.2.2.2.2.3.cmml" xref="S4.E3.m1.4.4.1.1.2.2.2.2.2.2.3">𝑖</ci></apply><apply id="S4.E3.m1.4.4.1.1.2.2.2.2.2.3.cmml" xref="S4.E3.m1.4.4.1.1.2.2.2.2.2.3"><csymbol cd="ambiguous" id="S4.E3.m1.4.4.1.1.2.2.2.2.2.3.1.cmml" xref="S4.E3.m1.4.4.1.1.2.2.2.2.2.3">subscript</csymbol><ci id="S4.E3.m1.4.4.1.1.2.2.2.2.2.3.2.cmml" xref="S4.E3.m1.4.4.1.1.2.2.2.2.2.3.2">𝑒</ci><ci id="S4.E3.m1.4.4.1.1.2.2.2.2.2.3.3.cmml" xref="S4.E3.m1.4.4.1.1.2.2.2.2.2.3.3">𝑛</ci></apply></apply></list></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E3.m1.4c">\mathbf{o}_{i}=\bigcup_{n=1}^{N_{i}}\mathbf{o}_{i}^{(n)},\quad\text{where }%
\mathbf{o}_{i}^{(n)}=[o_{i}^{b_{n}},\ldots,o_{i}^{e_{n}}].</annotation><annotation encoding="application/x-llamapun" id="S4.E3.m1.4d">bold_o start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT = ⋃ start_POSTSUBSCRIPT italic_n = 1 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_N start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT end_POSTSUPERSCRIPT bold_o start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ( italic_n ) end_POSTSUPERSCRIPT , where bold_o start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ( italic_n ) end_POSTSUPERSCRIPT = [ italic_o start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_b start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT end_POSTSUPERSCRIPT , … , italic_o start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_e start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT end_POSTSUPERSCRIPT ] .</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(3)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS1.p1.4">Each <math alttext="\mathbf{o}_{i}^{(n)}" class="ltx_Math" display="inline" id="S4.SS1.p1.3.m1.1"><semantics id="S4.SS1.p1.3.m1.1a"><msubsup id="S4.SS1.p1.3.m1.1.2" xref="S4.SS1.p1.3.m1.1.2.cmml"><mi id="S4.SS1.p1.3.m1.1.2.2.2" xref="S4.SS1.p1.3.m1.1.2.2.2.cmml">𝐨</mi><mi id="S4.SS1.p1.3.m1.1.2.2.3" xref="S4.SS1.p1.3.m1.1.2.2.3.cmml">i</mi><mrow id="S4.SS1.p1.3.m1.1.1.1.3" xref="S4.SS1.p1.3.m1.1.2.cmml"><mo id="S4.SS1.p1.3.m1.1.1.1.3.1" stretchy="false" xref="S4.SS1.p1.3.m1.1.2.cmml">(</mo><mi id="S4.SS1.p1.3.m1.1.1.1.1" xref="S4.SS1.p1.3.m1.1.1.1.1.cmml">n</mi><mo id="S4.SS1.p1.3.m1.1.1.1.3.2" stretchy="false" xref="S4.SS1.p1.3.m1.1.2.cmml">)</mo></mrow></msubsup><annotation-xml encoding="MathML-Content" id="S4.SS1.p1.3.m1.1b"><apply id="S4.SS1.p1.3.m1.1.2.cmml" xref="S4.SS1.p1.3.m1.1.2"><csymbol cd="ambiguous" id="S4.SS1.p1.3.m1.1.2.1.cmml" xref="S4.SS1.p1.3.m1.1.2">superscript</csymbol><apply id="S4.SS1.p1.3.m1.1.2.2.cmml" xref="S4.SS1.p1.3.m1.1.2"><csymbol cd="ambiguous" id="S4.SS1.p1.3.m1.1.2.2.1.cmml" xref="S4.SS1.p1.3.m1.1.2">subscript</csymbol><ci id="S4.SS1.p1.3.m1.1.2.2.2.cmml" xref="S4.SS1.p1.3.m1.1.2.2.2">𝐨</ci><ci id="S4.SS1.p1.3.m1.1.2.2.3.cmml" xref="S4.SS1.p1.3.m1.1.2.2.3">𝑖</ci></apply><ci id="S4.SS1.p1.3.m1.1.1.1.1.cmml" xref="S4.SS1.p1.3.m1.1.1.1.1">𝑛</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p1.3.m1.1c">\mathbf{o}_{i}^{(n)}</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p1.3.m1.1d">bold_o start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT start_POSTSUPERSCRIPT ( italic_n ) end_POSTSUPERSCRIPT</annotation></semantics></math> denotes the token span of the <math alttext="n" class="ltx_Math" display="inline" id="S4.SS1.p1.4.m2.1"><semantics id="S4.SS1.p1.4.m2.1a"><mi id="S4.SS1.p1.4.m2.1.1" xref="S4.SS1.p1.4.m2.1.1.cmml">n</mi><annotation-xml encoding="MathML-Content" id="S4.SS1.p1.4.m2.1b"><ci id="S4.SS1.p1.4.m2.1.1.cmml" xref="S4.SS1.p1.4.m2.1.1">𝑛</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p1.4.m2.1c">n</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p1.4.m2.1d">italic_n</annotation></semantics></math>-th step. The process is illustrated in (Fig. <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S4.F2" title="Figure 2 ‣ 4.1 Step-wise GRPO ‣ 4 Method: FLAME ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">2</span></a>).</p>
</div>
<div class="ltx_para" id="S4.SS1.p2">
<p class="ltx_p" id="S4.SS1.p2.1">This segmentation allows us to reinterpret generation as a Markov Decision Process, where each step forms a state-action pair.
This framing enables localized reward signals that better align step-wise actions with the global output quality.</p>
</div>
<figure class="ltx_figure" id="S4.F2"><img alt="Refer to caption" class="ltx_graphics ltx_centering ltx_img_landscape" height="136" id="S4.F2.g1" src="x2.png" width="830"/>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure">Figure 2: </span>(a) Output is segmented by medication names into decision steps. (b) Each step is viewed as a state, with potentials <math alttext="\varphi(n)" class="ltx_Math" display="inline" id="S4.F2.4.m1.1"><semantics id="S4.F2.4.m1.1b"><mrow id="S4.F2.4.m1.1.2" xref="S4.F2.4.m1.1.2.cmml"><mi id="S4.F2.4.m1.1.2.2" xref="S4.F2.4.m1.1.2.2.cmml">φ</mi><mo id="S4.F2.4.m1.1.2.1" xref="S4.F2.4.m1.1.2.1.cmml">⁢</mo><mrow id="S4.F2.4.m1.1.2.3.2" xref="S4.F2.4.m1.1.2.cmml"><mo id="S4.F2.4.m1.1.2.3.2.1" stretchy="false" xref="S4.F2.4.m1.1.2.cmml">(</mo><mi id="S4.F2.4.m1.1.1" xref="S4.F2.4.m1.1.1.cmml">n</mi><mo id="S4.F2.4.m1.1.2.3.2.2" stretchy="false" xref="S4.F2.4.m1.1.2.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.F2.4.m1.1c"><apply id="S4.F2.4.m1.1.2.cmml" xref="S4.F2.4.m1.1.2"><times id="S4.F2.4.m1.1.2.1.cmml" xref="S4.F2.4.m1.1.2.1"></times><ci id="S4.F2.4.m1.1.2.2.cmml" xref="S4.F2.4.m1.1.2.2">𝜑</ci><ci id="S4.F2.4.m1.1.1.cmml" xref="S4.F2.4.m1.1.1">𝑛</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.F2.4.m1.1d">\varphi(n)</annotation><annotation encoding="application/x-llamapun" id="S4.F2.4.m1.1e">italic_φ ( italic_n )</annotation></semantics></math> derived from comparisons with ground truth <math alttext="\mathcal{M}_{\text{GT}}" class="ltx_Math" display="inline" id="S4.F2.5.m2.1"><semantics id="S4.F2.5.m2.1b"><msub id="S4.F2.5.m2.1.1" xref="S4.F2.5.m2.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.F2.5.m2.1.1.2" xref="S4.F2.5.m2.1.1.2.cmml">ℳ</mi><mtext id="S4.F2.5.m2.1.1.3" xref="S4.F2.5.m2.1.1.3a.cmml">GT</mtext></msub><annotation-xml encoding="MathML-Content" id="S4.F2.5.m2.1c"><apply id="S4.F2.5.m2.1.1.cmml" xref="S4.F2.5.m2.1.1"><csymbol cd="ambiguous" id="S4.F2.5.m2.1.1.1.cmml" xref="S4.F2.5.m2.1.1">subscript</csymbol><ci id="S4.F2.5.m2.1.1.2.cmml" xref="S4.F2.5.m2.1.1.2">ℳ</ci><ci id="S4.F2.5.m2.1.1.3a.cmml" xref="S4.F2.5.m2.1.1.3"><mtext id="S4.F2.5.m2.1.1.3.cmml" mathsize="70%" xref="S4.F2.5.m2.1.1.3">GT</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.F2.5.m2.1d">\mathcal{M}_{\text{GT}}</annotation><annotation encoding="application/x-llamapun" id="S4.F2.5.m2.1e">caligraphic_M start_POSTSUBSCRIPT GT end_POSTSUBSCRIPT</annotation></semantics></math>. (c) Potential differences are combined with outcome rewards to provide fine-grained training signals <math alttext="\hat{A}" class="ltx_Math" display="inline" id="S4.F2.6.m3.1"><semantics id="S4.F2.6.m3.1b"><mover accent="true" id="S4.F2.6.m3.1.1" xref="S4.F2.6.m3.1.1.cmml"><mi id="S4.F2.6.m3.1.1.2" xref="S4.F2.6.m3.1.1.2.cmml">A</mi><mo id="S4.F2.6.m3.1.1.1" xref="S4.F2.6.m3.1.1.1.cmml">^</mo></mover><annotation-xml encoding="MathML-Content" id="S4.F2.6.m3.1c"><apply id="S4.F2.6.m3.1.1.cmml" xref="S4.F2.6.m3.1.1"><ci id="S4.F2.6.m3.1.1.1.cmml" xref="S4.F2.6.m3.1.1.1">^</ci><ci id="S4.F2.6.m3.1.1.2.cmml" xref="S4.F2.6.m3.1.1.2">𝐴</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.F2.6.m3.1d">\hat{A}</annotation><annotation encoding="application/x-llamapun" id="S4.F2.6.m3.1e">over^ start_ARG italic_A end_ARG</annotation></semantics></math>.</figcaption>
</figure>
<div class="ltx_para" id="S4.SS1.p3">
<p class="ltx_p" id="S4.SS1.p3.8"><span class="ltx_text ltx_font_bold" id="S4.SS1.p3.8.1">Potential-based Reward Shaping.</span>
We extend the standard GRPO advantage (Eq. <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S3.E2" title="In 3.2 Group Relative Policy Optimization (GRPO) ‣ 3 Preliminary ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">2</span></a>) with a shaping term that captures quality changes between consecutive steps:</p>
<table class="ltx_equation ltx_eqn_table" id="S4.E4">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\hat{A}_{i,t}=\tilde{r}_{i}+\lambda\cdot F(\text{step}(t),\text{step}(t)-1)" class="ltx_Math" display="block" id="S4.E4.m1.6"><semantics id="S4.E4.m1.6a"><mrow id="S4.E4.m1.6.6" xref="S4.E4.m1.6.6.cmml"><msub id="S4.E4.m1.6.6.4" xref="S4.E4.m1.6.6.4.cmml"><mover accent="true" id="S4.E4.m1.6.6.4.2" xref="S4.E4.m1.6.6.4.2.cmml"><mi id="S4.E4.m1.6.6.4.2.2" xref="S4.E4.m1.6.6.4.2.2.cmml">A</mi><mo id="S4.E4.m1.6.6.4.2.1" xref="S4.E4.m1.6.6.4.2.1.cmml">^</mo></mover><mrow id="S4.E4.m1.2.2.2.4" xref="S4.E4.m1.2.2.2.3.cmml"><mi id="S4.E4.m1.1.1.1.1" xref="S4.E4.m1.1.1.1.1.cmml">i</mi><mo id="S4.E4.m1.2.2.2.4.1" xref="S4.E4.m1.2.2.2.3.cmml">,</mo><mi id="S4.E4.m1.2.2.2.2" xref="S4.E4.m1.2.2.2.2.cmml">t</mi></mrow></msub><mo id="S4.E4.m1.6.6.3" xref="S4.E4.m1.6.6.3.cmml">=</mo><mrow id="S4.E4.m1.6.6.2" xref="S4.E4.m1.6.6.2.cmml"><msub id="S4.E4.m1.6.6.2.4" xref="S4.E4.m1.6.6.2.4.cmml"><mover accent="true" id="S4.E4.m1.6.6.2.4.2" xref="S4.E4.m1.6.6.2.4.2.cmml"><mi id="S4.E4.m1.6.6.2.4.2.2" xref="S4.E4.m1.6.6.2.4.2.2.cmml">r</mi><mo id="S4.E4.m1.6.6.2.4.2.1" xref="S4.E4.m1.6.6.2.4.2.1.cmml">~</mo></mover><mi id="S4.E4.m1.6.6.2.4.3" xref="S4.E4.m1.6.6.2.4.3.cmml">i</mi></msub><mo id="S4.E4.m1.6.6.2.3" xref="S4.E4.m1.6.6.2.3.cmml">+</mo><mrow id="S4.E4.m1.6.6.2.2" xref="S4.E4.m1.6.6.2.2.cmml"><mrow id="S4.E4.m1.6.6.2.2.4" xref="S4.E4.m1.6.6.2.2.4.cmml"><mi id="S4.E4.m1.6.6.2.2.4.2" xref="S4.E4.m1.6.6.2.2.4.2.cmml">λ</mi><mo id="S4.E4.m1.6.6.2.2.4.1" lspace="0.222em" rspace="0.222em" xref="S4.E4.m1.6.6.2.2.4.1.cmml">⋅</mo><mi id="S4.E4.m1.6.6.2.2.4.3" xref="S4.E4.m1.6.6.2.2.4.3.cmml">F</mi></mrow><mo id="S4.E4.m1.6.6.2.2.3" xref="S4.E4.m1.6.6.2.2.3.cmml">⁢</mo><mrow id="S4.E4.m1.6.6.2.2.2.2" xref="S4.E4.m1.6.6.2.2.2.3.cmml"><mo id="S4.E4.m1.6.6.2.2.2.2.3" stretchy="false" xref="S4.E4.m1.6.6.2.2.2.3.cmml">(</mo><mrow id="S4.E4.m1.5.5.1.1.1.1.1" xref="S4.E4.m1.5.5.1.1.1.1.1.cmml"><mtext id="S4.E4.m1.5.5.1.1.1.1.1.2" xref="S4.E4.m1.5.5.1.1.1.1.1.2a.cmml">step</mtext><mo id="S4.E4.m1.5.5.1.1.1.1.1.1" xref="S4.E4.m1.5.5.1.1.1.1.1.1.cmml">⁢</mo><mrow id="S4.E4.m1.5.5.1.1.1.1.1.3.2" xref="S4.E4.m1.5.5.1.1.1.1.1.cmml"><mo id="S4.E4.m1.5.5.1.1.1.1.1.3.2.1" stretchy="false" xref="S4.E4.m1.5.5.1.1.1.1.1.cmml">(</mo><mi id="S4.E4.m1.3.3" xref="S4.E4.m1.3.3.cmml">t</mi><mo id="S4.E4.m1.5.5.1.1.1.1.1.3.2.2" stretchy="false" xref="S4.E4.m1.5.5.1.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="S4.E4.m1.6.6.2.2.2.2.4" xref="S4.E4.m1.6.6.2.2.2.3.cmml">,</mo><mrow id="S4.E4.m1.6.6.2.2.2.2.2" xref="S4.E4.m1.6.6.2.2.2.2.2.cmml"><mrow id="S4.E4.m1.6.6.2.2.2.2.2.2" xref="S4.E4.m1.6.6.2.2.2.2.2.2.cmml"><mtext id="S4.E4.m1.6.6.2.2.2.2.2.2.2" xref="S4.E4.m1.6.6.2.2.2.2.2.2.2a.cmml">step</mtext><mo id="S4.E4.m1.6.6.2.2.2.2.2.2.1" xref="S4.E4.m1.6.6.2.2.2.2.2.2.1.cmml">⁢</mo><mrow id="S4.E4.m1.6.6.2.2.2.2.2.2.3.2" xref="S4.E4.m1.6.6.2.2.2.2.2.2.cmml"><mo id="S4.E4.m1.6.6.2.2.2.2.2.2.3.2.1" stretchy="false" xref="S4.E4.m1.6.6.2.2.2.2.2.2.cmml">(</mo><mi id="S4.E4.m1.4.4" xref="S4.E4.m1.4.4.cmml">t</mi><mo id="S4.E4.m1.6.6.2.2.2.2.2.2.3.2.2" stretchy="false" xref="S4.E4.m1.6.6.2.2.2.2.2.2.cmml">)</mo></mrow></mrow><mo id="S4.E4.m1.6.6.2.2.2.2.2.1" xref="S4.E4.m1.6.6.2.2.2.2.2.1.cmml">−</mo><mn id="S4.E4.m1.6.6.2.2.2.2.2.3" xref="S4.E4.m1.6.6.2.2.2.2.2.3.cmml">1</mn></mrow><mo id="S4.E4.m1.6.6.2.2.2.2.5" stretchy="false" xref="S4.E4.m1.6.6.2.2.2.3.cmml">)</mo></mrow></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.E4.m1.6b"><apply id="S4.E4.m1.6.6.cmml" xref="S4.E4.m1.6.6"><eq id="S4.E4.m1.6.6.3.cmml" xref="S4.E4.m1.6.6.3"></eq><apply id="S4.E4.m1.6.6.4.cmml" xref="S4.E4.m1.6.6.4"><csymbol cd="ambiguous" id="S4.E4.m1.6.6.4.1.cmml" xref="S4.E4.m1.6.6.4">subscript</csymbol><apply id="S4.E4.m1.6.6.4.2.cmml" xref="S4.E4.m1.6.6.4.2"><ci id="S4.E4.m1.6.6.4.2.1.cmml" xref="S4.E4.m1.6.6.4.2.1">^</ci><ci id="S4.E4.m1.6.6.4.2.2.cmml" xref="S4.E4.m1.6.6.4.2.2">𝐴</ci></apply><list id="S4.E4.m1.2.2.2.3.cmml" xref="S4.E4.m1.2.2.2.4"><ci id="S4.E4.m1.1.1.1.1.cmml" xref="S4.E4.m1.1.1.1.1">𝑖</ci><ci id="S4.E4.m1.2.2.2.2.cmml" xref="S4.E4.m1.2.2.2.2">𝑡</ci></list></apply><apply id="S4.E4.m1.6.6.2.cmml" xref="S4.E4.m1.6.6.2"><plus id="S4.E4.m1.6.6.2.3.cmml" xref="S4.E4.m1.6.6.2.3"></plus><apply id="S4.E4.m1.6.6.2.4.cmml" xref="S4.E4.m1.6.6.2.4"><csymbol cd="ambiguous" id="S4.E4.m1.6.6.2.4.1.cmml" xref="S4.E4.m1.6.6.2.4">subscript</csymbol><apply id="S4.E4.m1.6.6.2.4.2.cmml" xref="S4.E4.m1.6.6.2.4.2"><ci id="S4.E4.m1.6.6.2.4.2.1.cmml" xref="S4.E4.m1.6.6.2.4.2.1">~</ci><ci id="S4.E4.m1.6.6.2.4.2.2.cmml" xref="S4.E4.m1.6.6.2.4.2.2">𝑟</ci></apply><ci id="S4.E4.m1.6.6.2.4.3.cmml" xref="S4.E4.m1.6.6.2.4.3">𝑖</ci></apply><apply id="S4.E4.m1.6.6.2.2.cmml" xref="S4.E4.m1.6.6.2.2"><times id="S4.E4.m1.6.6.2.2.3.cmml" xref="S4.E4.m1.6.6.2.2.3"></times><apply id="S4.E4.m1.6.6.2.2.4.cmml" xref="S4.E4.m1.6.6.2.2.4"><ci id="S4.E4.m1.6.6.2.2.4.1.cmml" xref="S4.E4.m1.6.6.2.2.4.1">⋅</ci><ci id="S4.E4.m1.6.6.2.2.4.2.cmml" xref="S4.E4.m1.6.6.2.2.4.2">𝜆</ci><ci id="S4.E4.m1.6.6.2.2.4.3.cmml" xref="S4.E4.m1.6.6.2.2.4.3">𝐹</ci></apply><interval closure="open" id="S4.E4.m1.6.6.2.2.2.3.cmml" xref="S4.E4.m1.6.6.2.2.2.2"><apply id="S4.E4.m1.5.5.1.1.1.1.1.cmml" xref="S4.E4.m1.5.5.1.1.1.1.1"><times id="S4.E4.m1.5.5.1.1.1.1.1.1.cmml" xref="S4.E4.m1.5.5.1.1.1.1.1.1"></times><ci id="S4.E4.m1.5.5.1.1.1.1.1.2a.cmml" xref="S4.E4.m1.5.5.1.1.1.1.1.2"><mtext id="S4.E4.m1.5.5.1.1.1.1.1.2.cmml" xref="S4.E4.m1.5.5.1.1.1.1.1.2">step</mtext></ci><ci id="S4.E4.m1.3.3.cmml" xref="S4.E4.m1.3.3">𝑡</ci></apply><apply id="S4.E4.m1.6.6.2.2.2.2.2.cmml" xref="S4.E4.m1.6.6.2.2.2.2.2"><minus id="S4.E4.m1.6.6.2.2.2.2.2.1.cmml" xref="S4.E4.m1.6.6.2.2.2.2.2.1"></minus><apply id="S4.E4.m1.6.6.2.2.2.2.2.2.cmml" xref="S4.E4.m1.6.6.2.2.2.2.2.2"><times id="S4.E4.m1.6.6.2.2.2.2.2.2.1.cmml" xref="S4.E4.m1.6.6.2.2.2.2.2.2.1"></times><ci id="S4.E4.m1.6.6.2.2.2.2.2.2.2a.cmml" xref="S4.E4.m1.6.6.2.2.2.2.2.2.2"><mtext id="S4.E4.m1.6.6.2.2.2.2.2.2.2.cmml" xref="S4.E4.m1.6.6.2.2.2.2.2.2.2">step</mtext></ci><ci id="S4.E4.m1.4.4.cmml" xref="S4.E4.m1.4.4">𝑡</ci></apply><cn id="S4.E4.m1.6.6.2.2.2.2.2.3.cmml" type="integer" xref="S4.E4.m1.6.6.2.2.2.2.2.3">1</cn></apply></interval></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E4.m1.6c">\hat{A}_{i,t}=\tilde{r}_{i}+\lambda\cdot F(\text{step}(t),\text{step}(t)-1)</annotation><annotation encoding="application/x-llamapun" id="S4.E4.m1.6d">over^ start_ARG italic_A end_ARG start_POSTSUBSCRIPT italic_i , italic_t end_POSTSUBSCRIPT = over~ start_ARG italic_r end_ARG start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT + italic_λ ⋅ italic_F ( step ( italic_t ) , step ( italic_t ) - 1 )</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(4)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS1.p3.6">Here, <math alttext="\text{step}(t)" class="ltx_Math" display="inline" id="S4.SS1.p3.1.m1.1"><semantics id="S4.SS1.p3.1.m1.1a"><mrow id="S4.SS1.p3.1.m1.1.2" xref="S4.SS1.p3.1.m1.1.2.cmml"><mtext id="S4.SS1.p3.1.m1.1.2.2" xref="S4.SS1.p3.1.m1.1.2.2a.cmml">step</mtext><mo id="S4.SS1.p3.1.m1.1.2.1" xref="S4.SS1.p3.1.m1.1.2.1.cmml">⁢</mo><mrow id="S4.SS1.p3.1.m1.1.2.3.2" xref="S4.SS1.p3.1.m1.1.2.cmml"><mo id="S4.SS1.p3.1.m1.1.2.3.2.1" stretchy="false" xref="S4.SS1.p3.1.m1.1.2.cmml">(</mo><mi id="S4.SS1.p3.1.m1.1.1" xref="S4.SS1.p3.1.m1.1.1.cmml">t</mi><mo id="S4.SS1.p3.1.m1.1.2.3.2.2" stretchy="false" xref="S4.SS1.p3.1.m1.1.2.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.SS1.p3.1.m1.1b"><apply id="S4.SS1.p3.1.m1.1.2.cmml" xref="S4.SS1.p3.1.m1.1.2"><times id="S4.SS1.p3.1.m1.1.2.1.cmml" xref="S4.SS1.p3.1.m1.1.2.1"></times><ci id="S4.SS1.p3.1.m1.1.2.2a.cmml" xref="S4.SS1.p3.1.m1.1.2.2"><mtext id="S4.SS1.p3.1.m1.1.2.2.cmml" xref="S4.SS1.p3.1.m1.1.2.2">step</mtext></ci><ci id="S4.SS1.p3.1.m1.1.1.cmml" xref="S4.SS1.p3.1.m1.1.1">𝑡</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p3.1.m1.1c">\text{step}(t)</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p3.1.m1.1d">step ( italic_t )</annotation></semantics></math> maps token <math alttext="t" class="ltx_Math" display="inline" id="S4.SS1.p3.2.m2.1"><semantics id="S4.SS1.p3.2.m2.1a"><mi id="S4.SS1.p3.2.m2.1.1" xref="S4.SS1.p3.2.m2.1.1.cmml">t</mi><annotation-xml encoding="MathML-Content" id="S4.SS1.p3.2.m2.1b"><ci id="S4.SS1.p3.2.m2.1.1.cmml" xref="S4.SS1.p3.2.m2.1.1">𝑡</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p3.2.m2.1c">t</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p3.2.m2.1d">italic_t</annotation></semantics></math> to its step index, and <math alttext="F(\cdot,\cdot)" class="ltx_Math" display="inline" id="S4.SS1.p3.3.m3.2"><semantics id="S4.SS1.p3.3.m3.2a"><mrow id="S4.SS1.p3.3.m3.2.3" xref="S4.SS1.p3.3.m3.2.3.cmml"><mi id="S4.SS1.p3.3.m3.2.3.2" xref="S4.SS1.p3.3.m3.2.3.2.cmml">F</mi><mo id="S4.SS1.p3.3.m3.2.3.1" xref="S4.SS1.p3.3.m3.2.3.1.cmml">⁢</mo><mrow id="S4.SS1.p3.3.m3.2.3.3.2" xref="S4.SS1.p3.3.m3.2.3.3.1.cmml"><mo id="S4.SS1.p3.3.m3.2.3.3.2.1" stretchy="false" xref="S4.SS1.p3.3.m3.2.3.3.1.cmml">(</mo><mo id="S4.SS1.p3.3.m3.1.1" lspace="0em" rspace="0em" xref="S4.SS1.p3.3.m3.1.1.cmml">⋅</mo><mo id="S4.SS1.p3.3.m3.2.3.3.2.2" rspace="0em" xref="S4.SS1.p3.3.m3.2.3.3.1.cmml">,</mo><mo id="S4.SS1.p3.3.m3.2.2" lspace="0em" rspace="0em" xref="S4.SS1.p3.3.m3.2.2.cmml">⋅</mo><mo id="S4.SS1.p3.3.m3.2.3.3.2.3" stretchy="false" xref="S4.SS1.p3.3.m3.2.3.3.1.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.SS1.p3.3.m3.2b"><apply id="S4.SS1.p3.3.m3.2.3.cmml" xref="S4.SS1.p3.3.m3.2.3"><times id="S4.SS1.p3.3.m3.2.3.1.cmml" xref="S4.SS1.p3.3.m3.2.3.1"></times><ci id="S4.SS1.p3.3.m3.2.3.2.cmml" xref="S4.SS1.p3.3.m3.2.3.2">𝐹</ci><interval closure="open" id="S4.SS1.p3.3.m3.2.3.3.1.cmml" xref="S4.SS1.p3.3.m3.2.3.3.2"><ci id="S4.SS1.p3.3.m3.1.1.cmml" xref="S4.SS1.p3.3.m3.1.1">⋅</ci><ci id="S4.SS1.p3.3.m3.2.2.cmml" xref="S4.SS1.p3.3.m3.2.2">⋅</ci></interval></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p3.3.m3.2c">F(\cdot,\cdot)</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p3.3.m3.2d">italic_F ( ⋅ , ⋅ )</annotation></semantics></math> measures step-wise potential difference.
<math alttext="\lambda" class="ltx_Math" display="inline" id="S4.SS1.p3.4.m4.1"><semantics id="S4.SS1.p3.4.m4.1a"><mi id="S4.SS1.p3.4.m4.1.1" xref="S4.SS1.p3.4.m4.1.1.cmml">λ</mi><annotation-xml encoding="MathML-Content" id="S4.SS1.p3.4.m4.1b"><ci id="S4.SS1.p3.4.m4.1.1.cmml" xref="S4.SS1.p3.4.m4.1.1">𝜆</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p3.4.m4.1c">\lambda</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p3.4.m4.1d">italic_λ</annotation></semantics></math> is a weighting coefficient.
To preserve policy invariance <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib22" title="">22</a>]</cite>, we define <math alttext="F" class="ltx_Math" display="inline" id="S4.SS1.p3.5.m5.1"><semantics id="S4.SS1.p3.5.m5.1a"><mi id="S4.SS1.p3.5.m5.1.1" xref="S4.SS1.p3.5.m5.1.1.cmml">F</mi><annotation-xml encoding="MathML-Content" id="S4.SS1.p3.5.m5.1b"><ci id="S4.SS1.p3.5.m5.1.1.cmml" xref="S4.SS1.p3.5.m5.1.1">𝐹</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p3.5.m5.1c">F</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p3.5.m5.1d">italic_F</annotation></semantics></math> as the difference of a real-valued potential function <math alttext="\varphi" class="ltx_Math" display="inline" id="S4.SS1.p3.6.m6.1"><semantics id="S4.SS1.p3.6.m6.1a"><mi id="S4.SS1.p3.6.m6.1.1" xref="S4.SS1.p3.6.m6.1.1.cmml">φ</mi><annotation-xml encoding="MathML-Content" id="S4.SS1.p3.6.m6.1b"><ci id="S4.SS1.p3.6.m6.1.1.cmml" xref="S4.SS1.p3.6.m6.1.1">𝜑</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p3.6.m6.1c">\varphi</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p3.6.m6.1d">italic_φ</annotation></semantics></math>:</p>
<table class="ltx_equation ltx_eqn_table" id="S4.E5">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="F(n,n-1)=\gamma\cdot\varphi(n)-\varphi(n-1)" class="ltx_Math" display="block" id="S4.E5.m1.4"><semantics id="S4.E5.m1.4a"><mrow id="S4.E5.m1.4.4" xref="S4.E5.m1.4.4.cmml"><mrow id="S4.E5.m1.3.3.1" xref="S4.E5.m1.3.3.1.cmml"><mi id="S4.E5.m1.3.3.1.3" xref="S4.E5.m1.3.3.1.3.cmml">F</mi><mo id="S4.E5.m1.3.3.1.2" xref="S4.E5.m1.3.3.1.2.cmml">⁢</mo><mrow id="S4.E5.m1.3.3.1.1.1" xref="S4.E5.m1.3.3.1.1.2.cmml"><mo id="S4.E5.m1.3.3.1.1.1.2" stretchy="false" xref="S4.E5.m1.3.3.1.1.2.cmml">(</mo><mi id="S4.E5.m1.1.1" xref="S4.E5.m1.1.1.cmml">n</mi><mo id="S4.E5.m1.3.3.1.1.1.3" xref="S4.E5.m1.3.3.1.1.2.cmml">,</mo><mrow id="S4.E5.m1.3.3.1.1.1.1" xref="S4.E5.m1.3.3.1.1.1.1.cmml"><mi id="S4.E5.m1.3.3.1.1.1.1.2" xref="S4.E5.m1.3.3.1.1.1.1.2.cmml">n</mi><mo id="S4.E5.m1.3.3.1.1.1.1.1" xref="S4.E5.m1.3.3.1.1.1.1.1.cmml">−</mo><mn id="S4.E5.m1.3.3.1.1.1.1.3" xref="S4.E5.m1.3.3.1.1.1.1.3.cmml">1</mn></mrow><mo id="S4.E5.m1.3.3.1.1.1.4" stretchy="false" xref="S4.E5.m1.3.3.1.1.2.cmml">)</mo></mrow></mrow><mo id="S4.E5.m1.4.4.3" xref="S4.E5.m1.4.4.3.cmml">=</mo><mrow id="S4.E5.m1.4.4.2" xref="S4.E5.m1.4.4.2.cmml"><mrow id="S4.E5.m1.4.4.2.3" xref="S4.E5.m1.4.4.2.3.cmml"><mrow id="S4.E5.m1.4.4.2.3.2" xref="S4.E5.m1.4.4.2.3.2.cmml"><mi id="S4.E5.m1.4.4.2.3.2.2" xref="S4.E5.m1.4.4.2.3.2.2.cmml">γ</mi><mo id="S4.E5.m1.4.4.2.3.2.1" lspace="0.222em" rspace="0.222em" xref="S4.E5.m1.4.4.2.3.2.1.cmml">⋅</mo><mi id="S4.E5.m1.4.4.2.3.2.3" xref="S4.E5.m1.4.4.2.3.2.3.cmml">φ</mi></mrow><mo id="S4.E5.m1.4.4.2.3.1" xref="S4.E5.m1.4.4.2.3.1.cmml">⁢</mo><mrow id="S4.E5.m1.4.4.2.3.3.2" xref="S4.E5.m1.4.4.2.3.cmml"><mo id="S4.E5.m1.4.4.2.3.3.2.1" stretchy="false" xref="S4.E5.m1.4.4.2.3.cmml">(</mo><mi id="S4.E5.m1.2.2" xref="S4.E5.m1.2.2.cmml">n</mi><mo id="S4.E5.m1.4.4.2.3.3.2.2" stretchy="false" xref="S4.E5.m1.4.4.2.3.cmml">)</mo></mrow></mrow><mo id="S4.E5.m1.4.4.2.2" xref="S4.E5.m1.4.4.2.2.cmml">−</mo><mrow id="S4.E5.m1.4.4.2.1" xref="S4.E5.m1.4.4.2.1.cmml"><mi id="S4.E5.m1.4.4.2.1.3" xref="S4.E5.m1.4.4.2.1.3.cmml">φ</mi><mo id="S4.E5.m1.4.4.2.1.2" xref="S4.E5.m1.4.4.2.1.2.cmml">⁢</mo><mrow id="S4.E5.m1.4.4.2.1.1.1" xref="S4.E5.m1.4.4.2.1.1.1.1.cmml"><mo id="S4.E5.m1.4.4.2.1.1.1.2" stretchy="false" xref="S4.E5.m1.4.4.2.1.1.1.1.cmml">(</mo><mrow id="S4.E5.m1.4.4.2.1.1.1.1" xref="S4.E5.m1.4.4.2.1.1.1.1.cmml"><mi id="S4.E5.m1.4.4.2.1.1.1.1.2" xref="S4.E5.m1.4.4.2.1.1.1.1.2.cmml">n</mi><mo id="S4.E5.m1.4.4.2.1.1.1.1.1" xref="S4.E5.m1.4.4.2.1.1.1.1.1.cmml">−</mo><mn id="S4.E5.m1.4.4.2.1.1.1.1.3" xref="S4.E5.m1.4.4.2.1.1.1.1.3.cmml">1</mn></mrow><mo id="S4.E5.m1.4.4.2.1.1.1.3" stretchy="false" xref="S4.E5.m1.4.4.2.1.1.1.1.cmml">)</mo></mrow></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.E5.m1.4b"><apply id="S4.E5.m1.4.4.cmml" xref="S4.E5.m1.4.4"><eq id="S4.E5.m1.4.4.3.cmml" xref="S4.E5.m1.4.4.3"></eq><apply id="S4.E5.m1.3.3.1.cmml" xref="S4.E5.m1.3.3.1"><times id="S4.E5.m1.3.3.1.2.cmml" xref="S4.E5.m1.3.3.1.2"></times><ci id="S4.E5.m1.3.3.1.3.cmml" xref="S4.E5.m1.3.3.1.3">𝐹</ci><interval closure="open" id="S4.E5.m1.3.3.1.1.2.cmml" xref="S4.E5.m1.3.3.1.1.1"><ci id="S4.E5.m1.1.1.cmml" xref="S4.E5.m1.1.1">𝑛</ci><apply id="S4.E5.m1.3.3.1.1.1.1.cmml" xref="S4.E5.m1.3.3.1.1.1.1"><minus id="S4.E5.m1.3.3.1.1.1.1.1.cmml" xref="S4.E5.m1.3.3.1.1.1.1.1"></minus><ci id="S4.E5.m1.3.3.1.1.1.1.2.cmml" xref="S4.E5.m1.3.3.1.1.1.1.2">𝑛</ci><cn id="S4.E5.m1.3.3.1.1.1.1.3.cmml" type="integer" xref="S4.E5.m1.3.3.1.1.1.1.3">1</cn></apply></interval></apply><apply id="S4.E5.m1.4.4.2.cmml" xref="S4.E5.m1.4.4.2"><minus id="S4.E5.m1.4.4.2.2.cmml" xref="S4.E5.m1.4.4.2.2"></minus><apply id="S4.E5.m1.4.4.2.3.cmml" xref="S4.E5.m1.4.4.2.3"><times id="S4.E5.m1.4.4.2.3.1.cmml" xref="S4.E5.m1.4.4.2.3.1"></times><apply id="S4.E5.m1.4.4.2.3.2.cmml" xref="S4.E5.m1.4.4.2.3.2"><ci id="S4.E5.m1.4.4.2.3.2.1.cmml" xref="S4.E5.m1.4.4.2.3.2.1">⋅</ci><ci id="S4.E5.m1.4.4.2.3.2.2.cmml" xref="S4.E5.m1.4.4.2.3.2.2">𝛾</ci><ci id="S4.E5.m1.4.4.2.3.2.3.cmml" xref="S4.E5.m1.4.4.2.3.2.3">𝜑</ci></apply><ci id="S4.E5.m1.2.2.cmml" xref="S4.E5.m1.2.2">𝑛</ci></apply><apply id="S4.E5.m1.4.4.2.1.cmml" xref="S4.E5.m1.4.4.2.1"><times id="S4.E5.m1.4.4.2.1.2.cmml" xref="S4.E5.m1.4.4.2.1.2"></times><ci id="S4.E5.m1.4.4.2.1.3.cmml" xref="S4.E5.m1.4.4.2.1.3">𝜑</ci><apply id="S4.E5.m1.4.4.2.1.1.1.1.cmml" xref="S4.E5.m1.4.4.2.1.1.1"><minus id="S4.E5.m1.4.4.2.1.1.1.1.1.cmml" xref="S4.E5.m1.4.4.2.1.1.1.1.1"></minus><ci id="S4.E5.m1.4.4.2.1.1.1.1.2.cmml" xref="S4.E5.m1.4.4.2.1.1.1.1.2">𝑛</ci><cn id="S4.E5.m1.4.4.2.1.1.1.1.3.cmml" type="integer" xref="S4.E5.m1.4.4.2.1.1.1.1.3">1</cn></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E5.m1.4c">F(n,n-1)=\gamma\cdot\varphi(n)-\varphi(n-1)</annotation><annotation encoding="application/x-llamapun" id="S4.E5.m1.4d">italic_F ( italic_n , italic_n - 1 ) = italic_γ ⋅ italic_φ ( italic_n ) - italic_φ ( italic_n - 1 )</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(5)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS1.p3.7">with <math alttext="\gamma=1" class="ltx_Math" display="inline" id="S4.SS1.p3.7.m1.1"><semantics id="S4.SS1.p3.7.m1.1a"><mrow id="S4.SS1.p3.7.m1.1.1" xref="S4.SS1.p3.7.m1.1.1.cmml"><mi id="S4.SS1.p3.7.m1.1.1.2" xref="S4.SS1.p3.7.m1.1.1.2.cmml">γ</mi><mo id="S4.SS1.p3.7.m1.1.1.1" xref="S4.SS1.p3.7.m1.1.1.1.cmml">=</mo><mn id="S4.SS1.p3.7.m1.1.1.3" xref="S4.SS1.p3.7.m1.1.1.3.cmml">1</mn></mrow><annotation-xml encoding="MathML-Content" id="S4.SS1.p3.7.m1.1b"><apply id="S4.SS1.p3.7.m1.1.1.cmml" xref="S4.SS1.p3.7.m1.1.1"><eq id="S4.SS1.p3.7.m1.1.1.1.cmml" xref="S4.SS1.p3.7.m1.1.1.1"></eq><ci id="S4.SS1.p3.7.m1.1.1.2.cmml" xref="S4.SS1.p3.7.m1.1.1.2">𝛾</ci><cn id="S4.SS1.p3.7.m1.1.1.3.cmml" type="integer" xref="S4.SS1.p3.7.m1.1.1.3">1</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS1.p3.7.m1.1c">\gamma=1</annotation><annotation encoding="application/x-llamapun" id="S4.SS1.p3.7.m1.1d">italic_γ = 1</annotation></semantics></math>, assuming equal importance across steps.</p>
</div>
<div class="ltx_para" id="S4.SS1.p4">
<p class="ltx_p" id="S4.SS1.p4.1"><span class="ltx_text ltx_font_bold" id="S4.SS1.p4.1.1">Final Advantage.</span>
The final advantage used for policy optimization becomes:</p>
<table class="ltx_equation ltx_eqn_table" id="S4.E6">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\hat{A}_{i,t}=\tilde{r}_{i}+\lambda\left(\varphi(\text{step}(t))-\varphi(\text%
{step}(t)-1)\right)" class="ltx_Math" display="block" id="S4.E6.m1.5"><semantics id="S4.E6.m1.5a"><mrow id="S4.E6.m1.5.5" xref="S4.E6.m1.5.5.cmml"><msub id="S4.E6.m1.5.5.3" xref="S4.E6.m1.5.5.3.cmml"><mover accent="true" id="S4.E6.m1.5.5.3.2" xref="S4.E6.m1.5.5.3.2.cmml"><mi id="S4.E6.m1.5.5.3.2.2" xref="S4.E6.m1.5.5.3.2.2.cmml">A</mi><mo id="S4.E6.m1.5.5.3.2.1" xref="S4.E6.m1.5.5.3.2.1.cmml">^</mo></mover><mrow id="S4.E6.m1.2.2.2.4" xref="S4.E6.m1.2.2.2.3.cmml"><mi id="S4.E6.m1.1.1.1.1" xref="S4.E6.m1.1.1.1.1.cmml">i</mi><mo id="S4.E6.m1.2.2.2.4.1" xref="S4.E6.m1.2.2.2.3.cmml">,</mo><mi id="S4.E6.m1.2.2.2.2" xref="S4.E6.m1.2.2.2.2.cmml">t</mi></mrow></msub><mo id="S4.E6.m1.5.5.2" xref="S4.E6.m1.5.5.2.cmml">=</mo><mrow id="S4.E6.m1.5.5.1" xref="S4.E6.m1.5.5.1.cmml"><msub id="S4.E6.m1.5.5.1.3" xref="S4.E6.m1.5.5.1.3.cmml"><mover accent="true" id="S4.E6.m1.5.5.1.3.2" xref="S4.E6.m1.5.5.1.3.2.cmml"><mi id="S4.E6.m1.5.5.1.3.2.2" xref="S4.E6.m1.5.5.1.3.2.2.cmml">r</mi><mo id="S4.E6.m1.5.5.1.3.2.1" xref="S4.E6.m1.5.5.1.3.2.1.cmml">~</mo></mover><mi id="S4.E6.m1.5.5.1.3.3" xref="S4.E6.m1.5.5.1.3.3.cmml">i</mi></msub><mo id="S4.E6.m1.5.5.1.2" xref="S4.E6.m1.5.5.1.2.cmml">+</mo><mrow id="S4.E6.m1.5.5.1.1" xref="S4.E6.m1.5.5.1.1.cmml"><mi id="S4.E6.m1.5.5.1.1.3" xref="S4.E6.m1.5.5.1.1.3.cmml">λ</mi><mo id="S4.E6.m1.5.5.1.1.2" xref="S4.E6.m1.5.5.1.1.2.cmml">⁢</mo><mrow id="S4.E6.m1.5.5.1.1.1.1" xref="S4.E6.m1.5.5.1.1.1.1.1.cmml"><mo id="S4.E6.m1.5.5.1.1.1.1.2" xref="S4.E6.m1.5.5.1.1.1.1.1.cmml">(</mo><mrow id="S4.E6.m1.5.5.1.1.1.1.1" xref="S4.E6.m1.5.5.1.1.1.1.1.cmml"><mrow id="S4.E6.m1.5.5.1.1.1.1.1.1" xref="S4.E6.m1.5.5.1.1.1.1.1.1.cmml"><mi id="S4.E6.m1.5.5.1.1.1.1.1.1.3" xref="S4.E6.m1.5.5.1.1.1.1.1.1.3.cmml">φ</mi><mo id="S4.E6.m1.5.5.1.1.1.1.1.1.2" xref="S4.E6.m1.5.5.1.1.1.1.1.1.2.cmml">⁢</mo><mrow id="S4.E6.m1.5.5.1.1.1.1.1.1.1.1" xref="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.cmml"><mo id="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.2" stretchy="false" xref="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.cmml">(</mo><mrow id="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1" xref="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.cmml"><mtext id="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.2" xref="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.2a.cmml">step</mtext><mo id="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.1" xref="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.1.cmml">⁢</mo><mrow id="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.3.2" xref="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.cmml"><mo id="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.3.2.1" stretchy="false" xref="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.cmml">(</mo><mi id="S4.E6.m1.3.3" xref="S4.E6.m1.3.3.cmml">t</mi><mo id="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.3.2.2" stretchy="false" xref="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.3" stretchy="false" xref="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="S4.E6.m1.5.5.1.1.1.1.1.3" xref="S4.E6.m1.5.5.1.1.1.1.1.3.cmml">−</mo><mrow id="S4.E6.m1.5.5.1.1.1.1.1.2" xref="S4.E6.m1.5.5.1.1.1.1.1.2.cmml"><mi id="S4.E6.m1.5.5.1.1.1.1.1.2.3" xref="S4.E6.m1.5.5.1.1.1.1.1.2.3.cmml">φ</mi><mo id="S4.E6.m1.5.5.1.1.1.1.1.2.2" xref="S4.E6.m1.5.5.1.1.1.1.1.2.2.cmml">⁢</mo><mrow id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.cmml"><mo id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.2" stretchy="false" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.cmml">(</mo><mrow id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.cmml"><mrow id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.cmml"><mtext id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.2" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.2a.cmml">step</mtext><mo id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.1" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.1.cmml">⁢</mo><mrow id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.3.2" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.cmml"><mo id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.3.2.1" stretchy="false" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.cmml">(</mo><mi id="S4.E6.m1.4.4" xref="S4.E6.m1.4.4.cmml">t</mi><mo id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.3.2.2" stretchy="false" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.cmml">)</mo></mrow></mrow><mo id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.1" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.1.cmml">−</mo><mn id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.3" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.3.cmml">1</mn></mrow><mo id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.3" stretchy="false" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.cmml">)</mo></mrow></mrow></mrow><mo id="S4.E6.m1.5.5.1.1.1.1.3" xref="S4.E6.m1.5.5.1.1.1.1.1.cmml">)</mo></mrow></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.E6.m1.5b"><apply id="S4.E6.m1.5.5.cmml" xref="S4.E6.m1.5.5"><eq id="S4.E6.m1.5.5.2.cmml" xref="S4.E6.m1.5.5.2"></eq><apply id="S4.E6.m1.5.5.3.cmml" xref="S4.E6.m1.5.5.3"><csymbol cd="ambiguous" id="S4.E6.m1.5.5.3.1.cmml" xref="S4.E6.m1.5.5.3">subscript</csymbol><apply id="S4.E6.m1.5.5.3.2.cmml" xref="S4.E6.m1.5.5.3.2"><ci id="S4.E6.m1.5.5.3.2.1.cmml" xref="S4.E6.m1.5.5.3.2.1">^</ci><ci id="S4.E6.m1.5.5.3.2.2.cmml" xref="S4.E6.m1.5.5.3.2.2">𝐴</ci></apply><list id="S4.E6.m1.2.2.2.3.cmml" xref="S4.E6.m1.2.2.2.4"><ci id="S4.E6.m1.1.1.1.1.cmml" xref="S4.E6.m1.1.1.1.1">𝑖</ci><ci id="S4.E6.m1.2.2.2.2.cmml" xref="S4.E6.m1.2.2.2.2">𝑡</ci></list></apply><apply id="S4.E6.m1.5.5.1.cmml" xref="S4.E6.m1.5.5.1"><plus id="S4.E6.m1.5.5.1.2.cmml" xref="S4.E6.m1.5.5.1.2"></plus><apply id="S4.E6.m1.5.5.1.3.cmml" xref="S4.E6.m1.5.5.1.3"><csymbol cd="ambiguous" id="S4.E6.m1.5.5.1.3.1.cmml" xref="S4.E6.m1.5.5.1.3">subscript</csymbol><apply id="S4.E6.m1.5.5.1.3.2.cmml" xref="S4.E6.m1.5.5.1.3.2"><ci id="S4.E6.m1.5.5.1.3.2.1.cmml" xref="S4.E6.m1.5.5.1.3.2.1">~</ci><ci id="S4.E6.m1.5.5.1.3.2.2.cmml" xref="S4.E6.m1.5.5.1.3.2.2">𝑟</ci></apply><ci id="S4.E6.m1.5.5.1.3.3.cmml" xref="S4.E6.m1.5.5.1.3.3">𝑖</ci></apply><apply id="S4.E6.m1.5.5.1.1.cmml" xref="S4.E6.m1.5.5.1.1"><times id="S4.E6.m1.5.5.1.1.2.cmml" xref="S4.E6.m1.5.5.1.1.2"></times><ci id="S4.E6.m1.5.5.1.1.3.cmml" xref="S4.E6.m1.5.5.1.1.3">𝜆</ci><apply id="S4.E6.m1.5.5.1.1.1.1.1.cmml" xref="S4.E6.m1.5.5.1.1.1.1"><minus id="S4.E6.m1.5.5.1.1.1.1.1.3.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.3"></minus><apply id="S4.E6.m1.5.5.1.1.1.1.1.1.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.1"><times id="S4.E6.m1.5.5.1.1.1.1.1.1.2.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.1.2"></times><ci id="S4.E6.m1.5.5.1.1.1.1.1.1.3.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.1.3">𝜑</ci><apply id="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.1.1.1"><times id="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.1.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.1"></times><ci id="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.2a.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.2"><mtext id="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.2.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.1.1.1.1.2">step</mtext></ci><ci id="S4.E6.m1.3.3.cmml" xref="S4.E6.m1.3.3">𝑡</ci></apply></apply><apply id="S4.E6.m1.5.5.1.1.1.1.1.2.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.2"><times id="S4.E6.m1.5.5.1.1.1.1.1.2.2.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.2.2"></times><ci id="S4.E6.m1.5.5.1.1.1.1.1.2.3.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.2.3">𝜑</ci><apply id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1"><minus id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.1.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.1"></minus><apply id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2"><times id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.1.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.1"></times><ci id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.2a.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.2"><mtext id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.2.cmml" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.2.2">step</mtext></ci><ci id="S4.E6.m1.4.4.cmml" xref="S4.E6.m1.4.4">𝑡</ci></apply><cn id="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.3.cmml" type="integer" xref="S4.E6.m1.5.5.1.1.1.1.1.2.1.1.1.3">1</cn></apply></apply></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E6.m1.5c">\hat{A}_{i,t}=\tilde{r}_{i}+\lambda\left(\varphi(\text{step}(t))-\varphi(\text%
{step}(t)-1)\right)</annotation><annotation encoding="application/x-llamapun" id="S4.E6.m1.5d">over^ start_ARG italic_A end_ARG start_POSTSUBSCRIPT italic_i , italic_t end_POSTSUBSCRIPT = over~ start_ARG italic_r end_ARG start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT + italic_λ ( italic_φ ( step ( italic_t ) ) - italic_φ ( step ( italic_t ) - 1 ) )</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(6)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS1.p4.2">This formulation delivers dense training signals aligned with intermediate decision quality <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib23" title="">23</a>]</cite>, encouraging token-level improvements toward globally effective prescriptions.</p>
</div>
</section>
<section class="ltx_subsection" id="S4.SS2">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.2 </span>Fine-grained Alignment for Medication Recommendation</h3>
<div class="ltx_para" id="S4.SS2.p1">
<p class="ltx_p" id="S4.SS2.p1.5">We apply step-wise GRPO to our list-wise medication recommendation task by treating each decision step as a span representing a single medication.
We define:</p>
<ul class="ltx_itemize" id="S4.I1">
<li class="ltx_item" id="S4.I1.i1" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="S4.I1.i1.p1">
<p class="ltx_p" id="S4.I1.i1.p1.2"><em class="ltx_emph ltx_font_italic" id="S4.I1.i1.p1.2.1">State</em> <math alttext="s_{n}" class="ltx_Math" display="inline" id="S4.I1.i1.p1.1.m1.1"><semantics id="S4.I1.i1.p1.1.m1.1a"><msub id="S4.I1.i1.p1.1.m1.1.1" xref="S4.I1.i1.p1.1.m1.1.1.cmml"><mi id="S4.I1.i1.p1.1.m1.1.1.2" xref="S4.I1.i1.p1.1.m1.1.1.2.cmml">s</mi><mi id="S4.I1.i1.p1.1.m1.1.1.3" xref="S4.I1.i1.p1.1.m1.1.1.3.cmml">n</mi></msub><annotation-xml encoding="MathML-Content" id="S4.I1.i1.p1.1.m1.1b"><apply id="S4.I1.i1.p1.1.m1.1.1.cmml" xref="S4.I1.i1.p1.1.m1.1.1"><csymbol cd="ambiguous" id="S4.I1.i1.p1.1.m1.1.1.1.cmml" xref="S4.I1.i1.p1.1.m1.1.1">subscript</csymbol><ci id="S4.I1.i1.p1.1.m1.1.1.2.cmml" xref="S4.I1.i1.p1.1.m1.1.1.2">𝑠</ci><ci id="S4.I1.i1.p1.1.m1.1.1.3.cmml" xref="S4.I1.i1.p1.1.m1.1.1.3">𝑛</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.I1.i1.p1.1.m1.1c">s_{n}</annotation><annotation encoding="application/x-llamapun" id="S4.I1.i1.p1.1.m1.1d">italic_s start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT</annotation></semantics></math>: the patient profile and current medication set <math alttext="\mathcal{M}_{n}" class="ltx_Math" display="inline" id="S4.I1.i1.p1.2.m2.1"><semantics id="S4.I1.i1.p1.2.m2.1a"><msub id="S4.I1.i1.p1.2.m2.1.1" xref="S4.I1.i1.p1.2.m2.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.I1.i1.p1.2.m2.1.1.2" xref="S4.I1.i1.p1.2.m2.1.1.2.cmml">ℳ</mi><mi id="S4.I1.i1.p1.2.m2.1.1.3" xref="S4.I1.i1.p1.2.m2.1.1.3.cmml">n</mi></msub><annotation-xml encoding="MathML-Content" id="S4.I1.i1.p1.2.m2.1b"><apply id="S4.I1.i1.p1.2.m2.1.1.cmml" xref="S4.I1.i1.p1.2.m2.1.1"><csymbol cd="ambiguous" id="S4.I1.i1.p1.2.m2.1.1.1.cmml" xref="S4.I1.i1.p1.2.m2.1.1">subscript</csymbol><ci id="S4.I1.i1.p1.2.m2.1.1.2.cmml" xref="S4.I1.i1.p1.2.m2.1.1.2">ℳ</ci><ci id="S4.I1.i1.p1.2.m2.1.1.3.cmml" xref="S4.I1.i1.p1.2.m2.1.1.3">𝑛</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.I1.i1.p1.2.m2.1c">\mathcal{M}_{n}</annotation><annotation encoding="application/x-llamapun" id="S4.I1.i1.p1.2.m2.1d">caligraphic_M start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT</annotation></semantics></math>.</p>
</div>
</li>
<li class="ltx_item" id="S4.I1.i2" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="S4.I1.i2.p1">
<p class="ltx_p" id="S4.I1.i2.p1.2"><em class="ltx_emph ltx_font_italic" id="S4.I1.i2.p1.2.1">Action</em> <math alttext="a_{n}" class="ltx_Math" display="inline" id="S4.I1.i2.p1.1.m1.1"><semantics id="S4.I1.i2.p1.1.m1.1a"><msub id="S4.I1.i2.p1.1.m1.1.1" xref="S4.I1.i2.p1.1.m1.1.1.cmml"><mi id="S4.I1.i2.p1.1.m1.1.1.2" xref="S4.I1.i2.p1.1.m1.1.1.2.cmml">a</mi><mi id="S4.I1.i2.p1.1.m1.1.1.3" xref="S4.I1.i2.p1.1.m1.1.1.3.cmml">n</mi></msub><annotation-xml encoding="MathML-Content" id="S4.I1.i2.p1.1.m1.1b"><apply id="S4.I1.i2.p1.1.m1.1.1.cmml" xref="S4.I1.i2.p1.1.m1.1.1"><csymbol cd="ambiguous" id="S4.I1.i2.p1.1.m1.1.1.1.cmml" xref="S4.I1.i2.p1.1.m1.1.1">subscript</csymbol><ci id="S4.I1.i2.p1.1.m1.1.1.2.cmml" xref="S4.I1.i2.p1.1.m1.1.1.2">𝑎</ci><ci id="S4.I1.i2.p1.1.m1.1.1.3.cmml" xref="S4.I1.i2.p1.1.m1.1.1.3">𝑛</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.I1.i2.p1.1.m1.1c">a_{n}</annotation><annotation encoding="application/x-llamapun" id="S4.I1.i2.p1.1.m1.1d">italic_a start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT</annotation></semantics></math>: adding or removing a medication <math alttext="m_{n}" class="ltx_Math" display="inline" id="S4.I1.i2.p1.2.m2.1"><semantics id="S4.I1.i2.p1.2.m2.1a"><msub id="S4.I1.i2.p1.2.m2.1.1" xref="S4.I1.i2.p1.2.m2.1.1.cmml"><mi id="S4.I1.i2.p1.2.m2.1.1.2" xref="S4.I1.i2.p1.2.m2.1.1.2.cmml">m</mi><mi id="S4.I1.i2.p1.2.m2.1.1.3" xref="S4.I1.i2.p1.2.m2.1.1.3.cmml">n</mi></msub><annotation-xml encoding="MathML-Content" id="S4.I1.i2.p1.2.m2.1b"><apply id="S4.I1.i2.p1.2.m2.1.1.cmml" xref="S4.I1.i2.p1.2.m2.1.1"><csymbol cd="ambiguous" id="S4.I1.i2.p1.2.m2.1.1.1.cmml" xref="S4.I1.i2.p1.2.m2.1.1">subscript</csymbol><ci id="S4.I1.i2.p1.2.m2.1.1.2.cmml" xref="S4.I1.i2.p1.2.m2.1.1.2">𝑚</ci><ci id="S4.I1.i2.p1.2.m2.1.1.3.cmml" xref="S4.I1.i2.p1.2.m2.1.1.3">𝑛</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.I1.i2.p1.2.m2.1c">m_{n}</annotation><annotation encoding="application/x-llamapun" id="S4.I1.i2.p1.2.m2.1d">italic_m start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT</annotation></semantics></math>.</p>
</div>
</li>
</ul>
<p class="ltx_p" id="S4.SS2.p1.6">The state transition follows:</p>
<table class="ltx_equation ltx_eqn_table" id="S4.E7">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\mathcal{M}_{n+1}=\begin{cases}\mathcal{M}_{n}\cup\{m_{n}\},&amp;\text{if adding},%
\\
\mathcal{M}_{n}\setminus\{m_{n}\},&amp;\text{if removing}.\end{cases}" class="ltx_Math" display="block" id="S4.E7.m1.4"><semantics id="S4.E7.m1.4a"><mrow id="S4.E7.m1.4.5" xref="S4.E7.m1.4.5.cmml"><msub id="S4.E7.m1.4.5.2" xref="S4.E7.m1.4.5.2.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E7.m1.4.5.2.2" xref="S4.E7.m1.4.5.2.2.cmml">ℳ</mi><mrow id="S4.E7.m1.4.5.2.3" xref="S4.E7.m1.4.5.2.3.cmml"><mi id="S4.E7.m1.4.5.2.3.2" xref="S4.E7.m1.4.5.2.3.2.cmml">n</mi><mo id="S4.E7.m1.4.5.2.3.1" xref="S4.E7.m1.4.5.2.3.1.cmml">+</mo><mn id="S4.E7.m1.4.5.2.3.3" xref="S4.E7.m1.4.5.2.3.3.cmml">1</mn></mrow></msub><mo id="S4.E7.m1.4.5.1" xref="S4.E7.m1.4.5.1.cmml">=</mo><mrow id="S4.E7.m1.4.4" xref="S4.E7.m1.4.5.3.1.cmml"><mo id="S4.E7.m1.4.4.5" xref="S4.E7.m1.4.5.3.1.1.cmml">{</mo><mtable columnspacing="5pt" displaystyle="true" id="S4.E7.m1.4.4.4" rowspacing="0pt" xref="S4.E7.m1.4.5.3.1.cmml"><mtr id="S4.E7.m1.4.4.4a" xref="S4.E7.m1.4.5.3.1.cmml"><mtd class="ltx_align_left" columnalign="left" id="S4.E7.m1.4.4.4b" xref="S4.E7.m1.4.5.3.1.cmml"><mrow id="S4.E7.m1.1.1.1.1.1.1.1" xref="S4.E7.m1.1.1.1.1.1.1.1.1.cmml"><mrow id="S4.E7.m1.1.1.1.1.1.1.1.1" xref="S4.E7.m1.1.1.1.1.1.1.1.1.cmml"><msub id="S4.E7.m1.1.1.1.1.1.1.1.1.3" xref="S4.E7.m1.1.1.1.1.1.1.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E7.m1.1.1.1.1.1.1.1.1.3.2" xref="S4.E7.m1.1.1.1.1.1.1.1.1.3.2.cmml">ℳ</mi><mi id="S4.E7.m1.1.1.1.1.1.1.1.1.3.3" xref="S4.E7.m1.1.1.1.1.1.1.1.1.3.3.cmml">n</mi></msub><mo id="S4.E7.m1.1.1.1.1.1.1.1.1.2" xref="S4.E7.m1.1.1.1.1.1.1.1.1.2.cmml">∪</mo><mrow id="S4.E7.m1.1.1.1.1.1.1.1.1.1.1" xref="S4.E7.m1.1.1.1.1.1.1.1.1.1.2.cmml"><mo id="S4.E7.m1.1.1.1.1.1.1.1.1.1.1.2" stretchy="false" xref="S4.E7.m1.1.1.1.1.1.1.1.1.1.2.cmml">{</mo><msub id="S4.E7.m1.1.1.1.1.1.1.1.1.1.1.1" xref="S4.E7.m1.1.1.1.1.1.1.1.1.1.1.1.cmml"><mi id="S4.E7.m1.1.1.1.1.1.1.1.1.1.1.1.2" xref="S4.E7.m1.1.1.1.1.1.1.1.1.1.1.1.2.cmml">m</mi><mi id="S4.E7.m1.1.1.1.1.1.1.1.1.1.1.1.3" xref="S4.E7.m1.1.1.1.1.1.1.1.1.1.1.1.3.cmml">n</mi></msub><mo id="S4.E7.m1.1.1.1.1.1.1.1.1.1.1.3" stretchy="false" xref="S4.E7.m1.1.1.1.1.1.1.1.1.1.2.cmml">}</mo></mrow></mrow><mo id="S4.E7.m1.1.1.1.1.1.1.1.2" xref="S4.E7.m1.1.1.1.1.1.1.1.1.cmml">,</mo></mrow></mtd><mtd class="ltx_align_left" columnalign="left" id="S4.E7.m1.4.4.4c" xref="S4.E7.m1.4.5.3.1.cmml"><mrow id="S4.E7.m1.2.2.2.2.2.1.3" xref="S4.E7.m1.2.2.2.2.2.1.1a.cmml"><mtext id="S4.E7.m1.2.2.2.2.2.1.1" xref="S4.E7.m1.2.2.2.2.2.1.1.cmml">if adding</mtext><mo id="S4.E7.m1.2.2.2.2.2.1.3.1" xref="S4.E7.m1.2.2.2.2.2.1.1a.cmml">,</mo></mrow></mtd></mtr><mtr id="S4.E7.m1.4.4.4d" xref="S4.E7.m1.4.5.3.1.cmml"><mtd class="ltx_align_left" columnalign="left" id="S4.E7.m1.4.4.4e" xref="S4.E7.m1.4.5.3.1.cmml"><mrow id="S4.E7.m1.3.3.3.3.1.1.1" xref="S4.E7.m1.3.3.3.3.1.1.1.1.cmml"><mrow id="S4.E7.m1.3.3.3.3.1.1.1.1" xref="S4.E7.m1.3.3.3.3.1.1.1.1.cmml"><msub id="S4.E7.m1.3.3.3.3.1.1.1.1.3" xref="S4.E7.m1.3.3.3.3.1.1.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E7.m1.3.3.3.3.1.1.1.1.3.2" xref="S4.E7.m1.3.3.3.3.1.1.1.1.3.2.cmml">ℳ</mi><mi id="S4.E7.m1.3.3.3.3.1.1.1.1.3.3" xref="S4.E7.m1.3.3.3.3.1.1.1.1.3.3.cmml">n</mi></msub><mo id="S4.E7.m1.3.3.3.3.1.1.1.1.2" xref="S4.E7.m1.3.3.3.3.1.1.1.1.2.cmml">∖</mo><mrow id="S4.E7.m1.3.3.3.3.1.1.1.1.1.1" xref="S4.E7.m1.3.3.3.3.1.1.1.1.1.2.cmml"><mo id="S4.E7.m1.3.3.3.3.1.1.1.1.1.1.2" stretchy="false" xref="S4.E7.m1.3.3.3.3.1.1.1.1.1.2.cmml">{</mo><msub id="S4.E7.m1.3.3.3.3.1.1.1.1.1.1.1" xref="S4.E7.m1.3.3.3.3.1.1.1.1.1.1.1.cmml"><mi id="S4.E7.m1.3.3.3.3.1.1.1.1.1.1.1.2" xref="S4.E7.m1.3.3.3.3.1.1.1.1.1.1.1.2.cmml">m</mi><mi id="S4.E7.m1.3.3.3.3.1.1.1.1.1.1.1.3" xref="S4.E7.m1.3.3.3.3.1.1.1.1.1.1.1.3.cmml">n</mi></msub><mo id="S4.E7.m1.3.3.3.3.1.1.1.1.1.1.3" stretchy="false" xref="S4.E7.m1.3.3.3.3.1.1.1.1.1.2.cmml">}</mo></mrow></mrow><mo id="S4.E7.m1.3.3.3.3.1.1.1.2" xref="S4.E7.m1.3.3.3.3.1.1.1.1.cmml">,</mo></mrow></mtd><mtd class="ltx_align_left" columnalign="left" id="S4.E7.m1.4.4.4f" xref="S4.E7.m1.4.5.3.1.cmml"><mrow id="S4.E7.m1.4.4.4.4.2.1.3" xref="S4.E7.m1.4.4.4.4.2.1.1a.cmml"><mtext id="S4.E7.m1.4.4.4.4.2.1.1" xref="S4.E7.m1.4.4.4.4.2.1.1.cmml">if removing</mtext><mo id="S4.E7.m1.4.4.4.4.2.1.3.1" lspace="0em" xref="S4.E7.m1.4.4.4.4.2.1.1a.cmml">.</mo></mrow></mtd></mtr></mtable></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.E7.m1.4b"><apply id="S4.E7.m1.4.5.cmml" xref="S4.E7.m1.4.5"><eq id="S4.E7.m1.4.5.1.cmml" xref="S4.E7.m1.4.5.1"></eq><apply id="S4.E7.m1.4.5.2.cmml" xref="S4.E7.m1.4.5.2"><csymbol cd="ambiguous" id="S4.E7.m1.4.5.2.1.cmml" xref="S4.E7.m1.4.5.2">subscript</csymbol><ci id="S4.E7.m1.4.5.2.2.cmml" xref="S4.E7.m1.4.5.2.2">ℳ</ci><apply id="S4.E7.m1.4.5.2.3.cmml" xref="S4.E7.m1.4.5.2.3"><plus id="S4.E7.m1.4.5.2.3.1.cmml" xref="S4.E7.m1.4.5.2.3.1"></plus><ci id="S4.E7.m1.4.5.2.3.2.cmml" xref="S4.E7.m1.4.5.2.3.2">𝑛</ci><cn id="S4.E7.m1.4.5.2.3.3.cmml" type="integer" xref="S4.E7.m1.4.5.2.3.3">1</cn></apply></apply><apply id="S4.E7.m1.4.5.3.1.cmml" xref="S4.E7.m1.4.4"><csymbol cd="latexml" id="S4.E7.m1.4.5.3.1.1.cmml" xref="S4.E7.m1.4.4.5">cases</csymbol><apply id="S4.E7.m1.1.1.1.1.1.1.1.1.cmml" xref="S4.E7.m1.1.1.1.1.1.1.1"><union id="S4.E7.m1.1.1.1.1.1.1.1.1.2.cmml" xref="S4.E7.m1.1.1.1.1.1.1.1.1.2"></union><apply id="S4.E7.m1.1.1.1.1.1.1.1.1.3.cmml" xref="S4.E7.m1.1.1.1.1.1.1.1.1.3"><csymbol cd="ambiguous" id="S4.E7.m1.1.1.1.1.1.1.1.1.3.1.cmml" xref="S4.E7.m1.1.1.1.1.1.1.1.1.3">subscript</csymbol><ci id="S4.E7.m1.1.1.1.1.1.1.1.1.3.2.cmml" xref="S4.E7.m1.1.1.1.1.1.1.1.1.3.2">ℳ</ci><ci id="S4.E7.m1.1.1.1.1.1.1.1.1.3.3.cmml" xref="S4.E7.m1.1.1.1.1.1.1.1.1.3.3">𝑛</ci></apply><set id="S4.E7.m1.1.1.1.1.1.1.1.1.1.2.cmml" xref="S4.E7.m1.1.1.1.1.1.1.1.1.1.1"><apply id="S4.E7.m1.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="S4.E7.m1.1.1.1.1.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.E7.m1.1.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="S4.E7.m1.1.1.1.1.1.1.1.1.1.1.1">subscript</csymbol><ci id="S4.E7.m1.1.1.1.1.1.1.1.1.1.1.1.2.cmml" xref="S4.E7.m1.1.1.1.1.1.1.1.1.1.1.1.2">𝑚</ci><ci id="S4.E7.m1.1.1.1.1.1.1.1.1.1.1.1.3.cmml" xref="S4.E7.m1.1.1.1.1.1.1.1.1.1.1.1.3">𝑛</ci></apply></set></apply><ci id="S4.E7.m1.2.2.2.2.2.1.1a.cmml" xref="S4.E7.m1.2.2.2.2.2.1.3"><mtext id="S4.E7.m1.2.2.2.2.2.1.1.cmml" xref="S4.E7.m1.2.2.2.2.2.1.1">if adding</mtext></ci><apply id="S4.E7.m1.3.3.3.3.1.1.1.1.cmml" xref="S4.E7.m1.3.3.3.3.1.1.1"><setdiff id="S4.E7.m1.3.3.3.3.1.1.1.1.2.cmml" xref="S4.E7.m1.3.3.3.3.1.1.1.1.2"></setdiff><apply id="S4.E7.m1.3.3.3.3.1.1.1.1.3.cmml" xref="S4.E7.m1.3.3.3.3.1.1.1.1.3"><csymbol cd="ambiguous" id="S4.E7.m1.3.3.3.3.1.1.1.1.3.1.cmml" xref="S4.E7.m1.3.3.3.3.1.1.1.1.3">subscript</csymbol><ci id="S4.E7.m1.3.3.3.3.1.1.1.1.3.2.cmml" xref="S4.E7.m1.3.3.3.3.1.1.1.1.3.2">ℳ</ci><ci id="S4.E7.m1.3.3.3.3.1.1.1.1.3.3.cmml" xref="S4.E7.m1.3.3.3.3.1.1.1.1.3.3">𝑛</ci></apply><set id="S4.E7.m1.3.3.3.3.1.1.1.1.1.2.cmml" xref="S4.E7.m1.3.3.3.3.1.1.1.1.1.1"><apply id="S4.E7.m1.3.3.3.3.1.1.1.1.1.1.1.cmml" xref="S4.E7.m1.3.3.3.3.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.E7.m1.3.3.3.3.1.1.1.1.1.1.1.1.cmml" xref="S4.E7.m1.3.3.3.3.1.1.1.1.1.1.1">subscript</csymbol><ci id="S4.E7.m1.3.3.3.3.1.1.1.1.1.1.1.2.cmml" xref="S4.E7.m1.3.3.3.3.1.1.1.1.1.1.1.2">𝑚</ci><ci id="S4.E7.m1.3.3.3.3.1.1.1.1.1.1.1.3.cmml" xref="S4.E7.m1.3.3.3.3.1.1.1.1.1.1.1.3">𝑛</ci></apply></set></apply><ci id="S4.E7.m1.4.4.4.4.2.1.1a.cmml" xref="S4.E7.m1.4.4.4.4.2.1.3"><mtext id="S4.E7.m1.4.4.4.4.2.1.1.cmml" xref="S4.E7.m1.4.4.4.4.2.1.1">if removing</mtext></ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E7.m1.4c">\mathcal{M}_{n+1}=\begin{cases}\mathcal{M}_{n}\cup\{m_{n}\},&amp;\text{if adding},%
\\
\mathcal{M}_{n}\setminus\{m_{n}\},&amp;\text{if removing}.\end{cases}</annotation><annotation encoding="application/x-llamapun" id="S4.E7.m1.4d">caligraphic_M start_POSTSUBSCRIPT italic_n + 1 end_POSTSUBSCRIPT = { start_ROW start_CELL caligraphic_M start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT ∪ { italic_m start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT } , end_CELL start_CELL if adding , end_CELL end_ROW start_ROW start_CELL caligraphic_M start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT ∖ { italic_m start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT } , end_CELL start_CELL if removing . end_CELL end_ROW</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(7)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS2.p1.4">To evaluate the quality of intermediate states, we define a step-level potential function <math alttext="\varphi(\text{step}(t))" class="ltx_Math" display="inline" id="S4.SS2.p1.1.m1.2"><semantics id="S4.SS2.p1.1.m1.2a"><mrow id="S4.SS2.p1.1.m1.2.2" xref="S4.SS2.p1.1.m1.2.2.cmml"><mi id="S4.SS2.p1.1.m1.2.2.3" xref="S4.SS2.p1.1.m1.2.2.3.cmml">φ</mi><mo id="S4.SS2.p1.1.m1.2.2.2" xref="S4.SS2.p1.1.m1.2.2.2.cmml">⁢</mo><mrow id="S4.SS2.p1.1.m1.2.2.1.1" xref="S4.SS2.p1.1.m1.2.2.1.1.1.cmml"><mo id="S4.SS2.p1.1.m1.2.2.1.1.2" stretchy="false" xref="S4.SS2.p1.1.m1.2.2.1.1.1.cmml">(</mo><mrow id="S4.SS2.p1.1.m1.2.2.1.1.1" xref="S4.SS2.p1.1.m1.2.2.1.1.1.cmml"><mtext id="S4.SS2.p1.1.m1.2.2.1.1.1.2" xref="S4.SS2.p1.1.m1.2.2.1.1.1.2a.cmml">step</mtext><mo id="S4.SS2.p1.1.m1.2.2.1.1.1.1" xref="S4.SS2.p1.1.m1.2.2.1.1.1.1.cmml">⁢</mo><mrow id="S4.SS2.p1.1.m1.2.2.1.1.1.3.2" xref="S4.SS2.p1.1.m1.2.2.1.1.1.cmml"><mo id="S4.SS2.p1.1.m1.2.2.1.1.1.3.2.1" stretchy="false" xref="S4.SS2.p1.1.m1.2.2.1.1.1.cmml">(</mo><mi id="S4.SS2.p1.1.m1.1.1" xref="S4.SS2.p1.1.m1.1.1.cmml">t</mi><mo id="S4.SS2.p1.1.m1.2.2.1.1.1.3.2.2" stretchy="false" xref="S4.SS2.p1.1.m1.2.2.1.1.1.cmml">)</mo></mrow></mrow><mo id="S4.SS2.p1.1.m1.2.2.1.1.3" stretchy="false" xref="S4.SS2.p1.1.m1.2.2.1.1.1.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.SS2.p1.1.m1.2b"><apply id="S4.SS2.p1.1.m1.2.2.cmml" xref="S4.SS2.p1.1.m1.2.2"><times id="S4.SS2.p1.1.m1.2.2.2.cmml" xref="S4.SS2.p1.1.m1.2.2.2"></times><ci id="S4.SS2.p1.1.m1.2.2.3.cmml" xref="S4.SS2.p1.1.m1.2.2.3">𝜑</ci><apply id="S4.SS2.p1.1.m1.2.2.1.1.1.cmml" xref="S4.SS2.p1.1.m1.2.2.1.1"><times id="S4.SS2.p1.1.m1.2.2.1.1.1.1.cmml" xref="S4.SS2.p1.1.m1.2.2.1.1.1.1"></times><ci id="S4.SS2.p1.1.m1.2.2.1.1.1.2a.cmml" xref="S4.SS2.p1.1.m1.2.2.1.1.1.2"><mtext id="S4.SS2.p1.1.m1.2.2.1.1.1.2.cmml" xref="S4.SS2.p1.1.m1.2.2.1.1.1.2">step</mtext></ci><ci id="S4.SS2.p1.1.m1.1.1.cmml" xref="S4.SS2.p1.1.m1.1.1">𝑡</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p1.1.m1.2c">\varphi(\text{step}(t))</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p1.1.m1.2d">italic_φ ( step ( italic_t ) )</annotation></semantics></math> incorporating:
(1) <span class="ltx_text ltx_font_bold" id="S4.SS2.p1.4.1">Correctness</span>: Jaccard similarity to the ground-truth set <math alttext="\mathcal{M}_{\text{GT}}" class="ltx_Math" display="inline" id="S4.SS2.p1.2.m2.1"><semantics id="S4.SS2.p1.2.m2.1a"><msub id="S4.SS2.p1.2.m2.1.1" xref="S4.SS2.p1.2.m2.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.SS2.p1.2.m2.1.1.2" xref="S4.SS2.p1.2.m2.1.1.2.cmml">ℳ</mi><mtext id="S4.SS2.p1.2.m2.1.1.3" xref="S4.SS2.p1.2.m2.1.1.3a.cmml">GT</mtext></msub><annotation-xml encoding="MathML-Content" id="S4.SS2.p1.2.m2.1b"><apply id="S4.SS2.p1.2.m2.1.1.cmml" xref="S4.SS2.p1.2.m2.1.1"><csymbol cd="ambiguous" id="S4.SS2.p1.2.m2.1.1.1.cmml" xref="S4.SS2.p1.2.m2.1.1">subscript</csymbol><ci id="S4.SS2.p1.2.m2.1.1.2.cmml" xref="S4.SS2.p1.2.m2.1.1.2">ℳ</ci><ci id="S4.SS2.p1.2.m2.1.1.3a.cmml" xref="S4.SS2.p1.2.m2.1.1.3"><mtext id="S4.SS2.p1.2.m2.1.1.3.cmml" mathsize="70%" xref="S4.SS2.p1.2.m2.1.1.3">GT</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p1.2.m2.1c">\mathcal{M}_{\text{GT}}</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p1.2.m2.1d">caligraphic_M start_POSTSUBSCRIPT GT end_POSTSUBSCRIPT</annotation></semantics></math>, (2) <span class="ltx_text ltx_font_bold" id="S4.SS2.p1.4.2">Adherence</span>: constraint violation with respect to the candidate set <math alttext="\mathcal{M}_{C}" class="ltx_Math" display="inline" id="S4.SS2.p1.3.m3.1"><semantics id="S4.SS2.p1.3.m3.1a"><msub id="S4.SS2.p1.3.m3.1.1" xref="S4.SS2.p1.3.m3.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.SS2.p1.3.m3.1.1.2" xref="S4.SS2.p1.3.m3.1.1.2.cmml">ℳ</mi><mi id="S4.SS2.p1.3.m3.1.1.3" xref="S4.SS2.p1.3.m3.1.1.3.cmml">C</mi></msub><annotation-xml encoding="MathML-Content" id="S4.SS2.p1.3.m3.1b"><apply id="S4.SS2.p1.3.m3.1.1.cmml" xref="S4.SS2.p1.3.m3.1.1"><csymbol cd="ambiguous" id="S4.SS2.p1.3.m3.1.1.1.cmml" xref="S4.SS2.p1.3.m3.1.1">subscript</csymbol><ci id="S4.SS2.p1.3.m3.1.1.2.cmml" xref="S4.SS2.p1.3.m3.1.1.2">ℳ</ci><ci id="S4.SS2.p1.3.m3.1.1.3.cmml" xref="S4.SS2.p1.3.m3.1.1.3">𝐶</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p1.3.m3.1c">\mathcal{M}_{C}</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p1.3.m3.1d">caligraphic_M start_POSTSUBSCRIPT italic_C end_POSTSUBSCRIPT</annotation></semantics></math>, and (3) <span class="ltx_text ltx_font_bold" id="S4.SS2.p1.4.3">Safety</span>: DDI-based risk from the interaction graph <math alttext="\bm{D}" class="ltx_Math" display="inline" id="S4.SS2.p1.4.m4.1"><semantics id="S4.SS2.p1.4.m4.1a"><mi id="S4.SS2.p1.4.m4.1.1" xref="S4.SS2.p1.4.m4.1.1.cmml">𝑫</mi><annotation-xml encoding="MathML-Content" id="S4.SS2.p1.4.m4.1b"><ci id="S4.SS2.p1.4.m4.1.1.cmml" xref="S4.SS2.p1.4.m4.1.1">𝑫</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p1.4.m4.1c">\bm{D}</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p1.4.m4.1d">bold_italic_D</annotation></semantics></math>.
The potential function is given by:</p>
<table class="ltx_equation ltx_eqn_table" id="S4.E8">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\varphi(\text{step}(t))=\mathrm{Jaccard}(\mathcal{M}_{n},\mathcal{M}_{\text{GT%
}})-\alpha\cdot\mathrm{DDI}(\mathcal{M}_{n},\bm{D})-\beta\cdot\mathrm{%
RefusalRate}(\mathcal{M}_{n},\mathcal{M}_{C})" class="ltx_Math" display="block" id="S4.E8.m1.8"><semantics id="S4.E8.m1.8a"><mrow id="S4.E8.m1.8.8" xref="S4.E8.m1.8.8.cmml"><mrow id="S4.E8.m1.3.3.1" xref="S4.E8.m1.3.3.1.cmml"><mi id="S4.E8.m1.3.3.1.3" xref="S4.E8.m1.3.3.1.3.cmml">φ</mi><mo id="S4.E8.m1.3.3.1.2" xref="S4.E8.m1.3.3.1.2.cmml">⁢</mo><mrow id="S4.E8.m1.3.3.1.1.1" xref="S4.E8.m1.3.3.1.1.1.1.cmml"><mo id="S4.E8.m1.3.3.1.1.1.2" stretchy="false" xref="S4.E8.m1.3.3.1.1.1.1.cmml">(</mo><mrow id="S4.E8.m1.3.3.1.1.1.1" xref="S4.E8.m1.3.3.1.1.1.1.cmml"><mtext id="S4.E8.m1.3.3.1.1.1.1.2" xref="S4.E8.m1.3.3.1.1.1.1.2a.cmml">step</mtext><mo id="S4.E8.m1.3.3.1.1.1.1.1" xref="S4.E8.m1.3.3.1.1.1.1.1.cmml">⁢</mo><mrow id="S4.E8.m1.3.3.1.1.1.1.3.2" xref="S4.E8.m1.3.3.1.1.1.1.cmml"><mo id="S4.E8.m1.3.3.1.1.1.1.3.2.1" stretchy="false" xref="S4.E8.m1.3.3.1.1.1.1.cmml">(</mo><mi id="S4.E8.m1.1.1" xref="S4.E8.m1.1.1.cmml">t</mi><mo id="S4.E8.m1.3.3.1.1.1.1.3.2.2" stretchy="false" xref="S4.E8.m1.3.3.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="S4.E8.m1.3.3.1.1.1.3" stretchy="false" xref="S4.E8.m1.3.3.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="S4.E8.m1.8.8.7" xref="S4.E8.m1.8.8.7.cmml">=</mo><mrow id="S4.E8.m1.8.8.6" xref="S4.E8.m1.8.8.6.cmml"><mrow id="S4.E8.m1.5.5.3.2" xref="S4.E8.m1.5.5.3.2.cmml"><mi id="S4.E8.m1.5.5.3.2.4" xref="S4.E8.m1.5.5.3.2.4.cmml">Jaccard</mi><mo id="S4.E8.m1.5.5.3.2.3" xref="S4.E8.m1.5.5.3.2.3.cmml">⁢</mo><mrow id="S4.E8.m1.5.5.3.2.2.2" xref="S4.E8.m1.5.5.3.2.2.3.cmml"><mo id="S4.E8.m1.5.5.3.2.2.2.3" stretchy="false" xref="S4.E8.m1.5.5.3.2.2.3.cmml">(</mo><msub id="S4.E8.m1.4.4.2.1.1.1.1" xref="S4.E8.m1.4.4.2.1.1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E8.m1.4.4.2.1.1.1.1.2" xref="S4.E8.m1.4.4.2.1.1.1.1.2.cmml">ℳ</mi><mi id="S4.E8.m1.4.4.2.1.1.1.1.3" xref="S4.E8.m1.4.4.2.1.1.1.1.3.cmml">n</mi></msub><mo id="S4.E8.m1.5.5.3.2.2.2.4" xref="S4.E8.m1.5.5.3.2.2.3.cmml">,</mo><msub id="S4.E8.m1.5.5.3.2.2.2.2" xref="S4.E8.m1.5.5.3.2.2.2.2.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E8.m1.5.5.3.2.2.2.2.2" xref="S4.E8.m1.5.5.3.2.2.2.2.2.cmml">ℳ</mi><mtext id="S4.E8.m1.5.5.3.2.2.2.2.3" xref="S4.E8.m1.5.5.3.2.2.2.2.3a.cmml">GT</mtext></msub><mo id="S4.E8.m1.5.5.3.2.2.2.5" stretchy="false" xref="S4.E8.m1.5.5.3.2.2.3.cmml">)</mo></mrow></mrow><mo id="S4.E8.m1.8.8.6.6" xref="S4.E8.m1.8.8.6.6.cmml">−</mo><mrow id="S4.E8.m1.6.6.4.3" xref="S4.E8.m1.6.6.4.3.cmml"><mrow id="S4.E8.m1.6.6.4.3.3" xref="S4.E8.m1.6.6.4.3.3.cmml"><mi id="S4.E8.m1.6.6.4.3.3.2" xref="S4.E8.m1.6.6.4.3.3.2.cmml">α</mi><mo id="S4.E8.m1.6.6.4.3.3.1" lspace="0.222em" rspace="0.222em" xref="S4.E8.m1.6.6.4.3.3.1.cmml">⋅</mo><mi id="S4.E8.m1.6.6.4.3.3.3" xref="S4.E8.m1.6.6.4.3.3.3.cmml">DDI</mi></mrow><mo id="S4.E8.m1.6.6.4.3.2" xref="S4.E8.m1.6.6.4.3.2.cmml">⁢</mo><mrow id="S4.E8.m1.6.6.4.3.1.1" xref="S4.E8.m1.6.6.4.3.1.2.cmml"><mo id="S4.E8.m1.6.6.4.3.1.1.2" stretchy="false" xref="S4.E8.m1.6.6.4.3.1.2.cmml">(</mo><msub id="S4.E8.m1.6.6.4.3.1.1.1" xref="S4.E8.m1.6.6.4.3.1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E8.m1.6.6.4.3.1.1.1.2" xref="S4.E8.m1.6.6.4.3.1.1.1.2.cmml">ℳ</mi><mi id="S4.E8.m1.6.6.4.3.1.1.1.3" xref="S4.E8.m1.6.6.4.3.1.1.1.3.cmml">n</mi></msub><mo id="S4.E8.m1.6.6.4.3.1.1.3" xref="S4.E8.m1.6.6.4.3.1.2.cmml">,</mo><mi id="S4.E8.m1.2.2" xref="S4.E8.m1.2.2.cmml">𝑫</mi><mo id="S4.E8.m1.6.6.4.3.1.1.4" stretchy="false" xref="S4.E8.m1.6.6.4.3.1.2.cmml">)</mo></mrow></mrow><mo id="S4.E8.m1.8.8.6.6a" xref="S4.E8.m1.8.8.6.6.cmml">−</mo><mrow id="S4.E8.m1.8.8.6.5" xref="S4.E8.m1.8.8.6.5.cmml"><mrow id="S4.E8.m1.8.8.6.5.4" xref="S4.E8.m1.8.8.6.5.4.cmml"><mi id="S4.E8.m1.8.8.6.5.4.2" xref="S4.E8.m1.8.8.6.5.4.2.cmml">β</mi><mo id="S4.E8.m1.8.8.6.5.4.1" lspace="0.222em" rspace="0.222em" xref="S4.E8.m1.8.8.6.5.4.1.cmml">⋅</mo><mi id="S4.E8.m1.8.8.6.5.4.3" xref="S4.E8.m1.8.8.6.5.4.3.cmml">RefusalRate</mi></mrow><mo id="S4.E8.m1.8.8.6.5.3" xref="S4.E8.m1.8.8.6.5.3.cmml">⁢</mo><mrow id="S4.E8.m1.8.8.6.5.2.2" xref="S4.E8.m1.8.8.6.5.2.3.cmml"><mo id="S4.E8.m1.8.8.6.5.2.2.3" stretchy="false" xref="S4.E8.m1.8.8.6.5.2.3.cmml">(</mo><msub id="S4.E8.m1.7.7.5.4.1.1.1" xref="S4.E8.m1.7.7.5.4.1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E8.m1.7.7.5.4.1.1.1.2" xref="S4.E8.m1.7.7.5.4.1.1.1.2.cmml">ℳ</mi><mi id="S4.E8.m1.7.7.5.4.1.1.1.3" xref="S4.E8.m1.7.7.5.4.1.1.1.3.cmml">n</mi></msub><mo id="S4.E8.m1.8.8.6.5.2.2.4" xref="S4.E8.m1.8.8.6.5.2.3.cmml">,</mo><msub id="S4.E8.m1.8.8.6.5.2.2.2" xref="S4.E8.m1.8.8.6.5.2.2.2.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E8.m1.8.8.6.5.2.2.2.2" xref="S4.E8.m1.8.8.6.5.2.2.2.2.cmml">ℳ</mi><mi id="S4.E8.m1.8.8.6.5.2.2.2.3" xref="S4.E8.m1.8.8.6.5.2.2.2.3.cmml">C</mi></msub><mo id="S4.E8.m1.8.8.6.5.2.2.5" stretchy="false" xref="S4.E8.m1.8.8.6.5.2.3.cmml">)</mo></mrow></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.E8.m1.8b"><apply id="S4.E8.m1.8.8.cmml" xref="S4.E8.m1.8.8"><eq id="S4.E8.m1.8.8.7.cmml" xref="S4.E8.m1.8.8.7"></eq><apply id="S4.E8.m1.3.3.1.cmml" xref="S4.E8.m1.3.3.1"><times id="S4.E8.m1.3.3.1.2.cmml" xref="S4.E8.m1.3.3.1.2"></times><ci id="S4.E8.m1.3.3.1.3.cmml" xref="S4.E8.m1.3.3.1.3">𝜑</ci><apply id="S4.E8.m1.3.3.1.1.1.1.cmml" xref="S4.E8.m1.3.3.1.1.1"><times id="S4.E8.m1.3.3.1.1.1.1.1.cmml" xref="S4.E8.m1.3.3.1.1.1.1.1"></times><ci id="S4.E8.m1.3.3.1.1.1.1.2a.cmml" xref="S4.E8.m1.3.3.1.1.1.1.2"><mtext id="S4.E8.m1.3.3.1.1.1.1.2.cmml" xref="S4.E8.m1.3.3.1.1.1.1.2">step</mtext></ci><ci id="S4.E8.m1.1.1.cmml" xref="S4.E8.m1.1.1">𝑡</ci></apply></apply><apply id="S4.E8.m1.8.8.6.cmml" xref="S4.E8.m1.8.8.6"><minus id="S4.E8.m1.8.8.6.6.cmml" xref="S4.E8.m1.8.8.6.6"></minus><apply id="S4.E8.m1.5.5.3.2.cmml" xref="S4.E8.m1.5.5.3.2"><times id="S4.E8.m1.5.5.3.2.3.cmml" xref="S4.E8.m1.5.5.3.2.3"></times><ci id="S4.E8.m1.5.5.3.2.4.cmml" xref="S4.E8.m1.5.5.3.2.4">Jaccard</ci><interval closure="open" id="S4.E8.m1.5.5.3.2.2.3.cmml" xref="S4.E8.m1.5.5.3.2.2.2"><apply id="S4.E8.m1.4.4.2.1.1.1.1.cmml" xref="S4.E8.m1.4.4.2.1.1.1.1"><csymbol cd="ambiguous" id="S4.E8.m1.4.4.2.1.1.1.1.1.cmml" xref="S4.E8.m1.4.4.2.1.1.1.1">subscript</csymbol><ci id="S4.E8.m1.4.4.2.1.1.1.1.2.cmml" xref="S4.E8.m1.4.4.2.1.1.1.1.2">ℳ</ci><ci id="S4.E8.m1.4.4.2.1.1.1.1.3.cmml" xref="S4.E8.m1.4.4.2.1.1.1.1.3">𝑛</ci></apply><apply id="S4.E8.m1.5.5.3.2.2.2.2.cmml" xref="S4.E8.m1.5.5.3.2.2.2.2"><csymbol cd="ambiguous" id="S4.E8.m1.5.5.3.2.2.2.2.1.cmml" xref="S4.E8.m1.5.5.3.2.2.2.2">subscript</csymbol><ci id="S4.E8.m1.5.5.3.2.2.2.2.2.cmml" xref="S4.E8.m1.5.5.3.2.2.2.2.2">ℳ</ci><ci id="S4.E8.m1.5.5.3.2.2.2.2.3a.cmml" xref="S4.E8.m1.5.5.3.2.2.2.2.3"><mtext id="S4.E8.m1.5.5.3.2.2.2.2.3.cmml" mathsize="70%" xref="S4.E8.m1.5.5.3.2.2.2.2.3">GT</mtext></ci></apply></interval></apply><apply id="S4.E8.m1.6.6.4.3.cmml" xref="S4.E8.m1.6.6.4.3"><times id="S4.E8.m1.6.6.4.3.2.cmml" xref="S4.E8.m1.6.6.4.3.2"></times><apply id="S4.E8.m1.6.6.4.3.3.cmml" xref="S4.E8.m1.6.6.4.3.3"><ci id="S4.E8.m1.6.6.4.3.3.1.cmml" xref="S4.E8.m1.6.6.4.3.3.1">⋅</ci><ci id="S4.E8.m1.6.6.4.3.3.2.cmml" xref="S4.E8.m1.6.6.4.3.3.2">𝛼</ci><ci id="S4.E8.m1.6.6.4.3.3.3.cmml" xref="S4.E8.m1.6.6.4.3.3.3">DDI</ci></apply><interval closure="open" id="S4.E8.m1.6.6.4.3.1.2.cmml" xref="S4.E8.m1.6.6.4.3.1.1"><apply id="S4.E8.m1.6.6.4.3.1.1.1.cmml" xref="S4.E8.m1.6.6.4.3.1.1.1"><csymbol cd="ambiguous" id="S4.E8.m1.6.6.4.3.1.1.1.1.cmml" xref="S4.E8.m1.6.6.4.3.1.1.1">subscript</csymbol><ci id="S4.E8.m1.6.6.4.3.1.1.1.2.cmml" xref="S4.E8.m1.6.6.4.3.1.1.1.2">ℳ</ci><ci id="S4.E8.m1.6.6.4.3.1.1.1.3.cmml" xref="S4.E8.m1.6.6.4.3.1.1.1.3">𝑛</ci></apply><ci id="S4.E8.m1.2.2.cmml" xref="S4.E8.m1.2.2">𝑫</ci></interval></apply><apply id="S4.E8.m1.8.8.6.5.cmml" xref="S4.E8.m1.8.8.6.5"><times id="S4.E8.m1.8.8.6.5.3.cmml" xref="S4.E8.m1.8.8.6.5.3"></times><apply id="S4.E8.m1.8.8.6.5.4.cmml" xref="S4.E8.m1.8.8.6.5.4"><ci id="S4.E8.m1.8.8.6.5.4.1.cmml" xref="S4.E8.m1.8.8.6.5.4.1">⋅</ci><ci id="S4.E8.m1.8.8.6.5.4.2.cmml" xref="S4.E8.m1.8.8.6.5.4.2">𝛽</ci><ci id="S4.E8.m1.8.8.6.5.4.3.cmml" xref="S4.E8.m1.8.8.6.5.4.3">RefusalRate</ci></apply><interval closure="open" id="S4.E8.m1.8.8.6.5.2.3.cmml" xref="S4.E8.m1.8.8.6.5.2.2"><apply id="S4.E8.m1.7.7.5.4.1.1.1.cmml" xref="S4.E8.m1.7.7.5.4.1.1.1"><csymbol cd="ambiguous" id="S4.E8.m1.7.7.5.4.1.1.1.1.cmml" xref="S4.E8.m1.7.7.5.4.1.1.1">subscript</csymbol><ci id="S4.E8.m1.7.7.5.4.1.1.1.2.cmml" xref="S4.E8.m1.7.7.5.4.1.1.1.2">ℳ</ci><ci id="S4.E8.m1.7.7.5.4.1.1.1.3.cmml" xref="S4.E8.m1.7.7.5.4.1.1.1.3">𝑛</ci></apply><apply id="S4.E8.m1.8.8.6.5.2.2.2.cmml" xref="S4.E8.m1.8.8.6.5.2.2.2"><csymbol cd="ambiguous" id="S4.E8.m1.8.8.6.5.2.2.2.1.cmml" xref="S4.E8.m1.8.8.6.5.2.2.2">subscript</csymbol><ci id="S4.E8.m1.8.8.6.5.2.2.2.2.cmml" xref="S4.E8.m1.8.8.6.5.2.2.2.2">ℳ</ci><ci id="S4.E8.m1.8.8.6.5.2.2.2.3.cmml" xref="S4.E8.m1.8.8.6.5.2.2.2.3">𝐶</ci></apply></interval></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E8.m1.8c">\varphi(\text{step}(t))=\mathrm{Jaccard}(\mathcal{M}_{n},\mathcal{M}_{\text{GT%
}})-\alpha\cdot\mathrm{DDI}(\mathcal{M}_{n},\bm{D})-\beta\cdot\mathrm{%
RefusalRate}(\mathcal{M}_{n},\mathcal{M}_{C})</annotation><annotation encoding="application/x-llamapun" id="S4.E8.m1.8d">italic_φ ( step ( italic_t ) ) = roman_Jaccard ( caligraphic_M start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT , caligraphic_M start_POSTSUBSCRIPT GT end_POSTSUBSCRIPT ) - italic_α ⋅ roman_DDI ( caligraphic_M start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT , bold_italic_D ) - italic_β ⋅ roman_RefusalRate ( caligraphic_M start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT , caligraphic_M start_POSTSUBSCRIPT italic_C end_POSTSUBSCRIPT )</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(8)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS2.p1.7">where:</p>
<table class="ltx_equationgroup ltx_eqn_align ltx_eqn_table" id="A5.EGx1">
<tbody id="S4.Ex1"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math alttext="\displaystyle\mathrm{Jaccard}(\mathcal{M}_{n},\mathcal{M}_{\text{GT}})" class="ltx_Math" display="inline" id="S4.Ex1.m1.2"><semantics id="S4.Ex1.m1.2a"><mrow id="S4.Ex1.m1.2.2" xref="S4.Ex1.m1.2.2.cmml"><mi id="S4.Ex1.m1.2.2.4" xref="S4.Ex1.m1.2.2.4.cmml">Jaccard</mi><mo id="S4.Ex1.m1.2.2.3" xref="S4.Ex1.m1.2.2.3.cmml">⁢</mo><mrow id="S4.Ex1.m1.2.2.2.2" xref="S4.Ex1.m1.2.2.2.3.cmml"><mo id="S4.Ex1.m1.2.2.2.2.3" stretchy="false" xref="S4.Ex1.m1.2.2.2.3.cmml">(</mo><msub id="S4.Ex1.m1.1.1.1.1.1" xref="S4.Ex1.m1.1.1.1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.Ex1.m1.1.1.1.1.1.2" xref="S4.Ex1.m1.1.1.1.1.1.2.cmml">ℳ</mi><mi id="S4.Ex1.m1.1.1.1.1.1.3" xref="S4.Ex1.m1.1.1.1.1.1.3.cmml">n</mi></msub><mo id="S4.Ex1.m1.2.2.2.2.4" xref="S4.Ex1.m1.2.2.2.3.cmml">,</mo><msub id="S4.Ex1.m1.2.2.2.2.2" xref="S4.Ex1.m1.2.2.2.2.2.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.Ex1.m1.2.2.2.2.2.2" xref="S4.Ex1.m1.2.2.2.2.2.2.cmml">ℳ</mi><mtext id="S4.Ex1.m1.2.2.2.2.2.3" xref="S4.Ex1.m1.2.2.2.2.2.3a.cmml">GT</mtext></msub><mo id="S4.Ex1.m1.2.2.2.2.5" stretchy="false" xref="S4.Ex1.m1.2.2.2.3.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.Ex1.m1.2b"><apply id="S4.Ex1.m1.2.2.cmml" xref="S4.Ex1.m1.2.2"><times id="S4.Ex1.m1.2.2.3.cmml" xref="S4.Ex1.m1.2.2.3"></times><ci id="S4.Ex1.m1.2.2.4.cmml" xref="S4.Ex1.m1.2.2.4">Jaccard</ci><interval closure="open" id="S4.Ex1.m1.2.2.2.3.cmml" xref="S4.Ex1.m1.2.2.2.2"><apply id="S4.Ex1.m1.1.1.1.1.1.cmml" xref="S4.Ex1.m1.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.Ex1.m1.1.1.1.1.1.1.cmml" xref="S4.Ex1.m1.1.1.1.1.1">subscript</csymbol><ci id="S4.Ex1.m1.1.1.1.1.1.2.cmml" xref="S4.Ex1.m1.1.1.1.1.1.2">ℳ</ci><ci id="S4.Ex1.m1.1.1.1.1.1.3.cmml" xref="S4.Ex1.m1.1.1.1.1.1.3">𝑛</ci></apply><apply id="S4.Ex1.m1.2.2.2.2.2.cmml" xref="S4.Ex1.m1.2.2.2.2.2"><csymbol cd="ambiguous" id="S4.Ex1.m1.2.2.2.2.2.1.cmml" xref="S4.Ex1.m1.2.2.2.2.2">subscript</csymbol><ci id="S4.Ex1.m1.2.2.2.2.2.2.cmml" xref="S4.Ex1.m1.2.2.2.2.2.2">ℳ</ci><ci id="S4.Ex1.m1.2.2.2.2.2.3a.cmml" xref="S4.Ex1.m1.2.2.2.2.2.3"><mtext id="S4.Ex1.m1.2.2.2.2.2.3.cmml" mathsize="70%" xref="S4.Ex1.m1.2.2.2.2.2.3">GT</mtext></ci></apply></interval></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.Ex1.m1.2c">\displaystyle\mathrm{Jaccard}(\mathcal{M}_{n},\mathcal{M}_{\text{GT}})</annotation><annotation encoding="application/x-llamapun" id="S4.Ex1.m1.2d">roman_Jaccard ( caligraphic_M start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT , caligraphic_M start_POSTSUBSCRIPT GT end_POSTSUBSCRIPT )</annotation></semantics></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math alttext="\displaystyle=\frac{|\mathcal{M}_{n}\cap\mathcal{M}_{\text{GT}}|}{|\mathcal{M}%
_{n}\cup\mathcal{M}_{\text{GT}}|},~{}~{}~{}~{}\mathrm{RefusalRate}(\mathcal{M}%
_{n},\mathcal{M}_{C})=\frac{|\{m\in\mathcal{M}_{n}\mid m\notin\mathcal{M}_{C}%
\}|}{|\mathcal{M}_{n}|}." class="ltx_Math" display="inline" id="S4.Ex1.m2.5"><semantics id="S4.Ex1.m2.5a"><mrow id="S4.Ex1.m2.5.5.1"><mrow id="S4.Ex1.m2.5.5.1.1.2" xref="S4.Ex1.m2.5.5.1.1.3.cmml"><mrow id="S4.Ex1.m2.5.5.1.1.1.1" xref="S4.Ex1.m2.5.5.1.1.1.1.cmml"><mi id="S4.Ex1.m2.5.5.1.1.1.1.2" xref="S4.Ex1.m2.5.5.1.1.1.1.2.cmml"></mi><mo id="S4.Ex1.m2.5.5.1.1.1.1.1" xref="S4.Ex1.m2.5.5.1.1.1.1.1.cmml">=</mo><mstyle displaystyle="true" id="S4.Ex1.m2.2.2" xref="S4.Ex1.m2.2.2.cmml"><mfrac id="S4.Ex1.m2.2.2a" xref="S4.Ex1.m2.2.2.cmml"><mrow id="S4.Ex1.m2.1.1.1.1" xref="S4.Ex1.m2.1.1.1.2.cmml"><mo id="S4.Ex1.m2.1.1.1.1.2" stretchy="false" xref="S4.Ex1.m2.1.1.1.2.1.cmml">|</mo><mrow id="S4.Ex1.m2.1.1.1.1.1" xref="S4.Ex1.m2.1.1.1.1.1.cmml"><msub id="S4.Ex1.m2.1.1.1.1.1.2" xref="S4.Ex1.m2.1.1.1.1.1.2.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.Ex1.m2.1.1.1.1.1.2.2" xref="S4.Ex1.m2.1.1.1.1.1.2.2.cmml">ℳ</mi><mi id="S4.Ex1.m2.1.1.1.1.1.2.3" xref="S4.Ex1.m2.1.1.1.1.1.2.3.cmml">n</mi></msub><mo id="S4.Ex1.m2.1.1.1.1.1.1" xref="S4.Ex1.m2.1.1.1.1.1.1.cmml">∩</mo><msub id="S4.Ex1.m2.1.1.1.1.1.3" xref="S4.Ex1.m2.1.1.1.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.Ex1.m2.1.1.1.1.1.3.2" xref="S4.Ex1.m2.1.1.1.1.1.3.2.cmml">ℳ</mi><mtext id="S4.Ex1.m2.1.1.1.1.1.3.3" xref="S4.Ex1.m2.1.1.1.1.1.3.3a.cmml">GT</mtext></msub></mrow><mo id="S4.Ex1.m2.1.1.1.1.3" stretchy="false" xref="S4.Ex1.m2.1.1.1.2.1.cmml">|</mo></mrow><mrow id="S4.Ex1.m2.2.2.2.1" xref="S4.Ex1.m2.2.2.2.2.cmml"><mo id="S4.Ex1.m2.2.2.2.1.2" stretchy="false" xref="S4.Ex1.m2.2.2.2.2.1.cmml">|</mo><mrow id="S4.Ex1.m2.2.2.2.1.1" xref="S4.Ex1.m2.2.2.2.1.1.cmml"><msub id="S4.Ex1.m2.2.2.2.1.1.2" xref="S4.Ex1.m2.2.2.2.1.1.2.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.Ex1.m2.2.2.2.1.1.2.2" xref="S4.Ex1.m2.2.2.2.1.1.2.2.cmml">ℳ</mi><mi id="S4.Ex1.m2.2.2.2.1.1.2.3" xref="S4.Ex1.m2.2.2.2.1.1.2.3.cmml">n</mi></msub><mo id="S4.Ex1.m2.2.2.2.1.1.1" xref="S4.Ex1.m2.2.2.2.1.1.1.cmml">∪</mo><msub id="S4.Ex1.m2.2.2.2.1.1.3" xref="S4.Ex1.m2.2.2.2.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.Ex1.m2.2.2.2.1.1.3.2" xref="S4.Ex1.m2.2.2.2.1.1.3.2.cmml">ℳ</mi><mtext id="S4.Ex1.m2.2.2.2.1.1.3.3" xref="S4.Ex1.m2.2.2.2.1.1.3.3a.cmml">GT</mtext></msub></mrow><mo id="S4.Ex1.m2.2.2.2.1.3" stretchy="false" xref="S4.Ex1.m2.2.2.2.2.1.cmml">|</mo></mrow></mfrac></mstyle></mrow><mo id="S4.Ex1.m2.5.5.1.1.2.3" rspace="1.487em" xref="S4.Ex1.m2.5.5.1.1.3a.cmml">,</mo><mrow id="S4.Ex1.m2.5.5.1.1.2.2" xref="S4.Ex1.m2.5.5.1.1.2.2.cmml"><mrow id="S4.Ex1.m2.5.5.1.1.2.2.2" xref="S4.Ex1.m2.5.5.1.1.2.2.2.cmml"><mi id="S4.Ex1.m2.5.5.1.1.2.2.2.4" xref="S4.Ex1.m2.5.5.1.1.2.2.2.4.cmml">RefusalRate</mi><mo id="S4.Ex1.m2.5.5.1.1.2.2.2.3" xref="S4.Ex1.m2.5.5.1.1.2.2.2.3.cmml">⁢</mo><mrow id="S4.Ex1.m2.5.5.1.1.2.2.2.2.2" xref="S4.Ex1.m2.5.5.1.1.2.2.2.2.3.cmml"><mo id="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.3" stretchy="false" xref="S4.Ex1.m2.5.5.1.1.2.2.2.2.3.cmml">(</mo><msub id="S4.Ex1.m2.5.5.1.1.2.2.1.1.1.1" xref="S4.Ex1.m2.5.5.1.1.2.2.1.1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.Ex1.m2.5.5.1.1.2.2.1.1.1.1.2" xref="S4.Ex1.m2.5.5.1.1.2.2.1.1.1.1.2.cmml">ℳ</mi><mi id="S4.Ex1.m2.5.5.1.1.2.2.1.1.1.1.3" xref="S4.Ex1.m2.5.5.1.1.2.2.1.1.1.1.3.cmml">n</mi></msub><mo id="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.4" xref="S4.Ex1.m2.5.5.1.1.2.2.2.2.3.cmml">,</mo><msub id="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.2" xref="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.2.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.2.2" xref="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.2.2.cmml">ℳ</mi><mi id="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.2.3" xref="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.2.3.cmml">C</mi></msub><mo id="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.5" stretchy="false" xref="S4.Ex1.m2.5.5.1.1.2.2.2.2.3.cmml">)</mo></mrow></mrow><mo id="S4.Ex1.m2.5.5.1.1.2.2.3" xref="S4.Ex1.m2.5.5.1.1.2.2.3.cmml">=</mo><mstyle displaystyle="true" id="S4.Ex1.m2.4.4" xref="S4.Ex1.m2.4.4.cmml"><mfrac id="S4.Ex1.m2.4.4a" xref="S4.Ex1.m2.4.4.cmml"><mrow id="S4.Ex1.m2.3.3.1.1" xref="S4.Ex1.m2.3.3.1.2.cmml"><mo id="S4.Ex1.m2.3.3.1.1.2" stretchy="false" xref="S4.Ex1.m2.3.3.1.2.1.cmml">|</mo><mrow id="S4.Ex1.m2.3.3.1.1.1.2" xref="S4.Ex1.m2.3.3.1.1.1.3.cmml"><mo id="S4.Ex1.m2.3.3.1.1.1.2.3" stretchy="false" xref="S4.Ex1.m2.3.3.1.1.1.3.1.cmml">{</mo><mrow id="S4.Ex1.m2.3.3.1.1.1.1.1" xref="S4.Ex1.m2.3.3.1.1.1.1.1.cmml"><mi id="S4.Ex1.m2.3.3.1.1.1.1.1.2" xref="S4.Ex1.m2.3.3.1.1.1.1.1.2.cmml">m</mi><mo id="S4.Ex1.m2.3.3.1.1.1.1.1.1" xref="S4.Ex1.m2.3.3.1.1.1.1.1.1.cmml">∈</mo><msub id="S4.Ex1.m2.3.3.1.1.1.1.1.3" xref="S4.Ex1.m2.3.3.1.1.1.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.Ex1.m2.3.3.1.1.1.1.1.3.2" xref="S4.Ex1.m2.3.3.1.1.1.1.1.3.2.cmml">ℳ</mi><mi id="S4.Ex1.m2.3.3.1.1.1.1.1.3.3" xref="S4.Ex1.m2.3.3.1.1.1.1.1.3.3.cmml">n</mi></msub></mrow><mo fence="true" id="S4.Ex1.m2.3.3.1.1.1.2.4" lspace="0em" rspace="0em" xref="S4.Ex1.m2.3.3.1.1.1.3.1.cmml">∣</mo><mrow id="S4.Ex1.m2.3.3.1.1.1.2.2" xref="S4.Ex1.m2.3.3.1.1.1.2.2.cmml"><mi id="S4.Ex1.m2.3.3.1.1.1.2.2.2" xref="S4.Ex1.m2.3.3.1.1.1.2.2.2.cmml">m</mi><mo id="S4.Ex1.m2.3.3.1.1.1.2.2.1" xref="S4.Ex1.m2.3.3.1.1.1.2.2.1.cmml">∉</mo><msub id="S4.Ex1.m2.3.3.1.1.1.2.2.3" xref="S4.Ex1.m2.3.3.1.1.1.2.2.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.Ex1.m2.3.3.1.1.1.2.2.3.2" xref="S4.Ex1.m2.3.3.1.1.1.2.2.3.2.cmml">ℳ</mi><mi id="S4.Ex1.m2.3.3.1.1.1.2.2.3.3" xref="S4.Ex1.m2.3.3.1.1.1.2.2.3.3.cmml">C</mi></msub></mrow><mo id="S4.Ex1.m2.3.3.1.1.1.2.5" stretchy="false" xref="S4.Ex1.m2.3.3.1.1.1.3.1.cmml">}</mo></mrow><mo id="S4.Ex1.m2.3.3.1.1.3" stretchy="false" xref="S4.Ex1.m2.3.3.1.2.1.cmml">|</mo></mrow><mrow id="S4.Ex1.m2.4.4.2.1" xref="S4.Ex1.m2.4.4.2.2.cmml"><mo id="S4.Ex1.m2.4.4.2.1.2" stretchy="false" xref="S4.Ex1.m2.4.4.2.2.1.cmml">|</mo><msub id="S4.Ex1.m2.4.4.2.1.1" xref="S4.Ex1.m2.4.4.2.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.Ex1.m2.4.4.2.1.1.2" xref="S4.Ex1.m2.4.4.2.1.1.2.cmml">ℳ</mi><mi id="S4.Ex1.m2.4.4.2.1.1.3" xref="S4.Ex1.m2.4.4.2.1.1.3.cmml">n</mi></msub><mo id="S4.Ex1.m2.4.4.2.1.3" stretchy="false" xref="S4.Ex1.m2.4.4.2.2.1.cmml">|</mo></mrow></mfrac></mstyle></mrow></mrow><mo id="S4.Ex1.m2.5.5.1.2" lspace="0em">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.Ex1.m2.5b"><apply id="S4.Ex1.m2.5.5.1.1.3.cmml" xref="S4.Ex1.m2.5.5.1.1.2"><csymbol cd="ambiguous" id="S4.Ex1.m2.5.5.1.1.3a.cmml" xref="S4.Ex1.m2.5.5.1.1.2.3">formulae-sequence</csymbol><apply id="S4.Ex1.m2.5.5.1.1.1.1.cmml" xref="S4.Ex1.m2.5.5.1.1.1.1"><eq id="S4.Ex1.m2.5.5.1.1.1.1.1.cmml" xref="S4.Ex1.m2.5.5.1.1.1.1.1"></eq><csymbol cd="latexml" id="S4.Ex1.m2.5.5.1.1.1.1.2.cmml" xref="S4.Ex1.m2.5.5.1.1.1.1.2">absent</csymbol><apply id="S4.Ex1.m2.2.2.cmml" xref="S4.Ex1.m2.2.2"><divide id="S4.Ex1.m2.2.2.3.cmml" xref="S4.Ex1.m2.2.2"></divide><apply id="S4.Ex1.m2.1.1.1.2.cmml" xref="S4.Ex1.m2.1.1.1.1"><abs id="S4.Ex1.m2.1.1.1.2.1.cmml" xref="S4.Ex1.m2.1.1.1.1.2"></abs><apply id="S4.Ex1.m2.1.1.1.1.1.cmml" xref="S4.Ex1.m2.1.1.1.1.1"><intersect id="S4.Ex1.m2.1.1.1.1.1.1.cmml" xref="S4.Ex1.m2.1.1.1.1.1.1"></intersect><apply id="S4.Ex1.m2.1.1.1.1.1.2.cmml" xref="S4.Ex1.m2.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.Ex1.m2.1.1.1.1.1.2.1.cmml" xref="S4.Ex1.m2.1.1.1.1.1.2">subscript</csymbol><ci id="S4.Ex1.m2.1.1.1.1.1.2.2.cmml" xref="S4.Ex1.m2.1.1.1.1.1.2.2">ℳ</ci><ci id="S4.Ex1.m2.1.1.1.1.1.2.3.cmml" xref="S4.Ex1.m2.1.1.1.1.1.2.3">𝑛</ci></apply><apply id="S4.Ex1.m2.1.1.1.1.1.3.cmml" xref="S4.Ex1.m2.1.1.1.1.1.3"><csymbol cd="ambiguous" id="S4.Ex1.m2.1.1.1.1.1.3.1.cmml" xref="S4.Ex1.m2.1.1.1.1.1.3">subscript</csymbol><ci id="S4.Ex1.m2.1.1.1.1.1.3.2.cmml" xref="S4.Ex1.m2.1.1.1.1.1.3.2">ℳ</ci><ci id="S4.Ex1.m2.1.1.1.1.1.3.3a.cmml" xref="S4.Ex1.m2.1.1.1.1.1.3.3"><mtext id="S4.Ex1.m2.1.1.1.1.1.3.3.cmml" mathsize="70%" xref="S4.Ex1.m2.1.1.1.1.1.3.3">GT</mtext></ci></apply></apply></apply><apply id="S4.Ex1.m2.2.2.2.2.cmml" xref="S4.Ex1.m2.2.2.2.1"><abs id="S4.Ex1.m2.2.2.2.2.1.cmml" xref="S4.Ex1.m2.2.2.2.1.2"></abs><apply id="S4.Ex1.m2.2.2.2.1.1.cmml" xref="S4.Ex1.m2.2.2.2.1.1"><union id="S4.Ex1.m2.2.2.2.1.1.1.cmml" xref="S4.Ex1.m2.2.2.2.1.1.1"></union><apply id="S4.Ex1.m2.2.2.2.1.1.2.cmml" xref="S4.Ex1.m2.2.2.2.1.1.2"><csymbol cd="ambiguous" id="S4.Ex1.m2.2.2.2.1.1.2.1.cmml" xref="S4.Ex1.m2.2.2.2.1.1.2">subscript</csymbol><ci id="S4.Ex1.m2.2.2.2.1.1.2.2.cmml" xref="S4.Ex1.m2.2.2.2.1.1.2.2">ℳ</ci><ci id="S4.Ex1.m2.2.2.2.1.1.2.3.cmml" xref="S4.Ex1.m2.2.2.2.1.1.2.3">𝑛</ci></apply><apply id="S4.Ex1.m2.2.2.2.1.1.3.cmml" xref="S4.Ex1.m2.2.2.2.1.1.3"><csymbol cd="ambiguous" id="S4.Ex1.m2.2.2.2.1.1.3.1.cmml" xref="S4.Ex1.m2.2.2.2.1.1.3">subscript</csymbol><ci id="S4.Ex1.m2.2.2.2.1.1.3.2.cmml" xref="S4.Ex1.m2.2.2.2.1.1.3.2">ℳ</ci><ci id="S4.Ex1.m2.2.2.2.1.1.3.3a.cmml" xref="S4.Ex1.m2.2.2.2.1.1.3.3"><mtext id="S4.Ex1.m2.2.2.2.1.1.3.3.cmml" mathsize="70%" xref="S4.Ex1.m2.2.2.2.1.1.3.3">GT</mtext></ci></apply></apply></apply></apply></apply><apply id="S4.Ex1.m2.5.5.1.1.2.2.cmml" xref="S4.Ex1.m2.5.5.1.1.2.2"><eq id="S4.Ex1.m2.5.5.1.1.2.2.3.cmml" xref="S4.Ex1.m2.5.5.1.1.2.2.3"></eq><apply id="S4.Ex1.m2.5.5.1.1.2.2.2.cmml" xref="S4.Ex1.m2.5.5.1.1.2.2.2"><times id="S4.Ex1.m2.5.5.1.1.2.2.2.3.cmml" xref="S4.Ex1.m2.5.5.1.1.2.2.2.3"></times><ci id="S4.Ex1.m2.5.5.1.1.2.2.2.4.cmml" xref="S4.Ex1.m2.5.5.1.1.2.2.2.4">RefusalRate</ci><interval closure="open" id="S4.Ex1.m2.5.5.1.1.2.2.2.2.3.cmml" xref="S4.Ex1.m2.5.5.1.1.2.2.2.2.2"><apply id="S4.Ex1.m2.5.5.1.1.2.2.1.1.1.1.cmml" xref="S4.Ex1.m2.5.5.1.1.2.2.1.1.1.1"><csymbol cd="ambiguous" id="S4.Ex1.m2.5.5.1.1.2.2.1.1.1.1.1.cmml" xref="S4.Ex1.m2.5.5.1.1.2.2.1.1.1.1">subscript</csymbol><ci id="S4.Ex1.m2.5.5.1.1.2.2.1.1.1.1.2.cmml" xref="S4.Ex1.m2.5.5.1.1.2.2.1.1.1.1.2">ℳ</ci><ci id="S4.Ex1.m2.5.5.1.1.2.2.1.1.1.1.3.cmml" xref="S4.Ex1.m2.5.5.1.1.2.2.1.1.1.1.3">𝑛</ci></apply><apply id="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.2.cmml" xref="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.2"><csymbol cd="ambiguous" id="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.2.1.cmml" xref="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.2">subscript</csymbol><ci id="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.2.2.cmml" xref="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.2.2">ℳ</ci><ci id="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.2.3.cmml" xref="S4.Ex1.m2.5.5.1.1.2.2.2.2.2.2.3">𝐶</ci></apply></interval></apply><apply id="S4.Ex1.m2.4.4.cmml" xref="S4.Ex1.m2.4.4"><divide id="S4.Ex1.m2.4.4.3.cmml" xref="S4.Ex1.m2.4.4"></divide><apply id="S4.Ex1.m2.3.3.1.2.cmml" xref="S4.Ex1.m2.3.3.1.1"><abs id="S4.Ex1.m2.3.3.1.2.1.cmml" xref="S4.Ex1.m2.3.3.1.1.2"></abs><apply id="S4.Ex1.m2.3.3.1.1.1.3.cmml" xref="S4.Ex1.m2.3.3.1.1.1.2"><csymbol cd="latexml" id="S4.Ex1.m2.3.3.1.1.1.3.1.cmml" xref="S4.Ex1.m2.3.3.1.1.1.2.3">conditional-set</csymbol><apply id="S4.Ex1.m2.3.3.1.1.1.1.1.cmml" xref="S4.Ex1.m2.3.3.1.1.1.1.1"><in id="S4.Ex1.m2.3.3.1.1.1.1.1.1.cmml" xref="S4.Ex1.m2.3.3.1.1.1.1.1.1"></in><ci id="S4.Ex1.m2.3.3.1.1.1.1.1.2.cmml" xref="S4.Ex1.m2.3.3.1.1.1.1.1.2">𝑚</ci><apply id="S4.Ex1.m2.3.3.1.1.1.1.1.3.cmml" xref="S4.Ex1.m2.3.3.1.1.1.1.1.3"><csymbol cd="ambiguous" id="S4.Ex1.m2.3.3.1.1.1.1.1.3.1.cmml" xref="S4.Ex1.m2.3.3.1.1.1.1.1.3">subscript</csymbol><ci id="S4.Ex1.m2.3.3.1.1.1.1.1.3.2.cmml" xref="S4.Ex1.m2.3.3.1.1.1.1.1.3.2">ℳ</ci><ci id="S4.Ex1.m2.3.3.1.1.1.1.1.3.3.cmml" xref="S4.Ex1.m2.3.3.1.1.1.1.1.3.3">𝑛</ci></apply></apply><apply id="S4.Ex1.m2.3.3.1.1.1.2.2.cmml" xref="S4.Ex1.m2.3.3.1.1.1.2.2"><notin id="S4.Ex1.m2.3.3.1.1.1.2.2.1.cmml" xref="S4.Ex1.m2.3.3.1.1.1.2.2.1"></notin><ci id="S4.Ex1.m2.3.3.1.1.1.2.2.2.cmml" xref="S4.Ex1.m2.3.3.1.1.1.2.2.2">𝑚</ci><apply id="S4.Ex1.m2.3.3.1.1.1.2.2.3.cmml" xref="S4.Ex1.m2.3.3.1.1.1.2.2.3"><csymbol cd="ambiguous" id="S4.Ex1.m2.3.3.1.1.1.2.2.3.1.cmml" xref="S4.Ex1.m2.3.3.1.1.1.2.2.3">subscript</csymbol><ci id="S4.Ex1.m2.3.3.1.1.1.2.2.3.2.cmml" xref="S4.Ex1.m2.3.3.1.1.1.2.2.3.2">ℳ</ci><ci id="S4.Ex1.m2.3.3.1.1.1.2.2.3.3.cmml" xref="S4.Ex1.m2.3.3.1.1.1.2.2.3.3">𝐶</ci></apply></apply></apply></apply><apply id="S4.Ex1.m2.4.4.2.2.cmml" xref="S4.Ex1.m2.4.4.2.1"><abs id="S4.Ex1.m2.4.4.2.2.1.cmml" xref="S4.Ex1.m2.4.4.2.1.2"></abs><apply id="S4.Ex1.m2.4.4.2.1.1.cmml" xref="S4.Ex1.m2.4.4.2.1.1"><csymbol cd="ambiguous" id="S4.Ex1.m2.4.4.2.1.1.1.cmml" xref="S4.Ex1.m2.4.4.2.1.1">subscript</csymbol><ci id="S4.Ex1.m2.4.4.2.1.1.2.cmml" xref="S4.Ex1.m2.4.4.2.1.1.2">ℳ</ci><ci id="S4.Ex1.m2.4.4.2.1.1.3.cmml" xref="S4.Ex1.m2.4.4.2.1.1.3">𝑛</ci></apply></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.Ex1.m2.5c">\displaystyle=\frac{|\mathcal{M}_{n}\cap\mathcal{M}_{\text{GT}}|}{|\mathcal{M}%
_{n}\cup\mathcal{M}_{\text{GT}}|},~{}~{}~{}~{}\mathrm{RefusalRate}(\mathcal{M}%
_{n},\mathcal{M}_{C})=\frac{|\{m\in\mathcal{M}_{n}\mid m\notin\mathcal{M}_{C}%
\}|}{|\mathcal{M}_{n}|}.</annotation><annotation encoding="application/x-llamapun" id="S4.Ex1.m2.5d">= divide start_ARG | caligraphic_M start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT ∩ caligraphic_M start_POSTSUBSCRIPT GT end_POSTSUBSCRIPT | end_ARG start_ARG | caligraphic_M start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT ∪ caligraphic_M start_POSTSUBSCRIPT GT end_POSTSUBSCRIPT | end_ARG , roman_RefusalRate ( caligraphic_M start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT , caligraphic_M start_POSTSUBSCRIPT italic_C end_POSTSUBSCRIPT ) = divide start_ARG | { italic_m ∈ caligraphic_M start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT ∣ italic_m ∉ caligraphic_M start_POSTSUBSCRIPT italic_C end_POSTSUBSCRIPT } | end_ARG start_ARG | caligraphic_M start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT | end_ARG .</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
</tr></tbody>
<tbody id="S4.Ex2"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math alttext="\displaystyle\mathrm{DDI}(\mathcal{M}_{n},\bm{D})" class="ltx_Math" display="inline" id="S4.Ex2.m1.2"><semantics id="S4.Ex2.m1.2a"><mrow id="S4.Ex2.m1.2.2" xref="S4.Ex2.m1.2.2.cmml"><mi id="S4.Ex2.m1.2.2.3" xref="S4.Ex2.m1.2.2.3.cmml">DDI</mi><mo id="S4.Ex2.m1.2.2.2" xref="S4.Ex2.m1.2.2.2.cmml">⁢</mo><mrow id="S4.Ex2.m1.2.2.1.1" xref="S4.Ex2.m1.2.2.1.2.cmml"><mo id="S4.Ex2.m1.2.2.1.1.2" stretchy="false" xref="S4.Ex2.m1.2.2.1.2.cmml">(</mo><msub id="S4.Ex2.m1.2.2.1.1.1" xref="S4.Ex2.m1.2.2.1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.Ex2.m1.2.2.1.1.1.2" xref="S4.Ex2.m1.2.2.1.1.1.2.cmml">ℳ</mi><mi id="S4.Ex2.m1.2.2.1.1.1.3" xref="S4.Ex2.m1.2.2.1.1.1.3.cmml">n</mi></msub><mo id="S4.Ex2.m1.2.2.1.1.3" xref="S4.Ex2.m1.2.2.1.2.cmml">,</mo><mi id="S4.Ex2.m1.1.1" xref="S4.Ex2.m1.1.1.cmml">𝑫</mi><mo id="S4.Ex2.m1.2.2.1.1.4" stretchy="false" xref="S4.Ex2.m1.2.2.1.2.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.Ex2.m1.2b"><apply id="S4.Ex2.m1.2.2.cmml" xref="S4.Ex2.m1.2.2"><times id="S4.Ex2.m1.2.2.2.cmml" xref="S4.Ex2.m1.2.2.2"></times><ci id="S4.Ex2.m1.2.2.3.cmml" xref="S4.Ex2.m1.2.2.3">DDI</ci><interval closure="open" id="S4.Ex2.m1.2.2.1.2.cmml" xref="S4.Ex2.m1.2.2.1.1"><apply id="S4.Ex2.m1.2.2.1.1.1.cmml" xref="S4.Ex2.m1.2.2.1.1.1"><csymbol cd="ambiguous" id="S4.Ex2.m1.2.2.1.1.1.1.cmml" xref="S4.Ex2.m1.2.2.1.1.1">subscript</csymbol><ci id="S4.Ex2.m1.2.2.1.1.1.2.cmml" xref="S4.Ex2.m1.2.2.1.1.1.2">ℳ</ci><ci id="S4.Ex2.m1.2.2.1.1.1.3.cmml" xref="S4.Ex2.m1.2.2.1.1.1.3">𝑛</ci></apply><ci id="S4.Ex2.m1.1.1.cmml" xref="S4.Ex2.m1.1.1">𝑫</ci></interval></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.Ex2.m1.2c">\displaystyle\mathrm{DDI}(\mathcal{M}_{n},\bm{D})</annotation><annotation encoding="application/x-llamapun" id="S4.Ex2.m1.2d">roman_DDI ( caligraphic_M start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT , bold_italic_D )</annotation></semantics></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math alttext="\displaystyle=\frac{\left|\left\{(m_{i},m_{j})\mid m_{i},m_{j}\in\mathcal{M}_{%
n},\,i&lt;j,\,\bm{D}[m_{i},m_{j}]=1\right\}\right|}{\binom{|\mathcal{M}_{n}|}{2}}." class="ltx_Math" display="inline" id="S4.Ex2.m2.5"><semantics id="S4.Ex2.m2.5a"><mrow id="S4.Ex2.m2.5.5.1" xref="S4.Ex2.m2.5.5.1.1.cmml"><mrow id="S4.Ex2.m2.5.5.1.1" xref="S4.Ex2.m2.5.5.1.1.cmml"><mi id="S4.Ex2.m2.5.5.1.1.2" xref="S4.Ex2.m2.5.5.1.1.2.cmml"></mi><mo id="S4.Ex2.m2.5.5.1.1.1" xref="S4.Ex2.m2.5.5.1.1.1.cmml">=</mo><mstyle displaystyle="true" id="S4.Ex2.m2.4.4" xref="S4.Ex2.m2.4.4.cmml"><mfrac id="S4.Ex2.m2.4.4a" xref="S4.Ex2.m2.4.4.cmml"><mrow id="S4.Ex2.m2.4.4.4.2" xref="S4.Ex2.m2.4.4.4.3.cmml"><mo id="S4.Ex2.m2.4.4.4.2.2" xref="S4.Ex2.m2.4.4.4.3.1.cmml">|</mo><mrow id="S4.Ex2.m2.4.4.4.2.1.2" xref="S4.Ex2.m2.4.4.4.2.1.3.cmml"><mo id="S4.Ex2.m2.4.4.4.2.1.2.3" xref="S4.Ex2.m2.4.4.4.2.1.3.1.cmml">{</mo><mrow id="S4.Ex2.m2.4.4.4.2.1.1.1.2" xref="S4.Ex2.m2.4.4.4.2.1.1.1.3.cmml"><mo id="S4.Ex2.m2.4.4.4.2.1.1.1.2.3" stretchy="false" xref="S4.Ex2.m2.4.4.4.2.1.1.1.3.cmml">(</mo><msub id="S4.Ex2.m2.4.4.4.2.1.1.1.1.1" xref="S4.Ex2.m2.4.4.4.2.1.1.1.1.1.cmml"><mi id="S4.Ex2.m2.4.4.4.2.1.1.1.1.1.2" xref="S4.Ex2.m2.4.4.4.2.1.1.1.1.1.2.cmml">m</mi><mi id="S4.Ex2.m2.4.4.4.2.1.1.1.1.1.3" xref="S4.Ex2.m2.4.4.4.2.1.1.1.1.1.3.cmml">i</mi></msub><mo id="S4.Ex2.m2.4.4.4.2.1.1.1.2.4" xref="S4.Ex2.m2.4.4.4.2.1.1.1.3.cmml">,</mo><msub id="S4.Ex2.m2.4.4.4.2.1.1.1.2.2" xref="S4.Ex2.m2.4.4.4.2.1.1.1.2.2.cmml"><mi id="S4.Ex2.m2.4.4.4.2.1.1.1.2.2.2" xref="S4.Ex2.m2.4.4.4.2.1.1.1.2.2.2.cmml">m</mi><mi id="S4.Ex2.m2.4.4.4.2.1.1.1.2.2.3" xref="S4.Ex2.m2.4.4.4.2.1.1.1.2.2.3.cmml">j</mi></msub><mo id="S4.Ex2.m2.4.4.4.2.1.1.1.2.5" stretchy="false" xref="S4.Ex2.m2.4.4.4.2.1.1.1.3.cmml">)</mo></mrow><mo fence="true" id="S4.Ex2.m2.4.4.4.2.1.2.4" lspace="0em" rspace="0em" xref="S4.Ex2.m2.4.4.4.2.1.3.1.cmml">∣</mo><mrow id="S4.Ex2.m2.4.4.4.2.1.2.2.2" xref="S4.Ex2.m2.4.4.4.2.1.2.2.3.cmml"><mrow id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.cmml"><mrow id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.3.cmml"><msub id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.1.1.1" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.1.1.1.cmml"><mi id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.1.1.1.2" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.1.1.1.2.cmml">m</mi><mi id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.1.1.1.3" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.1.1.1.3.cmml">i</mi></msub><mo id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2.3" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.3.cmml">,</mo><msub id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2.2" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2.2.cmml"><mi id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2.2.2" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2.2.2.cmml">m</mi><mi id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2.2.3" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2.2.3.cmml">j</mi></msub></mrow><mo id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.3" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.3.cmml">∈</mo><msub id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.4" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.4.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.4.2" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.4.2.cmml">ℳ</mi><mi id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.4.3" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.4.3.cmml">n</mi></msub></mrow><mo id="S4.Ex2.m2.4.4.4.2.1.2.2.2.3" rspace="0.337em" xref="S4.Ex2.m2.4.4.4.2.1.2.2.3a.cmml">,</mo><mrow id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.3.cmml"><mrow id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.1.1" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.1.1.cmml"><mi id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.1.1.2" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.1.1.2.cmml">i</mi><mo id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.1.1.1" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.1.1.1.cmml">&lt;</mo><mi id="S4.Ex2.m2.3.3.3.1" xref="S4.Ex2.m2.3.3.3.1.cmml">j</mi></mrow><mo id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.3" rspace="0.337em" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.3a.cmml">,</mo><mrow id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.cmml"><mrow id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.cmml"><mi id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.4" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.4.cmml">𝑫</mi><mo id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.3" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.3.cmml">⁢</mo><mrow id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.3.cmml"><mo id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.3" stretchy="false" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.3.cmml">[</mo><msub id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.cmml"><mi id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.2" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.2.cmml">m</mi><mi id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.3" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.3.cmml">i</mi></msub><mo id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.4" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.3.cmml">,</mo><msub id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.cmml"><mi id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.2" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.2.cmml">m</mi><mi id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.3" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.3.cmml">j</mi></msub><mo id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.5" stretchy="false" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.3.cmml">]</mo></mrow></mrow><mo id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.3" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.3.cmml">=</mo><mn id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.4" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.4.cmml">1</mn></mrow></mrow></mrow><mo id="S4.Ex2.m2.4.4.4.2.1.2.5" xref="S4.Ex2.m2.4.4.4.2.1.3.1.cmml">}</mo></mrow><mo id="S4.Ex2.m2.4.4.4.2.3" xref="S4.Ex2.m2.4.4.4.3.1.cmml">|</mo></mrow><mrow id="S4.Ex2.m2.2.2.2a.4" xref="S4.Ex2.m2.2.2.2a.3.cmml"><mo id="S4.Ex2.m2.2.2.2a.4.1" xref="S4.Ex2.m2.2.2.2a.3.1.cmml">(</mo><mfrac id="S4.Ex2.m2.2.2.2.2.2.2a" linethickness="0pt" xref="S4.Ex2.m2.2.2.2a.3.cmml"><mrow id="S4.Ex2.m2.1.1.1.1.1.1.1.1.1" xref="S4.Ex2.m2.1.1.1.1.1.1.1.1.2.cmml"><mo id="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.2" stretchy="false" xref="S4.Ex2.m2.1.1.1.1.1.1.1.1.2.1.cmml">|</mo><msub id="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.1" xref="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.1.2" xref="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.1.2.cmml">ℳ</mi><mi id="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.1.3" xref="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.1.3.cmml">n</mi></msub><mo id="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.3" stretchy="false" xref="S4.Ex2.m2.1.1.1.1.1.1.1.1.2.1.cmml">|</mo></mrow><mn id="S4.Ex2.m2.2.2.2.2.2.2.2.1" xref="S4.Ex2.m2.2.2.2.2.2.2.2.1.cmml">2</mn></mfrac><mo id="S4.Ex2.m2.2.2.2a.4.2" xref="S4.Ex2.m2.2.2.2a.3.1.cmml">)</mo></mrow></mfrac></mstyle></mrow><mo id="S4.Ex2.m2.5.5.1.2" lspace="0em" xref="S4.Ex2.m2.5.5.1.1.cmml">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.Ex2.m2.5b"><apply id="S4.Ex2.m2.5.5.1.1.cmml" xref="S4.Ex2.m2.5.5.1"><eq id="S4.Ex2.m2.5.5.1.1.1.cmml" xref="S4.Ex2.m2.5.5.1.1.1"></eq><csymbol cd="latexml" id="S4.Ex2.m2.5.5.1.1.2.cmml" xref="S4.Ex2.m2.5.5.1.1.2">absent</csymbol><apply id="S4.Ex2.m2.4.4.cmml" xref="S4.Ex2.m2.4.4"><divide id="S4.Ex2.m2.4.4.5.cmml" xref="S4.Ex2.m2.4.4"></divide><apply id="S4.Ex2.m2.4.4.4.3.cmml" xref="S4.Ex2.m2.4.4.4.2"><abs id="S4.Ex2.m2.4.4.4.3.1.cmml" xref="S4.Ex2.m2.4.4.4.2.2"></abs><apply id="S4.Ex2.m2.4.4.4.2.1.3.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2"><csymbol cd="latexml" id="S4.Ex2.m2.4.4.4.2.1.3.1.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.3">conditional-set</csymbol><interval closure="open" id="S4.Ex2.m2.4.4.4.2.1.1.1.3.cmml" xref="S4.Ex2.m2.4.4.4.2.1.1.1.2"><apply id="S4.Ex2.m2.4.4.4.2.1.1.1.1.1.cmml" xref="S4.Ex2.m2.4.4.4.2.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.Ex2.m2.4.4.4.2.1.1.1.1.1.1.cmml" xref="S4.Ex2.m2.4.4.4.2.1.1.1.1.1">subscript</csymbol><ci id="S4.Ex2.m2.4.4.4.2.1.1.1.1.1.2.cmml" xref="S4.Ex2.m2.4.4.4.2.1.1.1.1.1.2">𝑚</ci><ci id="S4.Ex2.m2.4.4.4.2.1.1.1.1.1.3.cmml" xref="S4.Ex2.m2.4.4.4.2.1.1.1.1.1.3">𝑖</ci></apply><apply id="S4.Ex2.m2.4.4.4.2.1.1.1.2.2.cmml" xref="S4.Ex2.m2.4.4.4.2.1.1.1.2.2"><csymbol cd="ambiguous" id="S4.Ex2.m2.4.4.4.2.1.1.1.2.2.1.cmml" xref="S4.Ex2.m2.4.4.4.2.1.1.1.2.2">subscript</csymbol><ci id="S4.Ex2.m2.4.4.4.2.1.1.1.2.2.2.cmml" xref="S4.Ex2.m2.4.4.4.2.1.1.1.2.2.2">𝑚</ci><ci id="S4.Ex2.m2.4.4.4.2.1.1.1.2.2.3.cmml" xref="S4.Ex2.m2.4.4.4.2.1.1.1.2.2.3">𝑗</ci></apply></interval><apply id="S4.Ex2.m2.4.4.4.2.1.2.2.3.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2"><csymbol cd="ambiguous" id="S4.Ex2.m2.4.4.4.2.1.2.2.3a.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.3">formulae-sequence</csymbol><apply id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1"><in id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.3.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.3"></in><list id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.3.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2"><apply id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.1.1.1.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.1.1.1.1.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.1.1.1">subscript</csymbol><ci id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.1.1.1.2.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.1.1.1.2">𝑚</ci><ci id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.1.1.1.3.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.1.1.1.3">𝑖</ci></apply><apply id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2.2.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2.2"><csymbol cd="ambiguous" id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2.2.1.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2.2">subscript</csymbol><ci id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2.2.2.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2.2.2">𝑚</ci><ci id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2.2.3.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.2.2.2.3">𝑗</ci></apply></list><apply id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.4.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.4"><csymbol cd="ambiguous" id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.4.1.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.4">subscript</csymbol><ci id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.4.2.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.4.2">ℳ</ci><ci id="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.4.3.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.1.1.4.3">𝑛</ci></apply></apply><apply id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.3.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2"><csymbol cd="ambiguous" id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.3a.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.3">formulae-sequence</csymbol><apply id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.1.1.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.1.1"><lt id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.1.1.1.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.1.1.1"></lt><ci id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.1.1.2.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.1.1.2">𝑖</ci><ci id="S4.Ex2.m2.3.3.3.1.cmml" xref="S4.Ex2.m2.3.3.3.1">𝑗</ci></apply><apply id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2"><eq id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.3.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.3"></eq><apply id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2"><times id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.3.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.3"></times><ci id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.4.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.4">𝑫</ci><interval closure="closed" id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.3.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2"><apply id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1"><csymbol cd="ambiguous" id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.1.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1">subscript</csymbol><ci id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.2.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.2">𝑚</ci><ci id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.3.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.3">𝑖</ci></apply><apply id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2"><csymbol cd="ambiguous" id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.1.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2">subscript</csymbol><ci id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.2.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.2">𝑚</ci><ci id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.3.cmml" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.3">𝑗</ci></apply></interval></apply><cn id="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.4.cmml" type="integer" xref="S4.Ex2.m2.4.4.4.2.1.2.2.2.2.2.2.4">1</cn></apply></apply></apply></apply></apply><apply id="S4.Ex2.m2.2.2.2a.3.cmml" xref="S4.Ex2.m2.2.2.2a.4"><csymbol cd="latexml" id="S4.Ex2.m2.2.2.2a.3.1.cmml" xref="S4.Ex2.m2.2.2.2a.4.1">binomial</csymbol><apply id="S4.Ex2.m2.1.1.1.1.1.1.1.1.2.cmml" xref="S4.Ex2.m2.1.1.1.1.1.1.1.1.1"><abs id="S4.Ex2.m2.1.1.1.1.1.1.1.1.2.1.cmml" xref="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.2"></abs><apply id="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.1.cmml" xref="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.1">subscript</csymbol><ci id="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.1.2.cmml" xref="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.1.2">ℳ</ci><ci id="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.1.3.cmml" xref="S4.Ex2.m2.1.1.1.1.1.1.1.1.1.1.3">𝑛</ci></apply></apply><cn id="S4.Ex2.m2.2.2.2.2.2.2.2.1.cmml" type="integer" xref="S4.Ex2.m2.2.2.2.2.2.2.2.1">2</cn></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.Ex2.m2.5c">\displaystyle=\frac{\left|\left\{(m_{i},m_{j})\mid m_{i},m_{j}\in\mathcal{M}_{%
n},\,i&lt;j,\,\bm{D}[m_{i},m_{j}]=1\right\}\right|}{\binom{|\mathcal{M}_{n}|}{2}}.</annotation><annotation encoding="application/x-llamapun" id="S4.Ex2.m2.5d">= divide start_ARG | { ( italic_m start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT , italic_m start_POSTSUBSCRIPT italic_j end_POSTSUBSCRIPT ) ∣ italic_m start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT , italic_m start_POSTSUBSCRIPT italic_j end_POSTSUBSCRIPT ∈ caligraphic_M start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT , italic_i &lt; italic_j , bold_italic_D [ italic_m start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT , italic_m start_POSTSUBSCRIPT italic_j end_POSTSUBSCRIPT ] = 1 } | end_ARG start_ARG ( FRACOP start_ARG | caligraphic_M start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT | end_ARG start_ARG 2 end_ARG ) end_ARG .</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
</tr></tbody>
</table>
</div>
<div class="ltx_para" id="S4.SS2.p2">
<p class="ltx_p" id="S4.SS2.p2.2">This potential function <math alttext="\varphi(\text{step}(t))" class="ltx_Math" display="inline" id="S4.SS2.p2.1.m1.2"><semantics id="S4.SS2.p2.1.m1.2a"><mrow id="S4.SS2.p2.1.m1.2.2" xref="S4.SS2.p2.1.m1.2.2.cmml"><mi id="S4.SS2.p2.1.m1.2.2.3" xref="S4.SS2.p2.1.m1.2.2.3.cmml">φ</mi><mo id="S4.SS2.p2.1.m1.2.2.2" xref="S4.SS2.p2.1.m1.2.2.2.cmml">⁢</mo><mrow id="S4.SS2.p2.1.m1.2.2.1.1" xref="S4.SS2.p2.1.m1.2.2.1.1.1.cmml"><mo id="S4.SS2.p2.1.m1.2.2.1.1.2" stretchy="false" xref="S4.SS2.p2.1.m1.2.2.1.1.1.cmml">(</mo><mrow id="S4.SS2.p2.1.m1.2.2.1.1.1" xref="S4.SS2.p2.1.m1.2.2.1.1.1.cmml"><mtext id="S4.SS2.p2.1.m1.2.2.1.1.1.2" xref="S4.SS2.p2.1.m1.2.2.1.1.1.2a.cmml">step</mtext><mo id="S4.SS2.p2.1.m1.2.2.1.1.1.1" xref="S4.SS2.p2.1.m1.2.2.1.1.1.1.cmml">⁢</mo><mrow id="S4.SS2.p2.1.m1.2.2.1.1.1.3.2" xref="S4.SS2.p2.1.m1.2.2.1.1.1.cmml"><mo id="S4.SS2.p2.1.m1.2.2.1.1.1.3.2.1" stretchy="false" xref="S4.SS2.p2.1.m1.2.2.1.1.1.cmml">(</mo><mi id="S4.SS2.p2.1.m1.1.1" xref="S4.SS2.p2.1.m1.1.1.cmml">t</mi><mo id="S4.SS2.p2.1.m1.2.2.1.1.1.3.2.2" stretchy="false" xref="S4.SS2.p2.1.m1.2.2.1.1.1.cmml">)</mo></mrow></mrow><mo id="S4.SS2.p2.1.m1.2.2.1.1.3" stretchy="false" xref="S4.SS2.p2.1.m1.2.2.1.1.1.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.SS2.p2.1.m1.2b"><apply id="S4.SS2.p2.1.m1.2.2.cmml" xref="S4.SS2.p2.1.m1.2.2"><times id="S4.SS2.p2.1.m1.2.2.2.cmml" xref="S4.SS2.p2.1.m1.2.2.2"></times><ci id="S4.SS2.p2.1.m1.2.2.3.cmml" xref="S4.SS2.p2.1.m1.2.2.3">𝜑</ci><apply id="S4.SS2.p2.1.m1.2.2.1.1.1.cmml" xref="S4.SS2.p2.1.m1.2.2.1.1"><times id="S4.SS2.p2.1.m1.2.2.1.1.1.1.cmml" xref="S4.SS2.p2.1.m1.2.2.1.1.1.1"></times><ci id="S4.SS2.p2.1.m1.2.2.1.1.1.2a.cmml" xref="S4.SS2.p2.1.m1.2.2.1.1.1.2"><mtext id="S4.SS2.p2.1.m1.2.2.1.1.1.2.cmml" xref="S4.SS2.p2.1.m1.2.2.1.1.1.2">step</mtext></ci><ci id="S4.SS2.p2.1.m1.1.1.cmml" xref="S4.SS2.p2.1.m1.1.1">𝑡</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p2.1.m1.2c">\varphi(\text{step}(t))</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p2.1.m1.2d">italic_φ ( step ( italic_t ) )</annotation></semantics></math> allows computing local advantage via step-wise differences (Eq. <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S4.E6" title="In 4.1 Step-wise GRPO ‣ 4 Method: FLAME ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">6</span></a>), assigning credit based on incremental improvement in the medication set <math alttext="\mathcal{M}_{n}" class="ltx_Math" display="inline" id="S4.SS2.p2.2.m2.1"><semantics id="S4.SS2.p2.2.m2.1a"><msub id="S4.SS2.p2.2.m2.1.1" xref="S4.SS2.p2.2.m2.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.SS2.p2.2.m2.1.1.2" xref="S4.SS2.p2.2.m2.1.1.2.cmml">ℳ</mi><mi id="S4.SS2.p2.2.m2.1.1.3" xref="S4.SS2.p2.2.m2.1.1.3.cmml">n</mi></msub><annotation-xml encoding="MathML-Content" id="S4.SS2.p2.2.m2.1b"><apply id="S4.SS2.p2.2.m2.1.1.cmml" xref="S4.SS2.p2.2.m2.1.1"><csymbol cd="ambiguous" id="S4.SS2.p2.2.m2.1.1.1.cmml" xref="S4.SS2.p2.2.m2.1.1">subscript</csymbol><ci id="S4.SS2.p2.2.m2.1.1.2.cmml" xref="S4.SS2.p2.2.m2.1.1.2">ℳ</ci><ci id="S4.SS2.p2.2.m2.1.1.3.cmml" xref="S4.SS2.p2.2.m2.1.1.3">𝑛</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p2.2.m2.1c">\mathcal{M}_{n}</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p2.2.m2.1d">caligraphic_M start_POSTSUBSCRIPT italic_n end_POSTSUBSCRIPT</annotation></semantics></math>.
The overall list-level reward is defined as the net potential change from the initial to the final step:</p>
<table class="ltx_equation ltx_eqn_table" id="S4.E9">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="R_{i}=\varphi(N_{i})-\varphi(0)" class="ltx_Math" display="block" id="S4.E9.m1.2"><semantics id="S4.E9.m1.2a"><mrow id="S4.E9.m1.2.2" xref="S4.E9.m1.2.2.cmml"><msub id="S4.E9.m1.2.2.3" xref="S4.E9.m1.2.2.3.cmml"><mi id="S4.E9.m1.2.2.3.2" xref="S4.E9.m1.2.2.3.2.cmml">R</mi><mi id="S4.E9.m1.2.2.3.3" xref="S4.E9.m1.2.2.3.3.cmml">i</mi></msub><mo id="S4.E9.m1.2.2.2" xref="S4.E9.m1.2.2.2.cmml">=</mo><mrow id="S4.E9.m1.2.2.1" xref="S4.E9.m1.2.2.1.cmml"><mrow id="S4.E9.m1.2.2.1.1" xref="S4.E9.m1.2.2.1.1.cmml"><mi id="S4.E9.m1.2.2.1.1.3" xref="S4.E9.m1.2.2.1.1.3.cmml">φ</mi><mo id="S4.E9.m1.2.2.1.1.2" xref="S4.E9.m1.2.2.1.1.2.cmml">⁢</mo><mrow id="S4.E9.m1.2.2.1.1.1.1" xref="S4.E9.m1.2.2.1.1.1.1.1.cmml"><mo id="S4.E9.m1.2.2.1.1.1.1.2" stretchy="false" xref="S4.E9.m1.2.2.1.1.1.1.1.cmml">(</mo><msub id="S4.E9.m1.2.2.1.1.1.1.1" xref="S4.E9.m1.2.2.1.1.1.1.1.cmml"><mi id="S4.E9.m1.2.2.1.1.1.1.1.2" xref="S4.E9.m1.2.2.1.1.1.1.1.2.cmml">N</mi><mi id="S4.E9.m1.2.2.1.1.1.1.1.3" xref="S4.E9.m1.2.2.1.1.1.1.1.3.cmml">i</mi></msub><mo id="S4.E9.m1.2.2.1.1.1.1.3" stretchy="false" xref="S4.E9.m1.2.2.1.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="S4.E9.m1.2.2.1.2" xref="S4.E9.m1.2.2.1.2.cmml">−</mo><mrow id="S4.E9.m1.2.2.1.3" xref="S4.E9.m1.2.2.1.3.cmml"><mi id="S4.E9.m1.2.2.1.3.2" xref="S4.E9.m1.2.2.1.3.2.cmml">φ</mi><mo id="S4.E9.m1.2.2.1.3.1" xref="S4.E9.m1.2.2.1.3.1.cmml">⁢</mo><mrow id="S4.E9.m1.2.2.1.3.3.2" xref="S4.E9.m1.2.2.1.3.cmml"><mo id="S4.E9.m1.2.2.1.3.3.2.1" stretchy="false" xref="S4.E9.m1.2.2.1.3.cmml">(</mo><mn id="S4.E9.m1.1.1" xref="S4.E9.m1.1.1.cmml">0</mn><mo id="S4.E9.m1.2.2.1.3.3.2.2" stretchy="false" xref="S4.E9.m1.2.2.1.3.cmml">)</mo></mrow></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.E9.m1.2b"><apply id="S4.E9.m1.2.2.cmml" xref="S4.E9.m1.2.2"><eq id="S4.E9.m1.2.2.2.cmml" xref="S4.E9.m1.2.2.2"></eq><apply id="S4.E9.m1.2.2.3.cmml" xref="S4.E9.m1.2.2.3"><csymbol cd="ambiguous" id="S4.E9.m1.2.2.3.1.cmml" xref="S4.E9.m1.2.2.3">subscript</csymbol><ci id="S4.E9.m1.2.2.3.2.cmml" xref="S4.E9.m1.2.2.3.2">𝑅</ci><ci id="S4.E9.m1.2.2.3.3.cmml" xref="S4.E9.m1.2.2.3.3">𝑖</ci></apply><apply id="S4.E9.m1.2.2.1.cmml" xref="S4.E9.m1.2.2.1"><minus id="S4.E9.m1.2.2.1.2.cmml" xref="S4.E9.m1.2.2.1.2"></minus><apply id="S4.E9.m1.2.2.1.1.cmml" xref="S4.E9.m1.2.2.1.1"><times id="S4.E9.m1.2.2.1.1.2.cmml" xref="S4.E9.m1.2.2.1.1.2"></times><ci id="S4.E9.m1.2.2.1.1.3.cmml" xref="S4.E9.m1.2.2.1.1.3">𝜑</ci><apply id="S4.E9.m1.2.2.1.1.1.1.1.cmml" xref="S4.E9.m1.2.2.1.1.1.1"><csymbol cd="ambiguous" id="S4.E9.m1.2.2.1.1.1.1.1.1.cmml" xref="S4.E9.m1.2.2.1.1.1.1">subscript</csymbol><ci id="S4.E9.m1.2.2.1.1.1.1.1.2.cmml" xref="S4.E9.m1.2.2.1.1.1.1.1.2">𝑁</ci><ci id="S4.E9.m1.2.2.1.1.1.1.1.3.cmml" xref="S4.E9.m1.2.2.1.1.1.1.1.3">𝑖</ci></apply></apply><apply id="S4.E9.m1.2.2.1.3.cmml" xref="S4.E9.m1.2.2.1.3"><times id="S4.E9.m1.2.2.1.3.1.cmml" xref="S4.E9.m1.2.2.1.3.1"></times><ci id="S4.E9.m1.2.2.1.3.2.cmml" xref="S4.E9.m1.2.2.1.3.2">𝜑</ci><cn id="S4.E9.m1.1.1.cmml" type="integer" xref="S4.E9.m1.1.1">0</cn></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E9.m1.2c">R_{i}=\varphi(N_{i})-\varphi(0)</annotation><annotation encoding="application/x-llamapun" id="S4.E9.m1.2d">italic_R start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT = italic_φ ( italic_N start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT ) - italic_φ ( 0 )</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(9)</span></td>
</tr></tbody>
</table>
</div>
<figure class="ltx_figure" id="S4.F3"><img alt="Refer to caption" class="ltx_graphics ltx_centering ltx_img_landscape" height="198" id="S4.F3.g1" src="x3.png" width="830"/>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure">Figure 3: </span>Illustration of the two-stage recommendation framework.</figcaption>
</figure>
<div class="ltx_theorem ltx_theorem_theorem" id="S4.Thmtheorem1">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold" id="S4.Thmtheorem1.1.1.1">Theorem 4.1</span></span><span class="ltx_text ltx_font_bold" id="S4.Thmtheorem1.2.2"> </span>(Optimal Policy Equivalence under Reward Reshaping)<span class="ltx_text ltx_font_bold" id="S4.Thmtheorem1.3.3">.</span>
</h6>
<div class="ltx_para" id="S4.Thmtheorem1.p1">
<p class="ltx_p" id="S4.Thmtheorem1.p1.2"><span class="ltx_text ltx_font_italic" id="S4.Thmtheorem1.p1.2.2">Let the token-level reward for each token <math alttext="t" class="ltx_Math" display="inline" id="S4.Thmtheorem1.p1.1.1.m1.1"><semantics id="S4.Thmtheorem1.p1.1.1.m1.1a"><mi id="S4.Thmtheorem1.p1.1.1.m1.1.1" xref="S4.Thmtheorem1.p1.1.1.m1.1.1.cmml">t</mi><annotation-xml encoding="MathML-Content" id="S4.Thmtheorem1.p1.1.1.m1.1b"><ci id="S4.Thmtheorem1.p1.1.1.m1.1.1.cmml" xref="S4.Thmtheorem1.p1.1.1.m1.1.1">𝑡</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.Thmtheorem1.p1.1.1.m1.1c">t</annotation><annotation encoding="application/x-llamapun" id="S4.Thmtheorem1.p1.1.1.m1.1d">italic_t</annotation></semantics></math> in the generated output <math alttext="\mathbf{o}_{i}" class="ltx_Math" display="inline" id="S4.Thmtheorem1.p1.2.2.m2.1"><semantics id="S4.Thmtheorem1.p1.2.2.m2.1a"><msub id="S4.Thmtheorem1.p1.2.2.m2.1.1" xref="S4.Thmtheorem1.p1.2.2.m2.1.1.cmml"><mi id="S4.Thmtheorem1.p1.2.2.m2.1.1.2" xref="S4.Thmtheorem1.p1.2.2.m2.1.1.2.cmml">𝐨</mi><mi id="S4.Thmtheorem1.p1.2.2.m2.1.1.3" xref="S4.Thmtheorem1.p1.2.2.m2.1.1.3.cmml">i</mi></msub><annotation-xml encoding="MathML-Content" id="S4.Thmtheorem1.p1.2.2.m2.1b"><apply id="S4.Thmtheorem1.p1.2.2.m2.1.1.cmml" xref="S4.Thmtheorem1.p1.2.2.m2.1.1"><csymbol cd="ambiguous" id="S4.Thmtheorem1.p1.2.2.m2.1.1.1.cmml" xref="S4.Thmtheorem1.p1.2.2.m2.1.1">subscript</csymbol><ci id="S4.Thmtheorem1.p1.2.2.m2.1.1.2.cmml" xref="S4.Thmtheorem1.p1.2.2.m2.1.1.2">𝐨</ci><ci id="S4.Thmtheorem1.p1.2.2.m2.1.1.3.cmml" xref="S4.Thmtheorem1.p1.2.2.m2.1.1.3">𝑖</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.Thmtheorem1.p1.2.2.m2.1c">\mathbf{o}_{i}</annotation><annotation encoding="application/x-llamapun" id="S4.Thmtheorem1.p1.2.2.m2.1d">bold_o start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT</annotation></semantics></math> be defined under the following two schemes:</span></p>
<table class="ltx_equationgroup ltx_eqn_align ltx_eqn_table" id="A5.EGx2">
<tbody id="S4.E10"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math alttext="\displaystyle\textbf{(1) Outcome-based reward:}\quad r_{i,t}" class="ltx_Math" display="inline" id="S4.E10.m1.4"><semantics id="S4.E10.m1.4a"><mrow id="S4.E10.m1.4.4.1" xref="S4.E10.m1.4.4.2.cmml"><mtext class="ltx_mathvariant_bold-italic" id="S4.E10.m1.3.3" xref="S4.E10.m1.3.3a.cmml">(1) Outcome-based reward:</mtext><mspace id="S4.E10.m1.4.4.1.2" width="1em" xref="S4.E10.m1.4.4.2.cmml"></mspace><msub id="S4.E10.m1.4.4.1.1" xref="S4.E10.m1.4.4.1.1.cmml"><mi id="S4.E10.m1.4.4.1.1.2" xref="S4.E10.m1.4.4.1.1.2.cmml">r</mi><mrow id="S4.E10.m1.2.2.2.4" xref="S4.E10.m1.2.2.2.3.cmml"><mi id="S4.E10.m1.1.1.1.1" xref="S4.E10.m1.1.1.1.1.cmml">i</mi><mo id="S4.E10.m1.2.2.2.4.1" xref="S4.E10.m1.2.2.2.3.cmml">,</mo><mi id="S4.E10.m1.2.2.2.2" xref="S4.E10.m1.2.2.2.2.cmml">t</mi></mrow></msub></mrow><annotation-xml encoding="MathML-Content" id="S4.E10.m1.4b"><list id="S4.E10.m1.4.4.2.cmml" xref="S4.E10.m1.4.4.1"><ci id="S4.E10.m1.3.3a.cmml" xref="S4.E10.m1.3.3"><mtext class="ltx_mathvariant_bold-italic" id="S4.E10.m1.3.3.cmml" xref="S4.E10.m1.3.3">(1) Outcome-based reward:</mtext></ci><apply id="S4.E10.m1.4.4.1.1.cmml" xref="S4.E10.m1.4.4.1.1"><csymbol cd="ambiguous" id="S4.E10.m1.4.4.1.1.1.cmml" xref="S4.E10.m1.4.4.1.1">subscript</csymbol><ci id="S4.E10.m1.4.4.1.1.2.cmml" xref="S4.E10.m1.4.4.1.1.2">𝑟</ci><list id="S4.E10.m1.2.2.2.3.cmml" xref="S4.E10.m1.2.2.2.4"><ci id="S4.E10.m1.1.1.1.1.cmml" xref="S4.E10.m1.1.1.1.1">𝑖</ci><ci id="S4.E10.m1.2.2.2.2.cmml" xref="S4.E10.m1.2.2.2.2">𝑡</ci></list></apply></list></annotation-xml><annotation encoding="application/x-tex" id="S4.E10.m1.4c">\displaystyle\textbf{(1) Outcome-based reward:}\quad r_{i,t}</annotation><annotation encoding="application/x-llamapun" id="S4.E10.m1.4d">(1) Outcome-based reward: italic_r start_POSTSUBSCRIPT italic_i , italic_t end_POSTSUBSCRIPT</annotation></semantics></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math alttext="\displaystyle=\begin{cases}R_{i},&amp;\text{if }t\text{ is the terminal token},\\
0,&amp;\text{otherwise}\end{cases}" class="ltx_Math" display="inline" id="S4.E10.m2.4"><semantics id="S4.E10.m2.4a"><mrow id="S4.E10.m2.4.5" xref="S4.E10.m2.4.5.cmml"><mi id="S4.E10.m2.4.5.2" xref="S4.E10.m2.4.5.2.cmml"></mi><mo id="S4.E10.m2.4.5.1" xref="S4.E10.m2.4.5.1.cmml">=</mo><mrow id="S4.E10.m2.4.4a" xref="S4.E10.m2.4.5.3.1.cmml"><mo id="S4.E10.m2.4.4a.5" xref="S4.E10.m2.4.5.3.1.1.cmml">{</mo><mtable columnspacing="5pt" id="S4.E10.m2.4.4.4a" rowspacing="0pt" xref="S4.E10.m2.4.5.3.1.cmml"><mtr id="S4.E10.m2.4.4.4aa" xref="S4.E10.m2.4.5.3.1.cmml"><mtd class="ltx_align_left" columnalign="left" id="S4.E10.m2.4.4.4ab" xref="S4.E10.m2.4.5.3.1.cmml"><mrow id="S4.E10.m2.1.1.1.1.1.1.1" xref="S4.E10.m2.1.1.1.1.1.1.1.1.cmml"><msub id="S4.E10.m2.1.1.1.1.1.1.1.1" xref="S4.E10.m2.1.1.1.1.1.1.1.1.cmml"><mi id="S4.E10.m2.1.1.1.1.1.1.1.1.2" xref="S4.E10.m2.1.1.1.1.1.1.1.1.2.cmml">R</mi><mi id="S4.E10.m2.1.1.1.1.1.1.1.1.3" xref="S4.E10.m2.1.1.1.1.1.1.1.1.3.cmml">i</mi></msub><mo id="S4.E10.m2.1.1.1.1.1.1.1.2" xref="S4.E10.m2.1.1.1.1.1.1.1.1.cmml">,</mo></mrow></mtd><mtd class="ltx_align_left" columnalign="left" id="S4.E10.m2.4.4.4ac" xref="S4.E10.m2.4.5.3.1.cmml"><mrow id="S4.E10.m2.2.2.2.2.2.1.1" xref="S4.E10.m2.2.2.2.2.2.1.1.1.cmml"><mrow id="S4.E10.m2.2.2.2.2.2.1.1.1" xref="S4.E10.m2.2.2.2.2.2.1.1.1.cmml"><mtext class="ltx_mathvariant_italic" id="S4.E10.m2.2.2.2.2.2.1.1.1.2" xref="S4.E10.m2.2.2.2.2.2.1.1.1.2a.cmml">if </mtext><mo id="S4.E10.m2.2.2.2.2.2.1.1.1.1" xref="S4.E10.m2.2.2.2.2.2.1.1.1.1.cmml">⁢</mo><mi id="S4.E10.m2.2.2.2.2.2.1.1.1.3" xref="S4.E10.m2.2.2.2.2.2.1.1.1.3.cmml">t</mi><mo id="S4.E10.m2.2.2.2.2.2.1.1.1.1a" xref="S4.E10.m2.2.2.2.2.2.1.1.1.1.cmml">⁢</mo><mtext class="ltx_mathvariant_italic" id="S4.E10.m2.2.2.2.2.2.1.1.1.4" xref="S4.E10.m2.2.2.2.2.2.1.1.1.4a.cmml"> is the terminal token</mtext></mrow><mo id="S4.E10.m2.2.2.2.2.2.1.1.2" xref="S4.E10.m2.2.2.2.2.2.1.1.1.cmml">,</mo></mrow></mtd></mtr><mtr id="S4.E10.m2.4.4.4ad" xref="S4.E10.m2.4.5.3.1.cmml"><mtd class="ltx_align_left" columnalign="left" id="S4.E10.m2.4.4.4ae" xref="S4.E10.m2.4.5.3.1.cmml"><mrow id="S4.E10.m2.3.3.3.3.1.1.3" xref="S4.E10.m2.4.5.3.1.cmml"><mn id="S4.E10.m2.3.3.3.3.1.1.1" xref="S4.E10.m2.3.3.3.3.1.1.1.cmml">0</mn><mo id="S4.E10.m2.3.3.3.3.1.1.3.1" xref="S4.E10.m2.4.5.3.1.cmml">,</mo></mrow></mtd><mtd class="ltx_align_left" columnalign="left" id="S4.E10.m2.4.4.4af" xref="S4.E10.m2.4.5.3.1.cmml"><mtext class="ltx_mathvariant_italic" id="S4.E10.m2.4.4.4.4.2.1" xref="S4.E10.m2.4.4.4.4.2.1a.cmml">otherwise</mtext></mtd></mtr></mtable></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.E10.m2.4b"><apply id="S4.E10.m2.4.5.cmml" xref="S4.E10.m2.4.5"><eq id="S4.E10.m2.4.5.1.cmml" xref="S4.E10.m2.4.5.1"></eq><csymbol cd="latexml" id="S4.E10.m2.4.5.2.cmml" xref="S4.E10.m2.4.5.2">absent</csymbol><apply id="S4.E10.m2.4.5.3.1.cmml" xref="S4.E10.m2.4.4a"><csymbol cd="latexml" id="S4.E10.m2.4.5.3.1.1.cmml" xref="S4.E10.m2.4.4a.5">cases</csymbol><apply id="S4.E10.m2.1.1.1.1.1.1.1.1.cmml" xref="S4.E10.m2.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.E10.m2.1.1.1.1.1.1.1.1.1.cmml" xref="S4.E10.m2.1.1.1.1.1.1.1">subscript</csymbol><ci id="S4.E10.m2.1.1.1.1.1.1.1.1.2.cmml" xref="S4.E10.m2.1.1.1.1.1.1.1.1.2">𝑅</ci><ci id="S4.E10.m2.1.1.1.1.1.1.1.1.3.cmml" xref="S4.E10.m2.1.1.1.1.1.1.1.1.3">𝑖</ci></apply><apply id="S4.E10.m2.2.2.2.2.2.1.1.1.cmml" xref="S4.E10.m2.2.2.2.2.2.1.1"><times id="S4.E10.m2.2.2.2.2.2.1.1.1.1.cmml" xref="S4.E10.m2.2.2.2.2.2.1.1.1.1"></times><ci id="S4.E10.m2.2.2.2.2.2.1.1.1.2a.cmml" xref="S4.E10.m2.2.2.2.2.2.1.1.1.2"><mtext class="ltx_mathvariant_italic" id="S4.E10.m2.2.2.2.2.2.1.1.1.2.cmml" xref="S4.E10.m2.2.2.2.2.2.1.1.1.2">if </mtext></ci><ci id="S4.E10.m2.2.2.2.2.2.1.1.1.3.cmml" xref="S4.E10.m2.2.2.2.2.2.1.1.1.3">𝑡</ci><ci id="S4.E10.m2.2.2.2.2.2.1.1.1.4a.cmml" xref="S4.E10.m2.2.2.2.2.2.1.1.1.4"><mtext class="ltx_mathvariant_italic" id="S4.E10.m2.2.2.2.2.2.1.1.1.4.cmml" xref="S4.E10.m2.2.2.2.2.2.1.1.1.4"> is the terminal token</mtext></ci></apply><cn id="S4.E10.m2.3.3.3.3.1.1.1.cmml" type="integer" xref="S4.E10.m2.3.3.3.3.1.1.1">0</cn><ci id="S4.E10.m2.4.4.4.4.2.1a.cmml" xref="S4.E10.m2.4.4.4.4.2.1"><mtext class="ltx_mathvariant_italic" id="S4.E10.m2.4.4.4.4.2.1.cmml" xref="S4.E10.m2.4.4.4.4.2.1">otherwise</mtext></ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E10.m2.4c">\displaystyle=\begin{cases}R_{i},&amp;\text{if }t\text{ is the terminal token},\\
0,&amp;\text{otherwise}\end{cases}</annotation><annotation encoding="application/x-llamapun" id="S4.E10.m2.4d">= { start_ROW start_CELL italic_R start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT , end_CELL start_CELL if italic_t is the terminal token , end_CELL end_ROW start_ROW start_CELL 0 , end_CELL start_CELL otherwise end_CELL end_ROW</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(10)</span></td>
</tr></tbody>
<tbody id="S4.E11"><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_td ltx_align_right ltx_eqn_cell"><math alttext="\displaystyle\textbf{(2) Step-wise shaped reward:}\quad r^{\prime}_{i,t}" class="ltx_Math" display="inline" id="S4.E11.m1.4"><semantics id="S4.E11.m1.4a"><mrow id="S4.E11.m1.4.4.1" xref="S4.E11.m1.4.4.2.cmml"><mtext class="ltx_mathvariant_bold-italic" id="S4.E11.m1.3.3" xref="S4.E11.m1.3.3a.cmml">(2) Step-wise shaped reward:</mtext><mspace id="S4.E11.m1.4.4.1.2" width="1em" xref="S4.E11.m1.4.4.2.cmml"></mspace><msubsup id="S4.E11.m1.4.4.1.1" xref="S4.E11.m1.4.4.1.1.cmml"><mi id="S4.E11.m1.4.4.1.1.2.2" xref="S4.E11.m1.4.4.1.1.2.2.cmml">r</mi><mrow id="S4.E11.m1.2.2.2.4" xref="S4.E11.m1.2.2.2.3.cmml"><mi id="S4.E11.m1.1.1.1.1" xref="S4.E11.m1.1.1.1.1.cmml">i</mi><mo id="S4.E11.m1.2.2.2.4.1" xref="S4.E11.m1.2.2.2.3.cmml">,</mo><mi id="S4.E11.m1.2.2.2.2" xref="S4.E11.m1.2.2.2.2.cmml">t</mi></mrow><mo id="S4.E11.m1.4.4.1.1.2.3" xref="S4.E11.m1.4.4.1.1.2.3.cmml">′</mo></msubsup></mrow><annotation-xml encoding="MathML-Content" id="S4.E11.m1.4b"><list id="S4.E11.m1.4.4.2.cmml" xref="S4.E11.m1.4.4.1"><ci id="S4.E11.m1.3.3a.cmml" xref="S4.E11.m1.3.3"><mtext class="ltx_mathvariant_bold-italic" id="S4.E11.m1.3.3.cmml" xref="S4.E11.m1.3.3">(2) Step-wise shaped reward:</mtext></ci><apply id="S4.E11.m1.4.4.1.1.cmml" xref="S4.E11.m1.4.4.1.1"><csymbol cd="ambiguous" id="S4.E11.m1.4.4.1.1.1.cmml" xref="S4.E11.m1.4.4.1.1">subscript</csymbol><apply id="S4.E11.m1.4.4.1.1.2.cmml" xref="S4.E11.m1.4.4.1.1"><csymbol cd="ambiguous" id="S4.E11.m1.4.4.1.1.2.1.cmml" xref="S4.E11.m1.4.4.1.1">superscript</csymbol><ci id="S4.E11.m1.4.4.1.1.2.2.cmml" xref="S4.E11.m1.4.4.1.1.2.2">𝑟</ci><ci id="S4.E11.m1.4.4.1.1.2.3.cmml" xref="S4.E11.m1.4.4.1.1.2.3">′</ci></apply><list id="S4.E11.m1.2.2.2.3.cmml" xref="S4.E11.m1.2.2.2.4"><ci id="S4.E11.m1.1.1.1.1.cmml" xref="S4.E11.m1.1.1.1.1">𝑖</ci><ci id="S4.E11.m1.2.2.2.2.cmml" xref="S4.E11.m1.2.2.2.2">𝑡</ci></list></apply></list></annotation-xml><annotation encoding="application/x-tex" id="S4.E11.m1.4c">\displaystyle\textbf{(2) Step-wise shaped reward:}\quad r^{\prime}_{i,t}</annotation><annotation encoding="application/x-llamapun" id="S4.E11.m1.4d">(2) Step-wise shaped reward: italic_r start_POSTSUPERSCRIPT ′ end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_i , italic_t end_POSTSUBSCRIPT</annotation></semantics></math></td>
<td class="ltx_td ltx_align_left ltx_eqn_cell"><math alttext="\displaystyle=\varphi(\text{step}(t))-\varphi(\text{step}(t)-1)" class="ltx_Math" display="inline" id="S4.E11.m2.4"><semantics id="S4.E11.m2.4a"><mrow id="S4.E11.m2.4.4" xref="S4.E11.m2.4.4.cmml"><mi id="S4.E11.m2.4.4.4" xref="S4.E11.m2.4.4.4.cmml"></mi><mo id="S4.E11.m2.4.4.3" xref="S4.E11.m2.4.4.3.cmml">=</mo><mrow id="S4.E11.m2.4.4.2" xref="S4.E11.m2.4.4.2.cmml"><mrow id="S4.E11.m2.3.3.1.1" xref="S4.E11.m2.3.3.1.1.cmml"><mi id="S4.E11.m2.3.3.1.1.3" xref="S4.E11.m2.3.3.1.1.3.cmml">φ</mi><mo id="S4.E11.m2.3.3.1.1.2" xref="S4.E11.m2.3.3.1.1.2.cmml">⁢</mo><mrow id="S4.E11.m2.3.3.1.1.1.1" xref="S4.E11.m2.3.3.1.1.1.1.1.cmml"><mo id="S4.E11.m2.3.3.1.1.1.1.2" stretchy="false" xref="S4.E11.m2.3.3.1.1.1.1.1.cmml">(</mo><mrow id="S4.E11.m2.3.3.1.1.1.1.1" xref="S4.E11.m2.3.3.1.1.1.1.1.cmml"><mtext class="ltx_mathvariant_italic" id="S4.E11.m2.3.3.1.1.1.1.1.2" xref="S4.E11.m2.3.3.1.1.1.1.1.2a.cmml">step</mtext><mo id="S4.E11.m2.3.3.1.1.1.1.1.1" xref="S4.E11.m2.3.3.1.1.1.1.1.1.cmml">⁢</mo><mrow id="S4.E11.m2.3.3.1.1.1.1.1.3.2" xref="S4.E11.m2.3.3.1.1.1.1.1.cmml"><mo id="S4.E11.m2.3.3.1.1.1.1.1.3.2.1" stretchy="false" xref="S4.E11.m2.3.3.1.1.1.1.1.cmml">(</mo><mi id="S4.E11.m2.1.1" xref="S4.E11.m2.1.1.cmml">t</mi><mo id="S4.E11.m2.3.3.1.1.1.1.1.3.2.2" stretchy="false" xref="S4.E11.m2.3.3.1.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="S4.E11.m2.3.3.1.1.1.1.3" stretchy="false" xref="S4.E11.m2.3.3.1.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="S4.E11.m2.4.4.2.3" xref="S4.E11.m2.4.4.2.3.cmml">−</mo><mrow id="S4.E11.m2.4.4.2.2" xref="S4.E11.m2.4.4.2.2.cmml"><mi id="S4.E11.m2.4.4.2.2.3" xref="S4.E11.m2.4.4.2.2.3.cmml">φ</mi><mo id="S4.E11.m2.4.4.2.2.2" xref="S4.E11.m2.4.4.2.2.2.cmml">⁢</mo><mrow id="S4.E11.m2.4.4.2.2.1.1" xref="S4.E11.m2.4.4.2.2.1.1.1.cmml"><mo id="S4.E11.m2.4.4.2.2.1.1.2" stretchy="false" xref="S4.E11.m2.4.4.2.2.1.1.1.cmml">(</mo><mrow id="S4.E11.m2.4.4.2.2.1.1.1" xref="S4.E11.m2.4.4.2.2.1.1.1.cmml"><mrow id="S4.E11.m2.4.4.2.2.1.1.1.2" xref="S4.E11.m2.4.4.2.2.1.1.1.2.cmml"><mtext class="ltx_mathvariant_italic" id="S4.E11.m2.4.4.2.2.1.1.1.2.2" xref="S4.E11.m2.4.4.2.2.1.1.1.2.2a.cmml">step</mtext><mo id="S4.E11.m2.4.4.2.2.1.1.1.2.1" xref="S4.E11.m2.4.4.2.2.1.1.1.2.1.cmml">⁢</mo><mrow id="S4.E11.m2.4.4.2.2.1.1.1.2.3.2" xref="S4.E11.m2.4.4.2.2.1.1.1.2.cmml"><mo id="S4.E11.m2.4.4.2.2.1.1.1.2.3.2.1" stretchy="false" xref="S4.E11.m2.4.4.2.2.1.1.1.2.cmml">(</mo><mi id="S4.E11.m2.2.2" xref="S4.E11.m2.2.2.cmml">t</mi><mo id="S4.E11.m2.4.4.2.2.1.1.1.2.3.2.2" stretchy="false" xref="S4.E11.m2.4.4.2.2.1.1.1.2.cmml">)</mo></mrow></mrow><mo id="S4.E11.m2.4.4.2.2.1.1.1.1" xref="S4.E11.m2.4.4.2.2.1.1.1.1.cmml">−</mo><mn id="S4.E11.m2.4.4.2.2.1.1.1.3" xref="S4.E11.m2.4.4.2.2.1.1.1.3.cmml">1</mn></mrow><mo id="S4.E11.m2.4.4.2.2.1.1.3" stretchy="false" xref="S4.E11.m2.4.4.2.2.1.1.1.cmml">)</mo></mrow></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.E11.m2.4b"><apply id="S4.E11.m2.4.4.cmml" xref="S4.E11.m2.4.4"><eq id="S4.E11.m2.4.4.3.cmml" xref="S4.E11.m2.4.4.3"></eq><csymbol cd="latexml" id="S4.E11.m2.4.4.4.cmml" xref="S4.E11.m2.4.4.4">absent</csymbol><apply id="S4.E11.m2.4.4.2.cmml" xref="S4.E11.m2.4.4.2"><minus id="S4.E11.m2.4.4.2.3.cmml" xref="S4.E11.m2.4.4.2.3"></minus><apply id="S4.E11.m2.3.3.1.1.cmml" xref="S4.E11.m2.3.3.1.1"><times id="S4.E11.m2.3.3.1.1.2.cmml" xref="S4.E11.m2.3.3.1.1.2"></times><ci id="S4.E11.m2.3.3.1.1.3.cmml" xref="S4.E11.m2.3.3.1.1.3">𝜑</ci><apply id="S4.E11.m2.3.3.1.1.1.1.1.cmml" xref="S4.E11.m2.3.3.1.1.1.1"><times id="S4.E11.m2.3.3.1.1.1.1.1.1.cmml" xref="S4.E11.m2.3.3.1.1.1.1.1.1"></times><ci id="S4.E11.m2.3.3.1.1.1.1.1.2a.cmml" xref="S4.E11.m2.3.3.1.1.1.1.1.2"><mtext class="ltx_mathvariant_italic" id="S4.E11.m2.3.3.1.1.1.1.1.2.cmml" xref="S4.E11.m2.3.3.1.1.1.1.1.2">step</mtext></ci><ci id="S4.E11.m2.1.1.cmml" xref="S4.E11.m2.1.1">𝑡</ci></apply></apply><apply id="S4.E11.m2.4.4.2.2.cmml" xref="S4.E11.m2.4.4.2.2"><times id="S4.E11.m2.4.4.2.2.2.cmml" xref="S4.E11.m2.4.4.2.2.2"></times><ci id="S4.E11.m2.4.4.2.2.3.cmml" xref="S4.E11.m2.4.4.2.2.3">𝜑</ci><apply id="S4.E11.m2.4.4.2.2.1.1.1.cmml" xref="S4.E11.m2.4.4.2.2.1.1"><minus id="S4.E11.m2.4.4.2.2.1.1.1.1.cmml" xref="S4.E11.m2.4.4.2.2.1.1.1.1"></minus><apply id="S4.E11.m2.4.4.2.2.1.1.1.2.cmml" xref="S4.E11.m2.4.4.2.2.1.1.1.2"><times id="S4.E11.m2.4.4.2.2.1.1.1.2.1.cmml" xref="S4.E11.m2.4.4.2.2.1.1.1.2.1"></times><ci id="S4.E11.m2.4.4.2.2.1.1.1.2.2a.cmml" xref="S4.E11.m2.4.4.2.2.1.1.1.2.2"><mtext class="ltx_mathvariant_italic" id="S4.E11.m2.4.4.2.2.1.1.1.2.2.cmml" xref="S4.E11.m2.4.4.2.2.1.1.1.2.2">step</mtext></ci><ci id="S4.E11.m2.2.2.cmml" xref="S4.E11.m2.2.2">𝑡</ci></apply><cn id="S4.E11.m2.4.4.2.2.1.1.1.3.cmml" type="integer" xref="S4.E11.m2.4.4.2.2.1.1.1.3">1</cn></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E11.m2.4c">\displaystyle=\varphi(\text{step}(t))-\varphi(\text{step}(t)-1)</annotation><annotation encoding="application/x-llamapun" id="S4.E11.m2.4d">= italic_φ ( step ( italic_t ) ) - italic_φ ( step ( italic_t ) - 1 )</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(11)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.Thmtheorem1.p1.3"><span class="ltx_text ltx_font_italic" id="S4.Thmtheorem1.p1.3.1">Then, both reward formulations yield the same optimal policy.</span></p>
</div>
</div>
<div class="ltx_para" id="S4.SS2.p3">
<p class="ltx_p" id="S4.SS2.p3.1">The proof is provided in Appendix <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#A1" title="Appendix A Theoretical Analysis ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">A</span></a>.</p>
</div>
<div class="ltx_para" id="S4.SS2.p4">
<p class="ltx_p" id="S4.SS2.p4.1">Using the potential-shaped advantage <math alttext="\hat{A}_{i,t}" class="ltx_Math" display="inline" id="S4.SS2.p4.1.m1.2"><semantics id="S4.SS2.p4.1.m1.2a"><msub id="S4.SS2.p4.1.m1.2.3" xref="S4.SS2.p4.1.m1.2.3.cmml"><mover accent="true" id="S4.SS2.p4.1.m1.2.3.2" xref="S4.SS2.p4.1.m1.2.3.2.cmml"><mi id="S4.SS2.p4.1.m1.2.3.2.2" xref="S4.SS2.p4.1.m1.2.3.2.2.cmml">A</mi><mo id="S4.SS2.p4.1.m1.2.3.2.1" xref="S4.SS2.p4.1.m1.2.3.2.1.cmml">^</mo></mover><mrow id="S4.SS2.p4.1.m1.2.2.2.4" xref="S4.SS2.p4.1.m1.2.2.2.3.cmml"><mi id="S4.SS2.p4.1.m1.1.1.1.1" xref="S4.SS2.p4.1.m1.1.1.1.1.cmml">i</mi><mo id="S4.SS2.p4.1.m1.2.2.2.4.1" xref="S4.SS2.p4.1.m1.2.2.2.3.cmml">,</mo><mi id="S4.SS2.p4.1.m1.2.2.2.2" xref="S4.SS2.p4.1.m1.2.2.2.2.cmml">t</mi></mrow></msub><annotation-xml encoding="MathML-Content" id="S4.SS2.p4.1.m1.2b"><apply id="S4.SS2.p4.1.m1.2.3.cmml" xref="S4.SS2.p4.1.m1.2.3"><csymbol cd="ambiguous" id="S4.SS2.p4.1.m1.2.3.1.cmml" xref="S4.SS2.p4.1.m1.2.3">subscript</csymbol><apply id="S4.SS2.p4.1.m1.2.3.2.cmml" xref="S4.SS2.p4.1.m1.2.3.2"><ci id="S4.SS2.p4.1.m1.2.3.2.1.cmml" xref="S4.SS2.p4.1.m1.2.3.2.1">^</ci><ci id="S4.SS2.p4.1.m1.2.3.2.2.cmml" xref="S4.SS2.p4.1.m1.2.3.2.2">𝐴</ci></apply><list id="S4.SS2.p4.1.m1.2.2.2.3.cmml" xref="S4.SS2.p4.1.m1.2.2.2.4"><ci id="S4.SS2.p4.1.m1.1.1.1.1.cmml" xref="S4.SS2.p4.1.m1.1.1.1.1">𝑖</ci><ci id="S4.SS2.p4.1.m1.2.2.2.2.cmml" xref="S4.SS2.p4.1.m1.2.2.2.2">𝑡</ci></list></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS2.p4.1.m1.2c">\hat{A}_{i,t}</annotation><annotation encoding="application/x-llamapun" id="S4.SS2.p4.1.m1.2d">over^ start_ARG italic_A end_ARG start_POSTSUBSCRIPT italic_i , italic_t end_POSTSUBSCRIPT</annotation></semantics></math> in Eq. (<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S4.E6" title="In 4.1 Step-wise GRPO ‣ 4 Method: FLAME ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">6</span></a>), we optimize the policy via step-wise GRPO, while retaining the same objective form as standard GRPO (Eq. (<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S3.E1" title="In 3.2 Group Relative Policy Optimization (GRPO) ‣ 3 Preliminary ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">1</span></a>)).</p>
</div>
</section>
<section class="ltx_subsection" id="S4.SS3">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.3 </span>Two-stage Recommendation Framework</h3>
<div class="ltx_para" id="S4.SS3.p1">
<p class="ltx_p" id="S4.SS3.p1.2">We adopt a cascaded framework to generate an accurate and safe medication set <math alttext="\mathcal{M}_{v}" class="ltx_Math" display="inline" id="S4.SS3.p1.1.m1.1"><semantics id="S4.SS3.p1.1.m1.1a"><msub id="S4.SS3.p1.1.m1.1.1" xref="S4.SS3.p1.1.m1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.SS3.p1.1.m1.1.1.2" xref="S4.SS3.p1.1.m1.1.1.2.cmml">ℳ</mi><mi id="S4.SS3.p1.1.m1.1.1.3" xref="S4.SS3.p1.1.m1.1.1.3.cmml">v</mi></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.1.m1.1b"><apply id="S4.SS3.p1.1.m1.1.1.cmml" xref="S4.SS3.p1.1.m1.1.1"><csymbol cd="ambiguous" id="S4.SS3.p1.1.m1.1.1.1.cmml" xref="S4.SS3.p1.1.m1.1.1">subscript</csymbol><ci id="S4.SS3.p1.1.m1.1.1.2.cmml" xref="S4.SS3.p1.1.m1.1.1.2">ℳ</ci><ci id="S4.SS3.p1.1.m1.1.1.3.cmml" xref="S4.SS3.p1.1.m1.1.1.3">𝑣</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.1.m1.1c">\mathcal{M}_{v}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.1.m1.1d">caligraphic_M start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT</annotation></semantics></math> for a patient’s <math alttext="v" class="ltx_Math" display="inline" id="S4.SS3.p1.2.m2.1"><semantics id="S4.SS3.p1.2.m2.1a"><mi id="S4.SS3.p1.2.m2.1.1" xref="S4.SS3.p1.2.m2.1.1.cmml">v</mi><annotation-xml encoding="MathML-Content" id="S4.SS3.p1.2.m2.1b"><ci id="S4.SS3.p1.2.m2.1.1.cmml" xref="S4.SS3.p1.2.m2.1.1">𝑣</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p1.2.m2.1c">v</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p1.2.m2.1d">italic_v</annotation></semantics></math>-th visit.
The process consists of two stages: drug-level filtering and list-level refinement. The former is implemented via a binary classification model, and the latter through a policy fine-tuned with step-wise GRPO, as illustrated in Fig. <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S4.F3" title="Figure 3 ‣ 4.2 Fine-grained Alignment for Medication Recommendation ‣ 4 Method: FLAME ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">3</span></a>.</p>
</div>
<div class="ltx_para" id="S4.SS3.p2">
<p class="ltx_p" id="S4.SS3.p2.4"><span class="ltx_text ltx_font_bold" id="S4.SS3.p2.1.1">Drug-level Classifier (<math alttext="\pi_{\text{cls}}" class="ltx_Math" display="inline" id="S4.SS3.p2.1.1.m1.1"><semantics id="S4.SS3.p2.1.1.m1.1a"><msub id="S4.SS3.p2.1.1.m1.1.1" xref="S4.SS3.p2.1.1.m1.1.1.cmml"><mi id="S4.SS3.p2.1.1.m1.1.1.2" xref="S4.SS3.p2.1.1.m1.1.1.2.cmml">π</mi><mtext class="ltx_mathvariant_bold" id="S4.SS3.p2.1.1.m1.1.1.3" xref="S4.SS3.p2.1.1.m1.1.1.3a.cmml">cls</mtext></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p2.1.1.m1.1b"><apply id="S4.SS3.p2.1.1.m1.1.1.cmml" xref="S4.SS3.p2.1.1.m1.1.1"><csymbol cd="ambiguous" id="S4.SS3.p2.1.1.m1.1.1.1.cmml" xref="S4.SS3.p2.1.1.m1.1.1">subscript</csymbol><ci id="S4.SS3.p2.1.1.m1.1.1.2.cmml" xref="S4.SS3.p2.1.1.m1.1.1.2">𝜋</ci><ci id="S4.SS3.p2.1.1.m1.1.1.3a.cmml" xref="S4.SS3.p2.1.1.m1.1.1.3"><mtext class="ltx_mathvariant_bold" id="S4.SS3.p2.1.1.m1.1.1.3.cmml" mathsize="70%" xref="S4.SS3.p2.1.1.m1.1.1.3">cls</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p2.1.1.m1.1c">\pi_{\text{cls}}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p2.1.1.m1.1d">italic_π start_POSTSUBSCRIPT cls end_POSTSUBSCRIPT</annotation></semantics></math>).</span>
We implement <math alttext="\pi_{\text{cls}}" class="ltx_Math" display="inline" id="S4.SS3.p2.2.m1.1"><semantics id="S4.SS3.p2.2.m1.1a"><msub id="S4.SS3.p2.2.m1.1.1" xref="S4.SS3.p2.2.m1.1.1.cmml"><mi id="S4.SS3.p2.2.m1.1.1.2" xref="S4.SS3.p2.2.m1.1.1.2.cmml">π</mi><mtext id="S4.SS3.p2.2.m1.1.1.3" xref="S4.SS3.p2.2.m1.1.1.3a.cmml">cls</mtext></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p2.2.m1.1b"><apply id="S4.SS3.p2.2.m1.1.1.cmml" xref="S4.SS3.p2.2.m1.1.1"><csymbol cd="ambiguous" id="S4.SS3.p2.2.m1.1.1.1.cmml" xref="S4.SS3.p2.2.m1.1.1">subscript</csymbol><ci id="S4.SS3.p2.2.m1.1.1.2.cmml" xref="S4.SS3.p2.2.m1.1.1.2">𝜋</ci><ci id="S4.SS3.p2.2.m1.1.1.3a.cmml" xref="S4.SS3.p2.2.m1.1.1.3"><mtext id="S4.SS3.p2.2.m1.1.1.3.cmml" mathsize="70%" xref="S4.SS3.p2.2.m1.1.1.3">cls</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p2.2.m1.1c">\pi_{\text{cls}}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p2.2.m1.1d">italic_π start_POSTSUBSCRIPT cls end_POSTSUBSCRIPT</annotation></semantics></math> as an LLM-based binary classifier that evaluates the relevance of each candidate drug <math alttext="m\in\mathcal{M}_{c}" class="ltx_Math" display="inline" id="S4.SS3.p2.3.m2.1"><semantics id="S4.SS3.p2.3.m2.1a"><mrow id="S4.SS3.p2.3.m2.1.1" xref="S4.SS3.p2.3.m2.1.1.cmml"><mi id="S4.SS3.p2.3.m2.1.1.2" xref="S4.SS3.p2.3.m2.1.1.2.cmml">m</mi><mo id="S4.SS3.p2.3.m2.1.1.1" xref="S4.SS3.p2.3.m2.1.1.1.cmml">∈</mo><msub id="S4.SS3.p2.3.m2.1.1.3" xref="S4.SS3.p2.3.m2.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.SS3.p2.3.m2.1.1.3.2" xref="S4.SS3.p2.3.m2.1.1.3.2.cmml">ℳ</mi><mi id="S4.SS3.p2.3.m2.1.1.3.3" xref="S4.SS3.p2.3.m2.1.1.3.3.cmml">c</mi></msub></mrow><annotation-xml encoding="MathML-Content" id="S4.SS3.p2.3.m2.1b"><apply id="S4.SS3.p2.3.m2.1.1.cmml" xref="S4.SS3.p2.3.m2.1.1"><in id="S4.SS3.p2.3.m2.1.1.1.cmml" xref="S4.SS3.p2.3.m2.1.1.1"></in><ci id="S4.SS3.p2.3.m2.1.1.2.cmml" xref="S4.SS3.p2.3.m2.1.1.2">𝑚</ci><apply id="S4.SS3.p2.3.m2.1.1.3.cmml" xref="S4.SS3.p2.3.m2.1.1.3"><csymbol cd="ambiguous" id="S4.SS3.p2.3.m2.1.1.3.1.cmml" xref="S4.SS3.p2.3.m2.1.1.3">subscript</csymbol><ci id="S4.SS3.p2.3.m2.1.1.3.2.cmml" xref="S4.SS3.p2.3.m2.1.1.3.2">ℳ</ci><ci id="S4.SS3.p2.3.m2.1.1.3.3.cmml" xref="S4.SS3.p2.3.m2.1.1.3.3">𝑐</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p2.3.m2.1c">m\in\mathcal{M}_{c}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p2.3.m2.1d">italic_m ∈ caligraphic_M start_POSTSUBSCRIPT italic_c end_POSTSUBSCRIPT</annotation></semantics></math> given the patient input <math alttext="x" class="ltx_Math" display="inline" id="S4.SS3.p2.4.m3.1"><semantics id="S4.SS3.p2.4.m3.1a"><mi id="S4.SS3.p2.4.m3.1.1" xref="S4.SS3.p2.4.m3.1.1.cmml">x</mi><annotation-xml encoding="MathML-Content" id="S4.SS3.p2.4.m3.1b"><ci id="S4.SS3.p2.4.m3.1.1.cmml" xref="S4.SS3.p2.4.m3.1.1">𝑥</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p2.4.m3.1c">x</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p2.4.m3.1d">italic_x</annotation></semantics></math>.
The model returns a <span class="ltx_text ltx_font_typewriter" id="S4.SS3.p2.4.2">Yes</span>/<span class="ltx_text ltx_font_typewriter" id="S4.SS3.p2.4.3">No</span> decision, producing a personalized subset:</p>
<table class="ltx_equation ltx_eqn_table" id="S4.E12">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\mathcal{M}_{p}=\left\{m\in\mathcal{M}_{c}\mid\pi_{\text{cls}}(x,m)=\texttt{%
Yes}\right\}." class="ltx_Math" display="block" id="S4.E12.m1.3"><semantics id="S4.E12.m1.3a"><mrow id="S4.E12.m1.3.3.1" xref="S4.E12.m1.3.3.1.1.cmml"><mrow id="S4.E12.m1.3.3.1.1" xref="S4.E12.m1.3.3.1.1.cmml"><msub id="S4.E12.m1.3.3.1.1.4" xref="S4.E12.m1.3.3.1.1.4.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E12.m1.3.3.1.1.4.2" xref="S4.E12.m1.3.3.1.1.4.2.cmml">ℳ</mi><mi id="S4.E12.m1.3.3.1.1.4.3" xref="S4.E12.m1.3.3.1.1.4.3.cmml">p</mi></msub><mo id="S4.E12.m1.3.3.1.1.3" xref="S4.E12.m1.3.3.1.1.3.cmml">=</mo><mrow id="S4.E12.m1.3.3.1.1.2.2" xref="S4.E12.m1.3.3.1.1.2.3.cmml"><mo id="S4.E12.m1.3.3.1.1.2.2.3" xref="S4.E12.m1.3.3.1.1.2.3.1.cmml">{</mo><mrow id="S4.E12.m1.3.3.1.1.1.1.1" xref="S4.E12.m1.3.3.1.1.1.1.1.cmml"><mi id="S4.E12.m1.3.3.1.1.1.1.1.2" xref="S4.E12.m1.3.3.1.1.1.1.1.2.cmml">m</mi><mo id="S4.E12.m1.3.3.1.1.1.1.1.1" xref="S4.E12.m1.3.3.1.1.1.1.1.1.cmml">∈</mo><msub id="S4.E12.m1.3.3.1.1.1.1.1.3" xref="S4.E12.m1.3.3.1.1.1.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E12.m1.3.3.1.1.1.1.1.3.2" xref="S4.E12.m1.3.3.1.1.1.1.1.3.2.cmml">ℳ</mi><mi id="S4.E12.m1.3.3.1.1.1.1.1.3.3" xref="S4.E12.m1.3.3.1.1.1.1.1.3.3.cmml">c</mi></msub></mrow><mo fence="true" id="S4.E12.m1.3.3.1.1.2.2.4" lspace="0em" rspace="0em" xref="S4.E12.m1.3.3.1.1.2.3.1.cmml">∣</mo><mrow id="S4.E12.m1.3.3.1.1.2.2.2" xref="S4.E12.m1.3.3.1.1.2.2.2.cmml"><mrow id="S4.E12.m1.3.3.1.1.2.2.2.2" xref="S4.E12.m1.3.3.1.1.2.2.2.2.cmml"><msub id="S4.E12.m1.3.3.1.1.2.2.2.2.2" xref="S4.E12.m1.3.3.1.1.2.2.2.2.2.cmml"><mi id="S4.E12.m1.3.3.1.1.2.2.2.2.2.2" xref="S4.E12.m1.3.3.1.1.2.2.2.2.2.2.cmml">π</mi><mtext id="S4.E12.m1.3.3.1.1.2.2.2.2.2.3" xref="S4.E12.m1.3.3.1.1.2.2.2.2.2.3a.cmml">cls</mtext></msub><mo id="S4.E12.m1.3.3.1.1.2.2.2.2.1" xref="S4.E12.m1.3.3.1.1.2.2.2.2.1.cmml">⁢</mo><mrow id="S4.E12.m1.3.3.1.1.2.2.2.2.3.2" xref="S4.E12.m1.3.3.1.1.2.2.2.2.3.1.cmml"><mo id="S4.E12.m1.3.3.1.1.2.2.2.2.3.2.1" stretchy="false" xref="S4.E12.m1.3.3.1.1.2.2.2.2.3.1.cmml">(</mo><mi id="S4.E12.m1.1.1" xref="S4.E12.m1.1.1.cmml">x</mi><mo id="S4.E12.m1.3.3.1.1.2.2.2.2.3.2.2" xref="S4.E12.m1.3.3.1.1.2.2.2.2.3.1.cmml">,</mo><mi id="S4.E12.m1.2.2" xref="S4.E12.m1.2.2.cmml">m</mi><mo id="S4.E12.m1.3.3.1.1.2.2.2.2.3.2.3" stretchy="false" xref="S4.E12.m1.3.3.1.1.2.2.2.2.3.1.cmml">)</mo></mrow></mrow><mo id="S4.E12.m1.3.3.1.1.2.2.2.1" xref="S4.E12.m1.3.3.1.1.2.2.2.1.cmml">=</mo><mtext class="ltx_mathvariant_monospace" id="S4.E12.m1.3.3.1.1.2.2.2.3" xref="S4.E12.m1.3.3.1.1.2.2.2.3a.cmml">Yes</mtext></mrow><mo id="S4.E12.m1.3.3.1.1.2.2.5" xref="S4.E12.m1.3.3.1.1.2.3.1.cmml">}</mo></mrow></mrow><mo id="S4.E12.m1.3.3.1.2" lspace="0em" xref="S4.E12.m1.3.3.1.1.cmml">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.E12.m1.3b"><apply id="S4.E12.m1.3.3.1.1.cmml" xref="S4.E12.m1.3.3.1"><eq id="S4.E12.m1.3.3.1.1.3.cmml" xref="S4.E12.m1.3.3.1.1.3"></eq><apply id="S4.E12.m1.3.3.1.1.4.cmml" xref="S4.E12.m1.3.3.1.1.4"><csymbol cd="ambiguous" id="S4.E12.m1.3.3.1.1.4.1.cmml" xref="S4.E12.m1.3.3.1.1.4">subscript</csymbol><ci id="S4.E12.m1.3.3.1.1.4.2.cmml" xref="S4.E12.m1.3.3.1.1.4.2">ℳ</ci><ci id="S4.E12.m1.3.3.1.1.4.3.cmml" xref="S4.E12.m1.3.3.1.1.4.3">𝑝</ci></apply><apply id="S4.E12.m1.3.3.1.1.2.3.cmml" xref="S4.E12.m1.3.3.1.1.2.2"><csymbol cd="latexml" id="S4.E12.m1.3.3.1.1.2.3.1.cmml" xref="S4.E12.m1.3.3.1.1.2.2.3">conditional-set</csymbol><apply id="S4.E12.m1.3.3.1.1.1.1.1.cmml" xref="S4.E12.m1.3.3.1.1.1.1.1"><in id="S4.E12.m1.3.3.1.1.1.1.1.1.cmml" xref="S4.E12.m1.3.3.1.1.1.1.1.1"></in><ci id="S4.E12.m1.3.3.1.1.1.1.1.2.cmml" xref="S4.E12.m1.3.3.1.1.1.1.1.2">𝑚</ci><apply id="S4.E12.m1.3.3.1.1.1.1.1.3.cmml" xref="S4.E12.m1.3.3.1.1.1.1.1.3"><csymbol cd="ambiguous" id="S4.E12.m1.3.3.1.1.1.1.1.3.1.cmml" xref="S4.E12.m1.3.3.1.1.1.1.1.3">subscript</csymbol><ci id="S4.E12.m1.3.3.1.1.1.1.1.3.2.cmml" xref="S4.E12.m1.3.3.1.1.1.1.1.3.2">ℳ</ci><ci id="S4.E12.m1.3.3.1.1.1.1.1.3.3.cmml" xref="S4.E12.m1.3.3.1.1.1.1.1.3.3">𝑐</ci></apply></apply><apply id="S4.E12.m1.3.3.1.1.2.2.2.cmml" xref="S4.E12.m1.3.3.1.1.2.2.2"><eq id="S4.E12.m1.3.3.1.1.2.2.2.1.cmml" xref="S4.E12.m1.3.3.1.1.2.2.2.1"></eq><apply id="S4.E12.m1.3.3.1.1.2.2.2.2.cmml" xref="S4.E12.m1.3.3.1.1.2.2.2.2"><times id="S4.E12.m1.3.3.1.1.2.2.2.2.1.cmml" xref="S4.E12.m1.3.3.1.1.2.2.2.2.1"></times><apply id="S4.E12.m1.3.3.1.1.2.2.2.2.2.cmml" xref="S4.E12.m1.3.3.1.1.2.2.2.2.2"><csymbol cd="ambiguous" id="S4.E12.m1.3.3.1.1.2.2.2.2.2.1.cmml" xref="S4.E12.m1.3.3.1.1.2.2.2.2.2">subscript</csymbol><ci id="S4.E12.m1.3.3.1.1.2.2.2.2.2.2.cmml" xref="S4.E12.m1.3.3.1.1.2.2.2.2.2.2">𝜋</ci><ci id="S4.E12.m1.3.3.1.1.2.2.2.2.2.3a.cmml" xref="S4.E12.m1.3.3.1.1.2.2.2.2.2.3"><mtext id="S4.E12.m1.3.3.1.1.2.2.2.2.2.3.cmml" mathsize="70%" xref="S4.E12.m1.3.3.1.1.2.2.2.2.2.3">cls</mtext></ci></apply><interval closure="open" id="S4.E12.m1.3.3.1.1.2.2.2.2.3.1.cmml" xref="S4.E12.m1.3.3.1.1.2.2.2.2.3.2"><ci id="S4.E12.m1.1.1.cmml" xref="S4.E12.m1.1.1">𝑥</ci><ci id="S4.E12.m1.2.2.cmml" xref="S4.E12.m1.2.2">𝑚</ci></interval></apply><ci id="S4.E12.m1.3.3.1.1.2.2.2.3a.cmml" xref="S4.E12.m1.3.3.1.1.2.2.2.3"><mtext class="ltx_mathvariant_monospace" id="S4.E12.m1.3.3.1.1.2.2.2.3.cmml" xref="S4.E12.m1.3.3.1.1.2.2.2.3">Yes</mtext></ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E12.m1.3c">\mathcal{M}_{p}=\left\{m\in\mathcal{M}_{c}\mid\pi_{\text{cls}}(x,m)=\texttt{%
Yes}\right\}.</annotation><annotation encoding="application/x-llamapun" id="S4.E12.m1.3d">caligraphic_M start_POSTSUBSCRIPT italic_p end_POSTSUBSCRIPT = { italic_m ∈ caligraphic_M start_POSTSUBSCRIPT italic_c end_POSTSUBSCRIPT ∣ italic_π start_POSTSUBSCRIPT cls end_POSTSUBSCRIPT ( italic_x , italic_m ) = Yes } .</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(12)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS3.p2.5">This step establishes personalized relevance by filtering drugs based on individual compatibility prior to joint reasoning.</p>
</div>
<div class="ltx_para" id="S4.SS3.p3">
<p class="ltx_p" id="S4.SS3.p3.5"><span class="ltx_text ltx_font_bold" id="S4.SS3.p3.1.1">List-wise Policy (<math alttext="\pi_{\text{list}}" class="ltx_Math" display="inline" id="S4.SS3.p3.1.1.m1.1"><semantics id="S4.SS3.p3.1.1.m1.1a"><msub id="S4.SS3.p3.1.1.m1.1.1" xref="S4.SS3.p3.1.1.m1.1.1.cmml"><mi id="S4.SS3.p3.1.1.m1.1.1.2" xref="S4.SS3.p3.1.1.m1.1.1.2.cmml">π</mi><mtext class="ltx_mathvariant_bold" id="S4.SS3.p3.1.1.m1.1.1.3" xref="S4.SS3.p3.1.1.m1.1.1.3a.cmml">list</mtext></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p3.1.1.m1.1b"><apply id="S4.SS3.p3.1.1.m1.1.1.cmml" xref="S4.SS3.p3.1.1.m1.1.1"><csymbol cd="ambiguous" id="S4.SS3.p3.1.1.m1.1.1.1.cmml" xref="S4.SS3.p3.1.1.m1.1.1">subscript</csymbol><ci id="S4.SS3.p3.1.1.m1.1.1.2.cmml" xref="S4.SS3.p3.1.1.m1.1.1.2">𝜋</ci><ci id="S4.SS3.p3.1.1.m1.1.1.3a.cmml" xref="S4.SS3.p3.1.1.m1.1.1.3"><mtext class="ltx_mathvariant_bold" id="S4.SS3.p3.1.1.m1.1.1.3.cmml" mathsize="70%" xref="S4.SS3.p3.1.1.m1.1.1.3">list</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p3.1.1.m1.1c">\pi_{\text{list}}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p3.1.1.m1.1d">italic_π start_POSTSUBSCRIPT list end_POSTSUBSCRIPT</annotation></semantics></math>).</span>
To support global optimization, we introduce a list-wise policy <math alttext="\pi_{\text{list}}" class="ltx_Math" display="inline" id="S4.SS3.p3.2.m1.1"><semantics id="S4.SS3.p3.2.m1.1a"><msub id="S4.SS3.p3.2.m1.1.1" xref="S4.SS3.p3.2.m1.1.1.cmml"><mi id="S4.SS3.p3.2.m1.1.1.2" xref="S4.SS3.p3.2.m1.1.1.2.cmml">π</mi><mtext id="S4.SS3.p3.2.m1.1.1.3" xref="S4.SS3.p3.2.m1.1.1.3a.cmml">list</mtext></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p3.2.m1.1b"><apply id="S4.SS3.p3.2.m1.1.1.cmml" xref="S4.SS3.p3.2.m1.1.1"><csymbol cd="ambiguous" id="S4.SS3.p3.2.m1.1.1.1.cmml" xref="S4.SS3.p3.2.m1.1.1">subscript</csymbol><ci id="S4.SS3.p3.2.m1.1.1.2.cmml" xref="S4.SS3.p3.2.m1.1.1.2">𝜋</ci><ci id="S4.SS3.p3.2.m1.1.1.3a.cmml" xref="S4.SS3.p3.2.m1.1.1.3"><mtext id="S4.SS3.p3.2.m1.1.1.3.cmml" mathsize="70%" xref="S4.SS3.p3.2.m1.1.1.3">list</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p3.2.m1.1c">\pi_{\text{list}}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p3.2.m1.1d">italic_π start_POSTSUBSCRIPT list end_POSTSUBSCRIPT</annotation></semantics></math> that performs instruction-conditioned edits over <math alttext="\mathcal{M}_{p}" class="ltx_Math" display="inline" id="S4.SS3.p3.3.m2.1"><semantics id="S4.SS3.p3.3.m2.1a"><msub id="S4.SS3.p3.3.m2.1.1" xref="S4.SS3.p3.3.m2.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.SS3.p3.3.m2.1.1.2" xref="S4.SS3.p3.3.m2.1.1.2.cmml">ℳ</mi><mi id="S4.SS3.p3.3.m2.1.1.3" xref="S4.SS3.p3.3.m2.1.1.3.cmml">p</mi></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p3.3.m2.1b"><apply id="S4.SS3.p3.3.m2.1.1.cmml" xref="S4.SS3.p3.3.m2.1.1"><csymbol cd="ambiguous" id="S4.SS3.p3.3.m2.1.1.1.cmml" xref="S4.SS3.p3.3.m2.1.1">subscript</csymbol><ci id="S4.SS3.p3.3.m2.1.1.2.cmml" xref="S4.SS3.p3.3.m2.1.1.2">ℳ</ci><ci id="S4.SS3.p3.3.m2.1.1.3.cmml" xref="S4.SS3.p3.3.m2.1.1.3">𝑝</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p3.3.m2.1c">\mathcal{M}_{p}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p3.3.m2.1d">caligraphic_M start_POSTSUBSCRIPT italic_p end_POSTSUBSCRIPT</annotation></semantics></math>.
Given patient input <math alttext="x" class="ltx_Math" display="inline" id="S4.SS3.p3.4.m3.1"><semantics id="S4.SS3.p3.4.m3.1a"><mi id="S4.SS3.p3.4.m3.1.1" xref="S4.SS3.p3.4.m3.1.1.cmml">x</mi><annotation-xml encoding="MathML-Content" id="S4.SS3.p3.4.m3.1b"><ci id="S4.SS3.p3.4.m3.1.1.cmml" xref="S4.SS3.p3.4.m3.1.1">𝑥</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p3.4.m3.1c">x</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p3.4.m3.1d">italic_x</annotation></semantics></math>, a medication list <math alttext="\mathcal{M}" class="ltx_Math" display="inline" id="S4.SS3.p3.5.m4.1"><semantics id="S4.SS3.p3.5.m4.1a"><mi class="ltx_font_mathcaligraphic" id="S4.SS3.p3.5.m4.1.1" xref="S4.SS3.p3.5.m4.1.1.cmml">ℳ</mi><annotation-xml encoding="MathML-Content" id="S4.SS3.p3.5.m4.1b"><ci id="S4.SS3.p3.5.m4.1.1.cmml" xref="S4.SS3.p3.5.m4.1.1">ℳ</ci></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p3.5.m4.1c">\mathcal{M}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p3.5.m4.1d">caligraphic_M</annotation></semantics></math>, and an instruction (<span class="ltx_text ltx_font_typewriter" id="S4.SS3.p3.5.2">Add Drug</span> or <span class="ltx_text ltx_font_typewriter" id="S4.SS3.p3.5.3">Remove Drug</span>), the model predicts a modification set:</p>
<table class="ltx_equation ltx_eqn_table" id="S4.E13">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\Delta\mathcal{M}=\pi_{\text{list}}(x,\mathcal{M},\texttt{Instruction})." class="ltx_Math" display="block" id="S4.E13.m1.4"><semantics id="S4.E13.m1.4a"><mrow id="S4.E13.m1.4.4.1" xref="S4.E13.m1.4.4.1.1.cmml"><mrow id="S4.E13.m1.4.4.1.1" xref="S4.E13.m1.4.4.1.1.cmml"><mrow id="S4.E13.m1.4.4.1.1.2" xref="S4.E13.m1.4.4.1.1.2.cmml"><mi id="S4.E13.m1.4.4.1.1.2.2" mathvariant="normal" xref="S4.E13.m1.4.4.1.1.2.2.cmml">Δ</mi><mo id="S4.E13.m1.4.4.1.1.2.1" xref="S4.E13.m1.4.4.1.1.2.1.cmml">⁢</mo><mi class="ltx_font_mathcaligraphic" id="S4.E13.m1.4.4.1.1.2.3" xref="S4.E13.m1.4.4.1.1.2.3.cmml">ℳ</mi></mrow><mo id="S4.E13.m1.4.4.1.1.1" xref="S4.E13.m1.4.4.1.1.1.cmml">=</mo><mrow id="S4.E13.m1.4.4.1.1.3" xref="S4.E13.m1.4.4.1.1.3.cmml"><msub id="S4.E13.m1.4.4.1.1.3.2" xref="S4.E13.m1.4.4.1.1.3.2.cmml"><mi id="S4.E13.m1.4.4.1.1.3.2.2" xref="S4.E13.m1.4.4.1.1.3.2.2.cmml">π</mi><mtext id="S4.E13.m1.4.4.1.1.3.2.3" xref="S4.E13.m1.4.4.1.1.3.2.3a.cmml">list</mtext></msub><mo id="S4.E13.m1.4.4.1.1.3.1" xref="S4.E13.m1.4.4.1.1.3.1.cmml">⁢</mo><mrow id="S4.E13.m1.4.4.1.1.3.3.2" xref="S4.E13.m1.4.4.1.1.3.3.1.cmml"><mo id="S4.E13.m1.4.4.1.1.3.3.2.1" stretchy="false" xref="S4.E13.m1.4.4.1.1.3.3.1.cmml">(</mo><mi id="S4.E13.m1.1.1" xref="S4.E13.m1.1.1.cmml">x</mi><mo id="S4.E13.m1.4.4.1.1.3.3.2.2" xref="S4.E13.m1.4.4.1.1.3.3.1.cmml">,</mo><mi class="ltx_font_mathcaligraphic" id="S4.E13.m1.2.2" xref="S4.E13.m1.2.2.cmml">ℳ</mi><mo id="S4.E13.m1.4.4.1.1.3.3.2.3" xref="S4.E13.m1.4.4.1.1.3.3.1.cmml">,</mo><mtext class="ltx_mathvariant_monospace" id="S4.E13.m1.3.3" xref="S4.E13.m1.3.3a.cmml">Instruction</mtext><mo id="S4.E13.m1.4.4.1.1.3.3.2.4" stretchy="false" xref="S4.E13.m1.4.4.1.1.3.3.1.cmml">)</mo></mrow></mrow></mrow><mo id="S4.E13.m1.4.4.1.2" lspace="0em" xref="S4.E13.m1.4.4.1.1.cmml">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.E13.m1.4b"><apply id="S4.E13.m1.4.4.1.1.cmml" xref="S4.E13.m1.4.4.1"><eq id="S4.E13.m1.4.4.1.1.1.cmml" xref="S4.E13.m1.4.4.1.1.1"></eq><apply id="S4.E13.m1.4.4.1.1.2.cmml" xref="S4.E13.m1.4.4.1.1.2"><times id="S4.E13.m1.4.4.1.1.2.1.cmml" xref="S4.E13.m1.4.4.1.1.2.1"></times><ci id="S4.E13.m1.4.4.1.1.2.2.cmml" xref="S4.E13.m1.4.4.1.1.2.2">Δ</ci><ci id="S4.E13.m1.4.4.1.1.2.3.cmml" xref="S4.E13.m1.4.4.1.1.2.3">ℳ</ci></apply><apply id="S4.E13.m1.4.4.1.1.3.cmml" xref="S4.E13.m1.4.4.1.1.3"><times id="S4.E13.m1.4.4.1.1.3.1.cmml" xref="S4.E13.m1.4.4.1.1.3.1"></times><apply id="S4.E13.m1.4.4.1.1.3.2.cmml" xref="S4.E13.m1.4.4.1.1.3.2"><csymbol cd="ambiguous" id="S4.E13.m1.4.4.1.1.3.2.1.cmml" xref="S4.E13.m1.4.4.1.1.3.2">subscript</csymbol><ci id="S4.E13.m1.4.4.1.1.3.2.2.cmml" xref="S4.E13.m1.4.4.1.1.3.2.2">𝜋</ci><ci id="S4.E13.m1.4.4.1.1.3.2.3a.cmml" xref="S4.E13.m1.4.4.1.1.3.2.3"><mtext id="S4.E13.m1.4.4.1.1.3.2.3.cmml" mathsize="70%" xref="S4.E13.m1.4.4.1.1.3.2.3">list</mtext></ci></apply><vector id="S4.E13.m1.4.4.1.1.3.3.1.cmml" xref="S4.E13.m1.4.4.1.1.3.3.2"><ci id="S4.E13.m1.1.1.cmml" xref="S4.E13.m1.1.1">𝑥</ci><ci id="S4.E13.m1.2.2.cmml" xref="S4.E13.m1.2.2">ℳ</ci><ci id="S4.E13.m1.3.3a.cmml" xref="S4.E13.m1.3.3"><mtext class="ltx_mathvariant_monospace" id="S4.E13.m1.3.3.cmml" xref="S4.E13.m1.3.3">Instruction</mtext></ci></vector></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E13.m1.4c">\Delta\mathcal{M}=\pi_{\text{list}}(x,\mathcal{M},\texttt{Instruction}).</annotation><annotation encoding="application/x-llamapun" id="S4.E13.m1.4d">roman_Δ caligraphic_M = italic_π start_POSTSUBSCRIPT list end_POSTSUBSCRIPT ( italic_x , caligraphic_M , Instruction ) .</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(13)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS3.p3.7">We initialize <math alttext="\pi_{\text{list}}" class="ltx_Math" display="inline" id="S4.SS3.p3.6.m1.1"><semantics id="S4.SS3.p3.6.m1.1a"><msub id="S4.SS3.p3.6.m1.1.1" xref="S4.SS3.p3.6.m1.1.1.cmml"><mi id="S4.SS3.p3.6.m1.1.1.2" xref="S4.SS3.p3.6.m1.1.1.2.cmml">π</mi><mtext id="S4.SS3.p3.6.m1.1.1.3" xref="S4.SS3.p3.6.m1.1.1.3a.cmml">list</mtext></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p3.6.m1.1b"><apply id="S4.SS3.p3.6.m1.1.1.cmml" xref="S4.SS3.p3.6.m1.1.1"><csymbol cd="ambiguous" id="S4.SS3.p3.6.m1.1.1.1.cmml" xref="S4.SS3.p3.6.m1.1.1">subscript</csymbol><ci id="S4.SS3.p3.6.m1.1.1.2.cmml" xref="S4.SS3.p3.6.m1.1.1.2">𝜋</ci><ci id="S4.SS3.p3.6.m1.1.1.3a.cmml" xref="S4.SS3.p3.6.m1.1.1.3"><mtext id="S4.SS3.p3.6.m1.1.1.3.cmml" mathsize="70%" xref="S4.SS3.p3.6.m1.1.1.3">list</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p3.6.m1.1c">\pi_{\text{list}}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p3.6.m1.1d">italic_π start_POSTSUBSCRIPT list end_POSTSUBSCRIPT</annotation></semantics></math> with <math alttext="\pi_{\text{cls}}" class="ltx_Math" display="inline" id="S4.SS3.p3.7.m2.1"><semantics id="S4.SS3.p3.7.m2.1a"><msub id="S4.SS3.p3.7.m2.1.1" xref="S4.SS3.p3.7.m2.1.1.cmml"><mi id="S4.SS3.p3.7.m2.1.1.2" xref="S4.SS3.p3.7.m2.1.1.2.cmml">π</mi><mtext id="S4.SS3.p3.7.m2.1.1.3" xref="S4.SS3.p3.7.m2.1.1.3a.cmml">cls</mtext></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p3.7.m2.1b"><apply id="S4.SS3.p3.7.m2.1.1.cmml" xref="S4.SS3.p3.7.m2.1.1"><csymbol cd="ambiguous" id="S4.SS3.p3.7.m2.1.1.1.cmml" xref="S4.SS3.p3.7.m2.1.1">subscript</csymbol><ci id="S4.SS3.p3.7.m2.1.1.2.cmml" xref="S4.SS3.p3.7.m2.1.1.2">𝜋</ci><ci id="S4.SS3.p3.7.m2.1.1.3a.cmml" xref="S4.SS3.p3.7.m2.1.1.3"><mtext id="S4.SS3.p3.7.m2.1.1.3.cmml" mathsize="70%" xref="S4.SS3.p3.7.m2.1.1.3">cls</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p3.7.m2.1c">\pi_{\text{cls}}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p3.7.m2.1d">italic_π start_POSTSUBSCRIPT cls end_POSTSUBSCRIPT</annotation></semantics></math>, leveraging its drug-patient matching ability, and further adapt it to instruction-driven editing via supervised fine-tuning and step-wise GRPO (see Section <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S4.SS1" title="4.1 Step-wise GRPO ‣ 4 Method: FLAME ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">4.1</span></a>).</p>
</div>
<div class="ltx_para" id="S4.SS3.p4">
<p class="ltx_p" id="S4.SS3.p4.2"><span class="ltx_text ltx_font_bold" id="S4.SS3.p4.2.1">Inference.</span>
At inference, we first apply <math alttext="\pi_{\text{cls}}" class="ltx_Math" display="inline" id="S4.SS3.p4.1.m1.1"><semantics id="S4.SS3.p4.1.m1.1a"><msub id="S4.SS3.p4.1.m1.1.1" xref="S4.SS3.p4.1.m1.1.1.cmml"><mi id="S4.SS3.p4.1.m1.1.1.2" xref="S4.SS3.p4.1.m1.1.1.2.cmml">π</mi><mtext id="S4.SS3.p4.1.m1.1.1.3" xref="S4.SS3.p4.1.m1.1.1.3a.cmml">cls</mtext></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p4.1.m1.1b"><apply id="S4.SS3.p4.1.m1.1.1.cmml" xref="S4.SS3.p4.1.m1.1.1"><csymbol cd="ambiguous" id="S4.SS3.p4.1.m1.1.1.1.cmml" xref="S4.SS3.p4.1.m1.1.1">subscript</csymbol><ci id="S4.SS3.p4.1.m1.1.1.2.cmml" xref="S4.SS3.p4.1.m1.1.1.2">𝜋</ci><ci id="S4.SS3.p4.1.m1.1.1.3a.cmml" xref="S4.SS3.p4.1.m1.1.1.3"><mtext id="S4.SS3.p4.1.m1.1.1.3.cmml" mathsize="70%" xref="S4.SS3.p4.1.m1.1.1.3">cls</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p4.1.m1.1c">\pi_{\text{cls}}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p4.1.m1.1d">italic_π start_POSTSUBSCRIPT cls end_POSTSUBSCRIPT</annotation></semantics></math> to obtain <math alttext="\mathcal{M}_{p}" class="ltx_Math" display="inline" id="S4.SS3.p4.2.m2.1"><semantics id="S4.SS3.p4.2.m2.1a"><msub id="S4.SS3.p4.2.m2.1.1" xref="S4.SS3.p4.2.m2.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.SS3.p4.2.m2.1.1.2" xref="S4.SS3.p4.2.m2.1.1.2.cmml">ℳ</mi><mi id="S4.SS3.p4.2.m2.1.1.3" xref="S4.SS3.p4.2.m2.1.1.3.cmml">p</mi></msub><annotation-xml encoding="MathML-Content" id="S4.SS3.p4.2.m2.1b"><apply id="S4.SS3.p4.2.m2.1.1.cmml" xref="S4.SS3.p4.2.m2.1.1"><csymbol cd="ambiguous" id="S4.SS3.p4.2.m2.1.1.1.cmml" xref="S4.SS3.p4.2.m2.1.1">subscript</csymbol><ci id="S4.SS3.p4.2.m2.1.1.2.cmml" xref="S4.SS3.p4.2.m2.1.1.2">ℳ</ci><ci id="S4.SS3.p4.2.m2.1.1.3.cmml" xref="S4.SS3.p4.2.m2.1.1.3">𝑝</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS3.p4.2.m2.1c">\mathcal{M}_{p}</annotation><annotation encoding="application/x-llamapun" id="S4.SS3.p4.2.m2.1d">caligraphic_M start_POSTSUBSCRIPT italic_p end_POSTSUBSCRIPT</annotation></semantics></math> using Eq. (<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S4.E12" title="In 4.3 Two-stage Recommendation Framework ‣ 4 Method: FLAME ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">12</span></a>), then perform list-level edits:</p>
<table class="ltx_equation ltx_eqn_table" id="S4.E14">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\Delta\mathcal{M}_{\text{add}}=\pi_{\text{list}}(x,\mathcal{M}_{p},\texttt{Add%
 Drug}),\quad\Delta\mathcal{M}_{\text{remove}}=\pi_{\text{list}}(x,\mathcal{M}%
_{p},\texttt{Remove Drug})." class="ltx_Math" display="block" id="S4.E14.m1.5"><semantics id="S4.E14.m1.5a"><mrow id="S4.E14.m1.5.5.1"><mrow id="S4.E14.m1.5.5.1.1.2" xref="S4.E14.m1.5.5.1.1.3.cmml"><mrow id="S4.E14.m1.5.5.1.1.1.1" xref="S4.E14.m1.5.5.1.1.1.1.cmml"><mrow id="S4.E14.m1.5.5.1.1.1.1.3" xref="S4.E14.m1.5.5.1.1.1.1.3.cmml"><mi id="S4.E14.m1.5.5.1.1.1.1.3.2" mathvariant="normal" xref="S4.E14.m1.5.5.1.1.1.1.3.2.cmml">Δ</mi><mo id="S4.E14.m1.5.5.1.1.1.1.3.1" xref="S4.E14.m1.5.5.1.1.1.1.3.1.cmml">⁢</mo><msub id="S4.E14.m1.5.5.1.1.1.1.3.3" xref="S4.E14.m1.5.5.1.1.1.1.3.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E14.m1.5.5.1.1.1.1.3.3.2" xref="S4.E14.m1.5.5.1.1.1.1.3.3.2.cmml">ℳ</mi><mtext id="S4.E14.m1.5.5.1.1.1.1.3.3.3" xref="S4.E14.m1.5.5.1.1.1.1.3.3.3a.cmml">add</mtext></msub></mrow><mo id="S4.E14.m1.5.5.1.1.1.1.2" xref="S4.E14.m1.5.5.1.1.1.1.2.cmml">=</mo><mrow id="S4.E14.m1.5.5.1.1.1.1.1" xref="S4.E14.m1.5.5.1.1.1.1.1.cmml"><msub id="S4.E14.m1.5.5.1.1.1.1.1.3" xref="S4.E14.m1.5.5.1.1.1.1.1.3.cmml"><mi id="S4.E14.m1.5.5.1.1.1.1.1.3.2" xref="S4.E14.m1.5.5.1.1.1.1.1.3.2.cmml">π</mi><mtext id="S4.E14.m1.5.5.1.1.1.1.1.3.3" xref="S4.E14.m1.5.5.1.1.1.1.1.3.3a.cmml">list</mtext></msub><mo id="S4.E14.m1.5.5.1.1.1.1.1.2" xref="S4.E14.m1.5.5.1.1.1.1.1.2.cmml">⁢</mo><mrow id="S4.E14.m1.5.5.1.1.1.1.1.1.1" xref="S4.E14.m1.5.5.1.1.1.1.1.1.2.cmml"><mo id="S4.E14.m1.5.5.1.1.1.1.1.1.1.2" stretchy="false" xref="S4.E14.m1.5.5.1.1.1.1.1.1.2.cmml">(</mo><mi id="S4.E14.m1.1.1" xref="S4.E14.m1.1.1.cmml">x</mi><mo id="S4.E14.m1.5.5.1.1.1.1.1.1.1.3" xref="S4.E14.m1.5.5.1.1.1.1.1.1.2.cmml">,</mo><msub id="S4.E14.m1.5.5.1.1.1.1.1.1.1.1" xref="S4.E14.m1.5.5.1.1.1.1.1.1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E14.m1.5.5.1.1.1.1.1.1.1.1.2" xref="S4.E14.m1.5.5.1.1.1.1.1.1.1.1.2.cmml">ℳ</mi><mi id="S4.E14.m1.5.5.1.1.1.1.1.1.1.1.3" xref="S4.E14.m1.5.5.1.1.1.1.1.1.1.1.3.cmml">p</mi></msub><mo id="S4.E14.m1.5.5.1.1.1.1.1.1.1.4" xref="S4.E14.m1.5.5.1.1.1.1.1.1.2.cmml">,</mo><mtext class="ltx_mathvariant_monospace" id="S4.E14.m1.2.2" xref="S4.E14.m1.2.2a.cmml">Add Drug</mtext><mo id="S4.E14.m1.5.5.1.1.1.1.1.1.1.5" stretchy="false" xref="S4.E14.m1.5.5.1.1.1.1.1.1.2.cmml">)</mo></mrow></mrow></mrow><mo id="S4.E14.m1.5.5.1.1.2.3" rspace="1.167em" xref="S4.E14.m1.5.5.1.1.3a.cmml">,</mo><mrow id="S4.E14.m1.5.5.1.1.2.2" xref="S4.E14.m1.5.5.1.1.2.2.cmml"><mrow id="S4.E14.m1.5.5.1.1.2.2.3" xref="S4.E14.m1.5.5.1.1.2.2.3.cmml"><mi id="S4.E14.m1.5.5.1.1.2.2.3.2" mathvariant="normal" xref="S4.E14.m1.5.5.1.1.2.2.3.2.cmml">Δ</mi><mo id="S4.E14.m1.5.5.1.1.2.2.3.1" xref="S4.E14.m1.5.5.1.1.2.2.3.1.cmml">⁢</mo><msub id="S4.E14.m1.5.5.1.1.2.2.3.3" xref="S4.E14.m1.5.5.1.1.2.2.3.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E14.m1.5.5.1.1.2.2.3.3.2" xref="S4.E14.m1.5.5.1.1.2.2.3.3.2.cmml">ℳ</mi><mtext id="S4.E14.m1.5.5.1.1.2.2.3.3.3" xref="S4.E14.m1.5.5.1.1.2.2.3.3.3a.cmml">remove</mtext></msub></mrow><mo id="S4.E14.m1.5.5.1.1.2.2.2" xref="S4.E14.m1.5.5.1.1.2.2.2.cmml">=</mo><mrow id="S4.E14.m1.5.5.1.1.2.2.1" xref="S4.E14.m1.5.5.1.1.2.2.1.cmml"><msub id="S4.E14.m1.5.5.1.1.2.2.1.3" xref="S4.E14.m1.5.5.1.1.2.2.1.3.cmml"><mi id="S4.E14.m1.5.5.1.1.2.2.1.3.2" xref="S4.E14.m1.5.5.1.1.2.2.1.3.2.cmml">π</mi><mtext id="S4.E14.m1.5.5.1.1.2.2.1.3.3" xref="S4.E14.m1.5.5.1.1.2.2.1.3.3a.cmml">list</mtext></msub><mo id="S4.E14.m1.5.5.1.1.2.2.1.2" xref="S4.E14.m1.5.5.1.1.2.2.1.2.cmml">⁢</mo><mrow id="S4.E14.m1.5.5.1.1.2.2.1.1.1" xref="S4.E14.m1.5.5.1.1.2.2.1.1.2.cmml"><mo id="S4.E14.m1.5.5.1.1.2.2.1.1.1.2" stretchy="false" xref="S4.E14.m1.5.5.1.1.2.2.1.1.2.cmml">(</mo><mi id="S4.E14.m1.3.3" xref="S4.E14.m1.3.3.cmml">x</mi><mo id="S4.E14.m1.5.5.1.1.2.2.1.1.1.3" xref="S4.E14.m1.5.5.1.1.2.2.1.1.2.cmml">,</mo><msub id="S4.E14.m1.5.5.1.1.2.2.1.1.1.1" xref="S4.E14.m1.5.5.1.1.2.2.1.1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E14.m1.5.5.1.1.2.2.1.1.1.1.2" xref="S4.E14.m1.5.5.1.1.2.2.1.1.1.1.2.cmml">ℳ</mi><mi id="S4.E14.m1.5.5.1.1.2.2.1.1.1.1.3" xref="S4.E14.m1.5.5.1.1.2.2.1.1.1.1.3.cmml">p</mi></msub><mo id="S4.E14.m1.5.5.1.1.2.2.1.1.1.4" xref="S4.E14.m1.5.5.1.1.2.2.1.1.2.cmml">,</mo><mtext class="ltx_mathvariant_monospace" id="S4.E14.m1.4.4" xref="S4.E14.m1.4.4a.cmml">Remove Drug</mtext><mo id="S4.E14.m1.5.5.1.1.2.2.1.1.1.5" stretchy="false" xref="S4.E14.m1.5.5.1.1.2.2.1.1.2.cmml">)</mo></mrow></mrow></mrow></mrow><mo id="S4.E14.m1.5.5.1.2" lspace="0em">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.E14.m1.5b"><apply id="S4.E14.m1.5.5.1.1.3.cmml" xref="S4.E14.m1.5.5.1.1.2"><csymbol cd="ambiguous" id="S4.E14.m1.5.5.1.1.3a.cmml" xref="S4.E14.m1.5.5.1.1.2.3">formulae-sequence</csymbol><apply id="S4.E14.m1.5.5.1.1.1.1.cmml" xref="S4.E14.m1.5.5.1.1.1.1"><eq id="S4.E14.m1.5.5.1.1.1.1.2.cmml" xref="S4.E14.m1.5.5.1.1.1.1.2"></eq><apply id="S4.E14.m1.5.5.1.1.1.1.3.cmml" xref="S4.E14.m1.5.5.1.1.1.1.3"><times id="S4.E14.m1.5.5.1.1.1.1.3.1.cmml" xref="S4.E14.m1.5.5.1.1.1.1.3.1"></times><ci id="S4.E14.m1.5.5.1.1.1.1.3.2.cmml" xref="S4.E14.m1.5.5.1.1.1.1.3.2">Δ</ci><apply id="S4.E14.m1.5.5.1.1.1.1.3.3.cmml" xref="S4.E14.m1.5.5.1.1.1.1.3.3"><csymbol cd="ambiguous" id="S4.E14.m1.5.5.1.1.1.1.3.3.1.cmml" xref="S4.E14.m1.5.5.1.1.1.1.3.3">subscript</csymbol><ci id="S4.E14.m1.5.5.1.1.1.1.3.3.2.cmml" xref="S4.E14.m1.5.5.1.1.1.1.3.3.2">ℳ</ci><ci id="S4.E14.m1.5.5.1.1.1.1.3.3.3a.cmml" xref="S4.E14.m1.5.5.1.1.1.1.3.3.3"><mtext id="S4.E14.m1.5.5.1.1.1.1.3.3.3.cmml" mathsize="70%" xref="S4.E14.m1.5.5.1.1.1.1.3.3.3">add</mtext></ci></apply></apply><apply id="S4.E14.m1.5.5.1.1.1.1.1.cmml" xref="S4.E14.m1.5.5.1.1.1.1.1"><times id="S4.E14.m1.5.5.1.1.1.1.1.2.cmml" xref="S4.E14.m1.5.5.1.1.1.1.1.2"></times><apply id="S4.E14.m1.5.5.1.1.1.1.1.3.cmml" xref="S4.E14.m1.5.5.1.1.1.1.1.3"><csymbol cd="ambiguous" id="S4.E14.m1.5.5.1.1.1.1.1.3.1.cmml" xref="S4.E14.m1.5.5.1.1.1.1.1.3">subscript</csymbol><ci id="S4.E14.m1.5.5.1.1.1.1.1.3.2.cmml" xref="S4.E14.m1.5.5.1.1.1.1.1.3.2">𝜋</ci><ci id="S4.E14.m1.5.5.1.1.1.1.1.3.3a.cmml" xref="S4.E14.m1.5.5.1.1.1.1.1.3.3"><mtext id="S4.E14.m1.5.5.1.1.1.1.1.3.3.cmml" mathsize="70%" xref="S4.E14.m1.5.5.1.1.1.1.1.3.3">list</mtext></ci></apply><vector id="S4.E14.m1.5.5.1.1.1.1.1.1.2.cmml" xref="S4.E14.m1.5.5.1.1.1.1.1.1.1"><ci id="S4.E14.m1.1.1.cmml" xref="S4.E14.m1.1.1">𝑥</ci><apply id="S4.E14.m1.5.5.1.1.1.1.1.1.1.1.cmml" xref="S4.E14.m1.5.5.1.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.E14.m1.5.5.1.1.1.1.1.1.1.1.1.cmml" xref="S4.E14.m1.5.5.1.1.1.1.1.1.1.1">subscript</csymbol><ci id="S4.E14.m1.5.5.1.1.1.1.1.1.1.1.2.cmml" xref="S4.E14.m1.5.5.1.1.1.1.1.1.1.1.2">ℳ</ci><ci id="S4.E14.m1.5.5.1.1.1.1.1.1.1.1.3.cmml" xref="S4.E14.m1.5.5.1.1.1.1.1.1.1.1.3">𝑝</ci></apply><ci id="S4.E14.m1.2.2a.cmml" xref="S4.E14.m1.2.2"><mtext class="ltx_mathvariant_monospace" id="S4.E14.m1.2.2.cmml" xref="S4.E14.m1.2.2">Add Drug</mtext></ci></vector></apply></apply><apply id="S4.E14.m1.5.5.1.1.2.2.cmml" xref="S4.E14.m1.5.5.1.1.2.2"><eq id="S4.E14.m1.5.5.1.1.2.2.2.cmml" xref="S4.E14.m1.5.5.1.1.2.2.2"></eq><apply id="S4.E14.m1.5.5.1.1.2.2.3.cmml" xref="S4.E14.m1.5.5.1.1.2.2.3"><times id="S4.E14.m1.5.5.1.1.2.2.3.1.cmml" xref="S4.E14.m1.5.5.1.1.2.2.3.1"></times><ci id="S4.E14.m1.5.5.1.1.2.2.3.2.cmml" xref="S4.E14.m1.5.5.1.1.2.2.3.2">Δ</ci><apply id="S4.E14.m1.5.5.1.1.2.2.3.3.cmml" xref="S4.E14.m1.5.5.1.1.2.2.3.3"><csymbol cd="ambiguous" id="S4.E14.m1.5.5.1.1.2.2.3.3.1.cmml" xref="S4.E14.m1.5.5.1.1.2.2.3.3">subscript</csymbol><ci id="S4.E14.m1.5.5.1.1.2.2.3.3.2.cmml" xref="S4.E14.m1.5.5.1.1.2.2.3.3.2">ℳ</ci><ci id="S4.E14.m1.5.5.1.1.2.2.3.3.3a.cmml" xref="S4.E14.m1.5.5.1.1.2.2.3.3.3"><mtext id="S4.E14.m1.5.5.1.1.2.2.3.3.3.cmml" mathsize="70%" xref="S4.E14.m1.5.5.1.1.2.2.3.3.3">remove</mtext></ci></apply></apply><apply id="S4.E14.m1.5.5.1.1.2.2.1.cmml" xref="S4.E14.m1.5.5.1.1.2.2.1"><times id="S4.E14.m1.5.5.1.1.2.2.1.2.cmml" xref="S4.E14.m1.5.5.1.1.2.2.1.2"></times><apply id="S4.E14.m1.5.5.1.1.2.2.1.3.cmml" xref="S4.E14.m1.5.5.1.1.2.2.1.3"><csymbol cd="ambiguous" id="S4.E14.m1.5.5.1.1.2.2.1.3.1.cmml" xref="S4.E14.m1.5.5.1.1.2.2.1.3">subscript</csymbol><ci id="S4.E14.m1.5.5.1.1.2.2.1.3.2.cmml" xref="S4.E14.m1.5.5.1.1.2.2.1.3.2">𝜋</ci><ci id="S4.E14.m1.5.5.1.1.2.2.1.3.3a.cmml" xref="S4.E14.m1.5.5.1.1.2.2.1.3.3"><mtext id="S4.E14.m1.5.5.1.1.2.2.1.3.3.cmml" mathsize="70%" xref="S4.E14.m1.5.5.1.1.2.2.1.3.3">list</mtext></ci></apply><vector id="S4.E14.m1.5.5.1.1.2.2.1.1.2.cmml" xref="S4.E14.m1.5.5.1.1.2.2.1.1.1"><ci id="S4.E14.m1.3.3.cmml" xref="S4.E14.m1.3.3">𝑥</ci><apply id="S4.E14.m1.5.5.1.1.2.2.1.1.1.1.cmml" xref="S4.E14.m1.5.5.1.1.2.2.1.1.1.1"><csymbol cd="ambiguous" id="S4.E14.m1.5.5.1.1.2.2.1.1.1.1.1.cmml" xref="S4.E14.m1.5.5.1.1.2.2.1.1.1.1">subscript</csymbol><ci id="S4.E14.m1.5.5.1.1.2.2.1.1.1.1.2.cmml" xref="S4.E14.m1.5.5.1.1.2.2.1.1.1.1.2">ℳ</ci><ci id="S4.E14.m1.5.5.1.1.2.2.1.1.1.1.3.cmml" xref="S4.E14.m1.5.5.1.1.2.2.1.1.1.1.3">𝑝</ci></apply><ci id="S4.E14.m1.4.4a.cmml" xref="S4.E14.m1.4.4"><mtext class="ltx_mathvariant_monospace" id="S4.E14.m1.4.4.cmml" xref="S4.E14.m1.4.4">Remove Drug</mtext></ci></vector></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E14.m1.5c">\Delta\mathcal{M}_{\text{add}}=\pi_{\text{list}}(x,\mathcal{M}_{p},\texttt{Add%
 Drug}),\quad\Delta\mathcal{M}_{\text{remove}}=\pi_{\text{list}}(x,\mathcal{M}%
_{p},\texttt{Remove Drug}).</annotation><annotation encoding="application/x-llamapun" id="S4.E14.m1.5d">roman_Δ caligraphic_M start_POSTSUBSCRIPT add end_POSTSUBSCRIPT = italic_π start_POSTSUBSCRIPT list end_POSTSUBSCRIPT ( italic_x , caligraphic_M start_POSTSUBSCRIPT italic_p end_POSTSUBSCRIPT , Add Drug ) , roman_Δ caligraphic_M start_POSTSUBSCRIPT remove end_POSTSUBSCRIPT = italic_π start_POSTSUBSCRIPT list end_POSTSUBSCRIPT ( italic_x , caligraphic_M start_POSTSUBSCRIPT italic_p end_POSTSUBSCRIPT , Remove Drug ) .</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(14)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS3.p4.3">The final recommendation is obtained by applying the edits:</p>
<table class="ltx_equation ltx_eqn_table" id="S4.E15">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\mathcal{M}_{v}=\left(\mathcal{M}_{p}\cup\Delta\mathcal{M}_{\text{add}}\right)%
\setminus\Delta\mathcal{M}_{\text{remove}}." class="ltx_Math" display="block" id="S4.E15.m1.1"><semantics id="S4.E15.m1.1a"><mrow id="S4.E15.m1.1.1.1" xref="S4.E15.m1.1.1.1.1.cmml"><mrow id="S4.E15.m1.1.1.1.1" xref="S4.E15.m1.1.1.1.1.cmml"><msub id="S4.E15.m1.1.1.1.1.3" xref="S4.E15.m1.1.1.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E15.m1.1.1.1.1.3.2" xref="S4.E15.m1.1.1.1.1.3.2.cmml">ℳ</mi><mi id="S4.E15.m1.1.1.1.1.3.3" xref="S4.E15.m1.1.1.1.1.3.3.cmml">v</mi></msub><mo id="S4.E15.m1.1.1.1.1.2" xref="S4.E15.m1.1.1.1.1.2.cmml">=</mo><mrow id="S4.E15.m1.1.1.1.1.1" xref="S4.E15.m1.1.1.1.1.1.cmml"><mrow id="S4.E15.m1.1.1.1.1.1.1.1" xref="S4.E15.m1.1.1.1.1.1.1.1.1.cmml"><mo id="S4.E15.m1.1.1.1.1.1.1.1.2" xref="S4.E15.m1.1.1.1.1.1.1.1.1.cmml">(</mo><mrow id="S4.E15.m1.1.1.1.1.1.1.1.1" xref="S4.E15.m1.1.1.1.1.1.1.1.1.cmml"><msub id="S4.E15.m1.1.1.1.1.1.1.1.1.2" xref="S4.E15.m1.1.1.1.1.1.1.1.1.2.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E15.m1.1.1.1.1.1.1.1.1.2.2" xref="S4.E15.m1.1.1.1.1.1.1.1.1.2.2.cmml">ℳ</mi><mi id="S4.E15.m1.1.1.1.1.1.1.1.1.2.3" xref="S4.E15.m1.1.1.1.1.1.1.1.1.2.3.cmml">p</mi></msub><mo id="S4.E15.m1.1.1.1.1.1.1.1.1.1" xref="S4.E15.m1.1.1.1.1.1.1.1.1.1.cmml">∪</mo><mrow id="S4.E15.m1.1.1.1.1.1.1.1.1.3" xref="S4.E15.m1.1.1.1.1.1.1.1.1.3.cmml"><mi id="S4.E15.m1.1.1.1.1.1.1.1.1.3.2" mathvariant="normal" xref="S4.E15.m1.1.1.1.1.1.1.1.1.3.2.cmml">Δ</mi><mo id="S4.E15.m1.1.1.1.1.1.1.1.1.3.1" xref="S4.E15.m1.1.1.1.1.1.1.1.1.3.1.cmml">⁢</mo><msub id="S4.E15.m1.1.1.1.1.1.1.1.1.3.3" xref="S4.E15.m1.1.1.1.1.1.1.1.1.3.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E15.m1.1.1.1.1.1.1.1.1.3.3.2" xref="S4.E15.m1.1.1.1.1.1.1.1.1.3.3.2.cmml">ℳ</mi><mtext id="S4.E15.m1.1.1.1.1.1.1.1.1.3.3.3" xref="S4.E15.m1.1.1.1.1.1.1.1.1.3.3.3a.cmml">add</mtext></msub></mrow></mrow><mo id="S4.E15.m1.1.1.1.1.1.1.1.3" xref="S4.E15.m1.1.1.1.1.1.1.1.1.cmml">)</mo></mrow><mo id="S4.E15.m1.1.1.1.1.1.2" xref="S4.E15.m1.1.1.1.1.1.2.cmml">∖</mo><mrow id="S4.E15.m1.1.1.1.1.1.3" xref="S4.E15.m1.1.1.1.1.1.3.cmml"><mi id="S4.E15.m1.1.1.1.1.1.3.2" mathvariant="normal" xref="S4.E15.m1.1.1.1.1.1.3.2.cmml">Δ</mi><mo id="S4.E15.m1.1.1.1.1.1.3.1" xref="S4.E15.m1.1.1.1.1.1.3.1.cmml">⁢</mo><msub id="S4.E15.m1.1.1.1.1.1.3.3" xref="S4.E15.m1.1.1.1.1.1.3.3.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E15.m1.1.1.1.1.1.3.3.2" xref="S4.E15.m1.1.1.1.1.1.3.3.2.cmml">ℳ</mi><mtext id="S4.E15.m1.1.1.1.1.1.3.3.3" xref="S4.E15.m1.1.1.1.1.1.3.3.3a.cmml">remove</mtext></msub></mrow></mrow></mrow><mo id="S4.E15.m1.1.1.1.2" lspace="0em" xref="S4.E15.m1.1.1.1.1.cmml">.</mo></mrow><annotation-xml encoding="MathML-Content" id="S4.E15.m1.1b"><apply id="S4.E15.m1.1.1.1.1.cmml" xref="S4.E15.m1.1.1.1"><eq id="S4.E15.m1.1.1.1.1.2.cmml" xref="S4.E15.m1.1.1.1.1.2"></eq><apply id="S4.E15.m1.1.1.1.1.3.cmml" xref="S4.E15.m1.1.1.1.1.3"><csymbol cd="ambiguous" id="S4.E15.m1.1.1.1.1.3.1.cmml" xref="S4.E15.m1.1.1.1.1.3">subscript</csymbol><ci id="S4.E15.m1.1.1.1.1.3.2.cmml" xref="S4.E15.m1.1.1.1.1.3.2">ℳ</ci><ci id="S4.E15.m1.1.1.1.1.3.3.cmml" xref="S4.E15.m1.1.1.1.1.3.3">𝑣</ci></apply><apply id="S4.E15.m1.1.1.1.1.1.cmml" xref="S4.E15.m1.1.1.1.1.1"><setdiff id="S4.E15.m1.1.1.1.1.1.2.cmml" xref="S4.E15.m1.1.1.1.1.1.2"></setdiff><apply id="S4.E15.m1.1.1.1.1.1.1.1.1.cmml" xref="S4.E15.m1.1.1.1.1.1.1.1"><union id="S4.E15.m1.1.1.1.1.1.1.1.1.1.cmml" xref="S4.E15.m1.1.1.1.1.1.1.1.1.1"></union><apply id="S4.E15.m1.1.1.1.1.1.1.1.1.2.cmml" xref="S4.E15.m1.1.1.1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="S4.E15.m1.1.1.1.1.1.1.1.1.2.1.cmml" xref="S4.E15.m1.1.1.1.1.1.1.1.1.2">subscript</csymbol><ci id="S4.E15.m1.1.1.1.1.1.1.1.1.2.2.cmml" xref="S4.E15.m1.1.1.1.1.1.1.1.1.2.2">ℳ</ci><ci id="S4.E15.m1.1.1.1.1.1.1.1.1.2.3.cmml" xref="S4.E15.m1.1.1.1.1.1.1.1.1.2.3">𝑝</ci></apply><apply id="S4.E15.m1.1.1.1.1.1.1.1.1.3.cmml" xref="S4.E15.m1.1.1.1.1.1.1.1.1.3"><times id="S4.E15.m1.1.1.1.1.1.1.1.1.3.1.cmml" xref="S4.E15.m1.1.1.1.1.1.1.1.1.3.1"></times><ci id="S4.E15.m1.1.1.1.1.1.1.1.1.3.2.cmml" xref="S4.E15.m1.1.1.1.1.1.1.1.1.3.2">Δ</ci><apply id="S4.E15.m1.1.1.1.1.1.1.1.1.3.3.cmml" xref="S4.E15.m1.1.1.1.1.1.1.1.1.3.3"><csymbol cd="ambiguous" id="S4.E15.m1.1.1.1.1.1.1.1.1.3.3.1.cmml" xref="S4.E15.m1.1.1.1.1.1.1.1.1.3.3">subscript</csymbol><ci id="S4.E15.m1.1.1.1.1.1.1.1.1.3.3.2.cmml" xref="S4.E15.m1.1.1.1.1.1.1.1.1.3.3.2">ℳ</ci><ci id="S4.E15.m1.1.1.1.1.1.1.1.1.3.3.3a.cmml" xref="S4.E15.m1.1.1.1.1.1.1.1.1.3.3.3"><mtext id="S4.E15.m1.1.1.1.1.1.1.1.1.3.3.3.cmml" mathsize="70%" xref="S4.E15.m1.1.1.1.1.1.1.1.1.3.3.3">add</mtext></ci></apply></apply></apply><apply id="S4.E15.m1.1.1.1.1.1.3.cmml" xref="S4.E15.m1.1.1.1.1.1.3"><times id="S4.E15.m1.1.1.1.1.1.3.1.cmml" xref="S4.E15.m1.1.1.1.1.1.3.1"></times><ci id="S4.E15.m1.1.1.1.1.1.3.2.cmml" xref="S4.E15.m1.1.1.1.1.1.3.2">Δ</ci><apply id="S4.E15.m1.1.1.1.1.1.3.3.cmml" xref="S4.E15.m1.1.1.1.1.1.3.3"><csymbol cd="ambiguous" id="S4.E15.m1.1.1.1.1.1.3.3.1.cmml" xref="S4.E15.m1.1.1.1.1.1.3.3">subscript</csymbol><ci id="S4.E15.m1.1.1.1.1.1.3.3.2.cmml" xref="S4.E15.m1.1.1.1.1.1.3.3.2">ℳ</ci><ci id="S4.E15.m1.1.1.1.1.1.3.3.3a.cmml" xref="S4.E15.m1.1.1.1.1.1.3.3.3"><mtext id="S4.E15.m1.1.1.1.1.1.3.3.3.cmml" mathsize="70%" xref="S4.E15.m1.1.1.1.1.1.3.3.3">remove</mtext></ci></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E15.m1.1c">\mathcal{M}_{v}=\left(\mathcal{M}_{p}\cup\Delta\mathcal{M}_{\text{add}}\right)%
\setminus\Delta\mathcal{M}_{\text{remove}}.</annotation><annotation encoding="application/x-llamapun" id="S4.E15.m1.1d">caligraphic_M start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT = ( caligraphic_M start_POSTSUBSCRIPT italic_p end_POSTSUBSCRIPT ∪ roman_Δ caligraphic_M start_POSTSUBSCRIPT add end_POSTSUBSCRIPT ) ∖ roman_Δ caligraphic_M start_POSTSUBSCRIPT remove end_POSTSUBSCRIPT .</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(15)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS3.p4.4">This two-stage procedure combines individualized assessment with global reasoning for more controllable and context-aware recommendations.
Implementation details, including prompt templates and training setup, are provided in Appendix <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#A3" title="Appendix C Experimental Setup ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">C</span></a>.</p>
</div>
</section>
<section class="ltx_subsection" id="S4.SS4">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">4.4 </span>Multi-source Knowledge Fusion</h3>
<figure class="ltx_figure" id="S4.F4"><img alt="Refer to caption" class="ltx_graphics ltx_centering ltx_img_landscape" height="246" id="S4.F4.g1" src="x4.png" width="831"/>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure">Figure 4: </span>Overview of patient representation construction.</figcaption>
</figure>
<div class="ltx_para" id="S4.SS4.p1">
<p class="ltx_p" id="S4.SS4.p1.1">Traditional methods often encode structured inputs (e.g., diagnoses, procedures) into embeddings and integrate external knowledge via architectural modules such as graph encoders <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib3" title="">3</a>, <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib7" title="">7</a>]</cite>.
However, LLMs operate primarily on unstructured text, making the incorporation of structured signals non-trivial.</p>
</div>
<div class="ltx_para" id="S4.SS4.p2">
<p class="ltx_p" id="S4.SS4.p2.3">We propose a fusion mechanism that injects collaborative signals from structured sources into LLMs <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib24" title="">24</a>, <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib25" title="">25</a>]</cite>, as illustrated in Fig. <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S4.F4" title="Figure 4 ‣ 4.4 Multi-source Knowledge Fusion ‣ 4 Method: FLAME ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">4</span></a>.
For each structured entity, we construct two complementary representations: a <span class="ltx_text ltx_font_italic" id="S4.SS4.p2.3.1">textual embedding</span> <math alttext="\mathbf{e}^{\text{text}}\in\mathbb{R}^{d}" class="ltx_Math" display="inline" id="S4.SS4.p2.1.m1.1"><semantics id="S4.SS4.p2.1.m1.1a"><mrow id="S4.SS4.p2.1.m1.1.1" xref="S4.SS4.p2.1.m1.1.1.cmml"><msup id="S4.SS4.p2.1.m1.1.1.2" xref="S4.SS4.p2.1.m1.1.1.2.cmml"><mi id="S4.SS4.p2.1.m1.1.1.2.2" xref="S4.SS4.p2.1.m1.1.1.2.2.cmml">𝐞</mi><mtext id="S4.SS4.p2.1.m1.1.1.2.3" xref="S4.SS4.p2.1.m1.1.1.2.3a.cmml">text</mtext></msup><mo id="S4.SS4.p2.1.m1.1.1.1" xref="S4.SS4.p2.1.m1.1.1.1.cmml">∈</mo><msup id="S4.SS4.p2.1.m1.1.1.3" xref="S4.SS4.p2.1.m1.1.1.3.cmml"><mi id="S4.SS4.p2.1.m1.1.1.3.2" xref="S4.SS4.p2.1.m1.1.1.3.2.cmml">ℝ</mi><mi id="S4.SS4.p2.1.m1.1.1.3.3" xref="S4.SS4.p2.1.m1.1.1.3.3.cmml">d</mi></msup></mrow><annotation-xml encoding="MathML-Content" id="S4.SS4.p2.1.m1.1b"><apply id="S4.SS4.p2.1.m1.1.1.cmml" xref="S4.SS4.p2.1.m1.1.1"><in id="S4.SS4.p2.1.m1.1.1.1.cmml" xref="S4.SS4.p2.1.m1.1.1.1"></in><apply id="S4.SS4.p2.1.m1.1.1.2.cmml" xref="S4.SS4.p2.1.m1.1.1.2"><csymbol cd="ambiguous" id="S4.SS4.p2.1.m1.1.1.2.1.cmml" xref="S4.SS4.p2.1.m1.1.1.2">superscript</csymbol><ci id="S4.SS4.p2.1.m1.1.1.2.2.cmml" xref="S4.SS4.p2.1.m1.1.1.2.2">𝐞</ci><ci id="S4.SS4.p2.1.m1.1.1.2.3a.cmml" xref="S4.SS4.p2.1.m1.1.1.2.3"><mtext id="S4.SS4.p2.1.m1.1.1.2.3.cmml" mathsize="70%" xref="S4.SS4.p2.1.m1.1.1.2.3">text</mtext></ci></apply><apply id="S4.SS4.p2.1.m1.1.1.3.cmml" xref="S4.SS4.p2.1.m1.1.1.3"><csymbol cd="ambiguous" id="S4.SS4.p2.1.m1.1.1.3.1.cmml" xref="S4.SS4.p2.1.m1.1.1.3">superscript</csymbol><ci id="S4.SS4.p2.1.m1.1.1.3.2.cmml" xref="S4.SS4.p2.1.m1.1.1.3.2">ℝ</ci><ci id="S4.SS4.p2.1.m1.1.1.3.3.cmml" xref="S4.SS4.p2.1.m1.1.1.3.3">𝑑</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS4.p2.1.m1.1c">\mathbf{e}^{\text{text}}\in\mathbb{R}^{d}</annotation><annotation encoding="application/x-llamapun" id="S4.SS4.p2.1.m1.1d">bold_e start_POSTSUPERSCRIPT text end_POSTSUPERSCRIPT ∈ blackboard_R start_POSTSUPERSCRIPT italic_d end_POSTSUPERSCRIPT</annotation></semantics></math> from natural language descriptions, and a <span class="ltx_text ltx_font_italic" id="S4.SS4.p2.3.2">collaborative embedding</span> <math alttext="\mathbf{e}^{\text{collab}}\in\mathbb{R}^{d^{\prime}}" class="ltx_Math" display="inline" id="S4.SS4.p2.2.m2.1"><semantics id="S4.SS4.p2.2.m2.1a"><mrow id="S4.SS4.p2.2.m2.1.1" xref="S4.SS4.p2.2.m2.1.1.cmml"><msup id="S4.SS4.p2.2.m2.1.1.2" xref="S4.SS4.p2.2.m2.1.1.2.cmml"><mi id="S4.SS4.p2.2.m2.1.1.2.2" xref="S4.SS4.p2.2.m2.1.1.2.2.cmml">𝐞</mi><mtext id="S4.SS4.p2.2.m2.1.1.2.3" xref="S4.SS4.p2.2.m2.1.1.2.3a.cmml">collab</mtext></msup><mo id="S4.SS4.p2.2.m2.1.1.1" xref="S4.SS4.p2.2.m2.1.1.1.cmml">∈</mo><msup id="S4.SS4.p2.2.m2.1.1.3" xref="S4.SS4.p2.2.m2.1.1.3.cmml"><mi id="S4.SS4.p2.2.m2.1.1.3.2" xref="S4.SS4.p2.2.m2.1.1.3.2.cmml">ℝ</mi><msup id="S4.SS4.p2.2.m2.1.1.3.3" xref="S4.SS4.p2.2.m2.1.1.3.3.cmml"><mi id="S4.SS4.p2.2.m2.1.1.3.3.2" xref="S4.SS4.p2.2.m2.1.1.3.3.2.cmml">d</mi><mo id="S4.SS4.p2.2.m2.1.1.3.3.3" xref="S4.SS4.p2.2.m2.1.1.3.3.3.cmml">′</mo></msup></msup></mrow><annotation-xml encoding="MathML-Content" id="S4.SS4.p2.2.m2.1b"><apply id="S4.SS4.p2.2.m2.1.1.cmml" xref="S4.SS4.p2.2.m2.1.1"><in id="S4.SS4.p2.2.m2.1.1.1.cmml" xref="S4.SS4.p2.2.m2.1.1.1"></in><apply id="S4.SS4.p2.2.m2.1.1.2.cmml" xref="S4.SS4.p2.2.m2.1.1.2"><csymbol cd="ambiguous" id="S4.SS4.p2.2.m2.1.1.2.1.cmml" xref="S4.SS4.p2.2.m2.1.1.2">superscript</csymbol><ci id="S4.SS4.p2.2.m2.1.1.2.2.cmml" xref="S4.SS4.p2.2.m2.1.1.2.2">𝐞</ci><ci id="S4.SS4.p2.2.m2.1.1.2.3a.cmml" xref="S4.SS4.p2.2.m2.1.1.2.3"><mtext id="S4.SS4.p2.2.m2.1.1.2.3.cmml" mathsize="70%" xref="S4.SS4.p2.2.m2.1.1.2.3">collab</mtext></ci></apply><apply id="S4.SS4.p2.2.m2.1.1.3.cmml" xref="S4.SS4.p2.2.m2.1.1.3"><csymbol cd="ambiguous" id="S4.SS4.p2.2.m2.1.1.3.1.cmml" xref="S4.SS4.p2.2.m2.1.1.3">superscript</csymbol><ci id="S4.SS4.p2.2.m2.1.1.3.2.cmml" xref="S4.SS4.p2.2.m2.1.1.3.2">ℝ</ci><apply id="S4.SS4.p2.2.m2.1.1.3.3.cmml" xref="S4.SS4.p2.2.m2.1.1.3.3"><csymbol cd="ambiguous" id="S4.SS4.p2.2.m2.1.1.3.3.1.cmml" xref="S4.SS4.p2.2.m2.1.1.3.3">superscript</csymbol><ci id="S4.SS4.p2.2.m2.1.1.3.3.2.cmml" xref="S4.SS4.p2.2.m2.1.1.3.3.2">𝑑</ci><ci id="S4.SS4.p2.2.m2.1.1.3.3.3.cmml" xref="S4.SS4.p2.2.m2.1.1.3.3.3">′</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS4.p2.2.m2.1c">\mathbf{e}^{\text{collab}}\in\mathbb{R}^{d^{\prime}}</annotation><annotation encoding="application/x-llamapun" id="S4.SS4.p2.2.m2.1d">bold_e start_POSTSUPERSCRIPT collab end_POSTSUPERSCRIPT ∈ blackboard_R start_POSTSUPERSCRIPT italic_d start_POSTSUPERSCRIPT ′ end_POSTSUPERSCRIPT end_POSTSUPERSCRIPT</annotation></semantics></math> from a domain-specific encoder.
The collaborative embedding is projected into the LLM space via a learnable linear map <math alttext="\mathcal{P}:\mathbb{R}^{d^{\prime}}\rightarrow\mathbb{R}^{d}" class="ltx_Math" display="inline" id="S4.SS4.p2.3.m3.1"><semantics id="S4.SS4.p2.3.m3.1a"><mrow id="S4.SS4.p2.3.m3.1.1" xref="S4.SS4.p2.3.m3.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.SS4.p2.3.m3.1.1.2" xref="S4.SS4.p2.3.m3.1.1.2.cmml">𝒫</mi><mo id="S4.SS4.p2.3.m3.1.1.1" lspace="0.278em" rspace="0.278em" xref="S4.SS4.p2.3.m3.1.1.1.cmml">:</mo><mrow id="S4.SS4.p2.3.m3.1.1.3" xref="S4.SS4.p2.3.m3.1.1.3.cmml"><msup id="S4.SS4.p2.3.m3.1.1.3.2" xref="S4.SS4.p2.3.m3.1.1.3.2.cmml"><mi id="S4.SS4.p2.3.m3.1.1.3.2.2" xref="S4.SS4.p2.3.m3.1.1.3.2.2.cmml">ℝ</mi><msup id="S4.SS4.p2.3.m3.1.1.3.2.3" xref="S4.SS4.p2.3.m3.1.1.3.2.3.cmml"><mi id="S4.SS4.p2.3.m3.1.1.3.2.3.2" xref="S4.SS4.p2.3.m3.1.1.3.2.3.2.cmml">d</mi><mo id="S4.SS4.p2.3.m3.1.1.3.2.3.3" xref="S4.SS4.p2.3.m3.1.1.3.2.3.3.cmml">′</mo></msup></msup><mo id="S4.SS4.p2.3.m3.1.1.3.1" stretchy="false" xref="S4.SS4.p2.3.m3.1.1.3.1.cmml">→</mo><msup id="S4.SS4.p2.3.m3.1.1.3.3" xref="S4.SS4.p2.3.m3.1.1.3.3.cmml"><mi id="S4.SS4.p2.3.m3.1.1.3.3.2" xref="S4.SS4.p2.3.m3.1.1.3.3.2.cmml">ℝ</mi><mi id="S4.SS4.p2.3.m3.1.1.3.3.3" xref="S4.SS4.p2.3.m3.1.1.3.3.3.cmml">d</mi></msup></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.SS4.p2.3.m3.1b"><apply id="S4.SS4.p2.3.m3.1.1.cmml" xref="S4.SS4.p2.3.m3.1.1"><ci id="S4.SS4.p2.3.m3.1.1.1.cmml" xref="S4.SS4.p2.3.m3.1.1.1">:</ci><ci id="S4.SS4.p2.3.m3.1.1.2.cmml" xref="S4.SS4.p2.3.m3.1.1.2">𝒫</ci><apply id="S4.SS4.p2.3.m3.1.1.3.cmml" xref="S4.SS4.p2.3.m3.1.1.3"><ci id="S4.SS4.p2.3.m3.1.1.3.1.cmml" xref="S4.SS4.p2.3.m3.1.1.3.1">→</ci><apply id="S4.SS4.p2.3.m3.1.1.3.2.cmml" xref="S4.SS4.p2.3.m3.1.1.3.2"><csymbol cd="ambiguous" id="S4.SS4.p2.3.m3.1.1.3.2.1.cmml" xref="S4.SS4.p2.3.m3.1.1.3.2">superscript</csymbol><ci id="S4.SS4.p2.3.m3.1.1.3.2.2.cmml" xref="S4.SS4.p2.3.m3.1.1.3.2.2">ℝ</ci><apply id="S4.SS4.p2.3.m3.1.1.3.2.3.cmml" xref="S4.SS4.p2.3.m3.1.1.3.2.3"><csymbol cd="ambiguous" id="S4.SS4.p2.3.m3.1.1.3.2.3.1.cmml" xref="S4.SS4.p2.3.m3.1.1.3.2.3">superscript</csymbol><ci id="S4.SS4.p2.3.m3.1.1.3.2.3.2.cmml" xref="S4.SS4.p2.3.m3.1.1.3.2.3.2">𝑑</ci><ci id="S4.SS4.p2.3.m3.1.1.3.2.3.3.cmml" xref="S4.SS4.p2.3.m3.1.1.3.2.3.3">′</ci></apply></apply><apply id="S4.SS4.p2.3.m3.1.1.3.3.cmml" xref="S4.SS4.p2.3.m3.1.1.3.3"><csymbol cd="ambiguous" id="S4.SS4.p2.3.m3.1.1.3.3.1.cmml" xref="S4.SS4.p2.3.m3.1.1.3.3">superscript</csymbol><ci id="S4.SS4.p2.3.m3.1.1.3.3.2.cmml" xref="S4.SS4.p2.3.m3.1.1.3.3.2">ℝ</ci><ci id="S4.SS4.p2.3.m3.1.1.3.3.3.cmml" xref="S4.SS4.p2.3.m3.1.1.3.3.3">𝑑</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.SS4.p2.3.m3.1c">\mathcal{P}:\mathbb{R}^{d^{\prime}}\rightarrow\mathbb{R}^{d}</annotation><annotation encoding="application/x-llamapun" id="S4.SS4.p2.3.m3.1d">caligraphic_P : blackboard_R start_POSTSUPERSCRIPT italic_d start_POSTSUPERSCRIPT ′ end_POSTSUPERSCRIPT end_POSTSUPERSCRIPT → blackboard_R start_POSTSUPERSCRIPT italic_d end_POSTSUPERSCRIPT</annotation></semantics></math>, yielding:</p>
</div>
<div class="ltx_para" id="S4.SS4.p3">
<table class="ltx_equation ltx_eqn_table" id="S4.E16">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\mathbf{e}^{\text{fused}}=\text{Concat}(\mathbf{e}^{\text{text}},\mathcal{P}(%
\mathbf{e}^{\text{collab}}))" class="ltx_Math" display="block" id="S4.E16.m1.2"><semantics id="S4.E16.m1.2a"><mrow id="S4.E16.m1.2.2" xref="S4.E16.m1.2.2.cmml"><msup id="S4.E16.m1.2.2.4" xref="S4.E16.m1.2.2.4.cmml"><mi id="S4.E16.m1.2.2.4.2" xref="S4.E16.m1.2.2.4.2.cmml">𝐞</mi><mtext id="S4.E16.m1.2.2.4.3" xref="S4.E16.m1.2.2.4.3a.cmml">fused</mtext></msup><mo id="S4.E16.m1.2.2.3" xref="S4.E16.m1.2.2.3.cmml">=</mo><mrow id="S4.E16.m1.2.2.2" xref="S4.E16.m1.2.2.2.cmml"><mtext id="S4.E16.m1.2.2.2.4" xref="S4.E16.m1.2.2.2.4a.cmml">Concat</mtext><mo id="S4.E16.m1.2.2.2.3" xref="S4.E16.m1.2.2.2.3.cmml">⁢</mo><mrow id="S4.E16.m1.2.2.2.2.2" xref="S4.E16.m1.2.2.2.2.3.cmml"><mo id="S4.E16.m1.2.2.2.2.2.3" stretchy="false" xref="S4.E16.m1.2.2.2.2.3.cmml">(</mo><msup id="S4.E16.m1.1.1.1.1.1.1" xref="S4.E16.m1.1.1.1.1.1.1.cmml"><mi id="S4.E16.m1.1.1.1.1.1.1.2" xref="S4.E16.m1.1.1.1.1.1.1.2.cmml">𝐞</mi><mtext id="S4.E16.m1.1.1.1.1.1.1.3" xref="S4.E16.m1.1.1.1.1.1.1.3a.cmml">text</mtext></msup><mo id="S4.E16.m1.2.2.2.2.2.4" xref="S4.E16.m1.2.2.2.2.3.cmml">,</mo><mrow id="S4.E16.m1.2.2.2.2.2.2" xref="S4.E16.m1.2.2.2.2.2.2.cmml"><mi class="ltx_font_mathcaligraphic" id="S4.E16.m1.2.2.2.2.2.2.3" xref="S4.E16.m1.2.2.2.2.2.2.3.cmml">𝒫</mi><mo id="S4.E16.m1.2.2.2.2.2.2.2" xref="S4.E16.m1.2.2.2.2.2.2.2.cmml">⁢</mo><mrow id="S4.E16.m1.2.2.2.2.2.2.1.1" xref="S4.E16.m1.2.2.2.2.2.2.1.1.1.cmml"><mo id="S4.E16.m1.2.2.2.2.2.2.1.1.2" stretchy="false" xref="S4.E16.m1.2.2.2.2.2.2.1.1.1.cmml">(</mo><msup id="S4.E16.m1.2.2.2.2.2.2.1.1.1" xref="S4.E16.m1.2.2.2.2.2.2.1.1.1.cmml"><mi id="S4.E16.m1.2.2.2.2.2.2.1.1.1.2" xref="S4.E16.m1.2.2.2.2.2.2.1.1.1.2.cmml">𝐞</mi><mtext id="S4.E16.m1.2.2.2.2.2.2.1.1.1.3" xref="S4.E16.m1.2.2.2.2.2.2.1.1.1.3a.cmml">collab</mtext></msup><mo id="S4.E16.m1.2.2.2.2.2.2.1.1.3" stretchy="false" xref="S4.E16.m1.2.2.2.2.2.2.1.1.1.cmml">)</mo></mrow></mrow><mo id="S4.E16.m1.2.2.2.2.2.5" stretchy="false" xref="S4.E16.m1.2.2.2.2.3.cmml">)</mo></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="S4.E16.m1.2b"><apply id="S4.E16.m1.2.2.cmml" xref="S4.E16.m1.2.2"><eq id="S4.E16.m1.2.2.3.cmml" xref="S4.E16.m1.2.2.3"></eq><apply id="S4.E16.m1.2.2.4.cmml" xref="S4.E16.m1.2.2.4"><csymbol cd="ambiguous" id="S4.E16.m1.2.2.4.1.cmml" xref="S4.E16.m1.2.2.4">superscript</csymbol><ci id="S4.E16.m1.2.2.4.2.cmml" xref="S4.E16.m1.2.2.4.2">𝐞</ci><ci id="S4.E16.m1.2.2.4.3a.cmml" xref="S4.E16.m1.2.2.4.3"><mtext id="S4.E16.m1.2.2.4.3.cmml" mathsize="70%" xref="S4.E16.m1.2.2.4.3">fused</mtext></ci></apply><apply id="S4.E16.m1.2.2.2.cmml" xref="S4.E16.m1.2.2.2"><times id="S4.E16.m1.2.2.2.3.cmml" xref="S4.E16.m1.2.2.2.3"></times><ci id="S4.E16.m1.2.2.2.4a.cmml" xref="S4.E16.m1.2.2.2.4"><mtext id="S4.E16.m1.2.2.2.4.cmml" xref="S4.E16.m1.2.2.2.4">Concat</mtext></ci><interval closure="open" id="S4.E16.m1.2.2.2.2.3.cmml" xref="S4.E16.m1.2.2.2.2.2"><apply id="S4.E16.m1.1.1.1.1.1.1.cmml" xref="S4.E16.m1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="S4.E16.m1.1.1.1.1.1.1.1.cmml" xref="S4.E16.m1.1.1.1.1.1.1">superscript</csymbol><ci id="S4.E16.m1.1.1.1.1.1.1.2.cmml" xref="S4.E16.m1.1.1.1.1.1.1.2">𝐞</ci><ci id="S4.E16.m1.1.1.1.1.1.1.3a.cmml" xref="S4.E16.m1.1.1.1.1.1.1.3"><mtext id="S4.E16.m1.1.1.1.1.1.1.3.cmml" mathsize="70%" xref="S4.E16.m1.1.1.1.1.1.1.3">text</mtext></ci></apply><apply id="S4.E16.m1.2.2.2.2.2.2.cmml" xref="S4.E16.m1.2.2.2.2.2.2"><times id="S4.E16.m1.2.2.2.2.2.2.2.cmml" xref="S4.E16.m1.2.2.2.2.2.2.2"></times><ci id="S4.E16.m1.2.2.2.2.2.2.3.cmml" xref="S4.E16.m1.2.2.2.2.2.2.3">𝒫</ci><apply id="S4.E16.m1.2.2.2.2.2.2.1.1.1.cmml" xref="S4.E16.m1.2.2.2.2.2.2.1.1"><csymbol cd="ambiguous" id="S4.E16.m1.2.2.2.2.2.2.1.1.1.1.cmml" xref="S4.E16.m1.2.2.2.2.2.2.1.1">superscript</csymbol><ci id="S4.E16.m1.2.2.2.2.2.2.1.1.1.2.cmml" xref="S4.E16.m1.2.2.2.2.2.2.1.1.1.2">𝐞</ci><ci id="S4.E16.m1.2.2.2.2.2.2.1.1.1.3a.cmml" xref="S4.E16.m1.2.2.2.2.2.2.1.1.1.3"><mtext id="S4.E16.m1.2.2.2.2.2.2.1.1.1.3.cmml" mathsize="70%" xref="S4.E16.m1.2.2.2.2.2.2.1.1.1.3">collab</mtext></ci></apply></apply></interval></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="S4.E16.m1.2c">\mathbf{e}^{\text{fused}}=\text{Concat}(\mathbf{e}^{\text{text}},\mathcal{P}(%
\mathbf{e}^{\text{collab}}))</annotation><annotation encoding="application/x-llamapun" id="S4.E16.m1.2d">bold_e start_POSTSUPERSCRIPT fused end_POSTSUPERSCRIPT = Concat ( bold_e start_POSTSUPERSCRIPT text end_POSTSUPERSCRIPT , caligraphic_P ( bold_e start_POSTSUPERSCRIPT collab end_POSTSUPERSCRIPT ) )</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(16)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="S4.SS4.p3.1">This fusion enriches LLM inputs with high-level domain signals. We use four types of collaborative embeddings:
<span class="ltx_text ltx_font_bold" id="S4.SS4.p3.1.1">(1) Patient-level:</span> from RAREMed <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib5" title="">5</a>]</cite>, a pretrained model encoding clinical context via a transformer.
<span class="ltx_text ltx_font_bold" id="S4.SS4.p3.1.2">(2) Diagnosis-level</span> and <span class="ltx_text ltx_font_bold" id="S4.SS4.p3.1.3">(3) Procedure-level:</span> from MICRON <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib26" title="">26</a>]</cite>, capturing co-occurrence patterns from EHRs.
<span class="ltx_text ltx_font_bold" id="S4.SS4.p3.1.4">(4) Medication-level:</span> from Mole-BERT <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib27" title="">27</a>]</cite>, modeling drug substructure–function relationships via molecular graphs.</p>
</div>
<div class="ltx_para" id="S4.SS4.p4">
<p class="ltx_p" id="S4.SS4.p4.1">Moreover, we adopt <span class="ltx_text ltx_font_bold" id="S4.SS4.p4.1.1">Llama3.1-Aloe-Beta-8B</span> <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib13" title="">13</a>]</cite>, a medical LLM, as our backbone, enabling the fusion of structured embeddings with textual semantics. This hybrid representation not only enhances the modelto capture fine-grained clinical signals but also benefits from the comprehensive medical knowledge encoded in the LLM, together forming our multi-source knowledge fusion framework.</p>
</div>
</section>
</section>
<section class="ltx_section" id="S5">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">5 </span>Experiments</h2>
<div class="ltx_para" id="S5.p1">
<p class="ltx_p" id="S5.p1.1">We begin by detailing the experimental setup. We then evaluate FLAME against baselines across three dimensions: accuracy, safety–accuracy trade-offs, and cross-dataset generalization. Finally, an ablation study assesses the contribution of each component in our framework.</p>
</div>
<section class="ltx_subsection" id="S5.SS1">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">5.1 </span>Experimental Settings</h3>
<div class="ltx_para" id="S5.SS1.p1">
<p class="ltx_p" id="S5.SS1.p1.1"><span class="ltx_text ltx_font_bold" id="S5.SS1.p1.1.1">Datasets.</span>
We use real-world EHR datasets: MIMIC-III <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib14" title="">14</a>]</cite> for training and evaluation, and MIMIC-IV <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib15" title="">15</a>]</cite> and eICU <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib16" title="">16</a>]</cite> for generalization testing.
DDI relations are obtained from TWOSIDES <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib11" title="">11</a>]</cite>. Following prior works, MIMIC-III is split into training/validation/test sets (4:1:1).</p>
</div>
<div class="ltx_para" id="S5.SS1.p2">
<p class="ltx_p" id="S5.SS1.p2.1"><span class="ltx_text ltx_font_bold" id="S5.SS1.p2.1.1">Implementation.</span>
All methods are implemented in PyTorch and trained on NVIDIA A100 GPUs. Details on preprocessing, hyperparameters, and prompts are in Appendices <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#A2" title="Appendix B Dataset Details ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">B</span></a> and <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#A3" title="Appendix C Experimental Setup ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">C</span></a>.</p>
</div>
<div class="ltx_para" id="S5.SS1.p3">
<p class="ltx_p" id="S5.SS1.p3.1"><span class="ltx_text ltx_font_bold" id="S5.SS1.p3.1.1">Baselines.</span>
We compare FLAME with:
(1) Traditional methods: LEAP <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib6" title="">6</a>]</cite>, GAMENet <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib7" title="">7</a>]</cite>, SafeDrug <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib3" title="">3</a>]</cite>, COGNet <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib4" title="">4</a>]</cite>, MICRON <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib26" title="">26</a>]</cite>, MoleRec <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib8" title="">8</a>]</cite>, NLA-MMR <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib17" title="">17</a>]</cite>, RAREMed <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib5" title="">5</a>]</cite>;
(2) LLM-based method: LAMO <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib10" title="">10</a>]</cite>.</p>
</div>
<div class="ltx_para" id="S5.SS1.p4">
<p class="ltx_p" id="S5.SS1.p4.1"><span class="ltx_text ltx_font_bold" id="S5.SS1.p4.1.1">Metrics.</span>
Correctness is evaluated by Jaccard similarity and F1 score; safety by DDI rate.
Definitions and calculation details are in Appendix <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#A3" title="Appendix C Experimental Setup ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">C</span></a>.</p>
</div>
</section>
<section class="ltx_subsection" id="S5.SS2">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">5.2 </span>Overall Performance Comparison</h3>
<div class="ltx_para" id="S5.SS2.p1">
<p class="ltx_p" id="S5.SS2.p1.1">We evaluate FLAME from three perspectives: <span class="ltx_text ltx_font_bold" id="S5.SS2.p1.1.1">correctness</span>, <span class="ltx_text ltx_font_bold" id="S5.SS2.p1.1.2">safety controllability</span>, and <span class="ltx_text ltx_font_bold" id="S5.SS2.p1.1.3">generalizability</span>.
EHR datasets contain inherent DDI risks (e.g., 13.69% in MIMIC-III), meaning data fitting does not guarantee safe prescriptions.
Minimizing DDIs often compromises accuracy, making the correctness–safety trade-off a key metric for practical utility.</p>
</div>
<div class="ltx_para" id="S5.SS2.p2">
<p class="ltx_p" id="S5.SS2.p2.1">Unlike prior works reporting a single performance point, we explicitly decouple correctness and safety in evaluation, enabling a clearer assessment of a model’s reasoning ability and controllability under varying safety constraints.
To assess generalization, we further test on MIMIC-IV and eICU, examining performance under distribution shifts beyond the training domain.</p>
</div>
<div class="ltx_para" id="S5.SS2.p3">
<p class="ltx_p" id="S5.SS2.p3.1"><span class="ltx_text ltx_font_bold" id="S5.SS2.p3.1.1">Correctness Comparison</span>. Table <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S5.T1" title="Table 1 ‣ 5.2 Overall Performance Comparison ‣ 5 Experiments ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">1</span></a> reports correctness results on MIMIC-III.
Instance-based models (e.g., LEAP) perform poorly due to a lack of historical context modeling.
Longitudinal models like SafeDrug and GAMENet improve performance by leveraging temporal data, while MoleRec further enhances accuracy by incorporating molecular substructure information.
RAREMed achieves stronger results with transformer-based clinical representations.
The LLM-based LAMO benefits from unstructured clinical notes but lacks structured co-occurrence knowledge, limiting its potential.
Our proposed FLAME outperforms all baselines in Jaccard and F1 scores by formulating medication recommendation as a list-wise decision problem and fusing multi-source clinical knowledge.</p>
</div>
<figure class="ltx_table ltx_align_floatright" id="S5.T1">
<figcaption class="ltx_caption"><span class="ltx_tag ltx_tag_table">Table 1: </span>Correctness comparison on MIMIC-III. #Med indicates the average number of prescribed medications per patient (ground truth: 23.43).</figcaption>
<table class="ltx_tabular ltx_centering ltx_guessed_headers ltx_align_middle" id="S5.T1.1">
<thead class="ltx_thead">
<tr class="ltx_tr" id="S5.T1.1.1.1">
<th class="ltx_td ltx_align_left ltx_th ltx_th_column ltx_th_row ltx_border_r ltx_border_tt" id="S5.T1.1.1.1.1">Model</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt" id="S5.T1.1.1.1.2">Jaccard</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt" id="S5.T1.1.1.1.3">F1</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt" id="S5.T1.1.1.1.4">#Med</th>
</tr>
</thead>
<tbody class="ltx_tbody">
<tr class="ltx_tr" id="S5.T1.1.2.1">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r ltx_border_t" id="S5.T1.1.2.1.1">LEAP</th>
<td class="ltx_td ltx_align_center ltx_border_t" id="S5.T1.1.2.1.2">0.3073</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S5.T1.1.2.1.3">0.4610</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S5.T1.1.2.1.4">19.69</td>
</tr>
<tr class="ltx_tr" id="S5.T1.1.3.2">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="S5.T1.1.3.2.1">SafeDrug</th>
<td class="ltx_td ltx_align_center" id="S5.T1.1.3.2.2">0.3556</td>
<td class="ltx_td ltx_align_center" id="S5.T1.1.3.2.3">0.5135</td>
<td class="ltx_td ltx_align_center" id="S5.T1.1.3.2.4">22.94</td>
</tr>
<tr class="ltx_tr" id="S5.T1.1.4.3">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="S5.T1.1.4.3.1">GAMENet</th>
<td class="ltx_td ltx_align_center" id="S5.T1.1.4.3.2">0.3851</td>
<td class="ltx_td ltx_align_center" id="S5.T1.1.4.3.3">0.5422</td>
<td class="ltx_td ltx_align_center" id="S5.T1.1.4.3.4">20.02</td>
</tr>
<tr class="ltx_tr" id="S5.T1.1.5.4">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="S5.T1.1.5.4.1">COGNet</th>
<td class="ltx_td ltx_align_center" id="S5.T1.1.5.4.2">0.3876</td>
<td class="ltx_td ltx_align_center" id="S5.T1.1.5.4.3">0.5458</td>
<td class="ltx_td ltx_align_center" id="S5.T1.1.5.4.4">28.45</td>
</tr>
<tr class="ltx_tr" id="S5.T1.1.6.5">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="S5.T1.1.6.5.1">MICRON</th>
<td class="ltx_td ltx_align_center" id="S5.T1.1.6.5.2">0.3843</td>
<td class="ltx_td ltx_align_center" id="S5.T1.1.6.5.3">0.5419</td>
<td class="ltx_td ltx_align_center" id="S5.T1.1.6.5.4">20.49</td>
</tr>
<tr class="ltx_tr" id="S5.T1.1.7.6">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="S5.T1.1.7.6.1">NLA-MMR</th>
<td class="ltx_td ltx_align_center" id="S5.T1.1.7.6.2">0.3867</td>
<td class="ltx_td ltx_align_center" id="S5.T1.1.7.6.3">0.5453</td>
<td class="ltx_td ltx_align_center" id="S5.T1.1.7.6.4">25.54</td>
</tr>
<tr class="ltx_tr" id="S5.T1.1.8.7">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="S5.T1.1.8.7.1">MoleRec</th>
<td class="ltx_td ltx_align_center" id="S5.T1.1.8.7.2">0.4081</td>
<td class="ltx_td ltx_align_center" id="S5.T1.1.8.7.3">0.5677</td>
<td class="ltx_td ltx_align_center" id="S5.T1.1.8.7.4">24.73</td>
</tr>
<tr class="ltx_tr" id="S5.T1.1.9.8">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="S5.T1.1.9.8.1">RAREMed</th>
<td class="ltx_td ltx_align_center" id="S5.T1.1.9.8.2">0.4174</td>
<td class="ltx_td ltx_align_center" id="S5.T1.1.9.8.3">0.5776</td>
<td class="ltx_td ltx_align_center" id="S5.T1.1.9.8.4">23.03</td>
</tr>
<tr class="ltx_tr" id="S5.T1.1.10.9">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="S5.T1.1.10.9.1">LAMO</th>
<td class="ltx_td ltx_align_center" id="S5.T1.1.10.9.2">0.4701</td>
<td class="ltx_td ltx_align_center" id="S5.T1.1.10.9.3">0.6294</td>
<td class="ltx_td ltx_align_center" id="S5.T1.1.10.9.4">23.66</td>
</tr>
<tr class="ltx_tr" id="S5.T1.1.11.10">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_bb ltx_border_r ltx_border_t" id="S5.T1.1.11.10.1"><span class="ltx_text ltx_font_bold" id="S5.T1.1.11.10.1.1">FLAME</span></th>
<td class="ltx_td ltx_align_center ltx_border_bb ltx_border_t" id="S5.T1.1.11.10.2"><span class="ltx_text ltx_font_bold" id="S5.T1.1.11.10.2.1">0.4836</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb ltx_border_t" id="S5.T1.1.11.10.3"><span class="ltx_text ltx_font_bold" id="S5.T1.1.11.10.3.1">0.6408</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb ltx_border_t" id="S5.T1.1.11.10.4">22.24</td>
</tr>
</tbody>
</table>
</figure>
<div class="ltx_para" id="S5.SS2.p4">
<p class="ltx_p" id="S5.SS2.p4.1"><span class="ltx_text ltx_font_bold" id="S5.SS2.p4.1.1">Safety Control Comparison</span>.
We evaluate controllable safety by adjusting the penalty parameter <math alttext="\alpha" class="ltx_Math" display="inline" id="S5.SS2.p4.1.m1.1"><semantics id="S5.SS2.p4.1.m1.1a"><mi id="S5.SS2.p4.1.m1.1.1" xref="S5.SS2.p4.1.m1.1.1.cmml">α</mi><annotation-xml encoding="MathML-Content" id="S5.SS2.p4.1.m1.1b"><ci id="S5.SS2.p4.1.m1.1.1.cmml" xref="S5.SS2.p4.1.m1.1.1">𝛼</ci></annotation-xml><annotation encoding="application/x-tex" id="S5.SS2.p4.1.m1.1c">\alpha</annotation><annotation encoding="application/x-llamapun" id="S5.SS2.p4.1.m1.1d">italic_α</annotation></semantics></math> in Eq. <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S4.E8" title="In 4.2 Fine-grained Alignment for Medication Recommendation ‣ 4 Method: FLAME ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">8</span></a>, generating recommendations under varying DDI constraints.
Fig. <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S5.F5" title="Figure 5 ‣ 5.2 Overall Performance Comparison ‣ 5 Experiments ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">5</span></a>(a) shows Jaccard–DDI trade-off curves.
Among models supporting safety control, FLAME consistently achieves better accuracy–safety balance than baselines.
Notably, methods like LAMO are excluded as they lack safety adjustment mechanisms.
These results validate the effectiveness of step-wise GRPO in enabling controllable, clinically safer recommendations.</p>
</div>
<div class="ltx_para" id="S5.SS2.p5">
<p class="ltx_p" id="S5.SS2.p5.1"><span class="ltx_text ltx_font_bold" id="S5.SS2.p5.1.1">Generalization Comparison</span>.
We assess generalization through temporal and external validations.
For temporal validation, models trained on MIMIC-III are evaluated on MIMIC-IV, which covers newer time periods and ICD-10 codes.
Fig. <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S5.F5" title="Figure 5 ‣ 5.2 Overall Performance Comparison ‣ 5 Experiments ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">5</span></a>(b) shows that LLM-based models (FLAME, LAMO) degrade less over time compared to structured-data baselines, highlighting the robustness of language-based representations to coding shifts.
FLAME further surpasses LAMO due to its integration of multi-source knowledge and step-wise reasoning.</p>
</div>
<div class="ltx_para" id="S5.SS2.p6">
<p class="ltx_p" id="S5.SS2.p6.1">For external validation, we evaluate on eICU, a multi-center dataset with distributional and coding differences.
As shown in Fig. <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S5.F5" title="Figure 5 ‣ 5.2 Overall Performance Comparison ‣ 5 Experiments ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">5</span></a>(c), LLM-based methods again outperform structured-input baselines.
FLAME achieves superior out-of-distribution performance, demonstrating the advantage of combining list-wise decision modeling with collaborative knowledge fusion.</p>
</div>
<figure class="ltx_figure" id="S5.F5"><img alt="Refer to caption" class="ltx_graphics ltx_centering ltx_img_landscape" height="199" id="S5.F5.g1" src="x5.png" width="830"/>
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_figure">Figure 5: </span>Comparison with strong baselines.
(a) Safety–accuracy trade-off on MIMIC-III.
(b) Temporal generalization from MIMIC-III to MIMIC-IV.
(c) External generalization to eICU.
</figcaption>
</figure>
<figure class="ltx_figure" id="S5.SS2.8">
<div class="ltx_flex_figure">
<div class="ltx_flex_cell ltx_flex_size_2">
<figure class="ltx_figure ltx_figure_panel ltx_minipage ltx_align_middle" id="S5.SS2.7.7" style="width:238.5pt;">
<div class="ltx_flex_figure">
<div class="ltx_flex_cell ltx_flex_size_2">
<figure class="ltx_table ltx_figure_panel" id="S5.T2">
<figcaption class="ltx_caption"><span class="ltx_tag ltx_tag_table">Table 2: </span>Ablation study. “w/o” denotes “without”.</figcaption>
</figure>
</div>
<div class="ltx_flex_cell ltx_flex_size_2">
<table class="ltx_tabular ltx_centering ltx_figure_panel ltx_guessed_headers ltx_align_middle" id="S5.SS2.7.7.7">
<tbody class="ltx_tbody">
<tr class="ltx_tr" id="S5.SS2.7.7.7.8.1">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r ltx_border_tt" id="S5.SS2.7.7.7.8.1.1">Model Variants</th>
<td class="ltx_td ltx_align_center ltx_border_tt" id="S5.SS2.7.7.7.8.1.2">Jaccard</td>
<td class="ltx_td ltx_align_center ltx_border_tt" id="S5.SS2.7.7.7.8.1.3">F1</td>
</tr>
<tr class="ltx_tr" id="S5.SS2.1.1.1.1">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r ltx_border_t" id="S5.SS2.1.1.1.1.1">(a) w/o <math alttext="\pi_{\text{cls}}" class="ltx_Math" display="inline" id="S5.SS2.1.1.1.1.1.m1.1"><semantics id="S5.SS2.1.1.1.1.1.m1.1a"><msub id="S5.SS2.1.1.1.1.1.m1.1.1" xref="S5.SS2.1.1.1.1.1.m1.1.1.cmml"><mi id="S5.SS2.1.1.1.1.1.m1.1.1.2" xref="S5.SS2.1.1.1.1.1.m1.1.1.2.cmml">π</mi><mtext id="S5.SS2.1.1.1.1.1.m1.1.1.3" xref="S5.SS2.1.1.1.1.1.m1.1.1.3a.cmml">cls</mtext></msub><annotation-xml encoding="MathML-Content" id="S5.SS2.1.1.1.1.1.m1.1b"><apply id="S5.SS2.1.1.1.1.1.m1.1.1.cmml" xref="S5.SS2.1.1.1.1.1.m1.1.1"><csymbol cd="ambiguous" id="S5.SS2.1.1.1.1.1.m1.1.1.1.cmml" xref="S5.SS2.1.1.1.1.1.m1.1.1">subscript</csymbol><ci id="S5.SS2.1.1.1.1.1.m1.1.1.2.cmml" xref="S5.SS2.1.1.1.1.1.m1.1.1.2">𝜋</ci><ci id="S5.SS2.1.1.1.1.1.m1.1.1.3a.cmml" xref="S5.SS2.1.1.1.1.1.m1.1.1.3"><mtext id="S5.SS2.1.1.1.1.1.m1.1.1.3.cmml" mathsize="70%" xref="S5.SS2.1.1.1.1.1.m1.1.1.3">cls</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.SS2.1.1.1.1.1.m1.1c">\pi_{\text{cls}}</annotation><annotation encoding="application/x-llamapun" id="S5.SS2.1.1.1.1.1.m1.1d">italic_π start_POSTSUBSCRIPT cls end_POSTSUBSCRIPT</annotation></semantics></math>
</th>
<td class="ltx_td ltx_align_center ltx_border_t" id="S5.SS2.1.1.1.1.2">0.3473</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S5.SS2.1.1.1.1.3">0.5024</td>
</tr>
<tr class="ltx_tr" id="S5.SS2.2.2.2.2">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="S5.SS2.2.2.2.2.1">(b) w/o <math alttext="\pi_{\text{list}}" class="ltx_Math" display="inline" id="S5.SS2.2.2.2.2.1.m1.1"><semantics id="S5.SS2.2.2.2.2.1.m1.1a"><msub id="S5.SS2.2.2.2.2.1.m1.1.1" xref="S5.SS2.2.2.2.2.1.m1.1.1.cmml"><mi id="S5.SS2.2.2.2.2.1.m1.1.1.2" xref="S5.SS2.2.2.2.2.1.m1.1.1.2.cmml">π</mi><mtext id="S5.SS2.2.2.2.2.1.m1.1.1.3" xref="S5.SS2.2.2.2.2.1.m1.1.1.3a.cmml">list</mtext></msub><annotation-xml encoding="MathML-Content" id="S5.SS2.2.2.2.2.1.m1.1b"><apply id="S5.SS2.2.2.2.2.1.m1.1.1.cmml" xref="S5.SS2.2.2.2.2.1.m1.1.1"><csymbol cd="ambiguous" id="S5.SS2.2.2.2.2.1.m1.1.1.1.cmml" xref="S5.SS2.2.2.2.2.1.m1.1.1">subscript</csymbol><ci id="S5.SS2.2.2.2.2.1.m1.1.1.2.cmml" xref="S5.SS2.2.2.2.2.1.m1.1.1.2">𝜋</ci><ci id="S5.SS2.2.2.2.2.1.m1.1.1.3a.cmml" xref="S5.SS2.2.2.2.2.1.m1.1.1.3"><mtext id="S5.SS2.2.2.2.2.1.m1.1.1.3.cmml" mathsize="70%" xref="S5.SS2.2.2.2.2.1.m1.1.1.3">list</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.SS2.2.2.2.2.1.m1.1c">\pi_{\text{list}}</annotation><annotation encoding="application/x-llamapun" id="S5.SS2.2.2.2.2.1.m1.1d">italic_π start_POSTSUBSCRIPT list end_POSTSUBSCRIPT</annotation></semantics></math>
</th>
<td class="ltx_td ltx_align_center" id="S5.SS2.2.2.2.2.2">0.4785</td>
<td class="ltx_td ltx_align_center" id="S5.SS2.2.2.2.2.3">0.6354</td>
</tr>
<tr class="ltx_tr" id="S5.SS2.3.3.3.3">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r ltx_border_t" id="S5.SS2.3.3.3.3.1">(c) w/o SFT in <math alttext="\pi_{\text{list}}" class="ltx_Math" display="inline" id="S5.SS2.3.3.3.3.1.m1.1"><semantics id="S5.SS2.3.3.3.3.1.m1.1a"><msub id="S5.SS2.3.3.3.3.1.m1.1.1" xref="S5.SS2.3.3.3.3.1.m1.1.1.cmml"><mi id="S5.SS2.3.3.3.3.1.m1.1.1.2" xref="S5.SS2.3.3.3.3.1.m1.1.1.2.cmml">π</mi><mtext id="S5.SS2.3.3.3.3.1.m1.1.1.3" xref="S5.SS2.3.3.3.3.1.m1.1.1.3a.cmml">list</mtext></msub><annotation-xml encoding="MathML-Content" id="S5.SS2.3.3.3.3.1.m1.1b"><apply id="S5.SS2.3.3.3.3.1.m1.1.1.cmml" xref="S5.SS2.3.3.3.3.1.m1.1.1"><csymbol cd="ambiguous" id="S5.SS2.3.3.3.3.1.m1.1.1.1.cmml" xref="S5.SS2.3.3.3.3.1.m1.1.1">subscript</csymbol><ci id="S5.SS2.3.3.3.3.1.m1.1.1.2.cmml" xref="S5.SS2.3.3.3.3.1.m1.1.1.2">𝜋</ci><ci id="S5.SS2.3.3.3.3.1.m1.1.1.3a.cmml" xref="S5.SS2.3.3.3.3.1.m1.1.1.3"><mtext id="S5.SS2.3.3.3.3.1.m1.1.1.3.cmml" mathsize="70%" xref="S5.SS2.3.3.3.3.1.m1.1.1.3">list</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.SS2.3.3.3.3.1.m1.1c">\pi_{\text{list}}</annotation><annotation encoding="application/x-llamapun" id="S5.SS2.3.3.3.3.1.m1.1d">italic_π start_POSTSUBSCRIPT list end_POSTSUBSCRIPT</annotation></semantics></math>
</th>
<td class="ltx_td ltx_align_center ltx_border_t" id="S5.SS2.3.3.3.3.2">0.4810</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S5.SS2.3.3.3.3.3">0.6382</td>
</tr>
<tr class="ltx_tr" id="S5.SS2.4.4.4.4">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="S5.SS2.4.4.4.4.1">(d) w/o step-wise GRPO in <math alttext="\pi_{\text{list}}" class="ltx_Math" display="inline" id="S5.SS2.4.4.4.4.1.m1.1"><semantics id="S5.SS2.4.4.4.4.1.m1.1a"><msub id="S5.SS2.4.4.4.4.1.m1.1.1" xref="S5.SS2.4.4.4.4.1.m1.1.1.cmml"><mi id="S5.SS2.4.4.4.4.1.m1.1.1.2" xref="S5.SS2.4.4.4.4.1.m1.1.1.2.cmml">π</mi><mtext id="S5.SS2.4.4.4.4.1.m1.1.1.3" xref="S5.SS2.4.4.4.4.1.m1.1.1.3a.cmml">list</mtext></msub><annotation-xml encoding="MathML-Content" id="S5.SS2.4.4.4.4.1.m1.1b"><apply id="S5.SS2.4.4.4.4.1.m1.1.1.cmml" xref="S5.SS2.4.4.4.4.1.m1.1.1"><csymbol cd="ambiguous" id="S5.SS2.4.4.4.4.1.m1.1.1.1.cmml" xref="S5.SS2.4.4.4.4.1.m1.1.1">subscript</csymbol><ci id="S5.SS2.4.4.4.4.1.m1.1.1.2.cmml" xref="S5.SS2.4.4.4.4.1.m1.1.1.2">𝜋</ci><ci id="S5.SS2.4.4.4.4.1.m1.1.1.3a.cmml" xref="S5.SS2.4.4.4.4.1.m1.1.1.3"><mtext id="S5.SS2.4.4.4.4.1.m1.1.1.3.cmml" mathsize="70%" xref="S5.SS2.4.4.4.4.1.m1.1.1.3">list</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.SS2.4.4.4.4.1.m1.1c">\pi_{\text{list}}</annotation><annotation encoding="application/x-llamapun" id="S5.SS2.4.4.4.4.1.m1.1d">italic_π start_POSTSUBSCRIPT list end_POSTSUBSCRIPT</annotation></semantics></math>
</th>
<td class="ltx_td ltx_align_center" id="S5.SS2.4.4.4.4.2">0.4789</td>
<td class="ltx_td ltx_align_center" id="S5.SS2.4.4.4.4.3">0.6367</td>
</tr>
<tr class="ltx_tr" id="S5.SS2.7.7.7.9.2">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r ltx_border_t" id="S5.SS2.7.7.7.9.2.1">(e) with standard GRPO</th>
<td class="ltx_td ltx_align_center ltx_border_t" id="S5.SS2.7.7.7.9.2.2">0.4813</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S5.SS2.7.7.7.9.2.3">0.6385</td>
</tr>
<tr class="ltx_tr" id="S5.SS2.7.7.7.10.3">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r ltx_border_t" id="S5.SS2.7.7.7.10.3.1">(f) w/o structured codes</th>
<td class="ltx_td ltx_align_center ltx_border_t" id="S5.SS2.7.7.7.10.3.2">0.4535</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S5.SS2.7.7.7.10.3.3">0.6122</td>
</tr>
<tr class="ltx_tr" id="S5.SS2.7.7.7.11.4">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="S5.SS2.7.7.7.11.4.1">(g) w/o unstructured notes</th>
<td class="ltx_td ltx_align_center" id="S5.SS2.7.7.7.11.4.2">0.4104</td>
<td class="ltx_td ltx_align_center" id="S5.SS2.7.7.7.11.4.3">0.5692</td>
</tr>
<tr class="ltx_tr" id="S5.SS2.5.5.5.5">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r ltx_border_t" id="S5.SS2.5.5.5.5.1">(h) w/o <math alttext="\mathbf{e}^{\text{text}}" class="ltx_Math" display="inline" id="S5.SS2.5.5.5.5.1.m1.1"><semantics id="S5.SS2.5.5.5.5.1.m1.1a"><msup id="S5.SS2.5.5.5.5.1.m1.1.1" xref="S5.SS2.5.5.5.5.1.m1.1.1.cmml"><mi id="S5.SS2.5.5.5.5.1.m1.1.1.2" xref="S5.SS2.5.5.5.5.1.m1.1.1.2.cmml">𝐞</mi><mtext id="S5.SS2.5.5.5.5.1.m1.1.1.3" xref="S5.SS2.5.5.5.5.1.m1.1.1.3a.cmml">text</mtext></msup><annotation-xml encoding="MathML-Content" id="S5.SS2.5.5.5.5.1.m1.1b"><apply id="S5.SS2.5.5.5.5.1.m1.1.1.cmml" xref="S5.SS2.5.5.5.5.1.m1.1.1"><csymbol cd="ambiguous" id="S5.SS2.5.5.5.5.1.m1.1.1.1.cmml" xref="S5.SS2.5.5.5.5.1.m1.1.1">superscript</csymbol><ci id="S5.SS2.5.5.5.5.1.m1.1.1.2.cmml" xref="S5.SS2.5.5.5.5.1.m1.1.1.2">𝐞</ci><ci id="S5.SS2.5.5.5.5.1.m1.1.1.3a.cmml" xref="S5.SS2.5.5.5.5.1.m1.1.1.3"><mtext id="S5.SS2.5.5.5.5.1.m1.1.1.3.cmml" mathsize="70%" xref="S5.SS2.5.5.5.5.1.m1.1.1.3">text</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.SS2.5.5.5.5.1.m1.1c">\mathbf{e}^{\text{text}}</annotation><annotation encoding="application/x-llamapun" id="S5.SS2.5.5.5.5.1.m1.1d">bold_e start_POSTSUPERSCRIPT text end_POSTSUPERSCRIPT</annotation></semantics></math>
</th>
<td class="ltx_td ltx_align_center ltx_border_t" id="S5.SS2.5.5.5.5.2">0.3930</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S5.SS2.5.5.5.5.3">0.5509</td>
</tr>
<tr class="ltx_tr" id="S5.SS2.6.6.6.6">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="S5.SS2.6.6.6.6.1">(i) w/o <math alttext="{\tilde{\mathbf{e}}^{\text{collab}}}" class="ltx_Math" display="inline" id="S5.SS2.6.6.6.6.1.m1.1"><semantics id="S5.SS2.6.6.6.6.1.m1.1a"><msup id="S5.SS2.6.6.6.6.1.m1.1.1" xref="S5.SS2.6.6.6.6.1.m1.1.1.cmml"><mover accent="true" id="S5.SS2.6.6.6.6.1.m1.1.1.2" xref="S5.SS2.6.6.6.6.1.m1.1.1.2.cmml"><mi id="S5.SS2.6.6.6.6.1.m1.1.1.2.2" xref="S5.SS2.6.6.6.6.1.m1.1.1.2.2.cmml">𝐞</mi><mo id="S5.SS2.6.6.6.6.1.m1.1.1.2.1" xref="S5.SS2.6.6.6.6.1.m1.1.1.2.1.cmml">~</mo></mover><mtext id="S5.SS2.6.6.6.6.1.m1.1.1.3" xref="S5.SS2.6.6.6.6.1.m1.1.1.3a.cmml">collab</mtext></msup><annotation-xml encoding="MathML-Content" id="S5.SS2.6.6.6.6.1.m1.1b"><apply id="S5.SS2.6.6.6.6.1.m1.1.1.cmml" xref="S5.SS2.6.6.6.6.1.m1.1.1"><csymbol cd="ambiguous" id="S5.SS2.6.6.6.6.1.m1.1.1.1.cmml" xref="S5.SS2.6.6.6.6.1.m1.1.1">superscript</csymbol><apply id="S5.SS2.6.6.6.6.1.m1.1.1.2.cmml" xref="S5.SS2.6.6.6.6.1.m1.1.1.2"><ci id="S5.SS2.6.6.6.6.1.m1.1.1.2.1.cmml" xref="S5.SS2.6.6.6.6.1.m1.1.1.2.1">~</ci><ci id="S5.SS2.6.6.6.6.1.m1.1.1.2.2.cmml" xref="S5.SS2.6.6.6.6.1.m1.1.1.2.2">𝐞</ci></apply><ci id="S5.SS2.6.6.6.6.1.m1.1.1.3a.cmml" xref="S5.SS2.6.6.6.6.1.m1.1.1.3"><mtext id="S5.SS2.6.6.6.6.1.m1.1.1.3.cmml" mathsize="70%" xref="S5.SS2.6.6.6.6.1.m1.1.1.3">collab</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.SS2.6.6.6.6.1.m1.1c">{\tilde{\mathbf{e}}^{\text{collab}}}</annotation><annotation encoding="application/x-llamapun" id="S5.SS2.6.6.6.6.1.m1.1d">over~ start_ARG bold_e end_ARG start_POSTSUPERSCRIPT collab end_POSTSUPERSCRIPT</annotation></semantics></math>
</th>
<td class="ltx_td ltx_align_center" id="S5.SS2.6.6.6.6.2">0.4448</td>
<td class="ltx_td ltx_align_center" id="S5.SS2.6.6.6.6.3">0.6080</td>
</tr>
<tr class="ltx_tr" id="S5.SS2.7.7.7.7">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="S5.SS2.7.7.7.7.1">(j) with <math alttext="\tilde{\mathbf{e}}^{\text{collab}}_{\text{rand}}" class="ltx_Math" display="inline" id="S5.SS2.7.7.7.7.1.m1.1"><semantics id="S5.SS2.7.7.7.7.1.m1.1a"><msubsup id="S5.SS2.7.7.7.7.1.m1.1.1" xref="S5.SS2.7.7.7.7.1.m1.1.1.cmml"><mover accent="true" id="S5.SS2.7.7.7.7.1.m1.1.1.2.2" xref="S5.SS2.7.7.7.7.1.m1.1.1.2.2.cmml"><mi id="S5.SS2.7.7.7.7.1.m1.1.1.2.2.2" xref="S5.SS2.7.7.7.7.1.m1.1.1.2.2.2.cmml">𝐞</mi><mo id="S5.SS2.7.7.7.7.1.m1.1.1.2.2.1" xref="S5.SS2.7.7.7.7.1.m1.1.1.2.2.1.cmml">~</mo></mover><mtext id="S5.SS2.7.7.7.7.1.m1.1.1.3" xref="S5.SS2.7.7.7.7.1.m1.1.1.3a.cmml">rand</mtext><mtext id="S5.SS2.7.7.7.7.1.m1.1.1.2.3" xref="S5.SS2.7.7.7.7.1.m1.1.1.2.3a.cmml">collab</mtext></msubsup><annotation-xml encoding="MathML-Content" id="S5.SS2.7.7.7.7.1.m1.1b"><apply id="S5.SS2.7.7.7.7.1.m1.1.1.cmml" xref="S5.SS2.7.7.7.7.1.m1.1.1"><csymbol cd="ambiguous" id="S5.SS2.7.7.7.7.1.m1.1.1.1.cmml" xref="S5.SS2.7.7.7.7.1.m1.1.1">subscript</csymbol><apply id="S5.SS2.7.7.7.7.1.m1.1.1.2.cmml" xref="S5.SS2.7.7.7.7.1.m1.1.1"><csymbol cd="ambiguous" id="S5.SS2.7.7.7.7.1.m1.1.1.2.1.cmml" xref="S5.SS2.7.7.7.7.1.m1.1.1">superscript</csymbol><apply id="S5.SS2.7.7.7.7.1.m1.1.1.2.2.cmml" xref="S5.SS2.7.7.7.7.1.m1.1.1.2.2"><ci id="S5.SS2.7.7.7.7.1.m1.1.1.2.2.1.cmml" xref="S5.SS2.7.7.7.7.1.m1.1.1.2.2.1">~</ci><ci id="S5.SS2.7.7.7.7.1.m1.1.1.2.2.2.cmml" xref="S5.SS2.7.7.7.7.1.m1.1.1.2.2.2">𝐞</ci></apply><ci id="S5.SS2.7.7.7.7.1.m1.1.1.2.3a.cmml" xref="S5.SS2.7.7.7.7.1.m1.1.1.2.3"><mtext id="S5.SS2.7.7.7.7.1.m1.1.1.2.3.cmml" mathsize="70%" xref="S5.SS2.7.7.7.7.1.m1.1.1.2.3">collab</mtext></ci></apply><ci id="S5.SS2.7.7.7.7.1.m1.1.1.3a.cmml" xref="S5.SS2.7.7.7.7.1.m1.1.1.3"><mtext id="S5.SS2.7.7.7.7.1.m1.1.1.3.cmml" mathsize="70%" xref="S5.SS2.7.7.7.7.1.m1.1.1.3">rand</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.SS2.7.7.7.7.1.m1.1c">\tilde{\mathbf{e}}^{\text{collab}}_{\text{rand}}</annotation><annotation encoding="application/x-llamapun" id="S5.SS2.7.7.7.7.1.m1.1d">over~ start_ARG bold_e end_ARG start_POSTSUPERSCRIPT collab end_POSTSUPERSCRIPT start_POSTSUBSCRIPT rand end_POSTSUBSCRIPT</annotation></semantics></math>
</th>
<td class="ltx_td ltx_align_center" id="S5.SS2.7.7.7.7.2">0.4653</td>
<td class="ltx_td ltx_align_center" id="S5.SS2.7.7.7.7.3">0.6231</td>
</tr>
<tr class="ltx_tr" id="S5.SS2.7.7.7.12.5">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r ltx_border_t" id="S5.SS2.7.7.7.12.5.1">(k) FLAME-LLaMA2</th>
<td class="ltx_td ltx_align_center ltx_border_t" id="S5.SS2.7.7.7.12.5.2">0.4591</td>
<td class="ltx_td ltx_align_center ltx_border_t" id="S5.SS2.7.7.7.12.5.3">0.6168</td>
</tr>
<tr class="ltx_tr" id="S5.SS2.7.7.7.13.6">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="S5.SS2.7.7.7.13.6.1">(l) FLAME-LLaMA3</th>
<td class="ltx_td ltx_align_center" id="S5.SS2.7.7.7.13.6.2">0.4774</td>
<td class="ltx_td ltx_align_center" id="S5.SS2.7.7.7.13.6.3">0.6344</td>
</tr>
<tr class="ltx_tr" id="S5.SS2.7.7.7.14.7">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_bb ltx_border_r ltx_border_t" id="S5.SS2.7.7.7.14.7.1"><span class="ltx_text ltx_font_bold" id="S5.SS2.7.7.7.14.7.1.1">FLAME</span></th>
<td class="ltx_td ltx_align_center ltx_border_bb ltx_border_t" id="S5.SS2.7.7.7.14.7.2"><span class="ltx_text ltx_font_bold" id="S5.SS2.7.7.7.14.7.2.1">0.4836</span></td>
<td class="ltx_td ltx_align_center ltx_border_bb ltx_border_t" id="S5.SS2.7.7.7.14.7.3"><span class="ltx_text ltx_font_bold" id="S5.SS2.7.7.7.14.7.3.1">0.6408</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
<div class="ltx_flex_cell ltx_flex_size_2">
<figure class="ltx_figure ltx_figure_panel ltx_align_center ltx_align_middle" id="S5.F6" style="width:164.8pt;"><img alt="Refer to caption" class="ltx_graphics ltx_figure_panel ltx_img_portrait" height="1096" id="S5.SS2.8.8.g1" src="x6.png" width="830"/>
<br class="ltx_break ltx_break"/>
<figcaption class="ltx_caption"><span class="ltx_tag ltx_tag_figure">Figure 6: </span>Training curves of GRPO and step-wise GRPO.</figcaption>
</figure>
</div>
</div>
</figure>
</section>
<section class="ltx_subsection" id="S5.SS3">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">5.3 </span>Ablation Study</h3>
<div class="ltx_para" id="S5.SS3.p1">
<p class="ltx_p" id="S5.SS3.p1.1">We conduct ablations to assess the impact of each component in FLAME, including the list-wise decision model, step-wise GRPO, and multi-source knowledge fusion.</p>
</div>
<div class="ltx_para" id="S5.SS3.p2">
<p class="ltx_p" id="S5.SS3.p2.4"><span class="ltx_text ltx_font_bold" id="S5.SS3.p2.4.1">List-wise Decision Model.</span>
We first examine the roles of <math alttext="\pi_{\text{cls}}" class="ltx_Math" display="inline" id="S5.SS3.p2.1.m1.1"><semantics id="S5.SS3.p2.1.m1.1a"><msub id="S5.SS3.p2.1.m1.1.1" xref="S5.SS3.p2.1.m1.1.1.cmml"><mi id="S5.SS3.p2.1.m1.1.1.2" xref="S5.SS3.p2.1.m1.1.1.2.cmml">π</mi><mtext id="S5.SS3.p2.1.m1.1.1.3" xref="S5.SS3.p2.1.m1.1.1.3a.cmml">cls</mtext></msub><annotation-xml encoding="MathML-Content" id="S5.SS3.p2.1.m1.1b"><apply id="S5.SS3.p2.1.m1.1.1.cmml" xref="S5.SS3.p2.1.m1.1.1"><csymbol cd="ambiguous" id="S5.SS3.p2.1.m1.1.1.1.cmml" xref="S5.SS3.p2.1.m1.1.1">subscript</csymbol><ci id="S5.SS3.p2.1.m1.1.1.2.cmml" xref="S5.SS3.p2.1.m1.1.1.2">𝜋</ci><ci id="S5.SS3.p2.1.m1.1.1.3a.cmml" xref="S5.SS3.p2.1.m1.1.1.3"><mtext id="S5.SS3.p2.1.m1.1.1.3.cmml" mathsize="70%" xref="S5.SS3.p2.1.m1.1.1.3">cls</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.SS3.p2.1.m1.1c">\pi_{\text{cls}}</annotation><annotation encoding="application/x-llamapun" id="S5.SS3.p2.1.m1.1d">italic_π start_POSTSUBSCRIPT cls end_POSTSUBSCRIPT</annotation></semantics></math> and <math alttext="\pi_{\text{list}}" class="ltx_Math" display="inline" id="S5.SS3.p2.2.m2.1"><semantics id="S5.SS3.p2.2.m2.1a"><msub id="S5.SS3.p2.2.m2.1.1" xref="S5.SS3.p2.2.m2.1.1.cmml"><mi id="S5.SS3.p2.2.m2.1.1.2" xref="S5.SS3.p2.2.m2.1.1.2.cmml">π</mi><mtext id="S5.SS3.p2.2.m2.1.1.3" xref="S5.SS3.p2.2.m2.1.1.3a.cmml">list</mtext></msub><annotation-xml encoding="MathML-Content" id="S5.SS3.p2.2.m2.1b"><apply id="S5.SS3.p2.2.m2.1.1.cmml" xref="S5.SS3.p2.2.m2.1.1"><csymbol cd="ambiguous" id="S5.SS3.p2.2.m2.1.1.1.cmml" xref="S5.SS3.p2.2.m2.1.1">subscript</csymbol><ci id="S5.SS3.p2.2.m2.1.1.2.cmml" xref="S5.SS3.p2.2.m2.1.1.2">𝜋</ci><ci id="S5.SS3.p2.2.m2.1.1.3a.cmml" xref="S5.SS3.p2.2.m2.1.1.3"><mtext id="S5.SS3.p2.2.m2.1.1.3.cmml" mathsize="70%" xref="S5.SS3.p2.2.m2.1.1.3">list</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.SS3.p2.2.m2.1c">\pi_{\text{list}}</annotation><annotation encoding="application/x-llamapun" id="S5.SS3.p2.2.m2.1d">italic_π start_POSTSUBSCRIPT list end_POSTSUBSCRIPT</annotation></semantics></math>.
Table <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S5.T2" title="Table 2 ‣ 5.2 Overall Performance Comparison ‣ 5 Experiments ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">2</span></a> (a)-(b) shows that removing <math alttext="\pi_{\text{cls}}" class="ltx_Math" display="inline" id="S5.SS3.p2.3.m3.1"><semantics id="S5.SS3.p2.3.m3.1a"><msub id="S5.SS3.p2.3.m3.1.1" xref="S5.SS3.p2.3.m3.1.1.cmml"><mi id="S5.SS3.p2.3.m3.1.1.2" xref="S5.SS3.p2.3.m3.1.1.2.cmml">π</mi><mtext id="S5.SS3.p2.3.m3.1.1.3" xref="S5.SS3.p2.3.m3.1.1.3a.cmml">cls</mtext></msub><annotation-xml encoding="MathML-Content" id="S5.SS3.p2.3.m3.1b"><apply id="S5.SS3.p2.3.m3.1.1.cmml" xref="S5.SS3.p2.3.m3.1.1"><csymbol cd="ambiguous" id="S5.SS3.p2.3.m3.1.1.1.cmml" xref="S5.SS3.p2.3.m3.1.1">subscript</csymbol><ci id="S5.SS3.p2.3.m3.1.1.2.cmml" xref="S5.SS3.p2.3.m3.1.1.2">𝜋</ci><ci id="S5.SS3.p2.3.m3.1.1.3a.cmml" xref="S5.SS3.p2.3.m3.1.1.3"><mtext id="S5.SS3.p2.3.m3.1.1.3.cmml" mathsize="70%" xref="S5.SS3.p2.3.m3.1.1.3">cls</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.SS3.p2.3.m3.1c">\pi_{\text{cls}}</annotation><annotation encoding="application/x-llamapun" id="S5.SS3.p2.3.m3.1d">italic_π start_POSTSUBSCRIPT cls end_POSTSUBSCRIPT</annotation></semantics></math> significantly harms performance, highlighting the importance of individualized filtering.
Excluding <math alttext="\pi_{\text{list}}" class="ltx_Math" display="inline" id="S5.SS3.p2.4.m4.1"><semantics id="S5.SS3.p2.4.m4.1a"><msub id="S5.SS3.p2.4.m4.1.1" xref="S5.SS3.p2.4.m4.1.1.cmml"><mi id="S5.SS3.p2.4.m4.1.1.2" xref="S5.SS3.p2.4.m4.1.1.2.cmml">π</mi><mtext id="S5.SS3.p2.4.m4.1.1.3" xref="S5.SS3.p2.4.m4.1.1.3a.cmml">list</mtext></msub><annotation-xml encoding="MathML-Content" id="S5.SS3.p2.4.m4.1b"><apply id="S5.SS3.p2.4.m4.1.1.cmml" xref="S5.SS3.p2.4.m4.1.1"><csymbol cd="ambiguous" id="S5.SS3.p2.4.m4.1.1.1.cmml" xref="S5.SS3.p2.4.m4.1.1">subscript</csymbol><ci id="S5.SS3.p2.4.m4.1.1.2.cmml" xref="S5.SS3.p2.4.m4.1.1.2">𝜋</ci><ci id="S5.SS3.p2.4.m4.1.1.3a.cmml" xref="S5.SS3.p2.4.m4.1.1.3"><mtext id="S5.SS3.p2.4.m4.1.1.3.cmml" mathsize="70%" xref="S5.SS3.p2.4.m4.1.1.3">list</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.SS3.p2.4.m4.1c">\pi_{\text{list}}</annotation><annotation encoding="application/x-llamapun" id="S5.SS3.p2.4.m4.1d">italic_π start_POSTSUBSCRIPT list end_POSTSUBSCRIPT</annotation></semantics></math> also degrades results, indicating that list-wise modeling is essential for capturing decision structures beyond point-wise analysis.</p>
</div>
<div class="ltx_para" id="S5.SS3.p3">
<p class="ltx_p" id="S5.SS3.p3.1">We further evaluate the two-stage training of <math alttext="\pi_{\text{list}}" class="ltx_Math" display="inline" id="S5.SS3.p3.1.m1.1"><semantics id="S5.SS3.p3.1.m1.1a"><msub id="S5.SS3.p3.1.m1.1.1" xref="S5.SS3.p3.1.m1.1.1.cmml"><mi id="S5.SS3.p3.1.m1.1.1.2" xref="S5.SS3.p3.1.m1.1.1.2.cmml">π</mi><mtext id="S5.SS3.p3.1.m1.1.1.3" xref="S5.SS3.p3.1.m1.1.1.3a.cmml">list</mtext></msub><annotation-xml encoding="MathML-Content" id="S5.SS3.p3.1.m1.1b"><apply id="S5.SS3.p3.1.m1.1.1.cmml" xref="S5.SS3.p3.1.m1.1.1"><csymbol cd="ambiguous" id="S5.SS3.p3.1.m1.1.1.1.cmml" xref="S5.SS3.p3.1.m1.1.1">subscript</csymbol><ci id="S5.SS3.p3.1.m1.1.1.2.cmml" xref="S5.SS3.p3.1.m1.1.1.2">𝜋</ci><ci id="S5.SS3.p3.1.m1.1.1.3a.cmml" xref="S5.SS3.p3.1.m1.1.1.3"><mtext id="S5.SS3.p3.1.m1.1.1.3.cmml" mathsize="70%" xref="S5.SS3.p3.1.m1.1.1.3">list</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.SS3.p3.1.m1.1c">\pi_{\text{list}}</annotation><annotation encoding="application/x-llamapun" id="S5.SS3.p3.1.m1.1d">italic_π start_POSTSUBSCRIPT list end_POSTSUBSCRIPT</annotation></semantics></math>.
Skipping SFT limits task-form alignment, while omitting step-wise GRPO weakens preference learning (Table <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S5.T2" title="Table 2 ‣ 5.2 Overall Performance Comparison ‣ 5 Experiments ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">2</span></a> (c)-(d)).
These results confirm the necessity of both SFT and step-wise preference alignment.</p>
</div>
<div class="ltx_para" id="S5.SS3.p4">
<p class="ltx_p" id="S5.SS3.p4.1"><span class="ltx_text ltx_font_bold" id="S5.SS3.p4.1.1">Step-wise GRPO.</span>
Replacing step-wise GRPO with standard GRPO (Table <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S5.T2" title="Table 2 ‣ 5.2 Overall Performance Comparison ‣ 5 Experiments ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">2</span></a> (e)) results in clear performance drops, demonstrating that outcome-only rewards are insufficient.
Fig. <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S5.F6" title="Figure 6 ‣ 5.2 Overall Performance Comparison ‣ 5 Experiments ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">6</span></a> shows that step-wise GRPO provides denser feedback, accelerating learning and improving stability.</p>
</div>
<div class="ltx_para" id="S5.SS3.p5">
<p class="ltx_p" id="S5.SS3.p5.1"><span class="ltx_text ltx_font_bold" id="S5.SS3.p5.1.1">Multi-source Knowledge Fusion.</span>
Integrating structured codes and unstructured clinical notes significantly boosts performance; removing either degrades results (Table <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S5.T2" title="Table 2 ‣ 5.2 Overall Performance Comparison ‣ 5 Experiments ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">2</span></a> (f)-(g)).
To analyze embedding strategies, we replace collaborative embeddings with random vectors <math alttext="\tilde{\mathbf{e}}^{\text{collab}}_{\text{rand}}" class="ltx_Math" display="inline" id="S5.SS3.p5.1.m1.1"><semantics id="S5.SS3.p5.1.m1.1a"><msubsup id="S5.SS3.p5.1.m1.1.1" xref="S5.SS3.p5.1.m1.1.1.cmml"><mover accent="true" id="S5.SS3.p5.1.m1.1.1.2.2" xref="S5.SS3.p5.1.m1.1.1.2.2.cmml"><mi id="S5.SS3.p5.1.m1.1.1.2.2.2" xref="S5.SS3.p5.1.m1.1.1.2.2.2.cmml">𝐞</mi><mo id="S5.SS3.p5.1.m1.1.1.2.2.1" xref="S5.SS3.p5.1.m1.1.1.2.2.1.cmml">~</mo></mover><mtext id="S5.SS3.p5.1.m1.1.1.3" xref="S5.SS3.p5.1.m1.1.1.3a.cmml">rand</mtext><mtext id="S5.SS3.p5.1.m1.1.1.2.3" xref="S5.SS3.p5.1.m1.1.1.2.3a.cmml">collab</mtext></msubsup><annotation-xml encoding="MathML-Content" id="S5.SS3.p5.1.m1.1b"><apply id="S5.SS3.p5.1.m1.1.1.cmml" xref="S5.SS3.p5.1.m1.1.1"><csymbol cd="ambiguous" id="S5.SS3.p5.1.m1.1.1.1.cmml" xref="S5.SS3.p5.1.m1.1.1">subscript</csymbol><apply id="S5.SS3.p5.1.m1.1.1.2.cmml" xref="S5.SS3.p5.1.m1.1.1"><csymbol cd="ambiguous" id="S5.SS3.p5.1.m1.1.1.2.1.cmml" xref="S5.SS3.p5.1.m1.1.1">superscript</csymbol><apply id="S5.SS3.p5.1.m1.1.1.2.2.cmml" xref="S5.SS3.p5.1.m1.1.1.2.2"><ci id="S5.SS3.p5.1.m1.1.1.2.2.1.cmml" xref="S5.SS3.p5.1.m1.1.1.2.2.1">~</ci><ci id="S5.SS3.p5.1.m1.1.1.2.2.2.cmml" xref="S5.SS3.p5.1.m1.1.1.2.2.2">𝐞</ci></apply><ci id="S5.SS3.p5.1.m1.1.1.2.3a.cmml" xref="S5.SS3.p5.1.m1.1.1.2.3"><mtext id="S5.SS3.p5.1.m1.1.1.2.3.cmml" mathsize="70%" xref="S5.SS3.p5.1.m1.1.1.2.3">collab</mtext></ci></apply><ci id="S5.SS3.p5.1.m1.1.1.3a.cmml" xref="S5.SS3.p5.1.m1.1.1.3"><mtext id="S5.SS3.p5.1.m1.1.1.3.cmml" mathsize="70%" xref="S5.SS3.p5.1.m1.1.1.3">rand</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="S5.SS3.p5.1.m1.1c">\tilde{\mathbf{e}}^{\text{collab}}_{\text{rand}}</annotation><annotation encoding="application/x-llamapun" id="S5.SS3.p5.1.m1.1d">over~ start_ARG bold_e end_ARG start_POSTSUPERSCRIPT collab end_POSTSUPERSCRIPT start_POSTSUBSCRIPT rand end_POSTSUBSCRIPT</annotation></semantics></math>.
While random embeddings offer slight gains over text-only inputs, they lack meaningful domain knowledge, resulting in a notable gap from FLAME (Table <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S5.T2" title="Table 2 ‣ 5.2 Overall Performance Comparison ‣ 5 Experiments ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">2</span></a> (h)-(j)).</p>
</div>
<div class="ltx_para" id="S5.SS3.p6">
<p class="ltx_p" id="S5.SS3.p6.1"><span class="ltx_text ltx_font_bold" id="S5.SS3.p6.1.1">LLM Backbone.</span>
Replacing the Llama3.1-Aloe-Beta-8B backbone with general large language models (LLaMA2 and LLaMA3) leads to noticeable performance drops (Table <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S5.T2" title="Table 2 ‣ 5.2 Overall Performance Comparison ‣ 5 Experiments ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">2</span></a> (k)-(l)).
This highlights the critical role of domain-specific medical knowledge embedded in Llama3.1-Aloe-Beta-8B for accurate medication recommendation.</p>
</div>
</section>
</section>
<section class="ltx_section" id="S6">
<h2 class="ltx_title ltx_title_section">
<span class="ltx_tag ltx_tag_section">6 </span>Conclusion</h2>
<div class="ltx_para" id="S6.p1">
<p class="ltx_p" id="S6.p1.1">We presented FLAME, an LLM-based list-wise medication recommendation framework that formulates prescription generation as a sequential <span class="ltx_text ltx_font_italic" id="S6.p1.1.1">drug-by-drug</span> decision process.
By introducing <span class="ltx_text ltx_font_bold" id="S6.p1.1.2">step-wise GRPO</span> with potential-based reward shaping, FLAME enables fine-grained credit assignment, effectively capturing drug interactions and enforcing safety constraints such as DDIs.
Through hybrid representations that fuse structured clinical data, collaborative signals, and unstructured textual information, FLAME enhances the LLM’s capacity for accurate and clinically grounded recommendations.
Extensive experiments demonstrate FLAME’s superior accuracy, controllable safety–accuracy trade-offs, and strong generalization across temporal and institutional shifts.
These results highlight the potential of fine-grained list-wise alignment for building reliable, adaptable clinical decision support systems.
In future work, we plan to further improve FLAME’s generalization in diverse and evolving healthcare environments, advancing towards scalable and equitable AI-driven solutions for real-world clinical practice. In addition, we will explore the integration of physician decisions with FLAME to build a human-in-the-loop medication recommendation system.</p>
</div>
</section>
<section class="ltx_bibliography" id="bib">
<h2 class="ltx_title ltx_title_bibliography">References</h2>
<ul class="ltx_biblist">
<li class="ltx_bibitem" id="bib.bib1">
<span class="ltx_tag ltx_tag_bibitem">[1]</span>
<span class="ltx_bibblock">
Z. Ali, Y. Huang, I. Ullah, J. Feng, C. Deng, N. Thierry, A. Khan, A. U. Jan, X. Shen, W. Rui, <span class="ltx_text ltx_font_italic" id="bib.bib1.1.1">et al.</span>, “Deep learning for medication recommendation: a systematic survey,” <span class="ltx_text ltx_font_italic" id="bib.bib1.2.2">Data Intelligence</span>, vol. 5, no. 2, pp. 303–354, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib2">
<span class="ltx_tag ltx_tag_bibitem">[2]</span>
<span class="ltx_bibblock">
H. Sun, S. Xie, S. Li, Y. Chen, J.-R. Wen, and R. Yan, “Debiased, longitudinal and coordinated drug recommendation through multi-visit clinic records,” <span class="ltx_text ltx_font_italic" id="bib.bib2.1.1">Advances in Neural Information Processing Systems</span>, vol. 35, pp. 27837–27849, 2022.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib3">
<span class="ltx_tag ltx_tag_bibitem">[3]</span>
<span class="ltx_bibblock">
C. Yang, C. Xiao, F. Ma, L. Glass, and J. Sun, “Safedrug: Dual molecular graph encoders for recommending effective and safe drug combinations,” in <span class="ltx_text ltx_font_italic" id="bib.bib3.1.1">30th International Joint Conference on Artificial Intelligence, IJCAI 2021</span>, pp. 3735–3741, International Joint Conferences on Artificial Intelligence, 2021.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib4">
<span class="ltx_tag ltx_tag_bibitem">[4]</span>
<span class="ltx_bibblock">
R. Wu, Z. Qiu, J. Jiang, G. Qi, and X. Wu, “Conditional generation net for medication recommendation,” in <span class="ltx_text ltx_font_italic" id="bib.bib4.1.1">Proceedings of the ACM web conference 2022</span>, pp. 935–945, 2022.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib5">
<span class="ltx_tag ltx_tag_bibitem">[5]</span>
<span class="ltx_bibblock">
Z. Zhao, Y. Jing, F. Feng, J. Wu, C. Gao, and X. He, “Leave no patient behind: Enhancing medication recommendation for rare disease patients,” in <span class="ltx_text ltx_font_italic" id="bib.bib5.1.1">Proceedings of the 47th International ACM SIGIR Conference on Research and Development in Information Retrieval</span>, pp. 533–542, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib6">
<span class="ltx_tag ltx_tag_bibitem">[6]</span>
<span class="ltx_bibblock">
Y. Zhang, R. Chen, J. Tang, W. F. Stewart, and J. Sun, “Leap: learning to prescribe effective and safe treatment combinations for multimorbidity,” in <span class="ltx_text ltx_font_italic" id="bib.bib6.1.1">proceedings of the 23rd ACM SIGKDD international conference on knowledge Discovery and data Mining</span>, pp. 1315–1324, 2017.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib7">
<span class="ltx_tag ltx_tag_bibitem">[7]</span>
<span class="ltx_bibblock">
J. Shang, C. Xiao, T. Ma, H. Li, and J. Sun, “Gamenet: Graph augmented memory networks for recommending medication combination,” in <span class="ltx_text ltx_font_italic" id="bib.bib7.1.1">proceedings of the AAAI Conference on Artificial Intelligence</span>, vol. 33, pp. 1126–1133, 2019.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib8">
<span class="ltx_tag ltx_tag_bibitem">[8]</span>
<span class="ltx_bibblock">
N. Yang, K. Zeng, Q. Wu, and J. Yan, “Molerec: Combinatorial drug recommendation with substructure-aware molecular representation learning,” in <span class="ltx_text ltx_font_italic" id="bib.bib8.1.1">Proceedings of the ACM web conference 2023</span>, pp. 4075–4085, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib9">
<span class="ltx_tag ltx_tag_bibitem">[9]</span>
<span class="ltx_bibblock">
K. Singhal, S. Azizi, T. Tu, S. S. Mahdavi, J. Wei, H. W. Chung, N. Scales, A. Tanwani, H. Cole-Lewis, S. Pfohl, <span class="ltx_text ltx_font_italic" id="bib.bib9.1.1">et al.</span>, “Large language models encode clinical knowledge,” <span class="ltx_text ltx_font_italic" id="bib.bib9.2.2">Nature</span>, vol. 620, no. 7972, pp. 172–180, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib10">
<span class="ltx_tag ltx_tag_bibitem">[10]</span>
<span class="ltx_bibblock">
Z. Zhao, C. Fan, C. Gao, F. Feng, and X. He, “Addressing overprescribing challenges: Fine-tuning large language models for medication recommendation tasks,” <span class="ltx_text ltx_font_italic" id="bib.bib10.1.1">arXiv preprint arXiv:2503.03687</span>, 2025.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib11">
<span class="ltx_tag ltx_tag_bibitem">[11]</span>
<span class="ltx_bibblock">
N. P. Tatonetti, P. P. Ye, R. Daneshjou, and R. B. Altman, “Data-driven prediction of drug effects and interactions,” <span class="ltx_text ltx_font_italic" id="bib.bib11.1.1">Science translational medicine</span>, vol. 4, no. 125, pp. 125ra31–125ra31, 2012.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib12">
<span class="ltx_tag ltx_tag_bibitem">[12]</span>
<span class="ltx_bibblock">
Z. Shao, P. Wang, Q. Zhu, R. Xu, J. Song, X. Bi, H. Zhang, M. Zhang, Y. Li, Y. Wu, <span class="ltx_text ltx_font_italic" id="bib.bib12.1.1">et al.</span>, “Deepseekmath: Pushing the limits of mathematical reasoning in open language models,” <span class="ltx_text ltx_font_italic" id="bib.bib12.2.2">arXiv preprint arXiv:2402.03300</span>, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib13">
<span class="ltx_tag ltx_tag_bibitem">[13]</span>
<span class="ltx_bibblock">
A. K. Gururajan, E. Lopez-Cuena, J. Bayarri-Planas, A. Tormos, D. Hinjos, P. Bernabeu-Perez, A. Arias-Duart, P. A. Martin-Torres, L. Urcelay-Ganzabal, M. Gonzalez-Mallo, <span class="ltx_text ltx_font_italic" id="bib.bib13.1.1">et al.</span>, “Aloe: A family of fine-tuned open healthcare llms,” <span class="ltx_text ltx_font_italic" id="bib.bib13.2.2">arXiv preprint arXiv:2405.01886</span>, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib14">
<span class="ltx_tag ltx_tag_bibitem">[14]</span>
<span class="ltx_bibblock">
A. E. Johnson, T. J. Pollard, L. Shen, L.-w. H. Lehman, M. Feng, M. Ghassemi, B. Moody, P. Szolovits, L. Anthony Celi, and R. G. Mark, “Mimic-iii, a freely accessible critical care database,” <span class="ltx_text ltx_font_italic" id="bib.bib14.1.1">Scientific data</span>, vol. 3, no. 1, pp. 1–9, 2016.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib15">
<span class="ltx_tag ltx_tag_bibitem">[15]</span>
<span class="ltx_bibblock">
A. E. Johnson, L. Bulgarelli, L. Shen, A. Gayles, A. Shammout, S. Horng, T. J. Pollard, S. Hao, B. Moody, B. Gow, <span class="ltx_text ltx_font_italic" id="bib.bib15.1.1">et al.</span>, “Mimic-iv, a freely accessible electronic health record dataset,” <span class="ltx_text ltx_font_italic" id="bib.bib15.2.2">Scientific data</span>, vol. 10, no. 1, p. 1, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib16">
<span class="ltx_tag ltx_tag_bibitem">[16]</span>
<span class="ltx_bibblock">
T. J. Pollard, A. E. Johnson, J. D. Raffa, L. A. Celi, R. G. Mark, and O. Badawi, “The eicu collaborative research database, a freely available multi-center database for critical care research,” <span class="ltx_text ltx_font_italic" id="bib.bib16.1.1">Scientific data</span>, vol. 5, no. 1, pp. 1–13, 2018.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib17">
<span class="ltx_tag ltx_tag_bibitem">[17]</span>
<span class="ltx_bibblock">
J. Tan, Y. Rong, K. Zhao, T. Bian, T. Xu, J. Huang, H. Cheng, and H. Meng, “Natural language-assisted multi-modal medication recommendation,” in <span class="ltx_text ltx_font_italic" id="bib.bib17.1.1">Proceedings of the 33rd ACM International Conference on Information and Knowledge Management</span>, pp. 2200–2209, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib18">
<span class="ltx_tag ltx_tag_bibitem">[18]</span>
<span class="ltx_bibblock">
J. Schulman, F. Wolski, P. Dhariwal, A. Radford, and O. Klimov, “Proximal policy optimization algorithms,” <span class="ltx_text ltx_font_italic" id="bib.bib18.1.1">arXiv preprint arXiv:1707.06347</span>, 2017.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib19">
<span class="ltx_tag ltx_tag_bibitem">[19]</span>
<span class="ltx_bibblock">
R. Rafailov, A. Sharma, E. Mitchell, C. D. Manning, S. Ermon, and C. Finn, “Direct preference optimization: Your language model is secretly a reward model,” <span class="ltx_text ltx_font_italic" id="bib.bib19.1.1">Advances in Neural Information Processing Systems</span>, vol. 36, pp. 53728–53741, 2023.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib20">
<span class="ltx_tag ltx_tag_bibitem">[20]</span>
<span class="ltx_bibblock">
M. R. Cowie, J. I. Blomster, L. H. Curtis, S. Duclaux, I. Ford, F. Fritz, S. Goldman, S. Janmohamed, J. Kreuzer, M. Leenay, <span class="ltx_text ltx_font_italic" id="bib.bib20.1.1">et al.</span>, “Electronic health records to facilitate clinical research,” <span class="ltx_text ltx_font_italic" id="bib.bib20.2.2">Clinical Research in Cardiology</span>, vol. 106, pp. 1–9, 2017.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib21">
<span class="ltx_tag ltx_tag_bibitem">[21]</span>
<span class="ltx_bibblock">
C. Gao, M. Gao, C. Fan, S. Yuan, W. Shi, and X. He, “Process-supervised llm recommenders via flow-guided tuning,” <span class="ltx_text ltx_font_italic" id="bib.bib21.1.1">arXiv preprint arXiv:2503.07377</span>, 2025.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib22">
<span class="ltx_tag ltx_tag_bibitem">[22]</span>
<span class="ltx_bibblock">
A. Y. Ng, D. Harada, and S. Russell, “Policy invariance under reward transformations: Theory and application to reward shaping,” in <span class="ltx_text ltx_font_italic" id="bib.bib22.1.1">ICML</span>, pp. 278–287, Morgan Kaufmann, 1999.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib23">
<span class="ltx_tag ltx_tag_bibitem">[23]</span>
<span class="ltx_bibblock">
R. Rafailov, J. Hejna, R. Park, and C. Finn, “From r to q<sup class="ltx_sup" id="bib.bib23.2.1">∗</sup>: Your language model is secretly a q-function,” <span class="ltx_text ltx_font_italic" id="bib.bib23.3.2">arXiv preprint arXiv:2404.12358</span>, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib24">
<span class="ltx_tag ltx_tag_bibitem">[24]</span>
<span class="ltx_bibblock">
Y. Zhang, F. Feng, J. Zhang, K. Bao, Q. Wang, and X. He, “Collm: Integrating collaborative embeddings into large language models for recommendation,” <span class="ltx_text ltx_font_italic" id="bib.bib24.1.1">IEEE Transactions on Knowledge and Data Engineering</span>, 2025.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib25">
<span class="ltx_tag ltx_tag_bibitem">[25]</span>
<span class="ltx_bibblock">
J. Liao, S. Li, Z. Yang, J. Wu, Y. Yuan, X. Wang, and X. He, “Llara: Large language-recommendation assistant,” in <span class="ltx_text ltx_font_italic" id="bib.bib25.1.1">Proceedings of the 47th International ACM SIGIR Conference on Research and Development in Information Retrieval</span>, pp. 1785–1795, 2024.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib26">
<span class="ltx_tag ltx_tag_bibitem">[26]</span>
<span class="ltx_bibblock">
C. Yang, C. Xiao, L. Glass, and J. Sun, “Change matters: Medication change prediction with recurrent residual networks,” <span class="ltx_text ltx_font_italic" id="bib.bib26.1.1">arXiv preprint arXiv:2105.01876</span>, 2021.

</span>
</li>
<li class="ltx_bibitem" id="bib.bib27">
<span class="ltx_tag ltx_tag_bibitem">[27]</span>
<span class="ltx_bibblock">
J. Xia, C. Zhao, B. Hu, Z. Gao, C. Tan, Y. Liu, S. Li, and S. Z. Li, “Mole-bert: Rethinking pre-training graph neural networks for molecules,” 2023.

</span>
</li>
</ul>
</section>
<div class="ltx_pagination ltx_role_newpage"></div>
<section class="ltx_appendix" id="A1">
<h2 class="ltx_title ltx_title_appendix">
<span class="ltx_tag ltx_tag_appendix">Appendix A </span>Theoretical Analysis</h2>
<div class="ltx_proof" id="A1.4">
<h6 class="ltx_title ltx_runin ltx_font_italic ltx_title_proof">Proof.</h6>
<div class="ltx_para" id="A1.1.p1">
<p class="ltx_p" id="A1.1.p1.1">We prove the theorem using the reward shaping framework introduced by <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib22" title="">22</a>]</cite>, which shows that augmenting a reward function with a potential-based shaping term does not alter the optimal policy.</p>
</div>
<div class="ltx_theorem ltx_theorem_lemma" id="A1.Thmtheorem1">
<h6 class="ltx_title ltx_runin ltx_title_theorem">
<span class="ltx_tag ltx_tag_theorem"><span class="ltx_text ltx_font_bold" id="A1.Thmtheorem1.1.1.1">Lemma A.1</span></span><span class="ltx_text ltx_font_bold" id="A1.Thmtheorem1.2.2"> </span>(Ng et al., 1999)<span class="ltx_text ltx_font_bold" id="A1.Thmtheorem1.3.3">.</span>
</h6>
<div class="ltx_para" id="A1.Thmtheorem1.p1">
<p class="ltx_p" id="A1.Thmtheorem1.p1.3"><span class="ltx_text ltx_font_italic" id="A1.Thmtheorem1.p1.3.3">Let <math alttext="r(s_{t},a_{t})" class="ltx_Math" display="inline" id="A1.Thmtheorem1.p1.1.1.m1.2"><semantics id="A1.Thmtheorem1.p1.1.1.m1.2a"><mrow id="A1.Thmtheorem1.p1.1.1.m1.2.2" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.cmml"><mi id="A1.Thmtheorem1.p1.1.1.m1.2.2.4" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.4.cmml">r</mi><mo id="A1.Thmtheorem1.p1.1.1.m1.2.2.3" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.3.cmml">⁢</mo><mrow id="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.2.3.cmml"><mo id="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.3" stretchy="false" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.2.3.cmml">(</mo><msub id="A1.Thmtheorem1.p1.1.1.m1.1.1.1.1.1" xref="A1.Thmtheorem1.p1.1.1.m1.1.1.1.1.1.cmml"><mi id="A1.Thmtheorem1.p1.1.1.m1.1.1.1.1.1.2" xref="A1.Thmtheorem1.p1.1.1.m1.1.1.1.1.1.2.cmml">s</mi><mi id="A1.Thmtheorem1.p1.1.1.m1.1.1.1.1.1.3" xref="A1.Thmtheorem1.p1.1.1.m1.1.1.1.1.1.3.cmml">t</mi></msub><mo id="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.4" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.2.3.cmml">,</mo><msub id="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.2" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.2.cmml"><mi id="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.2.2" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.2.2.cmml">a</mi><mi id="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.2.3" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.2.3.cmml">t</mi></msub><mo id="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.5" stretchy="false" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.2.3.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="A1.Thmtheorem1.p1.1.1.m1.2b"><apply id="A1.Thmtheorem1.p1.1.1.m1.2.2.cmml" xref="A1.Thmtheorem1.p1.1.1.m1.2.2"><times id="A1.Thmtheorem1.p1.1.1.m1.2.2.3.cmml" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.3"></times><ci id="A1.Thmtheorem1.p1.1.1.m1.2.2.4.cmml" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.4">𝑟</ci><interval closure="open" id="A1.Thmtheorem1.p1.1.1.m1.2.2.2.3.cmml" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2"><apply id="A1.Thmtheorem1.p1.1.1.m1.1.1.1.1.1.cmml" xref="A1.Thmtheorem1.p1.1.1.m1.1.1.1.1.1"><csymbol cd="ambiguous" id="A1.Thmtheorem1.p1.1.1.m1.1.1.1.1.1.1.cmml" xref="A1.Thmtheorem1.p1.1.1.m1.1.1.1.1.1">subscript</csymbol><ci id="A1.Thmtheorem1.p1.1.1.m1.1.1.1.1.1.2.cmml" xref="A1.Thmtheorem1.p1.1.1.m1.1.1.1.1.1.2">𝑠</ci><ci id="A1.Thmtheorem1.p1.1.1.m1.1.1.1.1.1.3.cmml" xref="A1.Thmtheorem1.p1.1.1.m1.1.1.1.1.1.3">𝑡</ci></apply><apply id="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.2.cmml" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.2"><csymbol cd="ambiguous" id="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.2.1.cmml" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.2">subscript</csymbol><ci id="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.2.2.cmml" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.2.2">𝑎</ci><ci id="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.2.3.cmml" xref="A1.Thmtheorem1.p1.1.1.m1.2.2.2.2.2.3">𝑡</ci></apply></interval></apply></annotation-xml><annotation encoding="application/x-tex" id="A1.Thmtheorem1.p1.1.1.m1.2c">r(s_{t},a_{t})</annotation><annotation encoding="application/x-llamapun" id="A1.Thmtheorem1.p1.1.1.m1.2d">italic_r ( italic_s start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT , italic_a start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT )</annotation></semantics></math> and <math alttext="r^{\prime}(s_{t},a_{t})" class="ltx_Math" display="inline" id="A1.Thmtheorem1.p1.2.2.m2.2"><semantics id="A1.Thmtheorem1.p1.2.2.m2.2a"><mrow id="A1.Thmtheorem1.p1.2.2.m2.2.2" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.cmml"><msup id="A1.Thmtheorem1.p1.2.2.m2.2.2.4" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.4.cmml"><mi id="A1.Thmtheorem1.p1.2.2.m2.2.2.4.2" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.4.2.cmml">r</mi><mo id="A1.Thmtheorem1.p1.2.2.m2.2.2.4.3" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.4.3.cmml">′</mo></msup><mo id="A1.Thmtheorem1.p1.2.2.m2.2.2.3" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.3.cmml">⁢</mo><mrow id="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.2.3.cmml"><mo id="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.3" stretchy="false" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.2.3.cmml">(</mo><msub id="A1.Thmtheorem1.p1.2.2.m2.1.1.1.1.1" xref="A1.Thmtheorem1.p1.2.2.m2.1.1.1.1.1.cmml"><mi id="A1.Thmtheorem1.p1.2.2.m2.1.1.1.1.1.2" xref="A1.Thmtheorem1.p1.2.2.m2.1.1.1.1.1.2.cmml">s</mi><mi id="A1.Thmtheorem1.p1.2.2.m2.1.1.1.1.1.3" xref="A1.Thmtheorem1.p1.2.2.m2.1.1.1.1.1.3.cmml">t</mi></msub><mo id="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.4" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.2.3.cmml">,</mo><msub id="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.2" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.2.cmml"><mi id="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.2.2" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.2.2.cmml">a</mi><mi id="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.2.3" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.2.3.cmml">t</mi></msub><mo id="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.5" stretchy="false" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.2.3.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="A1.Thmtheorem1.p1.2.2.m2.2b"><apply id="A1.Thmtheorem1.p1.2.2.m2.2.2.cmml" xref="A1.Thmtheorem1.p1.2.2.m2.2.2"><times id="A1.Thmtheorem1.p1.2.2.m2.2.2.3.cmml" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.3"></times><apply id="A1.Thmtheorem1.p1.2.2.m2.2.2.4.cmml" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.4"><csymbol cd="ambiguous" id="A1.Thmtheorem1.p1.2.2.m2.2.2.4.1.cmml" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.4">superscript</csymbol><ci id="A1.Thmtheorem1.p1.2.2.m2.2.2.4.2.cmml" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.4.2">𝑟</ci><ci id="A1.Thmtheorem1.p1.2.2.m2.2.2.4.3.cmml" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.4.3">′</ci></apply><interval closure="open" id="A1.Thmtheorem1.p1.2.2.m2.2.2.2.3.cmml" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2"><apply id="A1.Thmtheorem1.p1.2.2.m2.1.1.1.1.1.cmml" xref="A1.Thmtheorem1.p1.2.2.m2.1.1.1.1.1"><csymbol cd="ambiguous" id="A1.Thmtheorem1.p1.2.2.m2.1.1.1.1.1.1.cmml" xref="A1.Thmtheorem1.p1.2.2.m2.1.1.1.1.1">subscript</csymbol><ci id="A1.Thmtheorem1.p1.2.2.m2.1.1.1.1.1.2.cmml" xref="A1.Thmtheorem1.p1.2.2.m2.1.1.1.1.1.2">𝑠</ci><ci id="A1.Thmtheorem1.p1.2.2.m2.1.1.1.1.1.3.cmml" xref="A1.Thmtheorem1.p1.2.2.m2.1.1.1.1.1.3">𝑡</ci></apply><apply id="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.2.cmml" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.2"><csymbol cd="ambiguous" id="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.2.1.cmml" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.2">subscript</csymbol><ci id="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.2.2.cmml" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.2.2">𝑎</ci><ci id="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.2.3.cmml" xref="A1.Thmtheorem1.p1.2.2.m2.2.2.2.2.2.3">𝑡</ci></apply></interval></apply></annotation-xml><annotation encoding="application/x-tex" id="A1.Thmtheorem1.p1.2.2.m2.2c">r^{\prime}(s_{t},a_{t})</annotation><annotation encoding="application/x-llamapun" id="A1.Thmtheorem1.p1.2.2.m2.2d">italic_r start_POSTSUPERSCRIPT ′ end_POSTSUPERSCRIPT ( italic_s start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT , italic_a start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT )</annotation></semantics></math> be two reward functions. If there exists a potential function <math alttext="\Phi(s)" class="ltx_Math" display="inline" id="A1.Thmtheorem1.p1.3.3.m3.1"><semantics id="A1.Thmtheorem1.p1.3.3.m3.1a"><mrow id="A1.Thmtheorem1.p1.3.3.m3.1.2" xref="A1.Thmtheorem1.p1.3.3.m3.1.2.cmml"><mi id="A1.Thmtheorem1.p1.3.3.m3.1.2.2" mathvariant="normal" xref="A1.Thmtheorem1.p1.3.3.m3.1.2.2.cmml">Φ</mi><mo id="A1.Thmtheorem1.p1.3.3.m3.1.2.1" xref="A1.Thmtheorem1.p1.3.3.m3.1.2.1.cmml">⁢</mo><mrow id="A1.Thmtheorem1.p1.3.3.m3.1.2.3.2" xref="A1.Thmtheorem1.p1.3.3.m3.1.2.cmml"><mo id="A1.Thmtheorem1.p1.3.3.m3.1.2.3.2.1" stretchy="false" xref="A1.Thmtheorem1.p1.3.3.m3.1.2.cmml">(</mo><mi id="A1.Thmtheorem1.p1.3.3.m3.1.1" xref="A1.Thmtheorem1.p1.3.3.m3.1.1.cmml">s</mi><mo id="A1.Thmtheorem1.p1.3.3.m3.1.2.3.2.2" stretchy="false" xref="A1.Thmtheorem1.p1.3.3.m3.1.2.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="A1.Thmtheorem1.p1.3.3.m3.1b"><apply id="A1.Thmtheorem1.p1.3.3.m3.1.2.cmml" xref="A1.Thmtheorem1.p1.3.3.m3.1.2"><times id="A1.Thmtheorem1.p1.3.3.m3.1.2.1.cmml" xref="A1.Thmtheorem1.p1.3.3.m3.1.2.1"></times><ci id="A1.Thmtheorem1.p1.3.3.m3.1.2.2.cmml" xref="A1.Thmtheorem1.p1.3.3.m3.1.2.2">Φ</ci><ci id="A1.Thmtheorem1.p1.3.3.m3.1.1.cmml" xref="A1.Thmtheorem1.p1.3.3.m3.1.1">𝑠</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="A1.Thmtheorem1.p1.3.3.m3.1c">\Phi(s)</annotation><annotation encoding="application/x-llamapun" id="A1.Thmtheorem1.p1.3.3.m3.1d">roman_Φ ( italic_s )</annotation></semantics></math> such that:</span></p>
<table class="ltx_equation ltx_eqn_table" id="A1.E17">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="r^{\prime}(s_{t},a_{t})=r(s_{t},a_{t})+\gamma\Phi(s_{t+1})-\Phi(s_{t})," class="ltx_Math" display="block" id="A1.E17.m1.1"><semantics id="A1.E17.m1.1a"><mrow id="A1.E17.m1.1.1.1" xref="A1.E17.m1.1.1.1.1.cmml"><mrow id="A1.E17.m1.1.1.1.1" xref="A1.E17.m1.1.1.1.1.cmml"><mrow id="A1.E17.m1.1.1.1.1.2" xref="A1.E17.m1.1.1.1.1.2.cmml"><msup id="A1.E17.m1.1.1.1.1.2.4" xref="A1.E17.m1.1.1.1.1.2.4.cmml"><mi id="A1.E17.m1.1.1.1.1.2.4.2" xref="A1.E17.m1.1.1.1.1.2.4.2.cmml">r</mi><mo id="A1.E17.m1.1.1.1.1.2.4.3" xref="A1.E17.m1.1.1.1.1.2.4.3.cmml">′</mo></msup><mo id="A1.E17.m1.1.1.1.1.2.3" xref="A1.E17.m1.1.1.1.1.2.3.cmml">⁢</mo><mrow id="A1.E17.m1.1.1.1.1.2.2.2" xref="A1.E17.m1.1.1.1.1.2.2.3.cmml"><mo id="A1.E17.m1.1.1.1.1.2.2.2.3" stretchy="false" xref="A1.E17.m1.1.1.1.1.2.2.3.cmml">(</mo><msub id="A1.E17.m1.1.1.1.1.1.1.1.1" xref="A1.E17.m1.1.1.1.1.1.1.1.1.cmml"><mi id="A1.E17.m1.1.1.1.1.1.1.1.1.2" xref="A1.E17.m1.1.1.1.1.1.1.1.1.2.cmml">s</mi><mi id="A1.E17.m1.1.1.1.1.1.1.1.1.3" xref="A1.E17.m1.1.1.1.1.1.1.1.1.3.cmml">t</mi></msub><mo id="A1.E17.m1.1.1.1.1.2.2.2.4" xref="A1.E17.m1.1.1.1.1.2.2.3.cmml">,</mo><msub id="A1.E17.m1.1.1.1.1.2.2.2.2" xref="A1.E17.m1.1.1.1.1.2.2.2.2.cmml"><mi id="A1.E17.m1.1.1.1.1.2.2.2.2.2" xref="A1.E17.m1.1.1.1.1.2.2.2.2.2.cmml">a</mi><mi id="A1.E17.m1.1.1.1.1.2.2.2.2.3" xref="A1.E17.m1.1.1.1.1.2.2.2.2.3.cmml">t</mi></msub><mo id="A1.E17.m1.1.1.1.1.2.2.2.5" stretchy="false" xref="A1.E17.m1.1.1.1.1.2.2.3.cmml">)</mo></mrow></mrow><mo id="A1.E17.m1.1.1.1.1.7" xref="A1.E17.m1.1.1.1.1.7.cmml">=</mo><mrow id="A1.E17.m1.1.1.1.1.6" xref="A1.E17.m1.1.1.1.1.6.cmml"><mrow id="A1.E17.m1.1.1.1.1.5.3" xref="A1.E17.m1.1.1.1.1.5.3.cmml"><mrow id="A1.E17.m1.1.1.1.1.4.2.2" xref="A1.E17.m1.1.1.1.1.4.2.2.cmml"><mi id="A1.E17.m1.1.1.1.1.4.2.2.4" xref="A1.E17.m1.1.1.1.1.4.2.2.4.cmml">r</mi><mo id="A1.E17.m1.1.1.1.1.4.2.2.3" xref="A1.E17.m1.1.1.1.1.4.2.2.3.cmml">⁢</mo><mrow id="A1.E17.m1.1.1.1.1.4.2.2.2.2" xref="A1.E17.m1.1.1.1.1.4.2.2.2.3.cmml"><mo id="A1.E17.m1.1.1.1.1.4.2.2.2.2.3" stretchy="false" xref="A1.E17.m1.1.1.1.1.4.2.2.2.3.cmml">(</mo><msub id="A1.E17.m1.1.1.1.1.3.1.1.1.1.1" xref="A1.E17.m1.1.1.1.1.3.1.1.1.1.1.cmml"><mi id="A1.E17.m1.1.1.1.1.3.1.1.1.1.1.2" xref="A1.E17.m1.1.1.1.1.3.1.1.1.1.1.2.cmml">s</mi><mi id="A1.E17.m1.1.1.1.1.3.1.1.1.1.1.3" xref="A1.E17.m1.1.1.1.1.3.1.1.1.1.1.3.cmml">t</mi></msub><mo id="A1.E17.m1.1.1.1.1.4.2.2.2.2.4" xref="A1.E17.m1.1.1.1.1.4.2.2.2.3.cmml">,</mo><msub id="A1.E17.m1.1.1.1.1.4.2.2.2.2.2" xref="A1.E17.m1.1.1.1.1.4.2.2.2.2.2.cmml"><mi id="A1.E17.m1.1.1.1.1.4.2.2.2.2.2.2" xref="A1.E17.m1.1.1.1.1.4.2.2.2.2.2.2.cmml">a</mi><mi id="A1.E17.m1.1.1.1.1.4.2.2.2.2.2.3" xref="A1.E17.m1.1.1.1.1.4.2.2.2.2.2.3.cmml">t</mi></msub><mo id="A1.E17.m1.1.1.1.1.4.2.2.2.2.5" stretchy="false" xref="A1.E17.m1.1.1.1.1.4.2.2.2.3.cmml">)</mo></mrow></mrow><mo id="A1.E17.m1.1.1.1.1.5.3.4" xref="A1.E17.m1.1.1.1.1.5.3.4.cmml">+</mo><mrow id="A1.E17.m1.1.1.1.1.5.3.3" xref="A1.E17.m1.1.1.1.1.5.3.3.cmml"><mi id="A1.E17.m1.1.1.1.1.5.3.3.3" xref="A1.E17.m1.1.1.1.1.5.3.3.3.cmml">γ</mi><mo id="A1.E17.m1.1.1.1.1.5.3.3.2" xref="A1.E17.m1.1.1.1.1.5.3.3.2.cmml">⁢</mo><mi id="A1.E17.m1.1.1.1.1.5.3.3.4" mathvariant="normal" xref="A1.E17.m1.1.1.1.1.5.3.3.4.cmml">Φ</mi><mo id="A1.E17.m1.1.1.1.1.5.3.3.2a" xref="A1.E17.m1.1.1.1.1.5.3.3.2.cmml">⁢</mo><mrow id="A1.E17.m1.1.1.1.1.5.3.3.1.1" xref="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.cmml"><mo id="A1.E17.m1.1.1.1.1.5.3.3.1.1.2" stretchy="false" xref="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.cmml">(</mo><msub id="A1.E17.m1.1.1.1.1.5.3.3.1.1.1" xref="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.cmml"><mi id="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.2" xref="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.2.cmml">s</mi><mrow id="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.3" xref="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.3.cmml"><mi id="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.3.2" xref="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.3.2.cmml">t</mi><mo id="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.3.1" xref="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.3.1.cmml">+</mo><mn id="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.3.3" xref="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.3.3.cmml">1</mn></mrow></msub><mo id="A1.E17.m1.1.1.1.1.5.3.3.1.1.3" stretchy="false" xref="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.cmml">)</mo></mrow></mrow></mrow><mo id="A1.E17.m1.1.1.1.1.6.5" xref="A1.E17.m1.1.1.1.1.6.5.cmml">−</mo><mrow id="A1.E17.m1.1.1.1.1.6.4" xref="A1.E17.m1.1.1.1.1.6.4.cmml"><mi id="A1.E17.m1.1.1.1.1.6.4.3" mathvariant="normal" xref="A1.E17.m1.1.1.1.1.6.4.3.cmml">Φ</mi><mo id="A1.E17.m1.1.1.1.1.6.4.2" xref="A1.E17.m1.1.1.1.1.6.4.2.cmml">⁢</mo><mrow id="A1.E17.m1.1.1.1.1.6.4.1.1" xref="A1.E17.m1.1.1.1.1.6.4.1.1.1.cmml"><mo id="A1.E17.m1.1.1.1.1.6.4.1.1.2" stretchy="false" xref="A1.E17.m1.1.1.1.1.6.4.1.1.1.cmml">(</mo><msub id="A1.E17.m1.1.1.1.1.6.4.1.1.1" xref="A1.E17.m1.1.1.1.1.6.4.1.1.1.cmml"><mi id="A1.E17.m1.1.1.1.1.6.4.1.1.1.2" xref="A1.E17.m1.1.1.1.1.6.4.1.1.1.2.cmml">s</mi><mi id="A1.E17.m1.1.1.1.1.6.4.1.1.1.3" xref="A1.E17.m1.1.1.1.1.6.4.1.1.1.3.cmml">t</mi></msub><mo id="A1.E17.m1.1.1.1.1.6.4.1.1.3" stretchy="false" xref="A1.E17.m1.1.1.1.1.6.4.1.1.1.cmml">)</mo></mrow></mrow></mrow></mrow><mo id="A1.E17.m1.1.1.1.2" xref="A1.E17.m1.1.1.1.1.cmml">,</mo></mrow><annotation-xml encoding="MathML-Content" id="A1.E17.m1.1b"><apply id="A1.E17.m1.1.1.1.1.cmml" xref="A1.E17.m1.1.1.1"><eq id="A1.E17.m1.1.1.1.1.7.cmml" xref="A1.E17.m1.1.1.1.1.7"></eq><apply id="A1.E17.m1.1.1.1.1.2.cmml" xref="A1.E17.m1.1.1.1.1.2"><times id="A1.E17.m1.1.1.1.1.2.3.cmml" xref="A1.E17.m1.1.1.1.1.2.3"></times><apply id="A1.E17.m1.1.1.1.1.2.4.cmml" xref="A1.E17.m1.1.1.1.1.2.4"><csymbol cd="ambiguous" id="A1.E17.m1.1.1.1.1.2.4.1.cmml" xref="A1.E17.m1.1.1.1.1.2.4">superscript</csymbol><ci id="A1.E17.m1.1.1.1.1.2.4.2.cmml" xref="A1.E17.m1.1.1.1.1.2.4.2">𝑟</ci><ci id="A1.E17.m1.1.1.1.1.2.4.3.cmml" xref="A1.E17.m1.1.1.1.1.2.4.3">′</ci></apply><interval closure="open" id="A1.E17.m1.1.1.1.1.2.2.3.cmml" xref="A1.E17.m1.1.1.1.1.2.2.2"><apply id="A1.E17.m1.1.1.1.1.1.1.1.1.cmml" xref="A1.E17.m1.1.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="A1.E17.m1.1.1.1.1.1.1.1.1.1.cmml" xref="A1.E17.m1.1.1.1.1.1.1.1.1">subscript</csymbol><ci id="A1.E17.m1.1.1.1.1.1.1.1.1.2.cmml" xref="A1.E17.m1.1.1.1.1.1.1.1.1.2">𝑠</ci><ci id="A1.E17.m1.1.1.1.1.1.1.1.1.3.cmml" xref="A1.E17.m1.1.1.1.1.1.1.1.1.3">𝑡</ci></apply><apply id="A1.E17.m1.1.1.1.1.2.2.2.2.cmml" xref="A1.E17.m1.1.1.1.1.2.2.2.2"><csymbol cd="ambiguous" id="A1.E17.m1.1.1.1.1.2.2.2.2.1.cmml" xref="A1.E17.m1.1.1.1.1.2.2.2.2">subscript</csymbol><ci id="A1.E17.m1.1.1.1.1.2.2.2.2.2.cmml" xref="A1.E17.m1.1.1.1.1.2.2.2.2.2">𝑎</ci><ci id="A1.E17.m1.1.1.1.1.2.2.2.2.3.cmml" xref="A1.E17.m1.1.1.1.1.2.2.2.2.3">𝑡</ci></apply></interval></apply><apply id="A1.E17.m1.1.1.1.1.6.cmml" xref="A1.E17.m1.1.1.1.1.6"><minus id="A1.E17.m1.1.1.1.1.6.5.cmml" xref="A1.E17.m1.1.1.1.1.6.5"></minus><apply id="A1.E17.m1.1.1.1.1.5.3.cmml" xref="A1.E17.m1.1.1.1.1.5.3"><plus id="A1.E17.m1.1.1.1.1.5.3.4.cmml" xref="A1.E17.m1.1.1.1.1.5.3.4"></plus><apply id="A1.E17.m1.1.1.1.1.4.2.2.cmml" xref="A1.E17.m1.1.1.1.1.4.2.2"><times id="A1.E17.m1.1.1.1.1.4.2.2.3.cmml" xref="A1.E17.m1.1.1.1.1.4.2.2.3"></times><ci id="A1.E17.m1.1.1.1.1.4.2.2.4.cmml" xref="A1.E17.m1.1.1.1.1.4.2.2.4">𝑟</ci><interval closure="open" id="A1.E17.m1.1.1.1.1.4.2.2.2.3.cmml" xref="A1.E17.m1.1.1.1.1.4.2.2.2.2"><apply id="A1.E17.m1.1.1.1.1.3.1.1.1.1.1.cmml" xref="A1.E17.m1.1.1.1.1.3.1.1.1.1.1"><csymbol cd="ambiguous" id="A1.E17.m1.1.1.1.1.3.1.1.1.1.1.1.cmml" xref="A1.E17.m1.1.1.1.1.3.1.1.1.1.1">subscript</csymbol><ci id="A1.E17.m1.1.1.1.1.3.1.1.1.1.1.2.cmml" xref="A1.E17.m1.1.1.1.1.3.1.1.1.1.1.2">𝑠</ci><ci id="A1.E17.m1.1.1.1.1.3.1.1.1.1.1.3.cmml" xref="A1.E17.m1.1.1.1.1.3.1.1.1.1.1.3">𝑡</ci></apply><apply id="A1.E17.m1.1.1.1.1.4.2.2.2.2.2.cmml" xref="A1.E17.m1.1.1.1.1.4.2.2.2.2.2"><csymbol cd="ambiguous" id="A1.E17.m1.1.1.1.1.4.2.2.2.2.2.1.cmml" xref="A1.E17.m1.1.1.1.1.4.2.2.2.2.2">subscript</csymbol><ci id="A1.E17.m1.1.1.1.1.4.2.2.2.2.2.2.cmml" xref="A1.E17.m1.1.1.1.1.4.2.2.2.2.2.2">𝑎</ci><ci id="A1.E17.m1.1.1.1.1.4.2.2.2.2.2.3.cmml" xref="A1.E17.m1.1.1.1.1.4.2.2.2.2.2.3">𝑡</ci></apply></interval></apply><apply id="A1.E17.m1.1.1.1.1.5.3.3.cmml" xref="A1.E17.m1.1.1.1.1.5.3.3"><times id="A1.E17.m1.1.1.1.1.5.3.3.2.cmml" xref="A1.E17.m1.1.1.1.1.5.3.3.2"></times><ci id="A1.E17.m1.1.1.1.1.5.3.3.3.cmml" xref="A1.E17.m1.1.1.1.1.5.3.3.3">𝛾</ci><ci id="A1.E17.m1.1.1.1.1.5.3.3.4.cmml" xref="A1.E17.m1.1.1.1.1.5.3.3.4">Φ</ci><apply id="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.cmml" xref="A1.E17.m1.1.1.1.1.5.3.3.1.1"><csymbol cd="ambiguous" id="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.1.cmml" xref="A1.E17.m1.1.1.1.1.5.3.3.1.1">subscript</csymbol><ci id="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.2.cmml" xref="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.2">𝑠</ci><apply id="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.3.cmml" xref="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.3"><plus id="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.3.1.cmml" xref="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.3.1"></plus><ci id="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.3.2.cmml" xref="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.3.2">𝑡</ci><cn id="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.3.3.cmml" type="integer" xref="A1.E17.m1.1.1.1.1.5.3.3.1.1.1.3.3">1</cn></apply></apply></apply></apply><apply id="A1.E17.m1.1.1.1.1.6.4.cmml" xref="A1.E17.m1.1.1.1.1.6.4"><times id="A1.E17.m1.1.1.1.1.6.4.2.cmml" xref="A1.E17.m1.1.1.1.1.6.4.2"></times><ci id="A1.E17.m1.1.1.1.1.6.4.3.cmml" xref="A1.E17.m1.1.1.1.1.6.4.3">Φ</ci><apply id="A1.E17.m1.1.1.1.1.6.4.1.1.1.cmml" xref="A1.E17.m1.1.1.1.1.6.4.1.1"><csymbol cd="ambiguous" id="A1.E17.m1.1.1.1.1.6.4.1.1.1.1.cmml" xref="A1.E17.m1.1.1.1.1.6.4.1.1">subscript</csymbol><ci id="A1.E17.m1.1.1.1.1.6.4.1.1.1.2.cmml" xref="A1.E17.m1.1.1.1.1.6.4.1.1.1.2">𝑠</ci><ci id="A1.E17.m1.1.1.1.1.6.4.1.1.1.3.cmml" xref="A1.E17.m1.1.1.1.1.6.4.1.1.1.3">𝑡</ci></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="A1.E17.m1.1c">r^{\prime}(s_{t},a_{t})=r(s_{t},a_{t})+\gamma\Phi(s_{t+1})-\Phi(s_{t}),</annotation><annotation encoding="application/x-llamapun" id="A1.E17.m1.1d">italic_r start_POSTSUPERSCRIPT ′ end_POSTSUPERSCRIPT ( italic_s start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT , italic_a start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT ) = italic_r ( italic_s start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT , italic_a start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT ) + italic_γ roman_Φ ( italic_s start_POSTSUBSCRIPT italic_t + 1 end_POSTSUBSCRIPT ) - roman_Φ ( italic_s start_POSTSUBSCRIPT italic_t end_POSTSUBSCRIPT ) ,</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(17)</span></td>
</tr></tbody>
</table>
<p class="ltx_p" id="A1.Thmtheorem1.p1.6"><span class="ltx_text ltx_font_italic" id="A1.Thmtheorem1.p1.6.3">where <math alttext="\gamma" class="ltx_Math" display="inline" id="A1.Thmtheorem1.p1.4.1.m1.1"><semantics id="A1.Thmtheorem1.p1.4.1.m1.1a"><mi id="A1.Thmtheorem1.p1.4.1.m1.1.1" xref="A1.Thmtheorem1.p1.4.1.m1.1.1.cmml">γ</mi><annotation-xml encoding="MathML-Content" id="A1.Thmtheorem1.p1.4.1.m1.1b"><ci id="A1.Thmtheorem1.p1.4.1.m1.1.1.cmml" xref="A1.Thmtheorem1.p1.4.1.m1.1.1">𝛾</ci></annotation-xml><annotation encoding="application/x-tex" id="A1.Thmtheorem1.p1.4.1.m1.1c">\gamma</annotation><annotation encoding="application/x-llamapun" id="A1.Thmtheorem1.p1.4.1.m1.1d">italic_γ</annotation></semantics></math> is the discount factor, then the optimal policies under <math alttext="r" class="ltx_Math" display="inline" id="A1.Thmtheorem1.p1.5.2.m2.1"><semantics id="A1.Thmtheorem1.p1.5.2.m2.1a"><mi id="A1.Thmtheorem1.p1.5.2.m2.1.1" xref="A1.Thmtheorem1.p1.5.2.m2.1.1.cmml">r</mi><annotation-xml encoding="MathML-Content" id="A1.Thmtheorem1.p1.5.2.m2.1b"><ci id="A1.Thmtheorem1.p1.5.2.m2.1.1.cmml" xref="A1.Thmtheorem1.p1.5.2.m2.1.1">𝑟</ci></annotation-xml><annotation encoding="application/x-tex" id="A1.Thmtheorem1.p1.5.2.m2.1c">r</annotation><annotation encoding="application/x-llamapun" id="A1.Thmtheorem1.p1.5.2.m2.1d">italic_r</annotation></semantics></math> and <math alttext="r^{\prime}" class="ltx_Math" display="inline" id="A1.Thmtheorem1.p1.6.3.m3.1"><semantics id="A1.Thmtheorem1.p1.6.3.m3.1a"><msup id="A1.Thmtheorem1.p1.6.3.m3.1.1" xref="A1.Thmtheorem1.p1.6.3.m3.1.1.cmml"><mi id="A1.Thmtheorem1.p1.6.3.m3.1.1.2" xref="A1.Thmtheorem1.p1.6.3.m3.1.1.2.cmml">r</mi><mo id="A1.Thmtheorem1.p1.6.3.m3.1.1.3" xref="A1.Thmtheorem1.p1.6.3.m3.1.1.3.cmml">′</mo></msup><annotation-xml encoding="MathML-Content" id="A1.Thmtheorem1.p1.6.3.m3.1b"><apply id="A1.Thmtheorem1.p1.6.3.m3.1.1.cmml" xref="A1.Thmtheorem1.p1.6.3.m3.1.1"><csymbol cd="ambiguous" id="A1.Thmtheorem1.p1.6.3.m3.1.1.1.cmml" xref="A1.Thmtheorem1.p1.6.3.m3.1.1">superscript</csymbol><ci id="A1.Thmtheorem1.p1.6.3.m3.1.1.2.cmml" xref="A1.Thmtheorem1.p1.6.3.m3.1.1.2">𝑟</ci><ci id="A1.Thmtheorem1.p1.6.3.m3.1.1.3.cmml" xref="A1.Thmtheorem1.p1.6.3.m3.1.1.3">′</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="A1.Thmtheorem1.p1.6.3.m3.1c">r^{\prime}</annotation><annotation encoding="application/x-llamapun" id="A1.Thmtheorem1.p1.6.3.m3.1d">italic_r start_POSTSUPERSCRIPT ′ end_POSTSUPERSCRIPT</annotation></semantics></math> are identical.</span></p>
</div>
</div>
<div class="ltx_para" id="A1.2.p2">
<p class="ltx_p" id="A1.2.p2.4">Now, consider the outcome-based reward:</p>
<table class="ltx_equation ltx_eqn_table" id="A1.Ex3">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="r^{\text{terminal}}_{i,t}=\begin{cases}\varphi(J_{i}),&amp;\text{if }t\text{ is %
terminal},\\
0,&amp;\text{otherwise}.\end{cases}" class="ltx_Math" display="block" id="A1.Ex3.m1.6"><semantics id="A1.Ex3.m1.6a"><mrow id="A1.Ex3.m1.6.7" xref="A1.Ex3.m1.6.7.cmml"><msubsup id="A1.Ex3.m1.6.7.2" xref="A1.Ex3.m1.6.7.2.cmml"><mi id="A1.Ex3.m1.6.7.2.2.2" xref="A1.Ex3.m1.6.7.2.2.2.cmml">r</mi><mrow id="A1.Ex3.m1.6.6.2.4" xref="A1.Ex3.m1.6.6.2.3.cmml"><mi id="A1.Ex3.m1.5.5.1.1" xref="A1.Ex3.m1.5.5.1.1.cmml">i</mi><mo id="A1.Ex3.m1.6.6.2.4.1" xref="A1.Ex3.m1.6.6.2.3.cmml">,</mo><mi id="A1.Ex3.m1.6.6.2.2" xref="A1.Ex3.m1.6.6.2.2.cmml">t</mi></mrow><mtext id="A1.Ex3.m1.6.7.2.2.3" xref="A1.Ex3.m1.6.7.2.2.3a.cmml">terminal</mtext></msubsup><mo id="A1.Ex3.m1.6.7.1" xref="A1.Ex3.m1.6.7.1.cmml">=</mo><mrow id="A1.Ex3.m1.4.4" xref="A1.Ex3.m1.6.7.3.1.cmml"><mo id="A1.Ex3.m1.4.4.5" xref="A1.Ex3.m1.6.7.3.1.1.cmml">{</mo><mtable columnspacing="5pt" displaystyle="true" id="A1.Ex3.m1.4.4.4" rowspacing="0pt" xref="A1.Ex3.m1.6.7.3.1.cmml"><mtr id="A1.Ex3.m1.4.4.4a" xref="A1.Ex3.m1.6.7.3.1.cmml"><mtd class="ltx_align_left" columnalign="left" id="A1.Ex3.m1.4.4.4b" xref="A1.Ex3.m1.6.7.3.1.cmml"><mrow id="A1.Ex3.m1.1.1.1.1.1.1.1" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.cmml"><mrow id="A1.Ex3.m1.1.1.1.1.1.1.1.1" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.cmml"><mi id="A1.Ex3.m1.1.1.1.1.1.1.1.1.3" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.3.cmml">φ</mi><mo id="A1.Ex3.m1.1.1.1.1.1.1.1.1.2" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.2.cmml">⁢</mo><mrow id="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.1.cmml"><mo id="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.2" stretchy="false" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.1.cmml">(</mo><msub id="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.1" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.1.cmml"><mi id="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.1.2" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.1.2.cmml">J</mi><mi id="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.1.3" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.1.3.cmml">i</mi></msub><mo id="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.3" stretchy="false" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="A1.Ex3.m1.1.1.1.1.1.1.1.2" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.cmml">,</mo></mrow></mtd><mtd class="ltx_align_left" columnalign="left" id="A1.Ex3.m1.4.4.4c" xref="A1.Ex3.m1.6.7.3.1.cmml"><mrow id="A1.Ex3.m1.2.2.2.2.2.1.1" xref="A1.Ex3.m1.2.2.2.2.2.1.1.1.cmml"><mrow id="A1.Ex3.m1.2.2.2.2.2.1.1.1" xref="A1.Ex3.m1.2.2.2.2.2.1.1.1.cmml"><mtext id="A1.Ex3.m1.2.2.2.2.2.1.1.1.2" xref="A1.Ex3.m1.2.2.2.2.2.1.1.1.2a.cmml">if </mtext><mo id="A1.Ex3.m1.2.2.2.2.2.1.1.1.1" xref="A1.Ex3.m1.2.2.2.2.2.1.1.1.1.cmml">⁢</mo><mi id="A1.Ex3.m1.2.2.2.2.2.1.1.1.3" xref="A1.Ex3.m1.2.2.2.2.2.1.1.1.3.cmml">t</mi><mo id="A1.Ex3.m1.2.2.2.2.2.1.1.1.1a" xref="A1.Ex3.m1.2.2.2.2.2.1.1.1.1.cmml">⁢</mo><mtext id="A1.Ex3.m1.2.2.2.2.2.1.1.1.4" xref="A1.Ex3.m1.2.2.2.2.2.1.1.1.4a.cmml"> is terminal</mtext></mrow><mo id="A1.Ex3.m1.2.2.2.2.2.1.1.2" xref="A1.Ex3.m1.2.2.2.2.2.1.1.1.cmml">,</mo></mrow></mtd></mtr><mtr id="A1.Ex3.m1.4.4.4d" xref="A1.Ex3.m1.6.7.3.1.cmml"><mtd class="ltx_align_left" columnalign="left" id="A1.Ex3.m1.4.4.4e" xref="A1.Ex3.m1.6.7.3.1.cmml"><mrow id="A1.Ex3.m1.3.3.3.3.1.1.3" xref="A1.Ex3.m1.6.7.3.1.cmml"><mn id="A1.Ex3.m1.3.3.3.3.1.1.1" xref="A1.Ex3.m1.3.3.3.3.1.1.1.cmml">0</mn><mo id="A1.Ex3.m1.3.3.3.3.1.1.3.1" xref="A1.Ex3.m1.6.7.3.1.cmml">,</mo></mrow></mtd><mtd class="ltx_align_left" columnalign="left" id="A1.Ex3.m1.4.4.4f" xref="A1.Ex3.m1.6.7.3.1.cmml"><mrow id="A1.Ex3.m1.4.4.4.4.2.1.3" xref="A1.Ex3.m1.4.4.4.4.2.1.1a.cmml"><mtext id="A1.Ex3.m1.4.4.4.4.2.1.1" xref="A1.Ex3.m1.4.4.4.4.2.1.1.cmml">otherwise</mtext><mo id="A1.Ex3.m1.4.4.4.4.2.1.3.1" lspace="0em" xref="A1.Ex3.m1.4.4.4.4.2.1.1a.cmml">.</mo></mrow></mtd></mtr></mtable></mrow></mrow><annotation-xml encoding="MathML-Content" id="A1.Ex3.m1.6b"><apply id="A1.Ex3.m1.6.7.cmml" xref="A1.Ex3.m1.6.7"><eq id="A1.Ex3.m1.6.7.1.cmml" xref="A1.Ex3.m1.6.7.1"></eq><apply id="A1.Ex3.m1.6.7.2.cmml" xref="A1.Ex3.m1.6.7.2"><csymbol cd="ambiguous" id="A1.Ex3.m1.6.7.2.1.cmml" xref="A1.Ex3.m1.6.7.2">subscript</csymbol><apply id="A1.Ex3.m1.6.7.2.2.cmml" xref="A1.Ex3.m1.6.7.2"><csymbol cd="ambiguous" id="A1.Ex3.m1.6.7.2.2.1.cmml" xref="A1.Ex3.m1.6.7.2">superscript</csymbol><ci id="A1.Ex3.m1.6.7.2.2.2.cmml" xref="A1.Ex3.m1.6.7.2.2.2">𝑟</ci><ci id="A1.Ex3.m1.6.7.2.2.3a.cmml" xref="A1.Ex3.m1.6.7.2.2.3"><mtext id="A1.Ex3.m1.6.7.2.2.3.cmml" mathsize="70%" xref="A1.Ex3.m1.6.7.2.2.3">terminal</mtext></ci></apply><list id="A1.Ex3.m1.6.6.2.3.cmml" xref="A1.Ex3.m1.6.6.2.4"><ci id="A1.Ex3.m1.5.5.1.1.cmml" xref="A1.Ex3.m1.5.5.1.1">𝑖</ci><ci id="A1.Ex3.m1.6.6.2.2.cmml" xref="A1.Ex3.m1.6.6.2.2">𝑡</ci></list></apply><apply id="A1.Ex3.m1.6.7.3.1.cmml" xref="A1.Ex3.m1.4.4"><csymbol cd="latexml" id="A1.Ex3.m1.6.7.3.1.1.cmml" xref="A1.Ex3.m1.4.4.5">cases</csymbol><apply id="A1.Ex3.m1.1.1.1.1.1.1.1.1.cmml" xref="A1.Ex3.m1.1.1.1.1.1.1.1"><times id="A1.Ex3.m1.1.1.1.1.1.1.1.1.2.cmml" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.2"></times><ci id="A1.Ex3.m1.1.1.1.1.1.1.1.1.3.cmml" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.3">𝜑</ci><apply id="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1">subscript</csymbol><ci id="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.1.2.cmml" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.1.2">𝐽</ci><ci id="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.1.3.cmml" xref="A1.Ex3.m1.1.1.1.1.1.1.1.1.1.1.1.3">𝑖</ci></apply></apply><apply id="A1.Ex3.m1.2.2.2.2.2.1.1.1.cmml" xref="A1.Ex3.m1.2.2.2.2.2.1.1"><times id="A1.Ex3.m1.2.2.2.2.2.1.1.1.1.cmml" xref="A1.Ex3.m1.2.2.2.2.2.1.1.1.1"></times><ci id="A1.Ex3.m1.2.2.2.2.2.1.1.1.2a.cmml" xref="A1.Ex3.m1.2.2.2.2.2.1.1.1.2"><mtext id="A1.Ex3.m1.2.2.2.2.2.1.1.1.2.cmml" xref="A1.Ex3.m1.2.2.2.2.2.1.1.1.2">if </mtext></ci><ci id="A1.Ex3.m1.2.2.2.2.2.1.1.1.3.cmml" xref="A1.Ex3.m1.2.2.2.2.2.1.1.1.3">𝑡</ci><ci id="A1.Ex3.m1.2.2.2.2.2.1.1.1.4a.cmml" xref="A1.Ex3.m1.2.2.2.2.2.1.1.1.4"><mtext id="A1.Ex3.m1.2.2.2.2.2.1.1.1.4.cmml" xref="A1.Ex3.m1.2.2.2.2.2.1.1.1.4"> is terminal</mtext></ci></apply><cn id="A1.Ex3.m1.3.3.3.3.1.1.1.cmml" type="integer" xref="A1.Ex3.m1.3.3.3.3.1.1.1">0</cn><ci id="A1.Ex3.m1.4.4.4.4.2.1.1a.cmml" xref="A1.Ex3.m1.4.4.4.4.2.1.3"><mtext id="A1.Ex3.m1.4.4.4.4.2.1.1.cmml" xref="A1.Ex3.m1.4.4.4.4.2.1.1">otherwise</mtext></ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="A1.Ex3.m1.6c">r^{\text{terminal}}_{i,t}=\begin{cases}\varphi(J_{i}),&amp;\text{if }t\text{ is %
terminal},\\
0,&amp;\text{otherwise}.\end{cases}</annotation><annotation encoding="application/x-llamapun" id="A1.Ex3.m1.6d">italic_r start_POSTSUPERSCRIPT terminal end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_i , italic_t end_POSTSUBSCRIPT = { start_ROW start_CELL italic_φ ( italic_J start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT ) , end_CELL start_CELL if italic_t is terminal , end_CELL end_ROW start_ROW start_CELL 0 , end_CELL start_CELL otherwise . end_CELL end_ROW</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
</tr></tbody>
</table>
<p class="ltx_p" id="A1.2.p2.5">We define the shaped step-wise reward as:</p>
<table class="ltx_equation ltx_eqn_table" id="A1.Ex4">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="r^{\text{step}}_{i,t}=\varphi(\text{step}(t))-\varphi(\text{step}(t)-1)." class="ltx_Math" display="block" id="A1.Ex4.m1.5"><semantics id="A1.Ex4.m1.5a"><mrow id="A1.Ex4.m1.5.5.1" xref="A1.Ex4.m1.5.5.1.1.cmml"><mrow id="A1.Ex4.m1.5.5.1.1" xref="A1.Ex4.m1.5.5.1.1.cmml"><msubsup id="A1.Ex4.m1.5.5.1.1.4" xref="A1.Ex4.m1.5.5.1.1.4.cmml"><mi id="A1.Ex4.m1.5.5.1.1.4.2.2" xref="A1.Ex4.m1.5.5.1.1.4.2.2.cmml">r</mi><mrow id="A1.Ex4.m1.2.2.2.4" xref="A1.Ex4.m1.2.2.2.3.cmml"><mi id="A1.Ex4.m1.1.1.1.1" xref="A1.Ex4.m1.1.1.1.1.cmml">i</mi><mo id="A1.Ex4.m1.2.2.2.4.1" xref="A1.Ex4.m1.2.2.2.3.cmml">,</mo><mi id="A1.Ex4.m1.2.2.2.2" xref="A1.Ex4.m1.2.2.2.2.cmml">t</mi></mrow><mtext id="A1.Ex4.m1.5.5.1.1.4.2.3" xref="A1.Ex4.m1.5.5.1.1.4.2.3a.cmml">step</mtext></msubsup><mo id="A1.Ex4.m1.5.5.1.1.3" xref="A1.Ex4.m1.5.5.1.1.3.cmml">=</mo><mrow id="A1.Ex4.m1.5.5.1.1.2" xref="A1.Ex4.m1.5.5.1.1.2.cmml"><mrow id="A1.Ex4.m1.5.5.1.1.1.1" xref="A1.Ex4.m1.5.5.1.1.1.1.cmml"><mi id="A1.Ex4.m1.5.5.1.1.1.1.3" xref="A1.Ex4.m1.5.5.1.1.1.1.3.cmml">φ</mi><mo id="A1.Ex4.m1.5.5.1.1.1.1.2" xref="A1.Ex4.m1.5.5.1.1.1.1.2.cmml">⁢</mo><mrow id="A1.Ex4.m1.5.5.1.1.1.1.1.1" xref="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.cmml"><mo id="A1.Ex4.m1.5.5.1.1.1.1.1.1.2" stretchy="false" xref="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.cmml">(</mo><mrow id="A1.Ex4.m1.5.5.1.1.1.1.1.1.1" xref="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.cmml"><mtext id="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.2" xref="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.2a.cmml">step</mtext><mo id="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.1" xref="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.1.cmml">⁢</mo><mrow id="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.3.2" xref="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.cmml"><mo id="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.3.2.1" stretchy="false" xref="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.cmml">(</mo><mi id="A1.Ex4.m1.3.3" xref="A1.Ex4.m1.3.3.cmml">t</mi><mo id="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.3.2.2" stretchy="false" xref="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="A1.Ex4.m1.5.5.1.1.1.1.1.1.3" stretchy="false" xref="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="A1.Ex4.m1.5.5.1.1.2.3" xref="A1.Ex4.m1.5.5.1.1.2.3.cmml">−</mo><mrow id="A1.Ex4.m1.5.5.1.1.2.2" xref="A1.Ex4.m1.5.5.1.1.2.2.cmml"><mi id="A1.Ex4.m1.5.5.1.1.2.2.3" xref="A1.Ex4.m1.5.5.1.1.2.2.3.cmml">φ</mi><mo id="A1.Ex4.m1.5.5.1.1.2.2.2" xref="A1.Ex4.m1.5.5.1.1.2.2.2.cmml">⁢</mo><mrow id="A1.Ex4.m1.5.5.1.1.2.2.1.1" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.cmml"><mo id="A1.Ex4.m1.5.5.1.1.2.2.1.1.2" stretchy="false" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.cmml">(</mo><mrow id="A1.Ex4.m1.5.5.1.1.2.2.1.1.1" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.cmml"><mrow id="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.cmml"><mtext id="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.2" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.2a.cmml">step</mtext><mo id="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.1" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.1.cmml">⁢</mo><mrow id="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.3.2" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.cmml"><mo id="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.3.2.1" stretchy="false" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.cmml">(</mo><mi id="A1.Ex4.m1.4.4" xref="A1.Ex4.m1.4.4.cmml">t</mi><mo id="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.3.2.2" stretchy="false" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.cmml">)</mo></mrow></mrow><mo id="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.1" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.1.cmml">−</mo><mn id="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.3" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.3.cmml">1</mn></mrow><mo id="A1.Ex4.m1.5.5.1.1.2.2.1.1.3" stretchy="false" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.cmml">)</mo></mrow></mrow></mrow></mrow><mo id="A1.Ex4.m1.5.5.1.2" lspace="0em" xref="A1.Ex4.m1.5.5.1.1.cmml">.</mo></mrow><annotation-xml encoding="MathML-Content" id="A1.Ex4.m1.5b"><apply id="A1.Ex4.m1.5.5.1.1.cmml" xref="A1.Ex4.m1.5.5.1"><eq id="A1.Ex4.m1.5.5.1.1.3.cmml" xref="A1.Ex4.m1.5.5.1.1.3"></eq><apply id="A1.Ex4.m1.5.5.1.1.4.cmml" xref="A1.Ex4.m1.5.5.1.1.4"><csymbol cd="ambiguous" id="A1.Ex4.m1.5.5.1.1.4.1.cmml" xref="A1.Ex4.m1.5.5.1.1.4">subscript</csymbol><apply id="A1.Ex4.m1.5.5.1.1.4.2.cmml" xref="A1.Ex4.m1.5.5.1.1.4"><csymbol cd="ambiguous" id="A1.Ex4.m1.5.5.1.1.4.2.1.cmml" xref="A1.Ex4.m1.5.5.1.1.4">superscript</csymbol><ci id="A1.Ex4.m1.5.5.1.1.4.2.2.cmml" xref="A1.Ex4.m1.5.5.1.1.4.2.2">𝑟</ci><ci id="A1.Ex4.m1.5.5.1.1.4.2.3a.cmml" xref="A1.Ex4.m1.5.5.1.1.4.2.3"><mtext id="A1.Ex4.m1.5.5.1.1.4.2.3.cmml" mathsize="70%" xref="A1.Ex4.m1.5.5.1.1.4.2.3">step</mtext></ci></apply><list id="A1.Ex4.m1.2.2.2.3.cmml" xref="A1.Ex4.m1.2.2.2.4"><ci id="A1.Ex4.m1.1.1.1.1.cmml" xref="A1.Ex4.m1.1.1.1.1">𝑖</ci><ci id="A1.Ex4.m1.2.2.2.2.cmml" xref="A1.Ex4.m1.2.2.2.2">𝑡</ci></list></apply><apply id="A1.Ex4.m1.5.5.1.1.2.cmml" xref="A1.Ex4.m1.5.5.1.1.2"><minus id="A1.Ex4.m1.5.5.1.1.2.3.cmml" xref="A1.Ex4.m1.5.5.1.1.2.3"></minus><apply id="A1.Ex4.m1.5.5.1.1.1.1.cmml" xref="A1.Ex4.m1.5.5.1.1.1.1"><times id="A1.Ex4.m1.5.5.1.1.1.1.2.cmml" xref="A1.Ex4.m1.5.5.1.1.1.1.2"></times><ci id="A1.Ex4.m1.5.5.1.1.1.1.3.cmml" xref="A1.Ex4.m1.5.5.1.1.1.1.3">𝜑</ci><apply id="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.cmml" xref="A1.Ex4.m1.5.5.1.1.1.1.1.1"><times id="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.1.cmml" xref="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.1"></times><ci id="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.2a.cmml" xref="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.2"><mtext id="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.2.cmml" xref="A1.Ex4.m1.5.5.1.1.1.1.1.1.1.2">step</mtext></ci><ci id="A1.Ex4.m1.3.3.cmml" xref="A1.Ex4.m1.3.3">𝑡</ci></apply></apply><apply id="A1.Ex4.m1.5.5.1.1.2.2.cmml" xref="A1.Ex4.m1.5.5.1.1.2.2"><times id="A1.Ex4.m1.5.5.1.1.2.2.2.cmml" xref="A1.Ex4.m1.5.5.1.1.2.2.2"></times><ci id="A1.Ex4.m1.5.5.1.1.2.2.3.cmml" xref="A1.Ex4.m1.5.5.1.1.2.2.3">𝜑</ci><apply id="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.cmml" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1"><minus id="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.1.cmml" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.1"></minus><apply id="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.cmml" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2"><times id="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.1.cmml" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.1"></times><ci id="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.2a.cmml" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.2"><mtext id="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.2.cmml" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.2.2">step</mtext></ci><ci id="A1.Ex4.m1.4.4.cmml" xref="A1.Ex4.m1.4.4">𝑡</ci></apply><cn id="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.3.cmml" type="integer" xref="A1.Ex4.m1.5.5.1.1.2.2.1.1.1.3">1</cn></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="A1.Ex4.m1.5c">r^{\text{step}}_{i,t}=\varphi(\text{step}(t))-\varphi(\text{step}(t)-1).</annotation><annotation encoding="application/x-llamapun" id="A1.Ex4.m1.5d">italic_r start_POSTSUPERSCRIPT step end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_i , italic_t end_POSTSUBSCRIPT = italic_φ ( step ( italic_t ) ) - italic_φ ( step ( italic_t ) - 1 ) .</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
</tr></tbody>
</table>
<p class="ltx_p" id="A1.2.p2.1">Let us define a potential function <math alttext="\Phi(t)=\varphi(\text{step}(t))" class="ltx_Math" display="inline" id="A1.2.p2.1.m1.3"><semantics id="A1.2.p2.1.m1.3a"><mrow id="A1.2.p2.1.m1.3.3" xref="A1.2.p2.1.m1.3.3.cmml"><mrow id="A1.2.p2.1.m1.3.3.3" xref="A1.2.p2.1.m1.3.3.3.cmml"><mi id="A1.2.p2.1.m1.3.3.3.2" mathvariant="normal" xref="A1.2.p2.1.m1.3.3.3.2.cmml">Φ</mi><mo id="A1.2.p2.1.m1.3.3.3.1" xref="A1.2.p2.1.m1.3.3.3.1.cmml">⁢</mo><mrow id="A1.2.p2.1.m1.3.3.3.3.2" xref="A1.2.p2.1.m1.3.3.3.cmml"><mo id="A1.2.p2.1.m1.3.3.3.3.2.1" stretchy="false" xref="A1.2.p2.1.m1.3.3.3.cmml">(</mo><mi id="A1.2.p2.1.m1.1.1" xref="A1.2.p2.1.m1.1.1.cmml">t</mi><mo id="A1.2.p2.1.m1.3.3.3.3.2.2" stretchy="false" xref="A1.2.p2.1.m1.3.3.3.cmml">)</mo></mrow></mrow><mo id="A1.2.p2.1.m1.3.3.2" xref="A1.2.p2.1.m1.3.3.2.cmml">=</mo><mrow id="A1.2.p2.1.m1.3.3.1" xref="A1.2.p2.1.m1.3.3.1.cmml"><mi id="A1.2.p2.1.m1.3.3.1.3" xref="A1.2.p2.1.m1.3.3.1.3.cmml">φ</mi><mo id="A1.2.p2.1.m1.3.3.1.2" xref="A1.2.p2.1.m1.3.3.1.2.cmml">⁢</mo><mrow id="A1.2.p2.1.m1.3.3.1.1.1" xref="A1.2.p2.1.m1.3.3.1.1.1.1.cmml"><mo id="A1.2.p2.1.m1.3.3.1.1.1.2" stretchy="false" xref="A1.2.p2.1.m1.3.3.1.1.1.1.cmml">(</mo><mrow id="A1.2.p2.1.m1.3.3.1.1.1.1" xref="A1.2.p2.1.m1.3.3.1.1.1.1.cmml"><mtext id="A1.2.p2.1.m1.3.3.1.1.1.1.2" xref="A1.2.p2.1.m1.3.3.1.1.1.1.2a.cmml">step</mtext><mo id="A1.2.p2.1.m1.3.3.1.1.1.1.1" xref="A1.2.p2.1.m1.3.3.1.1.1.1.1.cmml">⁢</mo><mrow id="A1.2.p2.1.m1.3.3.1.1.1.1.3.2" xref="A1.2.p2.1.m1.3.3.1.1.1.1.cmml"><mo id="A1.2.p2.1.m1.3.3.1.1.1.1.3.2.1" stretchy="false" xref="A1.2.p2.1.m1.3.3.1.1.1.1.cmml">(</mo><mi id="A1.2.p2.1.m1.2.2" xref="A1.2.p2.1.m1.2.2.cmml">t</mi><mo id="A1.2.p2.1.m1.3.3.1.1.1.1.3.2.2" stretchy="false" xref="A1.2.p2.1.m1.3.3.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="A1.2.p2.1.m1.3.3.1.1.1.3" stretchy="false" xref="A1.2.p2.1.m1.3.3.1.1.1.1.cmml">)</mo></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="A1.2.p2.1.m1.3b"><apply id="A1.2.p2.1.m1.3.3.cmml" xref="A1.2.p2.1.m1.3.3"><eq id="A1.2.p2.1.m1.3.3.2.cmml" xref="A1.2.p2.1.m1.3.3.2"></eq><apply id="A1.2.p2.1.m1.3.3.3.cmml" xref="A1.2.p2.1.m1.3.3.3"><times id="A1.2.p2.1.m1.3.3.3.1.cmml" xref="A1.2.p2.1.m1.3.3.3.1"></times><ci id="A1.2.p2.1.m1.3.3.3.2.cmml" xref="A1.2.p2.1.m1.3.3.3.2">Φ</ci><ci id="A1.2.p2.1.m1.1.1.cmml" xref="A1.2.p2.1.m1.1.1">𝑡</ci></apply><apply id="A1.2.p2.1.m1.3.3.1.cmml" xref="A1.2.p2.1.m1.3.3.1"><times id="A1.2.p2.1.m1.3.3.1.2.cmml" xref="A1.2.p2.1.m1.3.3.1.2"></times><ci id="A1.2.p2.1.m1.3.3.1.3.cmml" xref="A1.2.p2.1.m1.3.3.1.3">𝜑</ci><apply id="A1.2.p2.1.m1.3.3.1.1.1.1.cmml" xref="A1.2.p2.1.m1.3.3.1.1.1"><times id="A1.2.p2.1.m1.3.3.1.1.1.1.1.cmml" xref="A1.2.p2.1.m1.3.3.1.1.1.1.1"></times><ci id="A1.2.p2.1.m1.3.3.1.1.1.1.2a.cmml" xref="A1.2.p2.1.m1.3.3.1.1.1.1.2"><mtext id="A1.2.p2.1.m1.3.3.1.1.1.1.2.cmml" xref="A1.2.p2.1.m1.3.3.1.1.1.1.2">step</mtext></ci><ci id="A1.2.p2.1.m1.2.2.cmml" xref="A1.2.p2.1.m1.2.2">𝑡</ci></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="A1.2.p2.1.m1.3c">\Phi(t)=\varphi(\text{step}(t))</annotation><annotation encoding="application/x-llamapun" id="A1.2.p2.1.m1.3d">roman_Φ ( italic_t ) = italic_φ ( step ( italic_t ) )</annotation></semantics></math>. Then the step-wise reward can be rewritten as:</p>
<table class="ltx_equation ltx_eqn_table" id="A1.Ex5">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="r^{\text{step}}_{i,t}=\Phi(t)-\Phi(t-1)." class="ltx_Math" display="block" id="A1.Ex5.m1.4"><semantics id="A1.Ex5.m1.4a"><mrow id="A1.Ex5.m1.4.4.1" xref="A1.Ex5.m1.4.4.1.1.cmml"><mrow id="A1.Ex5.m1.4.4.1.1" xref="A1.Ex5.m1.4.4.1.1.cmml"><msubsup id="A1.Ex5.m1.4.4.1.1.3" xref="A1.Ex5.m1.4.4.1.1.3.cmml"><mi id="A1.Ex5.m1.4.4.1.1.3.2.2" xref="A1.Ex5.m1.4.4.1.1.3.2.2.cmml">r</mi><mrow id="A1.Ex5.m1.2.2.2.4" xref="A1.Ex5.m1.2.2.2.3.cmml"><mi id="A1.Ex5.m1.1.1.1.1" xref="A1.Ex5.m1.1.1.1.1.cmml">i</mi><mo id="A1.Ex5.m1.2.2.2.4.1" xref="A1.Ex5.m1.2.2.2.3.cmml">,</mo><mi id="A1.Ex5.m1.2.2.2.2" xref="A1.Ex5.m1.2.2.2.2.cmml">t</mi></mrow><mtext id="A1.Ex5.m1.4.4.1.1.3.2.3" xref="A1.Ex5.m1.4.4.1.1.3.2.3a.cmml">step</mtext></msubsup><mo id="A1.Ex5.m1.4.4.1.1.2" xref="A1.Ex5.m1.4.4.1.1.2.cmml">=</mo><mrow id="A1.Ex5.m1.4.4.1.1.1" xref="A1.Ex5.m1.4.4.1.1.1.cmml"><mrow id="A1.Ex5.m1.4.4.1.1.1.3" xref="A1.Ex5.m1.4.4.1.1.1.3.cmml"><mi id="A1.Ex5.m1.4.4.1.1.1.3.2" mathvariant="normal" xref="A1.Ex5.m1.4.4.1.1.1.3.2.cmml">Φ</mi><mo id="A1.Ex5.m1.4.4.1.1.1.3.1" xref="A1.Ex5.m1.4.4.1.1.1.3.1.cmml">⁢</mo><mrow id="A1.Ex5.m1.4.4.1.1.1.3.3.2" xref="A1.Ex5.m1.4.4.1.1.1.3.cmml"><mo id="A1.Ex5.m1.4.4.1.1.1.3.3.2.1" stretchy="false" xref="A1.Ex5.m1.4.4.1.1.1.3.cmml">(</mo><mi id="A1.Ex5.m1.3.3" xref="A1.Ex5.m1.3.3.cmml">t</mi><mo id="A1.Ex5.m1.4.4.1.1.1.3.3.2.2" stretchy="false" xref="A1.Ex5.m1.4.4.1.1.1.3.cmml">)</mo></mrow></mrow><mo id="A1.Ex5.m1.4.4.1.1.1.2" xref="A1.Ex5.m1.4.4.1.1.1.2.cmml">−</mo><mrow id="A1.Ex5.m1.4.4.1.1.1.1" xref="A1.Ex5.m1.4.4.1.1.1.1.cmml"><mi id="A1.Ex5.m1.4.4.1.1.1.1.3" mathvariant="normal" xref="A1.Ex5.m1.4.4.1.1.1.1.3.cmml">Φ</mi><mo id="A1.Ex5.m1.4.4.1.1.1.1.2" xref="A1.Ex5.m1.4.4.1.1.1.1.2.cmml">⁢</mo><mrow id="A1.Ex5.m1.4.4.1.1.1.1.1.1" xref="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.cmml"><mo id="A1.Ex5.m1.4.4.1.1.1.1.1.1.2" stretchy="false" xref="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.cmml">(</mo><mrow id="A1.Ex5.m1.4.4.1.1.1.1.1.1.1" xref="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.cmml"><mi id="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.2" xref="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.2.cmml">t</mi><mo id="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.1" xref="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.1.cmml">−</mo><mn id="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.3" xref="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.3.cmml">1</mn></mrow><mo id="A1.Ex5.m1.4.4.1.1.1.1.1.1.3" stretchy="false" xref="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.cmml">)</mo></mrow></mrow></mrow></mrow><mo id="A1.Ex5.m1.4.4.1.2" lspace="0em" xref="A1.Ex5.m1.4.4.1.1.cmml">.</mo></mrow><annotation-xml encoding="MathML-Content" id="A1.Ex5.m1.4b"><apply id="A1.Ex5.m1.4.4.1.1.cmml" xref="A1.Ex5.m1.4.4.1"><eq id="A1.Ex5.m1.4.4.1.1.2.cmml" xref="A1.Ex5.m1.4.4.1.1.2"></eq><apply id="A1.Ex5.m1.4.4.1.1.3.cmml" xref="A1.Ex5.m1.4.4.1.1.3"><csymbol cd="ambiguous" id="A1.Ex5.m1.4.4.1.1.3.1.cmml" xref="A1.Ex5.m1.4.4.1.1.3">subscript</csymbol><apply id="A1.Ex5.m1.4.4.1.1.3.2.cmml" xref="A1.Ex5.m1.4.4.1.1.3"><csymbol cd="ambiguous" id="A1.Ex5.m1.4.4.1.1.3.2.1.cmml" xref="A1.Ex5.m1.4.4.1.1.3">superscript</csymbol><ci id="A1.Ex5.m1.4.4.1.1.3.2.2.cmml" xref="A1.Ex5.m1.4.4.1.1.3.2.2">𝑟</ci><ci id="A1.Ex5.m1.4.4.1.1.3.2.3a.cmml" xref="A1.Ex5.m1.4.4.1.1.3.2.3"><mtext id="A1.Ex5.m1.4.4.1.1.3.2.3.cmml" mathsize="70%" xref="A1.Ex5.m1.4.4.1.1.3.2.3">step</mtext></ci></apply><list id="A1.Ex5.m1.2.2.2.3.cmml" xref="A1.Ex5.m1.2.2.2.4"><ci id="A1.Ex5.m1.1.1.1.1.cmml" xref="A1.Ex5.m1.1.1.1.1">𝑖</ci><ci id="A1.Ex5.m1.2.2.2.2.cmml" xref="A1.Ex5.m1.2.2.2.2">𝑡</ci></list></apply><apply id="A1.Ex5.m1.4.4.1.1.1.cmml" xref="A1.Ex5.m1.4.4.1.1.1"><minus id="A1.Ex5.m1.4.4.1.1.1.2.cmml" xref="A1.Ex5.m1.4.4.1.1.1.2"></minus><apply id="A1.Ex5.m1.4.4.1.1.1.3.cmml" xref="A1.Ex5.m1.4.4.1.1.1.3"><times id="A1.Ex5.m1.4.4.1.1.1.3.1.cmml" xref="A1.Ex5.m1.4.4.1.1.1.3.1"></times><ci id="A1.Ex5.m1.4.4.1.1.1.3.2.cmml" xref="A1.Ex5.m1.4.4.1.1.1.3.2">Φ</ci><ci id="A1.Ex5.m1.3.3.cmml" xref="A1.Ex5.m1.3.3">𝑡</ci></apply><apply id="A1.Ex5.m1.4.4.1.1.1.1.cmml" xref="A1.Ex5.m1.4.4.1.1.1.1"><times id="A1.Ex5.m1.4.4.1.1.1.1.2.cmml" xref="A1.Ex5.m1.4.4.1.1.1.1.2"></times><ci id="A1.Ex5.m1.4.4.1.1.1.1.3.cmml" xref="A1.Ex5.m1.4.4.1.1.1.1.3">Φ</ci><apply id="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.cmml" xref="A1.Ex5.m1.4.4.1.1.1.1.1.1"><minus id="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.1.cmml" xref="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.1"></minus><ci id="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.2.cmml" xref="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.2">𝑡</ci><cn id="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.3.cmml" type="integer" xref="A1.Ex5.m1.4.4.1.1.1.1.1.1.1.3">1</cn></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="A1.Ex5.m1.4c">r^{\text{step}}_{i,t}=\Phi(t)-\Phi(t-1).</annotation><annotation encoding="application/x-llamapun" id="A1.Ex5.m1.4d">italic_r start_POSTSUPERSCRIPT step end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_i , italic_t end_POSTSUBSCRIPT = roman_Φ ( italic_t ) - roman_Φ ( italic_t - 1 ) .</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
</tr></tbody>
</table>
<p class="ltx_p" id="A1.2.p2.6">Summing over the episode:</p>
<table class="ltx_equation ltx_eqn_table" id="A1.Ex6">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\sum_{t=1}^{T}r^{\text{step}}_{i,t}=\Phi(T)-\Phi(0)=\varphi(J_{i})-\varphi(0)," class="ltx_Math" display="block" id="A1.Ex6.m1.6"><semantics id="A1.Ex6.m1.6a"><mrow id="A1.Ex6.m1.6.6.1" xref="A1.Ex6.m1.6.6.1.1.cmml"><mrow id="A1.Ex6.m1.6.6.1.1" xref="A1.Ex6.m1.6.6.1.1.cmml"><mrow id="A1.Ex6.m1.6.6.1.1.3" xref="A1.Ex6.m1.6.6.1.1.3.cmml"><munderover id="A1.Ex6.m1.6.6.1.1.3.1" xref="A1.Ex6.m1.6.6.1.1.3.1.cmml"><mo id="A1.Ex6.m1.6.6.1.1.3.1.2.2" movablelimits="false" xref="A1.Ex6.m1.6.6.1.1.3.1.2.2.cmml">∑</mo><mrow id="A1.Ex6.m1.6.6.1.1.3.1.2.3" xref="A1.Ex6.m1.6.6.1.1.3.1.2.3.cmml"><mi id="A1.Ex6.m1.6.6.1.1.3.1.2.3.2" xref="A1.Ex6.m1.6.6.1.1.3.1.2.3.2.cmml">t</mi><mo id="A1.Ex6.m1.6.6.1.1.3.1.2.3.1" xref="A1.Ex6.m1.6.6.1.1.3.1.2.3.1.cmml">=</mo><mn id="A1.Ex6.m1.6.6.1.1.3.1.2.3.3" xref="A1.Ex6.m1.6.6.1.1.3.1.2.3.3.cmml">1</mn></mrow><mi id="A1.Ex6.m1.6.6.1.1.3.1.3" xref="A1.Ex6.m1.6.6.1.1.3.1.3.cmml">T</mi></munderover><msubsup id="A1.Ex6.m1.6.6.1.1.3.2" xref="A1.Ex6.m1.6.6.1.1.3.2.cmml"><mi id="A1.Ex6.m1.6.6.1.1.3.2.2.2" xref="A1.Ex6.m1.6.6.1.1.3.2.2.2.cmml">r</mi><mrow id="A1.Ex6.m1.2.2.2.4" xref="A1.Ex6.m1.2.2.2.3.cmml"><mi id="A1.Ex6.m1.1.1.1.1" xref="A1.Ex6.m1.1.1.1.1.cmml">i</mi><mo id="A1.Ex6.m1.2.2.2.4.1" xref="A1.Ex6.m1.2.2.2.3.cmml">,</mo><mi id="A1.Ex6.m1.2.2.2.2" xref="A1.Ex6.m1.2.2.2.2.cmml">t</mi></mrow><mtext id="A1.Ex6.m1.6.6.1.1.3.2.2.3" xref="A1.Ex6.m1.6.6.1.1.3.2.2.3a.cmml">step</mtext></msubsup></mrow><mo id="A1.Ex6.m1.6.6.1.1.4" xref="A1.Ex6.m1.6.6.1.1.4.cmml">=</mo><mrow id="A1.Ex6.m1.6.6.1.1.5" xref="A1.Ex6.m1.6.6.1.1.5.cmml"><mrow id="A1.Ex6.m1.6.6.1.1.5.2" xref="A1.Ex6.m1.6.6.1.1.5.2.cmml"><mi id="A1.Ex6.m1.6.6.1.1.5.2.2" mathvariant="normal" xref="A1.Ex6.m1.6.6.1.1.5.2.2.cmml">Φ</mi><mo id="A1.Ex6.m1.6.6.1.1.5.2.1" xref="A1.Ex6.m1.6.6.1.1.5.2.1.cmml">⁢</mo><mrow id="A1.Ex6.m1.6.6.1.1.5.2.3.2" xref="A1.Ex6.m1.6.6.1.1.5.2.cmml"><mo id="A1.Ex6.m1.6.6.1.1.5.2.3.2.1" stretchy="false" xref="A1.Ex6.m1.6.6.1.1.5.2.cmml">(</mo><mi id="A1.Ex6.m1.3.3" xref="A1.Ex6.m1.3.3.cmml">T</mi><mo id="A1.Ex6.m1.6.6.1.1.5.2.3.2.2" stretchy="false" xref="A1.Ex6.m1.6.6.1.1.5.2.cmml">)</mo></mrow></mrow><mo id="A1.Ex6.m1.6.6.1.1.5.1" xref="A1.Ex6.m1.6.6.1.1.5.1.cmml">−</mo><mrow id="A1.Ex6.m1.6.6.1.1.5.3" xref="A1.Ex6.m1.6.6.1.1.5.3.cmml"><mi id="A1.Ex6.m1.6.6.1.1.5.3.2" mathvariant="normal" xref="A1.Ex6.m1.6.6.1.1.5.3.2.cmml">Φ</mi><mo id="A1.Ex6.m1.6.6.1.1.5.3.1" xref="A1.Ex6.m1.6.6.1.1.5.3.1.cmml">⁢</mo><mrow id="A1.Ex6.m1.6.6.1.1.5.3.3.2" xref="A1.Ex6.m1.6.6.1.1.5.3.cmml"><mo id="A1.Ex6.m1.6.6.1.1.5.3.3.2.1" stretchy="false" xref="A1.Ex6.m1.6.6.1.1.5.3.cmml">(</mo><mn id="A1.Ex6.m1.4.4" xref="A1.Ex6.m1.4.4.cmml">0</mn><mo id="A1.Ex6.m1.6.6.1.1.5.3.3.2.2" stretchy="false" xref="A1.Ex6.m1.6.6.1.1.5.3.cmml">)</mo></mrow></mrow></mrow><mo id="A1.Ex6.m1.6.6.1.1.6" xref="A1.Ex6.m1.6.6.1.1.6.cmml">=</mo><mrow id="A1.Ex6.m1.6.6.1.1.1" xref="A1.Ex6.m1.6.6.1.1.1.cmml"><mrow id="A1.Ex6.m1.6.6.1.1.1.1" xref="A1.Ex6.m1.6.6.1.1.1.1.cmml"><mi id="A1.Ex6.m1.6.6.1.1.1.1.3" xref="A1.Ex6.m1.6.6.1.1.1.1.3.cmml">φ</mi><mo id="A1.Ex6.m1.6.6.1.1.1.1.2" xref="A1.Ex6.m1.6.6.1.1.1.1.2.cmml">⁢</mo><mrow id="A1.Ex6.m1.6.6.1.1.1.1.1.1" xref="A1.Ex6.m1.6.6.1.1.1.1.1.1.1.cmml"><mo id="A1.Ex6.m1.6.6.1.1.1.1.1.1.2" stretchy="false" xref="A1.Ex6.m1.6.6.1.1.1.1.1.1.1.cmml">(</mo><msub id="A1.Ex6.m1.6.6.1.1.1.1.1.1.1" xref="A1.Ex6.m1.6.6.1.1.1.1.1.1.1.cmml"><mi id="A1.Ex6.m1.6.6.1.1.1.1.1.1.1.2" xref="A1.Ex6.m1.6.6.1.1.1.1.1.1.1.2.cmml">J</mi><mi id="A1.Ex6.m1.6.6.1.1.1.1.1.1.1.3" xref="A1.Ex6.m1.6.6.1.1.1.1.1.1.1.3.cmml">i</mi></msub><mo id="A1.Ex6.m1.6.6.1.1.1.1.1.1.3" stretchy="false" xref="A1.Ex6.m1.6.6.1.1.1.1.1.1.1.cmml">)</mo></mrow></mrow><mo id="A1.Ex6.m1.6.6.1.1.1.2" xref="A1.Ex6.m1.6.6.1.1.1.2.cmml">−</mo><mrow id="A1.Ex6.m1.6.6.1.1.1.3" xref="A1.Ex6.m1.6.6.1.1.1.3.cmml"><mi id="A1.Ex6.m1.6.6.1.1.1.3.2" xref="A1.Ex6.m1.6.6.1.1.1.3.2.cmml">φ</mi><mo id="A1.Ex6.m1.6.6.1.1.1.3.1" xref="A1.Ex6.m1.6.6.1.1.1.3.1.cmml">⁢</mo><mrow id="A1.Ex6.m1.6.6.1.1.1.3.3.2" xref="A1.Ex6.m1.6.6.1.1.1.3.cmml"><mo id="A1.Ex6.m1.6.6.1.1.1.3.3.2.1" stretchy="false" xref="A1.Ex6.m1.6.6.1.1.1.3.cmml">(</mo><mn id="A1.Ex6.m1.5.5" xref="A1.Ex6.m1.5.5.cmml">0</mn><mo id="A1.Ex6.m1.6.6.1.1.1.3.3.2.2" stretchy="false" xref="A1.Ex6.m1.6.6.1.1.1.3.cmml">)</mo></mrow></mrow></mrow></mrow><mo id="A1.Ex6.m1.6.6.1.2" xref="A1.Ex6.m1.6.6.1.1.cmml">,</mo></mrow><annotation-xml encoding="MathML-Content" id="A1.Ex6.m1.6b"><apply id="A1.Ex6.m1.6.6.1.1.cmml" xref="A1.Ex6.m1.6.6.1"><and id="A1.Ex6.m1.6.6.1.1a.cmml" xref="A1.Ex6.m1.6.6.1"></and><apply id="A1.Ex6.m1.6.6.1.1b.cmml" xref="A1.Ex6.m1.6.6.1"><eq id="A1.Ex6.m1.6.6.1.1.4.cmml" xref="A1.Ex6.m1.6.6.1.1.4"></eq><apply id="A1.Ex6.m1.6.6.1.1.3.cmml" xref="A1.Ex6.m1.6.6.1.1.3"><apply id="A1.Ex6.m1.6.6.1.1.3.1.cmml" xref="A1.Ex6.m1.6.6.1.1.3.1"><csymbol cd="ambiguous" id="A1.Ex6.m1.6.6.1.1.3.1.1.cmml" xref="A1.Ex6.m1.6.6.1.1.3.1">superscript</csymbol><apply id="A1.Ex6.m1.6.6.1.1.3.1.2.cmml" xref="A1.Ex6.m1.6.6.1.1.3.1"><csymbol cd="ambiguous" id="A1.Ex6.m1.6.6.1.1.3.1.2.1.cmml" xref="A1.Ex6.m1.6.6.1.1.3.1">subscript</csymbol><sum id="A1.Ex6.m1.6.6.1.1.3.1.2.2.cmml" xref="A1.Ex6.m1.6.6.1.1.3.1.2.2"></sum><apply id="A1.Ex6.m1.6.6.1.1.3.1.2.3.cmml" xref="A1.Ex6.m1.6.6.1.1.3.1.2.3"><eq id="A1.Ex6.m1.6.6.1.1.3.1.2.3.1.cmml" xref="A1.Ex6.m1.6.6.1.1.3.1.2.3.1"></eq><ci id="A1.Ex6.m1.6.6.1.1.3.1.2.3.2.cmml" xref="A1.Ex6.m1.6.6.1.1.3.1.2.3.2">𝑡</ci><cn id="A1.Ex6.m1.6.6.1.1.3.1.2.3.3.cmml" type="integer" xref="A1.Ex6.m1.6.6.1.1.3.1.2.3.3">1</cn></apply></apply><ci id="A1.Ex6.m1.6.6.1.1.3.1.3.cmml" xref="A1.Ex6.m1.6.6.1.1.3.1.3">𝑇</ci></apply><apply id="A1.Ex6.m1.6.6.1.1.3.2.cmml" xref="A1.Ex6.m1.6.6.1.1.3.2"><csymbol cd="ambiguous" id="A1.Ex6.m1.6.6.1.1.3.2.1.cmml" xref="A1.Ex6.m1.6.6.1.1.3.2">subscript</csymbol><apply id="A1.Ex6.m1.6.6.1.1.3.2.2.cmml" xref="A1.Ex6.m1.6.6.1.1.3.2"><csymbol cd="ambiguous" id="A1.Ex6.m1.6.6.1.1.3.2.2.1.cmml" xref="A1.Ex6.m1.6.6.1.1.3.2">superscript</csymbol><ci id="A1.Ex6.m1.6.6.1.1.3.2.2.2.cmml" xref="A1.Ex6.m1.6.6.1.1.3.2.2.2">𝑟</ci><ci id="A1.Ex6.m1.6.6.1.1.3.2.2.3a.cmml" xref="A1.Ex6.m1.6.6.1.1.3.2.2.3"><mtext id="A1.Ex6.m1.6.6.1.1.3.2.2.3.cmml" mathsize="70%" xref="A1.Ex6.m1.6.6.1.1.3.2.2.3">step</mtext></ci></apply><list id="A1.Ex6.m1.2.2.2.3.cmml" xref="A1.Ex6.m1.2.2.2.4"><ci id="A1.Ex6.m1.1.1.1.1.cmml" xref="A1.Ex6.m1.1.1.1.1">𝑖</ci><ci id="A1.Ex6.m1.2.2.2.2.cmml" xref="A1.Ex6.m1.2.2.2.2">𝑡</ci></list></apply></apply><apply id="A1.Ex6.m1.6.6.1.1.5.cmml" xref="A1.Ex6.m1.6.6.1.1.5"><minus id="A1.Ex6.m1.6.6.1.1.5.1.cmml" xref="A1.Ex6.m1.6.6.1.1.5.1"></minus><apply id="A1.Ex6.m1.6.6.1.1.5.2.cmml" xref="A1.Ex6.m1.6.6.1.1.5.2"><times id="A1.Ex6.m1.6.6.1.1.5.2.1.cmml" xref="A1.Ex6.m1.6.6.1.1.5.2.1"></times><ci id="A1.Ex6.m1.6.6.1.1.5.2.2.cmml" xref="A1.Ex6.m1.6.6.1.1.5.2.2">Φ</ci><ci id="A1.Ex6.m1.3.3.cmml" xref="A1.Ex6.m1.3.3">𝑇</ci></apply><apply id="A1.Ex6.m1.6.6.1.1.5.3.cmml" xref="A1.Ex6.m1.6.6.1.1.5.3"><times id="A1.Ex6.m1.6.6.1.1.5.3.1.cmml" xref="A1.Ex6.m1.6.6.1.1.5.3.1"></times><ci id="A1.Ex6.m1.6.6.1.1.5.3.2.cmml" xref="A1.Ex6.m1.6.6.1.1.5.3.2">Φ</ci><cn id="A1.Ex6.m1.4.4.cmml" type="integer" xref="A1.Ex6.m1.4.4">0</cn></apply></apply></apply><apply id="A1.Ex6.m1.6.6.1.1c.cmml" xref="A1.Ex6.m1.6.6.1"><eq id="A1.Ex6.m1.6.6.1.1.6.cmml" xref="A1.Ex6.m1.6.6.1.1.6"></eq><share href="https://arxiv.org/html/2505.20218v1#A1.Ex6.m1.6.6.1.1.5.cmml" id="A1.Ex6.m1.6.6.1.1d.cmml" xref="A1.Ex6.m1.6.6.1"></share><apply id="A1.Ex6.m1.6.6.1.1.1.cmml" xref="A1.Ex6.m1.6.6.1.1.1"><minus id="A1.Ex6.m1.6.6.1.1.1.2.cmml" xref="A1.Ex6.m1.6.6.1.1.1.2"></minus><apply id="A1.Ex6.m1.6.6.1.1.1.1.cmml" xref="A1.Ex6.m1.6.6.1.1.1.1"><times id="A1.Ex6.m1.6.6.1.1.1.1.2.cmml" xref="A1.Ex6.m1.6.6.1.1.1.1.2"></times><ci id="A1.Ex6.m1.6.6.1.1.1.1.3.cmml" xref="A1.Ex6.m1.6.6.1.1.1.1.3">𝜑</ci><apply id="A1.Ex6.m1.6.6.1.1.1.1.1.1.1.cmml" xref="A1.Ex6.m1.6.6.1.1.1.1.1.1"><csymbol cd="ambiguous" id="A1.Ex6.m1.6.6.1.1.1.1.1.1.1.1.cmml" xref="A1.Ex6.m1.6.6.1.1.1.1.1.1">subscript</csymbol><ci id="A1.Ex6.m1.6.6.1.1.1.1.1.1.1.2.cmml" xref="A1.Ex6.m1.6.6.1.1.1.1.1.1.1.2">𝐽</ci><ci id="A1.Ex6.m1.6.6.1.1.1.1.1.1.1.3.cmml" xref="A1.Ex6.m1.6.6.1.1.1.1.1.1.1.3">𝑖</ci></apply></apply><apply id="A1.Ex6.m1.6.6.1.1.1.3.cmml" xref="A1.Ex6.m1.6.6.1.1.1.3"><times id="A1.Ex6.m1.6.6.1.1.1.3.1.cmml" xref="A1.Ex6.m1.6.6.1.1.1.3.1"></times><ci id="A1.Ex6.m1.6.6.1.1.1.3.2.cmml" xref="A1.Ex6.m1.6.6.1.1.1.3.2">𝜑</ci><cn id="A1.Ex6.m1.5.5.cmml" type="integer" xref="A1.Ex6.m1.5.5">0</cn></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="A1.Ex6.m1.6c">\sum_{t=1}^{T}r^{\text{step}}_{i,t}=\Phi(T)-\Phi(0)=\varphi(J_{i})-\varphi(0),</annotation><annotation encoding="application/x-llamapun" id="A1.Ex6.m1.6d">∑ start_POSTSUBSCRIPT italic_t = 1 end_POSTSUBSCRIPT start_POSTSUPERSCRIPT italic_T end_POSTSUPERSCRIPT italic_r start_POSTSUPERSCRIPT step end_POSTSUPERSCRIPT start_POSTSUBSCRIPT italic_i , italic_t end_POSTSUBSCRIPT = roman_Φ ( italic_T ) - roman_Φ ( 0 ) = italic_φ ( italic_J start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT ) - italic_φ ( 0 ) ,</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
</tr></tbody>
</table>
<p class="ltx_p" id="A1.2.p2.3">assuming <math alttext="\text{step}(T)=J_{i}" class="ltx_Math" display="inline" id="A1.2.p2.2.m1.1"><semantics id="A1.2.p2.2.m1.1a"><mrow id="A1.2.p2.2.m1.1.2" xref="A1.2.p2.2.m1.1.2.cmml"><mrow id="A1.2.p2.2.m1.1.2.2" xref="A1.2.p2.2.m1.1.2.2.cmml"><mtext id="A1.2.p2.2.m1.1.2.2.2" xref="A1.2.p2.2.m1.1.2.2.2a.cmml">step</mtext><mo id="A1.2.p2.2.m1.1.2.2.1" xref="A1.2.p2.2.m1.1.2.2.1.cmml">⁢</mo><mrow id="A1.2.p2.2.m1.1.2.2.3.2" xref="A1.2.p2.2.m1.1.2.2.cmml"><mo id="A1.2.p2.2.m1.1.2.2.3.2.1" stretchy="false" xref="A1.2.p2.2.m1.1.2.2.cmml">(</mo><mi id="A1.2.p2.2.m1.1.1" xref="A1.2.p2.2.m1.1.1.cmml">T</mi><mo id="A1.2.p2.2.m1.1.2.2.3.2.2" stretchy="false" xref="A1.2.p2.2.m1.1.2.2.cmml">)</mo></mrow></mrow><mo id="A1.2.p2.2.m1.1.2.1" xref="A1.2.p2.2.m1.1.2.1.cmml">=</mo><msub id="A1.2.p2.2.m1.1.2.3" xref="A1.2.p2.2.m1.1.2.3.cmml"><mi id="A1.2.p2.2.m1.1.2.3.2" xref="A1.2.p2.2.m1.1.2.3.2.cmml">J</mi><mi id="A1.2.p2.2.m1.1.2.3.3" xref="A1.2.p2.2.m1.1.2.3.3.cmml">i</mi></msub></mrow><annotation-xml encoding="MathML-Content" id="A1.2.p2.2.m1.1b"><apply id="A1.2.p2.2.m1.1.2.cmml" xref="A1.2.p2.2.m1.1.2"><eq id="A1.2.p2.2.m1.1.2.1.cmml" xref="A1.2.p2.2.m1.1.2.1"></eq><apply id="A1.2.p2.2.m1.1.2.2.cmml" xref="A1.2.p2.2.m1.1.2.2"><times id="A1.2.p2.2.m1.1.2.2.1.cmml" xref="A1.2.p2.2.m1.1.2.2.1"></times><ci id="A1.2.p2.2.m1.1.2.2.2a.cmml" xref="A1.2.p2.2.m1.1.2.2.2"><mtext id="A1.2.p2.2.m1.1.2.2.2.cmml" xref="A1.2.p2.2.m1.1.2.2.2">step</mtext></ci><ci id="A1.2.p2.2.m1.1.1.cmml" xref="A1.2.p2.2.m1.1.1">𝑇</ci></apply><apply id="A1.2.p2.2.m1.1.2.3.cmml" xref="A1.2.p2.2.m1.1.2.3"><csymbol cd="ambiguous" id="A1.2.p2.2.m1.1.2.3.1.cmml" xref="A1.2.p2.2.m1.1.2.3">subscript</csymbol><ci id="A1.2.p2.2.m1.1.2.3.2.cmml" xref="A1.2.p2.2.m1.1.2.3.2">𝐽</ci><ci id="A1.2.p2.2.m1.1.2.3.3.cmml" xref="A1.2.p2.2.m1.1.2.3.3">𝑖</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="A1.2.p2.2.m1.1c">\text{step}(T)=J_{i}</annotation><annotation encoding="application/x-llamapun" id="A1.2.p2.2.m1.1d">step ( italic_T ) = italic_J start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT</annotation></semantics></math>. Since <math alttext="\varphi(0)" class="ltx_Math" display="inline" id="A1.2.p2.3.m2.1"><semantics id="A1.2.p2.3.m2.1a"><mrow id="A1.2.p2.3.m2.1.2" xref="A1.2.p2.3.m2.1.2.cmml"><mi id="A1.2.p2.3.m2.1.2.2" xref="A1.2.p2.3.m2.1.2.2.cmml">φ</mi><mo id="A1.2.p2.3.m2.1.2.1" xref="A1.2.p2.3.m2.1.2.1.cmml">⁢</mo><mrow id="A1.2.p2.3.m2.1.2.3.2" xref="A1.2.p2.3.m2.1.2.cmml"><mo id="A1.2.p2.3.m2.1.2.3.2.1" stretchy="false" xref="A1.2.p2.3.m2.1.2.cmml">(</mo><mn id="A1.2.p2.3.m2.1.1" xref="A1.2.p2.3.m2.1.1.cmml">0</mn><mo id="A1.2.p2.3.m2.1.2.3.2.2" stretchy="false" xref="A1.2.p2.3.m2.1.2.cmml">)</mo></mrow></mrow><annotation-xml encoding="MathML-Content" id="A1.2.p2.3.m2.1b"><apply id="A1.2.p2.3.m2.1.2.cmml" xref="A1.2.p2.3.m2.1.2"><times id="A1.2.p2.3.m2.1.2.1.cmml" xref="A1.2.p2.3.m2.1.2.1"></times><ci id="A1.2.p2.3.m2.1.2.2.cmml" xref="A1.2.p2.3.m2.1.2.2">𝜑</ci><cn id="A1.2.p2.3.m2.1.1.cmml" type="integer" xref="A1.2.p2.3.m2.1.1">0</cn></apply></annotation-xml><annotation encoding="application/x-tex" id="A1.2.p2.3.m2.1c">\varphi(0)</annotation><annotation encoding="application/x-llamapun" id="A1.2.p2.3.m2.1d">italic_φ ( 0 )</annotation></semantics></math> is constant across all trajectories, it does not affect the optimization. Thus, both reward schemes only differ by a constant shift and a potential-based shaping term.</p>
</div>
<div class="ltx_para" id="A1.3.p3">
<p class="ltx_p" id="A1.3.p3.1">By the lemma, such a transformation does not change the optimal policy.</p>
</div>
<div class="ltx_para" id="A1.4.p4">
<p class="ltx_p" id="A1.4.p4.1"><span class="ltx_text ltx_font_bold" id="A1.4.p4.1.1">Conclusion:</span> The outcome-based terminal reward and the shaped step-wise reward are equivalent in terms of the policies they induce.
∎</p>
</div>
</div>
</section>
<section class="ltx_appendix" id="A2">
<h2 class="ltx_title ltx_title_appendix">
<span class="ltx_tag ltx_tag_appendix">Appendix B </span>Dataset Details</h2>
<section class="ltx_subsection" id="A2.SS1">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">B.1 </span>Data Preprocessing</h3>
<div class="ltx_para" id="A2.SS1.p1">
<p class="ltx_p" id="A2.SS1.p1.1">We follow the data preprocessing procedures adopted in prior work <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib10" title="">10</a>]</cite>, using structured and unstructured EHR data from the MIMIC-III <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib14" title="">14</a>]</cite> database. For structured clinical information, we extract diagnosis and procedure codes and retrieve their corresponding textual descriptions from the ICD dictionary tables. Since the original long titles in the dictionary can be overly verbose and difficult for LLMs to process, we utilize GPT-4o to compress them into concise titles while preserving the essential semantic content. This compression strategy follows the same approach as adopted in LAMO <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib10" title="">10</a>]</cite> to ensure semantic integrity and model compatibility.</p>
</div>
<div class="ltx_para" id="A2.SS1.p2">
<p class="ltx_p" id="A2.SS1.p2.1">For medication data, we map National Drug Codes to DrugBank IDs and obtain associated text descriptions from corresponding lookup tables. To incorporate unstructured information, we follow the previous pipeline and extract segments from clinical notes, including <span class="ltx_text ltx_font_bold" id="A2.SS1.p2.1.1">History of Present Illness</span>, <span class="ltx_text ltx_font_bold" id="A2.SS1.p2.1.2">Past Medical History</span>, <span class="ltx_text ltx_font_bold" id="A2.SS1.p2.1.3">Allergies</span>, and <span class="ltx_text ltx_font_bold" id="A2.SS1.p2.1.4">Medications on Admission</span>, using GPT-4o as a parser to construct patient condition descriptions.</p>
</div>
</section>
<section class="ltx_subsection" id="A2.SS2">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">B.2 </span>Dataset Statistics</h3>
<div class="ltx_para" id="A2.SS2.p1">
<p class="ltx_p" id="A2.SS2.p1.1">After preprocessing the structured clinical codes (diagnoses, procedures, and medications), we obtain the dataset statistics summarized in Table <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#A2.T3" title="Table 3 ‣ B.2 Dataset Statistics ‣ Appendix B Dataset Details ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">3</span></a>.</p>
</div>
<figure class="ltx_table" id="A2.T3">
<figcaption class="ltx_caption ltx_centering"><span class="ltx_tag ltx_tag_table">Table 3: </span>Statistics of processed data in MIMIC-III</figcaption>
<table class="ltx_tabular ltx_centering ltx_guessed_headers ltx_align_middle" id="A2.T3.1">
<thead class="ltx_thead">
<tr class="ltx_tr" id="A2.T3.1.1.1">
<th class="ltx_td ltx_align_left ltx_th ltx_th_column ltx_th_row ltx_border_r ltx_border_tt" id="A2.T3.1.1.1.1">Items</th>
<th class="ltx_td ltx_align_center ltx_th ltx_th_column ltx_border_tt" id="A2.T3.1.1.1.2">MIMIC-III</th>
</tr>
</thead>
<tbody class="ltx_tbody">
<tr class="ltx_tr" id="A2.T3.1.2.1">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r ltx_border_t" id="A2.T3.1.2.1.1"># of visits / # of patients</th>
<td class="ltx_td ltx_align_center ltx_border_t" id="A2.T3.1.2.1.2">14207 / 6226</td>
</tr>
<tr class="ltx_tr" id="A2.T3.1.3.2">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="A2.T3.1.3.2.1">dis. / prod. / med. space size</th>
<td class="ltx_td ltx_align_center" id="A2.T3.1.3.2.2">1676 / 511 / 151</td>
</tr>
<tr class="ltx_tr" id="A2.T3.1.4.3">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="A2.T3.1.4.3.1">avg. / max # of visits</th>
<td class="ltx_td ltx_align_center" id="A2.T3.1.4.3.2">2.28 / 29</td>
</tr>
<tr class="ltx_tr" id="A2.T3.1.5.4">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="A2.T3.1.5.4.1">avg. / max # of dis. per visit</th>
<td class="ltx_td ltx_align_center" id="A2.T3.1.5.4.2">13.59 / 39</td>
</tr>
<tr class="ltx_tr" id="A2.T3.1.6.5">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_r" id="A2.T3.1.6.5.1">avg. / max # of pro. per visit</th>
<td class="ltx_td ltx_align_center" id="A2.T3.1.6.5.2">4.23 / 27</td>
</tr>
<tr class="ltx_tr" id="A2.T3.1.7.6">
<th class="ltx_td ltx_align_left ltx_th ltx_th_row ltx_border_bb ltx_border_r" id="A2.T3.1.7.6.1">avg. / max # of med. per visit</th>
<td class="ltx_td ltx_align_center ltx_border_bb" id="A2.T3.1.7.6.2">23.36 / 77</td>
</tr>
</tbody>
</table>
</figure>
</section>
</section>
<section class="ltx_appendix" id="A3">
<h2 class="ltx_title ltx_title_appendix">
<span class="ltx_tag ltx_tag_appendix">Appendix C </span>Experimental Setup</h2>
<section class="ltx_subsection" id="A3.SS1">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">C.1 </span>Training Details and Hyperparameters</h3>
<div class="ltx_para" id="A3.SS1.p1">
<p class="ltx_p" id="A3.SS1.p1.1">We conduct all experiments on NVIDIA A100-SXM4-80GB GPUs, with Python 3.10 and PyTorch 2.5.1. During all training stages, the model is quantized using bf16 and LoRA, and optimized using the <span class="ltx_text ltx_font_typewriter" id="A3.SS1.p1.1.1">adamw_torch</span> optimizer.</p>
</div>
<div class="ltx_para" id="A3.SS1.p2">
<p class="ltx_p" id="A3.SS1.p2.1">For the SFT of drug-level classifier <math alttext="\pi_{\text{cls}}" class="ltx_Math" display="inline" id="A3.SS1.p2.1.m1.1"><semantics id="A3.SS1.p2.1.m1.1a"><msub id="A3.SS1.p2.1.m1.1.1" xref="A3.SS1.p2.1.m1.1.1.cmml"><mi id="A3.SS1.p2.1.m1.1.1.2" xref="A3.SS1.p2.1.m1.1.1.2.cmml">π</mi><mtext id="A3.SS1.p2.1.m1.1.1.3" xref="A3.SS1.p2.1.m1.1.1.3a.cmml">cls</mtext></msub><annotation-xml encoding="MathML-Content" id="A3.SS1.p2.1.m1.1b"><apply id="A3.SS1.p2.1.m1.1.1.cmml" xref="A3.SS1.p2.1.m1.1.1"><csymbol cd="ambiguous" id="A3.SS1.p2.1.m1.1.1.1.cmml" xref="A3.SS1.p2.1.m1.1.1">subscript</csymbol><ci id="A3.SS1.p2.1.m1.1.1.2.cmml" xref="A3.SS1.p2.1.m1.1.1.2">𝜋</ci><ci id="A3.SS1.p2.1.m1.1.1.3a.cmml" xref="A3.SS1.p2.1.m1.1.1.3"><mtext id="A3.SS1.p2.1.m1.1.1.3.cmml" mathsize="70%" xref="A3.SS1.p2.1.m1.1.1.3">cls</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="A3.SS1.p2.1.m1.1c">\pi_{\text{cls}}</annotation><annotation encoding="application/x-llamapun" id="A3.SS1.p2.1.m1.1d">italic_π start_POSTSUBSCRIPT cls end_POSTSUBSCRIPT</annotation></semantics></math>, we use Llama3-Aloe-8B-Alpha as the base model. Four projectors are randomly initialized: pat_projector, diag_projector, pro_projector, and med_projector, each consisting of a two-layer MLP with GELU activation. The learning rate is set to 5e-4, with a batch size of 128 and one epoch.</p>
</div>
<div class="ltx_para" id="A3.SS1.p3">
<p class="ltx_p" id="A3.SS1.p3.2">For the SFT of list-wise policy <math alttext="\pi_{\text{list}}" class="ltx_Math" display="inline" id="A3.SS1.p3.1.m1.1"><semantics id="A3.SS1.p3.1.m1.1a"><msub id="A3.SS1.p3.1.m1.1.1" xref="A3.SS1.p3.1.m1.1.1.cmml"><mi id="A3.SS1.p3.1.m1.1.1.2" xref="A3.SS1.p3.1.m1.1.1.2.cmml">π</mi><mtext id="A3.SS1.p3.1.m1.1.1.3" xref="A3.SS1.p3.1.m1.1.1.3a.cmml">list</mtext></msub><annotation-xml encoding="MathML-Content" id="A3.SS1.p3.1.m1.1b"><apply id="A3.SS1.p3.1.m1.1.1.cmml" xref="A3.SS1.p3.1.m1.1.1"><csymbol cd="ambiguous" id="A3.SS1.p3.1.m1.1.1.1.cmml" xref="A3.SS1.p3.1.m1.1.1">subscript</csymbol><ci id="A3.SS1.p3.1.m1.1.1.2.cmml" xref="A3.SS1.p3.1.m1.1.1.2">𝜋</ci><ci id="A3.SS1.p3.1.m1.1.1.3a.cmml" xref="A3.SS1.p3.1.m1.1.1.3"><mtext id="A3.SS1.p3.1.m1.1.1.3.cmml" mathsize="70%" xref="A3.SS1.p3.1.m1.1.1.3">list</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="A3.SS1.p3.1.m1.1c">\pi_{\text{list}}</annotation><annotation encoding="application/x-llamapun" id="A3.SS1.p3.1.m1.1d">italic_π start_POSTSUBSCRIPT list end_POSTSUBSCRIPT</annotation></semantics></math>, the model and projector weights from the previous step (<math alttext="\pi_{\text{cls}}" class="ltx_Math" display="inline" id="A3.SS1.p3.2.m2.1"><semantics id="A3.SS1.p3.2.m2.1a"><msub id="A3.SS1.p3.2.m2.1.1" xref="A3.SS1.p3.2.m2.1.1.cmml"><mi id="A3.SS1.p3.2.m2.1.1.2" xref="A3.SS1.p3.2.m2.1.1.2.cmml">π</mi><mtext id="A3.SS1.p3.2.m2.1.1.3" xref="A3.SS1.p3.2.m2.1.1.3a.cmml">cls</mtext></msub><annotation-xml encoding="MathML-Content" id="A3.SS1.p3.2.m2.1b"><apply id="A3.SS1.p3.2.m2.1.1.cmml" xref="A3.SS1.p3.2.m2.1.1"><csymbol cd="ambiguous" id="A3.SS1.p3.2.m2.1.1.1.cmml" xref="A3.SS1.p3.2.m2.1.1">subscript</csymbol><ci id="A3.SS1.p3.2.m2.1.1.2.cmml" xref="A3.SS1.p3.2.m2.1.1.2">𝜋</ci><ci id="A3.SS1.p3.2.m2.1.1.3a.cmml" xref="A3.SS1.p3.2.m2.1.1.3"><mtext id="A3.SS1.p3.2.m2.1.1.3.cmml" mathsize="70%" xref="A3.SS1.p3.2.m2.1.1.3">cls</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="A3.SS1.p3.2.m2.1c">\pi_{\text{cls}}</annotation><annotation encoding="application/x-llamapun" id="A3.SS1.p3.2.m2.1d">italic_π start_POSTSUBSCRIPT cls end_POSTSUBSCRIPT</annotation></semantics></math>) are used as initialization. The learning rate remains 5e-4, with a batch size of 64 and one epoch.</p>
</div>
<div class="ltx_para" id="A3.SS1.p4">
<p class="ltx_p" id="A3.SS1.p4.4">When performing step-wise GRPO on <math alttext="\pi_{\text{list}}" class="ltx_Math" display="inline" id="A3.SS1.p4.1.m1.1"><semantics id="A3.SS1.p4.1.m1.1a"><msub id="A3.SS1.p4.1.m1.1.1" xref="A3.SS1.p4.1.m1.1.1.cmml"><mi id="A3.SS1.p4.1.m1.1.1.2" xref="A3.SS1.p4.1.m1.1.1.2.cmml">π</mi><mtext id="A3.SS1.p4.1.m1.1.1.3" xref="A3.SS1.p4.1.m1.1.1.3a.cmml">list</mtext></msub><annotation-xml encoding="MathML-Content" id="A3.SS1.p4.1.m1.1b"><apply id="A3.SS1.p4.1.m1.1.1.cmml" xref="A3.SS1.p4.1.m1.1.1"><csymbol cd="ambiguous" id="A3.SS1.p4.1.m1.1.1.1.cmml" xref="A3.SS1.p4.1.m1.1.1">subscript</csymbol><ci id="A3.SS1.p4.1.m1.1.1.2.cmml" xref="A3.SS1.p4.1.m1.1.1.2">𝜋</ci><ci id="A3.SS1.p4.1.m1.1.1.3a.cmml" xref="A3.SS1.p4.1.m1.1.1.3"><mtext id="A3.SS1.p4.1.m1.1.1.3.cmml" mathsize="70%" xref="A3.SS1.p4.1.m1.1.1.3">list</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="A3.SS1.p4.1.m1.1c">\pi_{\text{list}}</annotation><annotation encoding="application/x-llamapun" id="A3.SS1.p4.1.m1.1d">italic_π start_POSTSUBSCRIPT list end_POSTSUBSCRIPT</annotation></semantics></math>, we initialize the model and projector weights from the previous SFT step. The projector parameter ‘r_grad’ is set to False. We use the Unsloth framework and vLLM 0.7.3 for acceleration. The learning rate is set to 1e-5, with a batch size of 16, ‘num_generations’ set to 8, and one epoch. The hyperparameter <math alttext="\alpha" class="ltx_Math" display="inline" id="A3.SS1.p4.2.m2.1"><semantics id="A3.SS1.p4.2.m2.1a"><mi id="A3.SS1.p4.2.m2.1.1" xref="A3.SS1.p4.2.m2.1.1.cmml">α</mi><annotation-xml encoding="MathML-Content" id="A3.SS1.p4.2.m2.1b"><ci id="A3.SS1.p4.2.m2.1.1.cmml" xref="A3.SS1.p4.2.m2.1.1">𝛼</ci></annotation-xml><annotation encoding="application/x-tex" id="A3.SS1.p4.2.m2.1c">\alpha</annotation><annotation encoding="application/x-llamapun" id="A3.SS1.p4.2.m2.1d">italic_α</annotation></semantics></math> is chosen from the set [0, 2, 5, 10, 20, 30, 40, 50] to adapt to different DDI requirements, while <math alttext="\beta" class="ltx_Math" display="inline" id="A3.SS1.p4.3.m3.1"><semantics id="A3.SS1.p4.3.m3.1a"><mi id="A3.SS1.p4.3.m3.1.1" xref="A3.SS1.p4.3.m3.1.1.cmml">β</mi><annotation-xml encoding="MathML-Content" id="A3.SS1.p4.3.m3.1b"><ci id="A3.SS1.p4.3.m3.1.1.cmml" xref="A3.SS1.p4.3.m3.1.1">𝛽</ci></annotation-xml><annotation encoding="application/x-tex" id="A3.SS1.p4.3.m3.1c">\beta</annotation><annotation encoding="application/x-llamapun" id="A3.SS1.p4.3.m3.1d">italic_β</annotation></semantics></math> is set to 0.5, and <math alttext="\lambda" class="ltx_Math" display="inline" id="A3.SS1.p4.4.m4.1"><semantics id="A3.SS1.p4.4.m4.1a"><mi id="A3.SS1.p4.4.m4.1.1" xref="A3.SS1.p4.4.m4.1.1.cmml">λ</mi><annotation-xml encoding="MathML-Content" id="A3.SS1.p4.4.m4.1b"><ci id="A3.SS1.p4.4.m4.1.1.cmml" xref="A3.SS1.p4.4.m4.1.1">𝜆</ci></annotation-xml><annotation encoding="application/x-tex" id="A3.SS1.p4.4.m4.1c">\lambda</annotation><annotation encoding="application/x-llamapun" id="A3.SS1.p4.4.m4.1d">italic_λ</annotation></semantics></math> is set to 5.</p>
</div>
</section>
<section class="ltx_subsection" id="A3.SS2">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">C.2 </span>Baseline Methods and Evaluation Metrics</h3>
<div class="ltx_para" id="A3.SS2.p1">
<p class="ltx_p" id="A3.SS2.p1.1">We provide a comprehensive overview of baseline models that have been widely used for the medication recommendation task:</p>
</div>
<div class="ltx_para" id="A3.SS2.p2">
<ul class="ltx_itemize" id="A3.I1">
<li class="ltx_item" id="A3.I1.i1" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A3.I1.i1.p1">
<p class="ltx_p" id="A3.I1.i1.p1.1"><span class="ltx_text ltx_font_bold" id="A3.I1.i1.p1.1.1">LEAP</span> <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib6" title="">6</a>]</cite> formulates the medication prediction task using only the current visit and models label dependencies via multi-instance multi-label learning.</p>
</div>
</li>
<li class="ltx_item" id="A3.I1.i2" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A3.I1.i2.p1">
<p class="ltx_p" id="A3.I1.i2.p1.1"><span class="ltx_text ltx_font_bold" id="A3.I1.i2.p1.1.1">GAMENet</span> <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib7" title="">7</a>]</cite> integrates EHR and DDI graphs via graph-augmented memory networks to ensure both accuracy and safety.</p>
</div>
</li>
<li class="ltx_item" id="A3.I1.i3" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A3.I1.i3.p1">
<p class="ltx_p" id="A3.I1.i3.p1.1"><span class="ltx_text ltx_font_bold" id="A3.I1.i3.p1.1.1">SafeDrug</span> <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib3" title="">3</a>]</cite> employs dual molecular encoders to learn molecular representations and improve safe prescription decisions.</p>
</div>
</li>
<li class="ltx_item" id="A3.I1.i4" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A3.I1.i4.p1">
<p class="ltx_p" id="A3.I1.i4.p1.1"><span class="ltx_text ltx_font_bold" id="A3.I1.i4.p1.1.1">COGNet</span> <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib4" title="">4</a>]</cite> leverages a copy-or-predict mechanism to incorporate historical prescriptions into current decision making.</p>
</div>
</li>
<li class="ltx_item" id="A3.I1.i5" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A3.I1.i5.p1">
<p class="ltx_p" id="A3.I1.i5.p1.1"><span class="ltx_text ltx_font_bold" id="A3.I1.i5.p1.1.1">MICRON</span> <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib26" title="">26</a>]</cite> introduces a recurrent residual learning model that treats medication change dynamics as the primary learning target.</p>
</div>
</li>
<li class="ltx_item" id="A3.I1.i6" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A3.I1.i6.p1">
<p class="ltx_p" id="A3.I1.i6.p1.1"><span class="ltx_text ltx_font_bold" id="A3.I1.i6.p1.1.1">MoleRec</span> <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib8" title="">8</a>]</cite> proposes a substructure-aware attention mechanism that models drug substructure–patient condition interactions at a fine-grained level.</p>
</div>
</li>
<li class="ltx_item" id="A3.I1.i7" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A3.I1.i7.p1">
<p class="ltx_p" id="A3.I1.i7.p1.1"><span class="ltx_text ltx_font_bold" id="A3.I1.i7.p1.1.1">RAREMed</span> <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib5" title="">5</a>]</cite> utilizes a Transformer-based encoder to derive comprehensive patient representations and mitigate fairness issues in recommendation.</p>
</div>
</li>
<li class="ltx_item" id="A3.I1.i8" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A3.I1.i8.p1">
<p class="ltx_p" id="A3.I1.i8.p1.1"><span class="ltx_text ltx_font_bold" id="A3.I1.i8.p1.1.1">NLA-MMR</span> <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib17" title="">17</a>]</cite> designs a multi-modal alignment framework to jointly encode patient and medication representations across modalities.</p>
</div>
</li>
<li class="ltx_item" id="A3.I1.i9" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A3.I1.i9.p1">
<p class="ltx_p" id="A3.I1.i9.p1.1"><span class="ltx_text ltx_font_bold" id="A3.I1.i9.p1.1.1">LAMO</span> <cite class="ltx_cite ltx_citemacro_cite">[<a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#bib.bib10" title="">10</a>]</cite> builds on LLaMA-2 and incorporates unstructured clinical notes to better capture the patient’s condition, leveraging the semantic understanding capabilities of LLMs for accurate medication recommendation.</p>
</div>
</li>
</ul>
</div>
<div class="ltx_para" id="A3.SS2.p3">
<p class="ltx_p" id="A3.SS2.p3.2">We adopt Jaccard Score and F1 Score to evaluate the prediction accuracy, and DDI rate to assess the safety of recommended medication sets.
Given the model prediction <math alttext="\mathcal{M}_{v}" class="ltx_Math" display="inline" id="A3.SS2.p3.1.m1.1"><semantics id="A3.SS2.p3.1.m1.1a"><msub id="A3.SS2.p3.1.m1.1.1" xref="A3.SS2.p3.1.m1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.SS2.p3.1.m1.1.1.2" xref="A3.SS2.p3.1.m1.1.1.2.cmml">ℳ</mi><mi id="A3.SS2.p3.1.m1.1.1.3" xref="A3.SS2.p3.1.m1.1.1.3.cmml">v</mi></msub><annotation-xml encoding="MathML-Content" id="A3.SS2.p3.1.m1.1b"><apply id="A3.SS2.p3.1.m1.1.1.cmml" xref="A3.SS2.p3.1.m1.1.1"><csymbol cd="ambiguous" id="A3.SS2.p3.1.m1.1.1.1.cmml" xref="A3.SS2.p3.1.m1.1.1">subscript</csymbol><ci id="A3.SS2.p3.1.m1.1.1.2.cmml" xref="A3.SS2.p3.1.m1.1.1.2">ℳ</ci><ci id="A3.SS2.p3.1.m1.1.1.3.cmml" xref="A3.SS2.p3.1.m1.1.1.3">𝑣</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="A3.SS2.p3.1.m1.1c">\mathcal{M}_{v}</annotation><annotation encoding="application/x-llamapun" id="A3.SS2.p3.1.m1.1d">caligraphic_M start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT</annotation></semantics></math> and the ground-truth set <math alttext="\mathcal{M}_{\text{GT}}" class="ltx_Math" display="inline" id="A3.SS2.p3.2.m2.1"><semantics id="A3.SS2.p3.2.m2.1a"><msub id="A3.SS2.p3.2.m2.1.1" xref="A3.SS2.p3.2.m2.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.SS2.p3.2.m2.1.1.2" xref="A3.SS2.p3.2.m2.1.1.2.cmml">ℳ</mi><mtext id="A3.SS2.p3.2.m2.1.1.3" xref="A3.SS2.p3.2.m2.1.1.3a.cmml">GT</mtext></msub><annotation-xml encoding="MathML-Content" id="A3.SS2.p3.2.m2.1b"><apply id="A3.SS2.p3.2.m2.1.1.cmml" xref="A3.SS2.p3.2.m2.1.1"><csymbol cd="ambiguous" id="A3.SS2.p3.2.m2.1.1.1.cmml" xref="A3.SS2.p3.2.m2.1.1">subscript</csymbol><ci id="A3.SS2.p3.2.m2.1.1.2.cmml" xref="A3.SS2.p3.2.m2.1.1.2">ℳ</ci><ci id="A3.SS2.p3.2.m2.1.1.3a.cmml" xref="A3.SS2.p3.2.m2.1.1.3"><mtext id="A3.SS2.p3.2.m2.1.1.3.cmml" mathsize="70%" xref="A3.SS2.p3.2.m2.1.1.3">GT</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="A3.SS2.p3.2.m2.1c">\mathcal{M}_{\text{GT}}</annotation><annotation encoding="application/x-llamapun" id="A3.SS2.p3.2.m2.1d">caligraphic_M start_POSTSUBSCRIPT GT end_POSTSUBSCRIPT</annotation></semantics></math>, we define:</p>
</div>
<div class="ltx_para" id="A3.SS2.p4">
<ul class="ltx_itemize" id="A3.I2">
<li class="ltx_item" id="A3.I2.i1" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A3.I2.i1.p1">
<p class="ltx_p" id="A3.I2.i1.p1.1"><span class="ltx_text ltx_font_bold" id="A3.I2.i1.p1.1.1">Jaccard Score</span>:</p>
<table class="ltx_equation ltx_eqn_table" id="A3.E18">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\mathrm{Jaccard}(\mathcal{M}_{v},\mathcal{M}_{\text{GT}})=\frac{|\mathcal{M}_{%
v}\cap\mathcal{M}_{\text{GT}}|}{|\mathcal{M}_{v}\cup\mathcal{M}_{\text{GT}}|}" class="ltx_Math" display="block" id="A3.E18.m1.4"><semantics id="A3.E18.m1.4a"><mrow id="A3.E18.m1.4.4" xref="A3.E18.m1.4.4.cmml"><mrow id="A3.E18.m1.4.4.2" xref="A3.E18.m1.4.4.2.cmml"><mi id="A3.E18.m1.4.4.2.4" xref="A3.E18.m1.4.4.2.4.cmml">Jaccard</mi><mo id="A3.E18.m1.4.4.2.3" xref="A3.E18.m1.4.4.2.3.cmml">⁢</mo><mrow id="A3.E18.m1.4.4.2.2.2" xref="A3.E18.m1.4.4.2.2.3.cmml"><mo id="A3.E18.m1.4.4.2.2.2.3" stretchy="false" xref="A3.E18.m1.4.4.2.2.3.cmml">(</mo><msub id="A3.E18.m1.3.3.1.1.1.1" xref="A3.E18.m1.3.3.1.1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.E18.m1.3.3.1.1.1.1.2" xref="A3.E18.m1.3.3.1.1.1.1.2.cmml">ℳ</mi><mi id="A3.E18.m1.3.3.1.1.1.1.3" xref="A3.E18.m1.3.3.1.1.1.1.3.cmml">v</mi></msub><mo id="A3.E18.m1.4.4.2.2.2.4" xref="A3.E18.m1.4.4.2.2.3.cmml">,</mo><msub id="A3.E18.m1.4.4.2.2.2.2" xref="A3.E18.m1.4.4.2.2.2.2.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.E18.m1.4.4.2.2.2.2.2" xref="A3.E18.m1.4.4.2.2.2.2.2.cmml">ℳ</mi><mtext id="A3.E18.m1.4.4.2.2.2.2.3" xref="A3.E18.m1.4.4.2.2.2.2.3a.cmml">GT</mtext></msub><mo id="A3.E18.m1.4.4.2.2.2.5" stretchy="false" xref="A3.E18.m1.4.4.2.2.3.cmml">)</mo></mrow></mrow><mo id="A3.E18.m1.4.4.3" xref="A3.E18.m1.4.4.3.cmml">=</mo><mfrac id="A3.E18.m1.2.2" xref="A3.E18.m1.2.2.cmml"><mrow id="A3.E18.m1.1.1.1.1" xref="A3.E18.m1.1.1.1.2.cmml"><mo id="A3.E18.m1.1.1.1.1.2" stretchy="false" xref="A3.E18.m1.1.1.1.2.1.cmml">|</mo><mrow id="A3.E18.m1.1.1.1.1.1" xref="A3.E18.m1.1.1.1.1.1.cmml"><msub id="A3.E18.m1.1.1.1.1.1.2" xref="A3.E18.m1.1.1.1.1.1.2.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.E18.m1.1.1.1.1.1.2.2" xref="A3.E18.m1.1.1.1.1.1.2.2.cmml">ℳ</mi><mi id="A3.E18.m1.1.1.1.1.1.2.3" xref="A3.E18.m1.1.1.1.1.1.2.3.cmml">v</mi></msub><mo id="A3.E18.m1.1.1.1.1.1.1" xref="A3.E18.m1.1.1.1.1.1.1.cmml">∩</mo><msub id="A3.E18.m1.1.1.1.1.1.3" xref="A3.E18.m1.1.1.1.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.E18.m1.1.1.1.1.1.3.2" xref="A3.E18.m1.1.1.1.1.1.3.2.cmml">ℳ</mi><mtext id="A3.E18.m1.1.1.1.1.1.3.3" xref="A3.E18.m1.1.1.1.1.1.3.3a.cmml">GT</mtext></msub></mrow><mo id="A3.E18.m1.1.1.1.1.3" stretchy="false" xref="A3.E18.m1.1.1.1.2.1.cmml">|</mo></mrow><mrow id="A3.E18.m1.2.2.2.1" xref="A3.E18.m1.2.2.2.2.cmml"><mo id="A3.E18.m1.2.2.2.1.2" stretchy="false" xref="A3.E18.m1.2.2.2.2.1.cmml">|</mo><mrow id="A3.E18.m1.2.2.2.1.1" xref="A3.E18.m1.2.2.2.1.1.cmml"><msub id="A3.E18.m1.2.2.2.1.1.2" xref="A3.E18.m1.2.2.2.1.1.2.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.E18.m1.2.2.2.1.1.2.2" xref="A3.E18.m1.2.2.2.1.1.2.2.cmml">ℳ</mi><mi id="A3.E18.m1.2.2.2.1.1.2.3" xref="A3.E18.m1.2.2.2.1.1.2.3.cmml">v</mi></msub><mo id="A3.E18.m1.2.2.2.1.1.1" xref="A3.E18.m1.2.2.2.1.1.1.cmml">∪</mo><msub id="A3.E18.m1.2.2.2.1.1.3" xref="A3.E18.m1.2.2.2.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.E18.m1.2.2.2.1.1.3.2" xref="A3.E18.m1.2.2.2.1.1.3.2.cmml">ℳ</mi><mtext id="A3.E18.m1.2.2.2.1.1.3.3" xref="A3.E18.m1.2.2.2.1.1.3.3a.cmml">GT</mtext></msub></mrow><mo id="A3.E18.m1.2.2.2.1.3" stretchy="false" xref="A3.E18.m1.2.2.2.2.1.cmml">|</mo></mrow></mfrac></mrow><annotation-xml encoding="MathML-Content" id="A3.E18.m1.4b"><apply id="A3.E18.m1.4.4.cmml" xref="A3.E18.m1.4.4"><eq id="A3.E18.m1.4.4.3.cmml" xref="A3.E18.m1.4.4.3"></eq><apply id="A3.E18.m1.4.4.2.cmml" xref="A3.E18.m1.4.4.2"><times id="A3.E18.m1.4.4.2.3.cmml" xref="A3.E18.m1.4.4.2.3"></times><ci id="A3.E18.m1.4.4.2.4.cmml" xref="A3.E18.m1.4.4.2.4">Jaccard</ci><interval closure="open" id="A3.E18.m1.4.4.2.2.3.cmml" xref="A3.E18.m1.4.4.2.2.2"><apply id="A3.E18.m1.3.3.1.1.1.1.cmml" xref="A3.E18.m1.3.3.1.1.1.1"><csymbol cd="ambiguous" id="A3.E18.m1.3.3.1.1.1.1.1.cmml" xref="A3.E18.m1.3.3.1.1.1.1">subscript</csymbol><ci id="A3.E18.m1.3.3.1.1.1.1.2.cmml" xref="A3.E18.m1.3.3.1.1.1.1.2">ℳ</ci><ci id="A3.E18.m1.3.3.1.1.1.1.3.cmml" xref="A3.E18.m1.3.3.1.1.1.1.3">𝑣</ci></apply><apply id="A3.E18.m1.4.4.2.2.2.2.cmml" xref="A3.E18.m1.4.4.2.2.2.2"><csymbol cd="ambiguous" id="A3.E18.m1.4.4.2.2.2.2.1.cmml" xref="A3.E18.m1.4.4.2.2.2.2">subscript</csymbol><ci id="A3.E18.m1.4.4.2.2.2.2.2.cmml" xref="A3.E18.m1.4.4.2.2.2.2.2">ℳ</ci><ci id="A3.E18.m1.4.4.2.2.2.2.3a.cmml" xref="A3.E18.m1.4.4.2.2.2.2.3"><mtext id="A3.E18.m1.4.4.2.2.2.2.3.cmml" mathsize="70%" xref="A3.E18.m1.4.4.2.2.2.2.3">GT</mtext></ci></apply></interval></apply><apply id="A3.E18.m1.2.2.cmml" xref="A3.E18.m1.2.2"><divide id="A3.E18.m1.2.2.3.cmml" xref="A3.E18.m1.2.2"></divide><apply id="A3.E18.m1.1.1.1.2.cmml" xref="A3.E18.m1.1.1.1.1"><abs id="A3.E18.m1.1.1.1.2.1.cmml" xref="A3.E18.m1.1.1.1.1.2"></abs><apply id="A3.E18.m1.1.1.1.1.1.cmml" xref="A3.E18.m1.1.1.1.1.1"><intersect id="A3.E18.m1.1.1.1.1.1.1.cmml" xref="A3.E18.m1.1.1.1.1.1.1"></intersect><apply id="A3.E18.m1.1.1.1.1.1.2.cmml" xref="A3.E18.m1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="A3.E18.m1.1.1.1.1.1.2.1.cmml" xref="A3.E18.m1.1.1.1.1.1.2">subscript</csymbol><ci id="A3.E18.m1.1.1.1.1.1.2.2.cmml" xref="A3.E18.m1.1.1.1.1.1.2.2">ℳ</ci><ci id="A3.E18.m1.1.1.1.1.1.2.3.cmml" xref="A3.E18.m1.1.1.1.1.1.2.3">𝑣</ci></apply><apply id="A3.E18.m1.1.1.1.1.1.3.cmml" xref="A3.E18.m1.1.1.1.1.1.3"><csymbol cd="ambiguous" id="A3.E18.m1.1.1.1.1.1.3.1.cmml" xref="A3.E18.m1.1.1.1.1.1.3">subscript</csymbol><ci id="A3.E18.m1.1.1.1.1.1.3.2.cmml" xref="A3.E18.m1.1.1.1.1.1.3.2">ℳ</ci><ci id="A3.E18.m1.1.1.1.1.1.3.3a.cmml" xref="A3.E18.m1.1.1.1.1.1.3.3"><mtext id="A3.E18.m1.1.1.1.1.1.3.3.cmml" mathsize="70%" xref="A3.E18.m1.1.1.1.1.1.3.3">GT</mtext></ci></apply></apply></apply><apply id="A3.E18.m1.2.2.2.2.cmml" xref="A3.E18.m1.2.2.2.1"><abs id="A3.E18.m1.2.2.2.2.1.cmml" xref="A3.E18.m1.2.2.2.1.2"></abs><apply id="A3.E18.m1.2.2.2.1.1.cmml" xref="A3.E18.m1.2.2.2.1.1"><union id="A3.E18.m1.2.2.2.1.1.1.cmml" xref="A3.E18.m1.2.2.2.1.1.1"></union><apply id="A3.E18.m1.2.2.2.1.1.2.cmml" xref="A3.E18.m1.2.2.2.1.1.2"><csymbol cd="ambiguous" id="A3.E18.m1.2.2.2.1.1.2.1.cmml" xref="A3.E18.m1.2.2.2.1.1.2">subscript</csymbol><ci id="A3.E18.m1.2.2.2.1.1.2.2.cmml" xref="A3.E18.m1.2.2.2.1.1.2.2">ℳ</ci><ci id="A3.E18.m1.2.2.2.1.1.2.3.cmml" xref="A3.E18.m1.2.2.2.1.1.2.3">𝑣</ci></apply><apply id="A3.E18.m1.2.2.2.1.1.3.cmml" xref="A3.E18.m1.2.2.2.1.1.3"><csymbol cd="ambiguous" id="A3.E18.m1.2.2.2.1.1.3.1.cmml" xref="A3.E18.m1.2.2.2.1.1.3">subscript</csymbol><ci id="A3.E18.m1.2.2.2.1.1.3.2.cmml" xref="A3.E18.m1.2.2.2.1.1.3.2">ℳ</ci><ci id="A3.E18.m1.2.2.2.1.1.3.3a.cmml" xref="A3.E18.m1.2.2.2.1.1.3.3"><mtext id="A3.E18.m1.2.2.2.1.1.3.3.cmml" mathsize="70%" xref="A3.E18.m1.2.2.2.1.1.3.3">GT</mtext></ci></apply></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="A3.E18.m1.4c">\mathrm{Jaccard}(\mathcal{M}_{v},\mathcal{M}_{\text{GT}})=\frac{|\mathcal{M}_{%
v}\cap\mathcal{M}_{\text{GT}}|}{|\mathcal{M}_{v}\cup\mathcal{M}_{\text{GT}}|}</annotation><annotation encoding="application/x-llamapun" id="A3.E18.m1.4d">roman_Jaccard ( caligraphic_M start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT , caligraphic_M start_POSTSUBSCRIPT GT end_POSTSUBSCRIPT ) = divide start_ARG | caligraphic_M start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT ∩ caligraphic_M start_POSTSUBSCRIPT GT end_POSTSUBSCRIPT | end_ARG start_ARG | caligraphic_M start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT ∪ caligraphic_M start_POSTSUBSCRIPT GT end_POSTSUBSCRIPT | end_ARG</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(18)</span></td>
</tr></tbody>
</table>
</div>
</li>
<li class="ltx_item" id="A3.I2.i2" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A3.I2.i2.p1">
<p class="ltx_p" id="A3.I2.i2.p1.1"><span class="ltx_text ltx_font_bold" id="A3.I2.i2.p1.1.1">F1 Score</span>, computed based on precision and recall:</p>
<table class="ltx_equation ltx_eqn_table" id="A3.E19">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\mathrm{Precision}=\frac{|\mathcal{M}_{v}\cap\mathcal{M}_{\text{GT}}|}{|%
\mathcal{M}_{v}|},\quad\mathrm{Recall}=\frac{|\mathcal{M}_{v}\cap\mathcal{M}_{%
\text{GT}}|}{|\mathcal{M}_{\text{GT}}|},\quad\mathrm{F1}=\frac{2\cdot\mathrm{%
Precision}\cdot\mathrm{Recall}}{\mathrm{Precision}+\mathrm{Recall}}" class="ltx_Math" display="block" id="A3.E19.m1.6"><semantics id="A3.E19.m1.6a"><mrow id="A3.E19.m1.6.6.2" xref="A3.E19.m1.6.6.3.cmml"><mrow id="A3.E19.m1.5.5.1.1" xref="A3.E19.m1.5.5.1.1.cmml"><mi id="A3.E19.m1.5.5.1.1.2" xref="A3.E19.m1.5.5.1.1.2.cmml">Precision</mi><mo id="A3.E19.m1.5.5.1.1.1" xref="A3.E19.m1.5.5.1.1.1.cmml">=</mo><mfrac id="A3.E19.m1.2.2" xref="A3.E19.m1.2.2.cmml"><mrow id="A3.E19.m1.1.1.1.1" xref="A3.E19.m1.1.1.1.2.cmml"><mo id="A3.E19.m1.1.1.1.1.2" stretchy="false" xref="A3.E19.m1.1.1.1.2.1.cmml">|</mo><mrow id="A3.E19.m1.1.1.1.1.1" xref="A3.E19.m1.1.1.1.1.1.cmml"><msub id="A3.E19.m1.1.1.1.1.1.2" xref="A3.E19.m1.1.1.1.1.1.2.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.E19.m1.1.1.1.1.1.2.2" xref="A3.E19.m1.1.1.1.1.1.2.2.cmml">ℳ</mi><mi id="A3.E19.m1.1.1.1.1.1.2.3" xref="A3.E19.m1.1.1.1.1.1.2.3.cmml">v</mi></msub><mo id="A3.E19.m1.1.1.1.1.1.1" xref="A3.E19.m1.1.1.1.1.1.1.cmml">∩</mo><msub id="A3.E19.m1.1.1.1.1.1.3" xref="A3.E19.m1.1.1.1.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.E19.m1.1.1.1.1.1.3.2" xref="A3.E19.m1.1.1.1.1.1.3.2.cmml">ℳ</mi><mtext id="A3.E19.m1.1.1.1.1.1.3.3" xref="A3.E19.m1.1.1.1.1.1.3.3a.cmml">GT</mtext></msub></mrow><mo id="A3.E19.m1.1.1.1.1.3" stretchy="false" xref="A3.E19.m1.1.1.1.2.1.cmml">|</mo></mrow><mrow id="A3.E19.m1.2.2.2.1" xref="A3.E19.m1.2.2.2.2.cmml"><mo id="A3.E19.m1.2.2.2.1.2" stretchy="false" xref="A3.E19.m1.2.2.2.2.1.cmml">|</mo><msub id="A3.E19.m1.2.2.2.1.1" xref="A3.E19.m1.2.2.2.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.E19.m1.2.2.2.1.1.2" xref="A3.E19.m1.2.2.2.1.1.2.cmml">ℳ</mi><mi id="A3.E19.m1.2.2.2.1.1.3" xref="A3.E19.m1.2.2.2.1.1.3.cmml">v</mi></msub><mo id="A3.E19.m1.2.2.2.1.3" stretchy="false" xref="A3.E19.m1.2.2.2.2.1.cmml">|</mo></mrow></mfrac></mrow><mo id="A3.E19.m1.6.6.2.3" rspace="1.167em" xref="A3.E19.m1.6.6.3a.cmml">,</mo><mrow id="A3.E19.m1.6.6.2.2.2" xref="A3.E19.m1.6.6.2.2.3.cmml"><mrow id="A3.E19.m1.6.6.2.2.1.1" xref="A3.E19.m1.6.6.2.2.1.1.cmml"><mi id="A3.E19.m1.6.6.2.2.1.1.2" xref="A3.E19.m1.6.6.2.2.1.1.2.cmml">Recall</mi><mo id="A3.E19.m1.6.6.2.2.1.1.1" xref="A3.E19.m1.6.6.2.2.1.1.1.cmml">=</mo><mfrac id="A3.E19.m1.4.4" xref="A3.E19.m1.4.4.cmml"><mrow id="A3.E19.m1.3.3.1.1" xref="A3.E19.m1.3.3.1.2.cmml"><mo id="A3.E19.m1.3.3.1.1.2" stretchy="false" xref="A3.E19.m1.3.3.1.2.1.cmml">|</mo><mrow id="A3.E19.m1.3.3.1.1.1" xref="A3.E19.m1.3.3.1.1.1.cmml"><msub id="A3.E19.m1.3.3.1.1.1.2" xref="A3.E19.m1.3.3.1.1.1.2.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.E19.m1.3.3.1.1.1.2.2" xref="A3.E19.m1.3.3.1.1.1.2.2.cmml">ℳ</mi><mi id="A3.E19.m1.3.3.1.1.1.2.3" xref="A3.E19.m1.3.3.1.1.1.2.3.cmml">v</mi></msub><mo id="A3.E19.m1.3.3.1.1.1.1" xref="A3.E19.m1.3.3.1.1.1.1.cmml">∩</mo><msub id="A3.E19.m1.3.3.1.1.1.3" xref="A3.E19.m1.3.3.1.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.E19.m1.3.3.1.1.1.3.2" xref="A3.E19.m1.3.3.1.1.1.3.2.cmml">ℳ</mi><mtext id="A3.E19.m1.3.3.1.1.1.3.3" xref="A3.E19.m1.3.3.1.1.1.3.3a.cmml">GT</mtext></msub></mrow><mo id="A3.E19.m1.3.3.1.1.3" stretchy="false" xref="A3.E19.m1.3.3.1.2.1.cmml">|</mo></mrow><mrow id="A3.E19.m1.4.4.2.1" xref="A3.E19.m1.4.4.2.2.cmml"><mo id="A3.E19.m1.4.4.2.1.2" stretchy="false" xref="A3.E19.m1.4.4.2.2.1.cmml">|</mo><msub id="A3.E19.m1.4.4.2.1.1" xref="A3.E19.m1.4.4.2.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.E19.m1.4.4.2.1.1.2" xref="A3.E19.m1.4.4.2.1.1.2.cmml">ℳ</mi><mtext id="A3.E19.m1.4.4.2.1.1.3" xref="A3.E19.m1.4.4.2.1.1.3a.cmml">GT</mtext></msub><mo id="A3.E19.m1.4.4.2.1.3" stretchy="false" xref="A3.E19.m1.4.4.2.2.1.cmml">|</mo></mrow></mfrac></mrow><mo id="A3.E19.m1.6.6.2.2.2.3" rspace="1.167em" xref="A3.E19.m1.6.6.2.2.3a.cmml">,</mo><mrow id="A3.E19.m1.6.6.2.2.2.2" xref="A3.E19.m1.6.6.2.2.2.2.cmml"><mi id="A3.E19.m1.6.6.2.2.2.2.2" xref="A3.E19.m1.6.6.2.2.2.2.2.cmml">F1</mi><mo id="A3.E19.m1.6.6.2.2.2.2.1" xref="A3.E19.m1.6.6.2.2.2.2.1.cmml">=</mo><mfrac id="A3.E19.m1.6.6.2.2.2.2.3" xref="A3.E19.m1.6.6.2.2.2.2.3.cmml"><mrow id="A3.E19.m1.6.6.2.2.2.2.3.2" xref="A3.E19.m1.6.6.2.2.2.2.3.2.cmml"><mn id="A3.E19.m1.6.6.2.2.2.2.3.2.2" xref="A3.E19.m1.6.6.2.2.2.2.3.2.2.cmml">2</mn><mo id="A3.E19.m1.6.6.2.2.2.2.3.2.1" lspace="0.222em" rspace="0.222em" xref="A3.E19.m1.6.6.2.2.2.2.3.2.1.cmml">⋅</mo><mi id="A3.E19.m1.6.6.2.2.2.2.3.2.3" xref="A3.E19.m1.6.6.2.2.2.2.3.2.3.cmml">Precision</mi><mo id="A3.E19.m1.6.6.2.2.2.2.3.2.1a" lspace="0.222em" rspace="0.222em" xref="A3.E19.m1.6.6.2.2.2.2.3.2.1.cmml">⋅</mo><mi id="A3.E19.m1.6.6.2.2.2.2.3.2.4" xref="A3.E19.m1.6.6.2.2.2.2.3.2.4.cmml">Recall</mi></mrow><mrow id="A3.E19.m1.6.6.2.2.2.2.3.3" xref="A3.E19.m1.6.6.2.2.2.2.3.3.cmml"><mi id="A3.E19.m1.6.6.2.2.2.2.3.3.2" xref="A3.E19.m1.6.6.2.2.2.2.3.3.2.cmml">Precision</mi><mo id="A3.E19.m1.6.6.2.2.2.2.3.3.1" xref="A3.E19.m1.6.6.2.2.2.2.3.3.1.cmml">+</mo><mi id="A3.E19.m1.6.6.2.2.2.2.3.3.3" xref="A3.E19.m1.6.6.2.2.2.2.3.3.3.cmml">Recall</mi></mrow></mfrac></mrow></mrow></mrow><annotation-xml encoding="MathML-Content" id="A3.E19.m1.6b"><apply id="A3.E19.m1.6.6.3.cmml" xref="A3.E19.m1.6.6.2"><csymbol cd="ambiguous" id="A3.E19.m1.6.6.3a.cmml" xref="A3.E19.m1.6.6.2.3">formulae-sequence</csymbol><apply id="A3.E19.m1.5.5.1.1.cmml" xref="A3.E19.m1.5.5.1.1"><eq id="A3.E19.m1.5.5.1.1.1.cmml" xref="A3.E19.m1.5.5.1.1.1"></eq><ci id="A3.E19.m1.5.5.1.1.2.cmml" xref="A3.E19.m1.5.5.1.1.2">Precision</ci><apply id="A3.E19.m1.2.2.cmml" xref="A3.E19.m1.2.2"><divide id="A3.E19.m1.2.2.3.cmml" xref="A3.E19.m1.2.2"></divide><apply id="A3.E19.m1.1.1.1.2.cmml" xref="A3.E19.m1.1.1.1.1"><abs id="A3.E19.m1.1.1.1.2.1.cmml" xref="A3.E19.m1.1.1.1.1.2"></abs><apply id="A3.E19.m1.1.1.1.1.1.cmml" xref="A3.E19.m1.1.1.1.1.1"><intersect id="A3.E19.m1.1.1.1.1.1.1.cmml" xref="A3.E19.m1.1.1.1.1.1.1"></intersect><apply id="A3.E19.m1.1.1.1.1.1.2.cmml" xref="A3.E19.m1.1.1.1.1.1.2"><csymbol cd="ambiguous" id="A3.E19.m1.1.1.1.1.1.2.1.cmml" xref="A3.E19.m1.1.1.1.1.1.2">subscript</csymbol><ci id="A3.E19.m1.1.1.1.1.1.2.2.cmml" xref="A3.E19.m1.1.1.1.1.1.2.2">ℳ</ci><ci id="A3.E19.m1.1.1.1.1.1.2.3.cmml" xref="A3.E19.m1.1.1.1.1.1.2.3">𝑣</ci></apply><apply id="A3.E19.m1.1.1.1.1.1.3.cmml" xref="A3.E19.m1.1.1.1.1.1.3"><csymbol cd="ambiguous" id="A3.E19.m1.1.1.1.1.1.3.1.cmml" xref="A3.E19.m1.1.1.1.1.1.3">subscript</csymbol><ci id="A3.E19.m1.1.1.1.1.1.3.2.cmml" xref="A3.E19.m1.1.1.1.1.1.3.2">ℳ</ci><ci id="A3.E19.m1.1.1.1.1.1.3.3a.cmml" xref="A3.E19.m1.1.1.1.1.1.3.3"><mtext id="A3.E19.m1.1.1.1.1.1.3.3.cmml" mathsize="70%" xref="A3.E19.m1.1.1.1.1.1.3.3">GT</mtext></ci></apply></apply></apply><apply id="A3.E19.m1.2.2.2.2.cmml" xref="A3.E19.m1.2.2.2.1"><abs id="A3.E19.m1.2.2.2.2.1.cmml" xref="A3.E19.m1.2.2.2.1.2"></abs><apply id="A3.E19.m1.2.2.2.1.1.cmml" xref="A3.E19.m1.2.2.2.1.1"><csymbol cd="ambiguous" id="A3.E19.m1.2.2.2.1.1.1.cmml" xref="A3.E19.m1.2.2.2.1.1">subscript</csymbol><ci id="A3.E19.m1.2.2.2.1.1.2.cmml" xref="A3.E19.m1.2.2.2.1.1.2">ℳ</ci><ci id="A3.E19.m1.2.2.2.1.1.3.cmml" xref="A3.E19.m1.2.2.2.1.1.3">𝑣</ci></apply></apply></apply></apply><apply id="A3.E19.m1.6.6.2.2.3.cmml" xref="A3.E19.m1.6.6.2.2.2"><csymbol cd="ambiguous" id="A3.E19.m1.6.6.2.2.3a.cmml" xref="A3.E19.m1.6.6.2.2.2.3">formulae-sequence</csymbol><apply id="A3.E19.m1.6.6.2.2.1.1.cmml" xref="A3.E19.m1.6.6.2.2.1.1"><eq id="A3.E19.m1.6.6.2.2.1.1.1.cmml" xref="A3.E19.m1.6.6.2.2.1.1.1"></eq><ci id="A3.E19.m1.6.6.2.2.1.1.2.cmml" xref="A3.E19.m1.6.6.2.2.1.1.2">Recall</ci><apply id="A3.E19.m1.4.4.cmml" xref="A3.E19.m1.4.4"><divide id="A3.E19.m1.4.4.3.cmml" xref="A3.E19.m1.4.4"></divide><apply id="A3.E19.m1.3.3.1.2.cmml" xref="A3.E19.m1.3.3.1.1"><abs id="A3.E19.m1.3.3.1.2.1.cmml" xref="A3.E19.m1.3.3.1.1.2"></abs><apply id="A3.E19.m1.3.3.1.1.1.cmml" xref="A3.E19.m1.3.3.1.1.1"><intersect id="A3.E19.m1.3.3.1.1.1.1.cmml" xref="A3.E19.m1.3.3.1.1.1.1"></intersect><apply id="A3.E19.m1.3.3.1.1.1.2.cmml" xref="A3.E19.m1.3.3.1.1.1.2"><csymbol cd="ambiguous" id="A3.E19.m1.3.3.1.1.1.2.1.cmml" xref="A3.E19.m1.3.3.1.1.1.2">subscript</csymbol><ci id="A3.E19.m1.3.3.1.1.1.2.2.cmml" xref="A3.E19.m1.3.3.1.1.1.2.2">ℳ</ci><ci id="A3.E19.m1.3.3.1.1.1.2.3.cmml" xref="A3.E19.m1.3.3.1.1.1.2.3">𝑣</ci></apply><apply id="A3.E19.m1.3.3.1.1.1.3.cmml" xref="A3.E19.m1.3.3.1.1.1.3"><csymbol cd="ambiguous" id="A3.E19.m1.3.3.1.1.1.3.1.cmml" xref="A3.E19.m1.3.3.1.1.1.3">subscript</csymbol><ci id="A3.E19.m1.3.3.1.1.1.3.2.cmml" xref="A3.E19.m1.3.3.1.1.1.3.2">ℳ</ci><ci id="A3.E19.m1.3.3.1.1.1.3.3a.cmml" xref="A3.E19.m1.3.3.1.1.1.3.3"><mtext id="A3.E19.m1.3.3.1.1.1.3.3.cmml" mathsize="70%" xref="A3.E19.m1.3.3.1.1.1.3.3">GT</mtext></ci></apply></apply></apply><apply id="A3.E19.m1.4.4.2.2.cmml" xref="A3.E19.m1.4.4.2.1"><abs id="A3.E19.m1.4.4.2.2.1.cmml" xref="A3.E19.m1.4.4.2.1.2"></abs><apply id="A3.E19.m1.4.4.2.1.1.cmml" xref="A3.E19.m1.4.4.2.1.1"><csymbol cd="ambiguous" id="A3.E19.m1.4.4.2.1.1.1.cmml" xref="A3.E19.m1.4.4.2.1.1">subscript</csymbol><ci id="A3.E19.m1.4.4.2.1.1.2.cmml" xref="A3.E19.m1.4.4.2.1.1.2">ℳ</ci><ci id="A3.E19.m1.4.4.2.1.1.3a.cmml" xref="A3.E19.m1.4.4.2.1.1.3"><mtext id="A3.E19.m1.4.4.2.1.1.3.cmml" mathsize="70%" xref="A3.E19.m1.4.4.2.1.1.3">GT</mtext></ci></apply></apply></apply></apply><apply id="A3.E19.m1.6.6.2.2.2.2.cmml" xref="A3.E19.m1.6.6.2.2.2.2"><eq id="A3.E19.m1.6.6.2.2.2.2.1.cmml" xref="A3.E19.m1.6.6.2.2.2.2.1"></eq><ci id="A3.E19.m1.6.6.2.2.2.2.2.cmml" xref="A3.E19.m1.6.6.2.2.2.2.2">F1</ci><apply id="A3.E19.m1.6.6.2.2.2.2.3.cmml" xref="A3.E19.m1.6.6.2.2.2.2.3"><divide id="A3.E19.m1.6.6.2.2.2.2.3.1.cmml" xref="A3.E19.m1.6.6.2.2.2.2.3"></divide><apply id="A3.E19.m1.6.6.2.2.2.2.3.2.cmml" xref="A3.E19.m1.6.6.2.2.2.2.3.2"><ci id="A3.E19.m1.6.6.2.2.2.2.3.2.1.cmml" xref="A3.E19.m1.6.6.2.2.2.2.3.2.1">⋅</ci><cn id="A3.E19.m1.6.6.2.2.2.2.3.2.2.cmml" type="integer" xref="A3.E19.m1.6.6.2.2.2.2.3.2.2">2</cn><ci id="A3.E19.m1.6.6.2.2.2.2.3.2.3.cmml" xref="A3.E19.m1.6.6.2.2.2.2.3.2.3">Precision</ci><ci id="A3.E19.m1.6.6.2.2.2.2.3.2.4.cmml" xref="A3.E19.m1.6.6.2.2.2.2.3.2.4">Recall</ci></apply><apply id="A3.E19.m1.6.6.2.2.2.2.3.3.cmml" xref="A3.E19.m1.6.6.2.2.2.2.3.3"><plus id="A3.E19.m1.6.6.2.2.2.2.3.3.1.cmml" xref="A3.E19.m1.6.6.2.2.2.2.3.3.1"></plus><ci id="A3.E19.m1.6.6.2.2.2.2.3.3.2.cmml" xref="A3.E19.m1.6.6.2.2.2.2.3.3.2">Precision</ci><ci id="A3.E19.m1.6.6.2.2.2.2.3.3.3.cmml" xref="A3.E19.m1.6.6.2.2.2.2.3.3.3">Recall</ci></apply></apply></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="A3.E19.m1.6c">\mathrm{Precision}=\frac{|\mathcal{M}_{v}\cap\mathcal{M}_{\text{GT}}|}{|%
\mathcal{M}_{v}|},\quad\mathrm{Recall}=\frac{|\mathcal{M}_{v}\cap\mathcal{M}_{%
\text{GT}}|}{|\mathcal{M}_{\text{GT}}|},\quad\mathrm{F1}=\frac{2\cdot\mathrm{%
Precision}\cdot\mathrm{Recall}}{\mathrm{Precision}+\mathrm{Recall}}</annotation><annotation encoding="application/x-llamapun" id="A3.E19.m1.6d">roman_Precision = divide start_ARG | caligraphic_M start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT ∩ caligraphic_M start_POSTSUBSCRIPT GT end_POSTSUBSCRIPT | end_ARG start_ARG | caligraphic_M start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT | end_ARG , roman_Recall = divide start_ARG | caligraphic_M start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT ∩ caligraphic_M start_POSTSUBSCRIPT GT end_POSTSUBSCRIPT | end_ARG start_ARG | caligraphic_M start_POSTSUBSCRIPT GT end_POSTSUBSCRIPT | end_ARG , F1 = divide start_ARG 2 ⋅ roman_Precision ⋅ roman_Recall end_ARG start_ARG roman_Precision + roman_Recall end_ARG</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(19)</span></td>
</tr></tbody>
</table>
</div>
</li>
<li class="ltx_item" id="A3.I2.i3" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A3.I2.i3.p1">
<p class="ltx_p" id="A3.I2.i3.p1.1"><span class="ltx_text ltx_font_bold" id="A3.I2.i3.p1.1.1">DDI rate</span> measures the ratio of harmful drug-drug interactions among predicted medications:</p>
<table class="ltx_equation ltx_eqn_table" id="A3.E20">
<tbody><tr class="ltx_equation ltx_eqn_row ltx_align_baseline">
<td class="ltx_eqn_cell ltx_eqn_center_padleft"></td>
<td class="ltx_eqn_cell ltx_align_center"><math alttext="\mathrm{DDI}(\mathcal{M}_{v},\bm{D})=\frac{\left|\left\{(d_{i},d_{j})\,\middle%
|\,d_{i},d_{j}\in\mathcal{M}_{v},\,i&lt;j,\,\bm{D}[d_{i},d_{j}]=1\right\}\right|}%
{\binom{|\mathcal{M}_{v}|}{2}}" class="ltx_Math" display="block" id="A3.E20.m1.6"><semantics id="A3.E20.m1.6a"><mrow id="A3.E20.m1.6.6" xref="A3.E20.m1.6.6.cmml"><mrow id="A3.E20.m1.6.6.1" xref="A3.E20.m1.6.6.1.cmml"><mi id="A3.E20.m1.6.6.1.3" xref="A3.E20.m1.6.6.1.3.cmml">DDI</mi><mo id="A3.E20.m1.6.6.1.2" xref="A3.E20.m1.6.6.1.2.cmml">⁢</mo><mrow id="A3.E20.m1.6.6.1.1.1" xref="A3.E20.m1.6.6.1.1.2.cmml"><mo id="A3.E20.m1.6.6.1.1.1.2" stretchy="false" xref="A3.E20.m1.6.6.1.1.2.cmml">(</mo><msub id="A3.E20.m1.6.6.1.1.1.1" xref="A3.E20.m1.6.6.1.1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.E20.m1.6.6.1.1.1.1.2" xref="A3.E20.m1.6.6.1.1.1.1.2.cmml">ℳ</mi><mi id="A3.E20.m1.6.6.1.1.1.1.3" xref="A3.E20.m1.6.6.1.1.1.1.3.cmml">v</mi></msub><mo id="A3.E20.m1.6.6.1.1.1.3" xref="A3.E20.m1.6.6.1.1.2.cmml">,</mo><mi id="A3.E20.m1.5.5" xref="A3.E20.m1.5.5.cmml">𝑫</mi><mo id="A3.E20.m1.6.6.1.1.1.4" stretchy="false" xref="A3.E20.m1.6.6.1.1.2.cmml">)</mo></mrow></mrow><mo id="A3.E20.m1.6.6.2" xref="A3.E20.m1.6.6.2.cmml">=</mo><mfrac id="A3.E20.m1.4.4" xref="A3.E20.m1.4.4.cmml"><mrow id="A3.E20.m1.4.4.4.2" xref="A3.E20.m1.4.4.4.3.cmml"><mo id="A3.E20.m1.4.4.4.2.2" xref="A3.E20.m1.4.4.4.3.1.cmml">|</mo><mrow id="A3.E20.m1.4.4.4.2.1.2" xref="A3.E20.m1.4.4.4.2.1.3.cmml"><mo id="A3.E20.m1.4.4.4.2.1.2.3" xref="A3.E20.m1.4.4.4.2.1.3.1.cmml">{</mo><mrow id="A3.E20.m1.4.4.4.2.1.1.1.2" xref="A3.E20.m1.4.4.4.2.1.1.1.3.cmml"><mo id="A3.E20.m1.4.4.4.2.1.1.1.2.3" stretchy="false" xref="A3.E20.m1.4.4.4.2.1.1.1.3.cmml">(</mo><msub id="A3.E20.m1.4.4.4.2.1.1.1.1.1" xref="A3.E20.m1.4.4.4.2.1.1.1.1.1.cmml"><mi id="A3.E20.m1.4.4.4.2.1.1.1.1.1.2" xref="A3.E20.m1.4.4.4.2.1.1.1.1.1.2.cmml">d</mi><mi id="A3.E20.m1.4.4.4.2.1.1.1.1.1.3" xref="A3.E20.m1.4.4.4.2.1.1.1.1.1.3.cmml">i</mi></msub><mo id="A3.E20.m1.4.4.4.2.1.1.1.2.4" xref="A3.E20.m1.4.4.4.2.1.1.1.3.cmml">,</mo><msub id="A3.E20.m1.4.4.4.2.1.1.1.2.2" xref="A3.E20.m1.4.4.4.2.1.1.1.2.2.cmml"><mi id="A3.E20.m1.4.4.4.2.1.1.1.2.2.2" xref="A3.E20.m1.4.4.4.2.1.1.1.2.2.2.cmml">d</mi><mi id="A3.E20.m1.4.4.4.2.1.1.1.2.2.3" xref="A3.E20.m1.4.4.4.2.1.1.1.2.2.3.cmml">j</mi></msub><mo id="A3.E20.m1.4.4.4.2.1.1.1.2.5" stretchy="false" xref="A3.E20.m1.4.4.4.2.1.1.1.3.cmml">)</mo></mrow><mo id="A3.E20.m1.4.4.4.2.1.2.4" lspace="0.170em" rspace="0.170em" stretchy="true" xref="A3.E20.m1.4.4.4.2.1.3.1.cmml">|</mo><mrow id="A3.E20.m1.4.4.4.2.1.2.2.2" xref="A3.E20.m1.4.4.4.2.1.2.2.3.cmml"><mrow id="A3.E20.m1.4.4.4.2.1.2.2.1.1" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.cmml"><mrow id="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.3.cmml"><msub id="A3.E20.m1.4.4.4.2.1.2.2.1.1.1.1.1" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.1.1.1.cmml"><mi id="A3.E20.m1.4.4.4.2.1.2.2.1.1.1.1.1.2" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.1.1.1.2.cmml">d</mi><mi id="A3.E20.m1.4.4.4.2.1.2.2.1.1.1.1.1.3" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.1.1.1.3.cmml">i</mi></msub><mo id="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2.3" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.3.cmml">,</mo><msub id="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2.2" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2.2.cmml"><mi id="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2.2.2" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2.2.2.cmml">d</mi><mi id="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2.2.3" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2.2.3.cmml">j</mi></msub></mrow><mo id="A3.E20.m1.4.4.4.2.1.2.2.1.1.3" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.3.cmml">∈</mo><msub id="A3.E20.m1.4.4.4.2.1.2.2.1.1.4" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.4.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.E20.m1.4.4.4.2.1.2.2.1.1.4.2" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.4.2.cmml">ℳ</mi><mi id="A3.E20.m1.4.4.4.2.1.2.2.1.1.4.3" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.4.3.cmml">v</mi></msub></mrow><mo id="A3.E20.m1.4.4.4.2.1.2.2.2.3" rspace="0.337em" xref="A3.E20.m1.4.4.4.2.1.2.2.3a.cmml">,</mo><mrow id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.3.cmml"><mrow id="A3.E20.m1.4.4.4.2.1.2.2.2.2.1.1" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.1.1.cmml"><mi id="A3.E20.m1.4.4.4.2.1.2.2.2.2.1.1.2" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.1.1.2.cmml">i</mi><mo id="A3.E20.m1.4.4.4.2.1.2.2.2.2.1.1.1" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.1.1.1.cmml">&lt;</mo><mi id="A3.E20.m1.3.3.3.1" xref="A3.E20.m1.3.3.3.1.cmml">j</mi></mrow><mo id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.3" rspace="0.337em" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.3a.cmml">,</mo><mrow id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.cmml"><mrow id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.cmml"><mi id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.4" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.4.cmml">𝑫</mi><mo id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.3" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.3.cmml">⁢</mo><mrow id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.3.cmml"><mo id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.3" stretchy="false" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.3.cmml">[</mo><msub id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.cmml"><mi id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.2" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.2.cmml">d</mi><mi id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.3" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.3.cmml">i</mi></msub><mo id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.4" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.3.cmml">,</mo><msub id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.cmml"><mi id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.2" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.2.cmml">d</mi><mi id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.3" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.3.cmml">j</mi></msub><mo id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.5" stretchy="false" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.3.cmml">]</mo></mrow></mrow><mo id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.3" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.3.cmml">=</mo><mn id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.4" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.4.cmml">1</mn></mrow></mrow></mrow><mo id="A3.E20.m1.4.4.4.2.1.2.5" xref="A3.E20.m1.4.4.4.2.1.3.1.cmml">}</mo></mrow><mo id="A3.E20.m1.4.4.4.2.3" xref="A3.E20.m1.4.4.4.3.1.cmml">|</mo></mrow><mrow id="A3.E20.m1.2.2.2.4" xref="A3.E20.m1.2.2.2.3.cmml"><mo id="A3.E20.m1.2.2.2.4.1" xref="A3.E20.m1.2.2.2.3.1.cmml">(</mo><mfrac id="A3.E20.m1.2.2.2.2.2.2" linethickness="0pt" xref="A3.E20.m1.2.2.2.3.cmml"><mrow id="A3.E20.m1.1.1.1.1.1.1.1.1.1" xref="A3.E20.m1.1.1.1.1.1.1.1.1.2.cmml"><mo id="A3.E20.m1.1.1.1.1.1.1.1.1.1.2" stretchy="false" xref="A3.E20.m1.1.1.1.1.1.1.1.1.2.1.cmml">|</mo><msub id="A3.E20.m1.1.1.1.1.1.1.1.1.1.1" xref="A3.E20.m1.1.1.1.1.1.1.1.1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.E20.m1.1.1.1.1.1.1.1.1.1.1.2" xref="A3.E20.m1.1.1.1.1.1.1.1.1.1.1.2.cmml">ℳ</mi><mi id="A3.E20.m1.1.1.1.1.1.1.1.1.1.1.3" xref="A3.E20.m1.1.1.1.1.1.1.1.1.1.1.3.cmml">v</mi></msub><mo id="A3.E20.m1.1.1.1.1.1.1.1.1.1.3" stretchy="false" xref="A3.E20.m1.1.1.1.1.1.1.1.1.2.1.cmml">|</mo></mrow><mn id="A3.E20.m1.2.2.2.2.2.2.2.1" xref="A3.E20.m1.2.2.2.2.2.2.2.1.cmml">2</mn></mfrac><mo id="A3.E20.m1.2.2.2.4.2" xref="A3.E20.m1.2.2.2.3.1.cmml">)</mo></mrow></mfrac></mrow><annotation-xml encoding="MathML-Content" id="A3.E20.m1.6b"><apply id="A3.E20.m1.6.6.cmml" xref="A3.E20.m1.6.6"><eq id="A3.E20.m1.6.6.2.cmml" xref="A3.E20.m1.6.6.2"></eq><apply id="A3.E20.m1.6.6.1.cmml" xref="A3.E20.m1.6.6.1"><times id="A3.E20.m1.6.6.1.2.cmml" xref="A3.E20.m1.6.6.1.2"></times><ci id="A3.E20.m1.6.6.1.3.cmml" xref="A3.E20.m1.6.6.1.3">DDI</ci><interval closure="open" id="A3.E20.m1.6.6.1.1.2.cmml" xref="A3.E20.m1.6.6.1.1.1"><apply id="A3.E20.m1.6.6.1.1.1.1.cmml" xref="A3.E20.m1.6.6.1.1.1.1"><csymbol cd="ambiguous" id="A3.E20.m1.6.6.1.1.1.1.1.cmml" xref="A3.E20.m1.6.6.1.1.1.1">subscript</csymbol><ci id="A3.E20.m1.6.6.1.1.1.1.2.cmml" xref="A3.E20.m1.6.6.1.1.1.1.2">ℳ</ci><ci id="A3.E20.m1.6.6.1.1.1.1.3.cmml" xref="A3.E20.m1.6.6.1.1.1.1.3">𝑣</ci></apply><ci id="A3.E20.m1.5.5.cmml" xref="A3.E20.m1.5.5">𝑫</ci></interval></apply><apply id="A3.E20.m1.4.4.cmml" xref="A3.E20.m1.4.4"><divide id="A3.E20.m1.4.4.5.cmml" xref="A3.E20.m1.4.4"></divide><apply id="A3.E20.m1.4.4.4.3.cmml" xref="A3.E20.m1.4.4.4.2"><abs id="A3.E20.m1.4.4.4.3.1.cmml" xref="A3.E20.m1.4.4.4.2.2"></abs><apply id="A3.E20.m1.4.4.4.2.1.3.cmml" xref="A3.E20.m1.4.4.4.2.1.2"><csymbol cd="latexml" id="A3.E20.m1.4.4.4.2.1.3.1.cmml" xref="A3.E20.m1.4.4.4.2.1.2.3">conditional-set</csymbol><interval closure="open" id="A3.E20.m1.4.4.4.2.1.1.1.3.cmml" xref="A3.E20.m1.4.4.4.2.1.1.1.2"><apply id="A3.E20.m1.4.4.4.2.1.1.1.1.1.cmml" xref="A3.E20.m1.4.4.4.2.1.1.1.1.1"><csymbol cd="ambiguous" id="A3.E20.m1.4.4.4.2.1.1.1.1.1.1.cmml" xref="A3.E20.m1.4.4.4.2.1.1.1.1.1">subscript</csymbol><ci id="A3.E20.m1.4.4.4.2.1.1.1.1.1.2.cmml" xref="A3.E20.m1.4.4.4.2.1.1.1.1.1.2">𝑑</ci><ci id="A3.E20.m1.4.4.4.2.1.1.1.1.1.3.cmml" xref="A3.E20.m1.4.4.4.2.1.1.1.1.1.3">𝑖</ci></apply><apply id="A3.E20.m1.4.4.4.2.1.1.1.2.2.cmml" xref="A3.E20.m1.4.4.4.2.1.1.1.2.2"><csymbol cd="ambiguous" id="A3.E20.m1.4.4.4.2.1.1.1.2.2.1.cmml" xref="A3.E20.m1.4.4.4.2.1.1.1.2.2">subscript</csymbol><ci id="A3.E20.m1.4.4.4.2.1.1.1.2.2.2.cmml" xref="A3.E20.m1.4.4.4.2.1.1.1.2.2.2">𝑑</ci><ci id="A3.E20.m1.4.4.4.2.1.1.1.2.2.3.cmml" xref="A3.E20.m1.4.4.4.2.1.1.1.2.2.3">𝑗</ci></apply></interval><apply id="A3.E20.m1.4.4.4.2.1.2.2.3.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2"><csymbol cd="ambiguous" id="A3.E20.m1.4.4.4.2.1.2.2.3a.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.3">formulae-sequence</csymbol><apply id="A3.E20.m1.4.4.4.2.1.2.2.1.1.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1"><in id="A3.E20.m1.4.4.4.2.1.2.2.1.1.3.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.3"></in><list id="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.3.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2"><apply id="A3.E20.m1.4.4.4.2.1.2.2.1.1.1.1.1.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.1.1.1"><csymbol cd="ambiguous" id="A3.E20.m1.4.4.4.2.1.2.2.1.1.1.1.1.1.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.1.1.1">subscript</csymbol><ci id="A3.E20.m1.4.4.4.2.1.2.2.1.1.1.1.1.2.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.1.1.1.2">𝑑</ci><ci id="A3.E20.m1.4.4.4.2.1.2.2.1.1.1.1.1.3.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.1.1.1.3">𝑖</ci></apply><apply id="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2.2.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2.2"><csymbol cd="ambiguous" id="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2.2.1.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2.2">subscript</csymbol><ci id="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2.2.2.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2.2.2">𝑑</ci><ci id="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2.2.3.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.2.2.2.3">𝑗</ci></apply></list><apply id="A3.E20.m1.4.4.4.2.1.2.2.1.1.4.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.4"><csymbol cd="ambiguous" id="A3.E20.m1.4.4.4.2.1.2.2.1.1.4.1.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.4">subscript</csymbol><ci id="A3.E20.m1.4.4.4.2.1.2.2.1.1.4.2.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.4.2">ℳ</ci><ci id="A3.E20.m1.4.4.4.2.1.2.2.1.1.4.3.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.1.1.4.3">𝑣</ci></apply></apply><apply id="A3.E20.m1.4.4.4.2.1.2.2.2.2.3.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2"><csymbol cd="ambiguous" id="A3.E20.m1.4.4.4.2.1.2.2.2.2.3a.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.3">formulae-sequence</csymbol><apply id="A3.E20.m1.4.4.4.2.1.2.2.2.2.1.1.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.1.1"><lt id="A3.E20.m1.4.4.4.2.1.2.2.2.2.1.1.1.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.1.1.1"></lt><ci id="A3.E20.m1.4.4.4.2.1.2.2.2.2.1.1.2.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.1.1.2">𝑖</ci><ci id="A3.E20.m1.3.3.3.1.cmml" xref="A3.E20.m1.3.3.3.1">𝑗</ci></apply><apply id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2"><eq id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.3.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.3"></eq><apply id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2"><times id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.3.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.3"></times><ci id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.4.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.4">𝑫</ci><interval closure="closed" id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.3.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2"><apply id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1"><csymbol cd="ambiguous" id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.1.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1">subscript</csymbol><ci id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.2.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.2">𝑑</ci><ci id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.3.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.1.1.1.1.3">𝑖</ci></apply><apply id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2"><csymbol cd="ambiguous" id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.1.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2">subscript</csymbol><ci id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.2.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.2">𝑑</ci><ci id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.3.cmml" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.2.2.2.2.3">𝑗</ci></apply></interval></apply><cn id="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.4.cmml" type="integer" xref="A3.E20.m1.4.4.4.2.1.2.2.2.2.2.2.4">1</cn></apply></apply></apply></apply></apply><apply id="A3.E20.m1.2.2.2.3.cmml" xref="A3.E20.m1.2.2.2.4"><csymbol cd="latexml" id="A3.E20.m1.2.2.2.3.1.cmml" xref="A3.E20.m1.2.2.2.4.1">binomial</csymbol><apply id="A3.E20.m1.1.1.1.1.1.1.1.1.2.cmml" xref="A3.E20.m1.1.1.1.1.1.1.1.1.1"><abs id="A3.E20.m1.1.1.1.1.1.1.1.1.2.1.cmml" xref="A3.E20.m1.1.1.1.1.1.1.1.1.1.2"></abs><apply id="A3.E20.m1.1.1.1.1.1.1.1.1.1.1.cmml" xref="A3.E20.m1.1.1.1.1.1.1.1.1.1.1"><csymbol cd="ambiguous" id="A3.E20.m1.1.1.1.1.1.1.1.1.1.1.1.cmml" xref="A3.E20.m1.1.1.1.1.1.1.1.1.1.1">subscript</csymbol><ci id="A3.E20.m1.1.1.1.1.1.1.1.1.1.1.2.cmml" xref="A3.E20.m1.1.1.1.1.1.1.1.1.1.1.2">ℳ</ci><ci id="A3.E20.m1.1.1.1.1.1.1.1.1.1.1.3.cmml" xref="A3.E20.m1.1.1.1.1.1.1.1.1.1.1.3">𝑣</ci></apply></apply><cn id="A3.E20.m1.2.2.2.2.2.2.2.1.cmml" type="integer" xref="A3.E20.m1.2.2.2.2.2.2.2.1">2</cn></apply></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="A3.E20.m1.6c">\mathrm{DDI}(\mathcal{M}_{v},\bm{D})=\frac{\left|\left\{(d_{i},d_{j})\,\middle%
|\,d_{i},d_{j}\in\mathcal{M}_{v},\,i&lt;j,\,\bm{D}[d_{i},d_{j}]=1\right\}\right|}%
{\binom{|\mathcal{M}_{v}|}{2}}</annotation><annotation encoding="application/x-llamapun" id="A3.E20.m1.6d">roman_DDI ( caligraphic_M start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT , bold_italic_D ) = divide start_ARG | { ( italic_d start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT , italic_d start_POSTSUBSCRIPT italic_j end_POSTSUBSCRIPT ) | italic_d start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT , italic_d start_POSTSUBSCRIPT italic_j end_POSTSUBSCRIPT ∈ caligraphic_M start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT , italic_i &lt; italic_j , bold_italic_D [ italic_d start_POSTSUBSCRIPT italic_i end_POSTSUBSCRIPT , italic_d start_POSTSUBSCRIPT italic_j end_POSTSUBSCRIPT ] = 1 } | end_ARG start_ARG ( FRACOP start_ARG | caligraphic_M start_POSTSUBSCRIPT italic_v end_POSTSUBSCRIPT | end_ARG start_ARG 2 end_ARG ) end_ARG</annotation></semantics></math></td>
<td class="ltx_eqn_cell ltx_eqn_center_padright"></td>
<td class="ltx_eqn_cell ltx_eqn_eqno ltx_align_middle ltx_align_right" rowspan="1"><span class="ltx_tag ltx_tag_equation ltx_align_right">(20)</span></td>
</tr></tbody>
</table>
</div>
</li>
</ul>
</div>
</section>
<section class="ltx_subsection" id="A3.SS3">
<h3 class="ltx_title ltx_title_subsection">
<span class="ltx_tag ltx_tag_subsection">C.3 </span>Prompt Templates</h3>
<div class="ltx_para" id="A3.SS3.p1">
<p class="ltx_p" id="A3.SS3.p1.1">In Section <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S4.SS3" title="4.3 Two-stage Recommendation Framework ‣ 4 Method: FLAME ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">4.3</span></a>, we propose a two-stage recommendation framework, which consists of: (1) drug-level filtering and (2) list-level refinement. Below we provide the prompt templates used in each stage.</p>
</div>
<div class="ltx_para" id="A3.SS3.p2">
<p class="ltx_p" id="A3.SS3.p2.2">For the drug-level classifier (<math alttext="\pi_{\text{cls}}" class="ltx_Math" display="inline" id="A3.SS3.p2.1.m1.1"><semantics id="A3.SS3.p2.1.m1.1a"><msub id="A3.SS3.p2.1.m1.1.1" xref="A3.SS3.p2.1.m1.1.1.cmml"><mi id="A3.SS3.p2.1.m1.1.1.2" xref="A3.SS3.p2.1.m1.1.1.2.cmml">π</mi><mtext id="A3.SS3.p2.1.m1.1.1.3" xref="A3.SS3.p2.1.m1.1.1.3a.cmml">cls</mtext></msub><annotation-xml encoding="MathML-Content" id="A3.SS3.p2.1.m1.1b"><apply id="A3.SS3.p2.1.m1.1.1.cmml" xref="A3.SS3.p2.1.m1.1.1"><csymbol cd="ambiguous" id="A3.SS3.p2.1.m1.1.1.1.cmml" xref="A3.SS3.p2.1.m1.1.1">subscript</csymbol><ci id="A3.SS3.p2.1.m1.1.1.2.cmml" xref="A3.SS3.p2.1.m1.1.1.2">𝜋</ci><ci id="A3.SS3.p2.1.m1.1.1.3a.cmml" xref="A3.SS3.p2.1.m1.1.1.3"><mtext id="A3.SS3.p2.1.m1.1.1.3.cmml" mathsize="70%" xref="A3.SS3.p2.1.m1.1.1.3">cls</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="A3.SS3.p2.1.m1.1c">\pi_{\text{cls}}</annotation><annotation encoding="application/x-llamapun" id="A3.SS3.p2.1.m1.1d">italic_π start_POSTSUBSCRIPT cls end_POSTSUBSCRIPT</annotation></semantics></math>), we formulate a binary classification task over each candidate drug <math alttext="m\in\mathcal{M}_{c}" class="ltx_Math" display="inline" id="A3.SS3.p2.2.m2.1"><semantics id="A3.SS3.p2.2.m2.1a"><mrow id="A3.SS3.p2.2.m2.1.1" xref="A3.SS3.p2.2.m2.1.1.cmml"><mi id="A3.SS3.p2.2.m2.1.1.2" xref="A3.SS3.p2.2.m2.1.1.2.cmml">m</mi><mo id="A3.SS3.p2.2.m2.1.1.1" xref="A3.SS3.p2.2.m2.1.1.1.cmml">∈</mo><msub id="A3.SS3.p2.2.m2.1.1.3" xref="A3.SS3.p2.2.m2.1.1.3.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.SS3.p2.2.m2.1.1.3.2" xref="A3.SS3.p2.2.m2.1.1.3.2.cmml">ℳ</mi><mi id="A3.SS3.p2.2.m2.1.1.3.3" xref="A3.SS3.p2.2.m2.1.1.3.3.cmml">c</mi></msub></mrow><annotation-xml encoding="MathML-Content" id="A3.SS3.p2.2.m2.1b"><apply id="A3.SS3.p2.2.m2.1.1.cmml" xref="A3.SS3.p2.2.m2.1.1"><in id="A3.SS3.p2.2.m2.1.1.1.cmml" xref="A3.SS3.p2.2.m2.1.1.1"></in><ci id="A3.SS3.p2.2.m2.1.1.2.cmml" xref="A3.SS3.p2.2.m2.1.1.2">𝑚</ci><apply id="A3.SS3.p2.2.m2.1.1.3.cmml" xref="A3.SS3.p2.2.m2.1.1.3"><csymbol cd="ambiguous" id="A3.SS3.p2.2.m2.1.1.3.1.cmml" xref="A3.SS3.p2.2.m2.1.1.3">subscript</csymbol><ci id="A3.SS3.p2.2.m2.1.1.3.2.cmml" xref="A3.SS3.p2.2.m2.1.1.3.2">ℳ</ci><ci id="A3.SS3.p2.2.m2.1.1.3.3.cmml" xref="A3.SS3.p2.2.m2.1.1.3.3">𝑐</ci></apply></apply></annotation-xml><annotation encoding="application/x-tex" id="A3.SS3.p2.2.m2.1c">m\in\mathcal{M}_{c}</annotation><annotation encoding="application/x-llamapun" id="A3.SS3.p2.2.m2.1d">italic_m ∈ caligraphic_M start_POSTSUBSCRIPT italic_c end_POSTSUBSCRIPT</annotation></semantics></math> in the set of drug candidates. Each drug is evaluated independently based on its appropriateness for the given patient. The model is prompted with the patient’s clinical representation and a textual description of the candidate drug. Specifically, <span class="ltx_text ltx_font_typewriter" id="A3.SS3.p2.2.1">{{Patient Representation}}</span> includes both patient’s current status and previous hospitalization records. <span class="ltx_text ltx_font_typewriter" id="A3.SS3.p2.2.2">{{Drug Candidate}}</span> refers to the textual representation of a single drug under evaluation.</p>
</div>
<div class="ltx_para ltx_noindent" id="A3.SS3.p3">
<svg class="ltx_picture" height="178.23" id="A3.SS3.p3.pic1" overflow="visible" version="1.1" width="600"><g fill="#000000" stroke="#000000" stroke-width="0.4pt" transform="translate(0,178.23) matrix(1 0 0 -1 0 0)"><g fill="#BF0000" fill-opacity="1.0"><path d="M 0 5.91 L 0 172.33 C 0 175.59 2.64 178.23 5.91 178.23 L 594.09 178.23 C 597.36 178.23 600 175.59 600 172.33 L 600 5.91 C 600 2.64 597.36 0 594.09 0 L 5.91 0 C 2.64 0 0 2.64 0 5.91 Z" style="stroke:none"></path></g><g fill="#FFF2F2" fill-opacity="1.0"><path d="M 1.97 5.91 L 1.97 154.12 L 598.03 154.12 L 598.03 5.91 C 598.03 3.73 596.27 1.97 594.09 1.97 L 5.91 1.97 C 3.73 1.97 1.97 3.73 1.97 5.91 Z" style="stroke:none"></path></g><g fill-opacity="1.0" transform="matrix(1.0 0.0 0.0 1.0 21.65 160.03)"><foreignobject color="#FFFFFF" height="12.3" overflow="visible" transform="matrix(1 0 0 -1 0 16.6)" width="556.69">
<span class="ltx_inline-block ltx_minipage ltx_align_bottom" id="A3.SS3.p3.pic1.1.1.1.1.1" style="width:402.3pt;">
<span class="ltx_p" id="A3.SS3.p3.pic1.1.1.1.1.1.1">Prompt Template for Drug-level Filtering</span>
</span></foreignobject></g><g fill-opacity="1.0" transform="matrix(1.0 0.0 0.0 1.0 21.65 13.78)"><foreignobject color="#000000" height="128.53" overflow="visible" transform="matrix(1 0 0 -1 0 16.6)" width="556.69">
<span class="ltx_inline-block ltx_minipage ltx_align_bottom" id="A3.SS3.p3.pic1.2.2.2.1.1" style="width:402.3pt;">
<span class="ltx_p" id="A3.SS3.p3.pic1.2.2.2.1.1.1">You are about to evaluate a candidate drug for a patient’s clinical condition. You will be provided with the patient’s current condition, as well as information about their previous hospitalization, and the candidate drug. Your task is to determine whether the candidate drug is effective and safe for the patient. Please respond with &lt;Yes.&gt; or &lt;No.&gt; without providing an explanation.</span>
<span class="ltx_p" id="A3.SS3.p3.pic1.2.2.2.1.1.2"><span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p3.pic1.2.2.2.1.1.2.1">{{Patient Representation}}</span></span>
<span class="ltx_p" id="A3.SS3.p3.pic1.2.2.2.1.1.3">Candidate drug: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p3.pic1.2.2.2.1.1.3.1">{{Drug Candidates}}</span></span>
<span class="ltx_p" id="A3.SS3.p3.pic1.2.2.2.1.1.4">###Answer:</span>
</span></foreignobject></g></g></svg>
</div>
<div class="ltx_para" id="A3.SS3.p4">
<p class="ltx_p" id="A3.SS3.p4.2">For the list-level refinement policy (<math alttext="\pi_{\text{list}}" class="ltx_Math" display="inline" id="A3.SS3.p4.1.m1.1"><semantics id="A3.SS3.p4.1.m1.1a"><msub id="A3.SS3.p4.1.m1.1.1" xref="A3.SS3.p4.1.m1.1.1.cmml"><mi id="A3.SS3.p4.1.m1.1.1.2" xref="A3.SS3.p4.1.m1.1.1.2.cmml">π</mi><mtext id="A3.SS3.p4.1.m1.1.1.3" xref="A3.SS3.p4.1.m1.1.1.3a.cmml">list</mtext></msub><annotation-xml encoding="MathML-Content" id="A3.SS3.p4.1.m1.1b"><apply id="A3.SS3.p4.1.m1.1.1.cmml" xref="A3.SS3.p4.1.m1.1.1"><csymbol cd="ambiguous" id="A3.SS3.p4.1.m1.1.1.1.cmml" xref="A3.SS3.p4.1.m1.1.1">subscript</csymbol><ci id="A3.SS3.p4.1.m1.1.1.2.cmml" xref="A3.SS3.p4.1.m1.1.1.2">𝜋</ci><ci id="A3.SS3.p4.1.m1.1.1.3a.cmml" xref="A3.SS3.p4.1.m1.1.1.3"><mtext id="A3.SS3.p4.1.m1.1.1.3.cmml" mathsize="70%" xref="A3.SS3.p4.1.m1.1.1.3">list</mtext></ci></apply></annotation-xml><annotation encoding="application/x-tex" id="A3.SS3.p4.1.m1.1c">\pi_{\text{list}}</annotation><annotation encoding="application/x-llamapun" id="A3.SS3.p4.1.m1.1d">italic_π start_POSTSUBSCRIPT list end_POSTSUBSCRIPT</annotation></semantics></math>), we further optimize the drug set <math alttext="\mathcal{M}_{p}" class="ltx_Math" display="inline" id="A3.SS3.p4.2.m2.1"><semantics id="A3.SS3.p4.2.m2.1a"><msub id="A3.SS3.p4.2.m2.1.1" xref="A3.SS3.p4.2.m2.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.SS3.p4.2.m2.1.1.2" xref="A3.SS3.p4.2.m2.1.1.2.cmml">ℳ</mi><mi id="A3.SS3.p4.2.m2.1.1.3" xref="A3.SS3.p4.2.m2.1.1.3.cmml">p</mi></msub><annotation-xml encoding="MathML-Content" id="A3.SS3.p4.2.m2.1b"><apply id="A3.SS3.p4.2.m2.1.1.cmml" xref="A3.SS3.p4.2.m2.1.1"><csymbol cd="ambiguous" id="A3.SS3.p4.2.m2.1.1.1.cmml" xref="A3.SS3.p4.2.m2.1.1">subscript</csymbol><ci id="A3.SS3.p4.2.m2.1.1.2.cmml" xref="A3.SS3.p4.2.m2.1.1.2">ℳ</ci><ci id="A3.SS3.p4.2.m2.1.1.3.cmml" xref="A3.SS3.p4.2.m2.1.1.3">𝑝</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="A3.SS3.p4.2.m2.1c">\mathcal{M}_{p}</annotation><annotation encoding="application/x-llamapun" id="A3.SS3.p4.2.m2.1d">caligraphic_M start_POSTSUBSCRIPT italic_p end_POSTSUBSCRIPT</annotation></semantics></math> produced by the drug-level classifier by modeling dependencies among drugs and refining the list through two complementary tasks: (1) adding missing yet clinically necessary drugs, and (2) removing drugs that are unnecessary or potentially unsafe for the patient. Each task is formulated as a separate prompt, where the model is asked to revise a pre-predicted drug list based on the patient’s condition and medical history.</p>
</div>
<div class="ltx_para" id="A3.SS3.p5">
<p class="ltx_p" id="A3.SS3.p5.1">The task instruction is injected into the prompt through the <span class="ltx_text ltx_font_typewriter" id="A3.SS3.p5.1.1">{{instruction}}</span> placeholder, with the following two variants:</p>
</div>
<div class="ltx_para" id="A3.SS3.p6">
<ul class="ltx_itemize" id="A3.I3">
<li class="ltx_item" id="A3.I3.i1" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A3.I3.i1.p1">
<p class="ltx_p" id="A3.I3.i1.p1.1"><span class="ltx_text ltx_font_bold" id="A3.I3.i1.p1.1.1">Add task:</span> add any relevant drugs that are missing from the pre-predicted list.</p>
</div>
</li>
<li class="ltx_item" id="A3.I3.i2" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A3.I3.i2.p1">
<p class="ltx_p" id="A3.I3.i2.p1.1"><span class="ltx_text ltx_font_bold" id="A3.I3.i2.p1.1.1">Remove task:</span> remove any drugs from the pre-predicted list that are unnecessary or unsuitable for the patient’s condition.</p>
</div>
</li>
</ul>
<p class="ltx_p" id="A3.SS3.p6.1">The unified prompt template used in both tasks is shown below:</p>
</div>
<div class="ltx_para ltx_noindent" id="A3.SS3.p7">
<svg class="ltx_picture" height="196.37" id="A3.SS3.p7.pic1" overflow="visible" version="1.1" width="600"><g fill="#000000" stroke="#000000" stroke-width="0.4pt" transform="translate(0,196.37) matrix(1 0 0 -1 0 0)"><g fill="#BF0000" fill-opacity="1.0"><path d="M 0 5.91 L 0 190.47 C 0 193.73 2.64 196.37 5.91 196.37 L 594.09 196.37 C 597.36 196.37 600 193.73 600 190.47 L 600 5.91 C 600 2.64 597.36 0 594.09 0 L 5.91 0 C 2.64 0 0 2.64 0 5.91 Z" style="stroke:none"></path></g><g fill="#FFF2F2" fill-opacity="1.0"><path d="M 1.97 5.91 L 1.97 172.26 L 598.03 172.26 L 598.03 5.91 C 598.03 3.73 596.27 1.97 594.09 1.97 L 5.91 1.97 C 3.73 1.97 1.97 3.73 1.97 5.91 Z" style="stroke:none"></path></g><g fill-opacity="1.0" transform="matrix(1.0 0.0 0.0 1.0 21.65 178.17)"><foreignobject color="#FFFFFF" height="12.3" overflow="visible" transform="matrix(1 0 0 -1 0 16.6)" width="556.69">
<span class="ltx_inline-block ltx_minipage ltx_align_bottom" id="A3.SS3.p7.pic1.2.2.2.1.1" style="width:402.3pt;">
<span class="ltx_p" id="A3.SS3.p7.pic1.2.2.2.1.1.1">Prompt Template for List-level Refinement</span>
</span></foreignobject></g><g fill-opacity="1.0" transform="matrix(1.0 0.0 0.0 1.0 21.65 13.78)"><foreignobject color="#000000" height="146.67" overflow="visible" transform="matrix(1 0 0 -1 0 16.6)" width="556.69">
<span class="ltx_inline-block ltx_minipage ltx_align_bottom" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1" style="width:402.3pt;">
<span class="ltx_p" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.2">You are tasked with refining a drug list for a patient’s clinical condition. You will be provided with the patient’s condition, information about their previous hospitalization and a pre-predicted drug list.</span>
<span class="ltx_p" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3">Your task is to: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.3.1">{{instruction}}</span></span>
<span class="ltx_p" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.4">Please output a list of drugs that need to be <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.4.1">{{added or removed}}</span>, with each drug separated by a newline.</span>
<span class="ltx_p" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.5"><span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.5.1">{{Patient Representation}}</span></span>
<span class="ltx_p" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1">###Pre-predicted Drug List: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1">{{<math alttext="\mathcal{M}_{p}" class="ltx_Math" display="inline" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1"><semantics id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1a"><msub id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1.1" xref="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1.1.cmml"><mi class="ltx_font_mathcaligraphic" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1.1.2" xref="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1.1.2.cmml">ℳ</mi><mi id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1.1.3" xref="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1.1.3.cmml">p</mi></msub><annotation-xml encoding="MathML-Content" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1b"><apply id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1.1.cmml" xref="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1.1"><csymbol cd="ambiguous" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1.1.1.cmml" xref="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1.1">subscript</csymbol><ci id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1.1.2.cmml" xref="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1.1.2">ℳ</ci><ci id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1.1.3.cmml" xref="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1.1.3">𝑝</ci></apply></annotation-xml><annotation encoding="application/x-tex" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1c">\mathcal{M}_{p}</annotation><annotation encoding="application/x-llamapun" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.m1.1d">caligraphic_M start_POSTSUBSCRIPT italic_p end_POSTSUBSCRIPT</annotation></semantics></math>}}</span></span>
<span class="ltx_p" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.6">###Drugs to <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p7.pic1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.1.6.1">{{Add or Remove}}</span>:</span>
</span></foreignobject></g></g></svg>
</div>
<div class="ltx_para" id="A3.SS3.p8">
<p class="ltx_p" id="A3.SS3.p8.1">To enable comprehensive modeling of the patient’s condition within each task prompt, we incorporate both current and historical clinical information into the <span class="ltx_text ltx_font_typewriter" id="A3.SS3.p8.1.1">{{Patient Representation}}</span> field whenever available. Specifically, we differentiate between patients with and without prior hospitalization records. The formatting is as follows:</p>
</div>
<div class="ltx_para ltx_noindent" id="A3.SS3.p9">
<svg class="ltx_picture" height="146.56" id="A3.SS3.p9.pic1" overflow="visible" version="1.1" width="600"><g fill="#000000" stroke="#000000" stroke-width="0.4pt" transform="translate(0,146.56) matrix(1 0 0 -1 0 0)"><g fill="#006060" fill-opacity="1.0"><path d="M 0 5.91 L 0 140.65 C 0 143.92 2.64 146.56 5.91 146.56 L 594.09 146.56 C 597.36 146.56 600 143.92 600 140.65 L 600 5.91 C 600 2.64 597.36 0 594.09 0 L 5.91 0 C 2.64 0 0 2.64 0 5.91 Z" style="stroke:none"></path></g><g fill="#F2F9F9" fill-opacity="1.0"><path d="M 1.97 5.91 L 1.97 122.45 L 598.03 122.45 L 598.03 5.91 C 598.03 3.73 596.27 1.97 594.09 1.97 L 5.91 1.97 C 3.73 1.97 1.97 3.73 1.97 5.91 Z" style="stroke:none"></path></g><g fill-opacity="1.0" transform="matrix(1.0 0.0 0.0 1.0 21.65 128.35)"><foreignobject color="#FFFFFF" height="12.3" overflow="visible" transform="matrix(1 0 0 -1 0 16.6)" width="556.69">
<span class="ltx_inline-block ltx_minipage ltx_align_bottom" id="A3.SS3.p9.pic1.1.1.1.1.1" style="width:402.3pt;">
<span class="ltx_p" id="A3.SS3.p9.pic1.1.1.1.1.1.1">Prompt Template for Patient Representation</span>
</span></foreignobject></g><g fill-opacity="1.0" transform="matrix(1.0 0.0 0.0 1.0 21.65 13.78)"><foreignobject color="#000000" height="96.86" overflow="visible" transform="matrix(1 0 0 -1 0 16.6)" width="556.69">
<span class="ltx_inline-block ltx_minipage ltx_align_bottom" id="A3.SS3.p9.pic1.2.2.2.1.1" style="width:402.3pt;">
<span class="ltx_p" id="A3.SS3.p9.pic1.2.2.2.1.1.1"><span class="ltx_text ltx_font_bold" id="A3.SS3.p9.pic1.2.2.2.1.1.1.1">For patients with previous hospitalization records:</span></span>
<span class="ltx_p" id="A3.SS3.p9.pic1.2.2.2.1.1.2">### Previous Hospitalization: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p9.pic1.2.2.2.1.1.2.1">{{Previous Representation}}</span></span>
<span class="ltx_p" id="A3.SS3.p9.pic1.2.2.2.1.1.3">### Current Clinical Condition: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p9.pic1.2.2.2.1.1.3.1">{{Current Representation}}</span></span>
<span class="ltx_p" id="A3.SS3.p9.pic1.2.2.2.1.1.4"><span class="ltx_rule" style="width:433.6pt;height:1.0pt;background:black;display:inline-block;"> </span>  
<span class="ltx_text ltx_font_bold" id="A3.SS3.p9.pic1.2.2.2.1.1.4.1">For patients without previous hospitalization records:</span></span>
<span class="ltx_p" id="A3.SS3.p9.pic1.2.2.2.1.1.5">### Current Clinical Condition: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p9.pic1.2.2.2.1.1.5.1">{{Current Representation}}</span></span>
</span></foreignobject></g></g></svg>
</div>
<div class="ltx_para" id="A3.SS3.p10">
<p class="ltx_p" id="A3.SS3.p10.1">For the patient’s previous hospitalization representation <span class="ltx_text ltx_font_typewriter" id="A3.SS3.p10.1.1">{{Previous Representation}}</span>, we construct a hybrid representation that integrates structured information from diagnoses, procedures, and medications, along with demographic data.</p>
</div>
<div class="ltx_para ltx_noindent" id="A3.SS3.p11">
<svg class="ltx_picture" height="129.96" id="A3.SS3.p11.pic1" overflow="visible" version="1.1" width="600"><g fill="#000000" stroke="#000000" stroke-width="0.4pt" transform="translate(0,129.96) matrix(1 0 0 -1 0 0)"><g fill="#006060" fill-opacity="1.0"><path d="M 0 5.91 L 0 124.05 C 0 127.31 2.64 129.96 5.91 129.96 L 594.09 129.96 C 597.36 129.96 600 127.31 600 124.05 L 600 5.91 C 600 2.64 597.36 0 594.09 0 L 5.91 0 C 2.64 0 0 2.64 0 5.91 Z" style="stroke:none"></path></g><g fill="#F2F9F9" fill-opacity="1.0"><path d="M 1.97 5.91 L 1.97 105.85 L 598.03 105.85 L 598.03 5.91 C 598.03 3.73 596.27 1.97 594.09 1.97 L 5.91 1.97 C 3.73 1.97 1.97 3.73 1.97 5.91 Z" style="stroke:none"></path></g><g fill-opacity="1.0" transform="matrix(1.0 0.0 0.0 1.0 21.65 111.75)"><foreignobject color="#FFFFFF" height="12.3" overflow="visible" transform="matrix(1 0 0 -1 0 16.6)" width="556.69">
<span class="ltx_inline-block ltx_minipage ltx_align_bottom" id="A3.SS3.p11.pic1.1.1.1.1.1" style="width:402.3pt;">
<span class="ltx_p" id="A3.SS3.p11.pic1.1.1.1.1.1.1">Prompt Template for Previous Representation</span>
</span></foreignobject></g><g fill-opacity="1.0" transform="matrix(1.0 0.0 0.0 1.0 21.65 13.78)"><foreignobject color="#000000" height="80.25" overflow="visible" transform="matrix(1 0 0 -1 0 16.6)" width="556.69">
<span class="ltx_inline-block ltx_minipage ltx_align_bottom" id="A3.SS3.p11.pic1.2.2.2.1.1" style="width:402.3pt;">
<span class="ltx_p" id="A3.SS3.p11.pic1.2.2.2.1.1.1">Age: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p11.pic1.2.2.2.1.1.1.1">{{Age of the patient, eg. 68}}</span>,</span>
<span class="ltx_p" id="A3.SS3.p11.pic1.2.2.2.1.1.2">Gender: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p11.pic1.2.2.2.1.1.2.1">{{Patient’s biological sex, e.g., Male}}</span>,</span>
<span class="ltx_p" id="A3.SS3.p11.pic1.2.2.2.1.1.3">Diagnoses: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p11.pic1.2.2.2.1.1.3.1">{{Hybrid diagnosis representation}}</span>,</span>
<span class="ltx_p" id="A3.SS3.p11.pic1.2.2.2.1.1.4">Procedures: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p11.pic1.2.2.2.1.1.4.1">{{Hybrid procedures representation}}</span>,</span>
<span class="ltx_p" id="A3.SS3.p11.pic1.2.2.2.1.1.5">Drug names: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p11.pic1.2.2.2.1.1.5.1">{{Hybrid drugs representation}}</span>.</span>
</span></foreignobject></g></g></svg>
</div>
<div class="ltx_para" id="A3.SS3.p12">
<p class="ltx_p" id="A3.SS3.p12.1">Here we further describe the format of the <span class="ltx_text ltx_font_typewriter" id="A3.SS3.p12.1.1">{{Current Representation}}</span>, which captures the patient’s clinical status at admission. This representation integrates both structured data—such as diagnoses and procedures—and unstructured information extracted from clinical notes, including the history of present illness, past medical history, allergies, and medications on admission.</p>
</div>
<div class="ltx_para ltx_noindent" id="A3.SS3.p13">
<svg class="ltx_picture" height="163.16" id="A3.SS3.p13.pic1" overflow="visible" version="1.1" width="600"><g fill="#000000" stroke="#000000" stroke-width="0.4pt" transform="translate(0,163.16) matrix(1 0 0 -1 0 0)"><g fill="#006060" fill-opacity="1.0"><path d="M 0 5.91 L 0 157.26 C 0 160.52 2.64 163.16 5.91 163.16 L 594.09 163.16 C 597.36 163.16 600 160.52 600 157.26 L 600 5.91 C 600 2.64 597.36 0 594.09 0 L 5.91 0 C 2.64 0 0 2.64 0 5.91 Z" style="stroke:none"></path></g><g fill="#F2F9F9" fill-opacity="1.0"><path d="M 1.97 5.91 L 1.97 139.05 L 598.03 139.05 L 598.03 5.91 C 598.03 3.73 596.27 1.97 594.09 1.97 L 5.91 1.97 C 3.73 1.97 1.97 3.73 1.97 5.91 Z" style="stroke:none"></path></g><g fill-opacity="1.0" transform="matrix(1.0 0.0 0.0 1.0 21.65 144.96)"><foreignobject color="#FFFFFF" height="12.3" overflow="visible" transform="matrix(1 0 0 -1 0 16.6)" width="556.69">
<span class="ltx_inline-block ltx_minipage ltx_align_bottom" id="A3.SS3.p13.pic1.1.1.1.1.1" style="width:402.3pt;">
<span class="ltx_p" id="A3.SS3.p13.pic1.1.1.1.1.1.1">Prompt Template for Current Representation</span>
</span></foreignobject></g><g fill-opacity="1.0" transform="matrix(1.0 0.0 0.0 1.0 21.65 13.78)"><foreignobject color="#000000" height="113.46" overflow="visible" transform="matrix(1 0 0 -1 0 16.6)" width="556.69">
<span class="ltx_inline-block ltx_minipage ltx_align_bottom" id="A3.SS3.p13.pic1.2.2.2.1.1" style="width:402.3pt;">
<span class="ltx_p" id="A3.SS3.p13.pic1.2.2.2.1.1.1">Patient representation: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p13.pic1.2.2.2.1.1.1.1">{{Latent embedding}}</span>,</span>
<span class="ltx_p" id="A3.SS3.p13.pic1.2.2.2.1.1.2">History of present illness: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p13.pic1.2.2.2.1.1.2.1">{{Unstructured text extracted from clinical notes}}</span>,</span>
<span class="ltx_p" id="A3.SS3.p13.pic1.2.2.2.1.1.3">Past medical history: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p13.pic1.2.2.2.1.1.3.1">{{Unstructured text extracted from clinical notes}}</span>,</span>
<span class="ltx_p" id="A3.SS3.p13.pic1.2.2.2.1.1.4">Allergies: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p13.pic1.2.2.2.1.1.4.1">{{Unstructured text extracted from clinical notes}}</span>,</span>
<span class="ltx_p" id="A3.SS3.p13.pic1.2.2.2.1.1.5">Medications on admission: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p13.pic1.2.2.2.1.1.5.1">{{Unstructured text extracted from clinical notes}}</span>,</span>
<span class="ltx_p" id="A3.SS3.p13.pic1.2.2.2.1.1.6">Diagnoses: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p13.pic1.2.2.2.1.1.6.1">{{Hybrid diagnosis representation}}</span>,</span>
<span class="ltx_p" id="A3.SS3.p13.pic1.2.2.2.1.1.7">Procedures: <span class="ltx_text ltx_font_typewriter ltx_framed ltx_framed_underline" id="A3.SS3.p13.pic1.2.2.2.1.1.7.1">{{Hybrid procedures representation}}</span>.</span>
</span></foreignobject></g></g></svg>
</div>
<div class="ltx_para" id="A3.SS3.p14">
<p class="ltx_p" id="A3.SS3.p14.1">As introduced in Section <a class="ltx_ref" href="https://arxiv.org/html/2505.20218v1#S4.SS4" title="4.4 Multi-source Knowledge Fusion ‣ 4 Method: FLAME ‣ Fine-grained List-wise Alignment for Generative Medication Recommendation"><span class="ltx_text ltx_ref_tag">4.4</span></a>, our model leverages hybrid representations to encode structured EHR fields—namely diagnoses, procedures, and medications—by combining the textual representations generated by LLM with collaborative embeddings produced by domain-specific encoders. These hybrid representations correspond to the placeholder fields—<span class="ltx_text ltx_font_typewriter" id="A3.SS3.p14.1.1">Hybrid diagnosis representation</span>, <span class="ltx_text ltx_font_typewriter" id="A3.SS3.p14.1.2">Hybrid procedures representation</span>, and <span class="ltx_text ltx_font_typewriter" id="A3.SS3.p14.1.3">Hybrid drugs representation</span>—previously introduced in our prompt templates. Here, we provide concrete examples of how each field is instantiated.</p>
</div>
<div class="ltx_para" id="A3.SS3.p15">
<p class="ltx_p" id="A3.SS3.p15.1">Specifically, for each structured medical code, we first obtain a textual description suitable for LLM input. In parallel, we apply a domain-specific encoder to the original structured code to extract an collaborative embedding, which captures latent clinical semantics. This collaborative embedding is then projected into the LLM embedding space using a learnable adapter, rather than being passed through the LLM’s standard tokenizer and embedding layer. The final hybrid representation is thus composed of both the textual token sequence and its aligned embedding enhancement. More details of this embedding alignment can be found in Section 4.4.</p>
</div>
<div class="ltx_para" id="A3.SS3.p16">
<p class="ltx_p" id="A3.SS3.p16.1">The following illustrates the prompt-level instantiation of hybrid representations:</p>
</div>
<div class="ltx_para ltx_noindent" id="A3.SS3.p17">
<svg class="ltx_picture" height="146.56" id="A3.SS3.p17.pic1" overflow="visible" version="1.1" width="600"><g fill="#000000" stroke="#000000" stroke-width="0.4pt" transform="translate(0,146.56) matrix(1 0 0 -1 0 0)"><g fill="#BF6000" fill-opacity="1.0"><path d="M 0 5.91 L 0 140.65 C 0 143.92 2.64 146.56 5.91 146.56 L 594.09 146.56 C 597.36 146.56 600 143.92 600 140.65 L 600 5.91 C 600 2.64 597.36 0 594.09 0 L 5.91 0 C 2.64 0 0 2.64 0 5.91 Z" style="stroke:none"></path></g><g fill="#FFF9F2" fill-opacity="1.0"><path d="M 1.97 5.91 L 1.97 122.45 L 598.03 122.45 L 598.03 5.91 C 598.03 3.73 596.27 1.97 594.09 1.97 L 5.91 1.97 C 3.73 1.97 1.97 3.73 1.97 5.91 Z" style="stroke:none"></path></g><g fill-opacity="1.0" transform="matrix(1.0 0.0 0.0 1.0 21.65 128.35)"><foreignobject color="#FFFFFF" height="12.3" overflow="visible" transform="matrix(1 0 0 -1 0 16.6)" width="556.69">
<span class="ltx_inline-block ltx_minipage ltx_align_bottom" id="A3.SS3.p17.pic1.1.1.1.1.1" style="width:402.3pt;">
<span class="ltx_p" id="A3.SS3.p17.pic1.1.1.1.1.1.1">Prompt-level Instantiation of Hybrid Representations</span>
</span></foreignobject></g><g fill-opacity="1.0" transform="matrix(1.0 0.0 0.0 1.0 21.65 13.78)"><foreignobject color="#000000" height="96.86" overflow="visible" transform="matrix(1 0 0 -1 0 16.6)" width="556.69">
<span class="ltx_inline-block ltx_minipage ltx_align_bottom" id="A3.SS3.p17.pic1.2.2.2.1.1" style="width:402.3pt;">
<span class="ltx_p" id="A3.SS3.p17.pic1.2.2.2.1.1.1">Diagnoses: Hematochezia <span class="ltx_text ltx_font_bold" id="A3.SS3.p17.pic1.2.2.2.1.1.1.1">[DiagEmb-12]</span>, Acute Kidney Injury <span class="ltx_text ltx_font_bold" id="A3.SS3.p17.pic1.2.2.2.1.1.1.2">[DiagEmb-56]</span>, Heart Failure <span class="ltx_text ltx_font_bold" id="A3.SS3.p17.pic1.2.2.2.1.1.1.3">[DiagEmb-104]</span> …</span>
<span class="ltx_p" id="A3.SS3.p17.pic1.2.2.2.1.1.2">Procedures: Coronary Artery Stenting <span class="ltx_text ltx_font_bold" id="A3.SS3.p17.pic1.2.2.2.1.1.2.1">[ProEmb-8]</span>, Three Vessel Procedure <span class="ltx_text ltx_font_bold" id="A3.SS3.p17.pic1.2.2.2.1.1.2.2">[ProEmb-79]</span>, Stent Insertion <span class="ltx_text ltx_font_bold" id="A3.SS3.p17.pic1.2.2.2.1.1.2.3">[ProEmb-226]</span> …</span>
<span class="ltx_p" id="A3.SS3.p17.pic1.2.2.2.1.1.3">Drug names: Calcium gluconate <span class="ltx_text ltx_font_bold" id="A3.SS3.p17.pic1.2.2.2.1.1.3.1">[DrugEmb-2]</span>, Captopril <span class="ltx_text ltx_font_bold" id="A3.SS3.p17.pic1.2.2.2.1.1.3.2">[DrugEmb-31]</span>, Magnesium sulfate <span class="ltx_text ltx_font_bold" id="A3.SS3.p17.pic1.2.2.2.1.1.3.3">[DrugEmb-3]</span> …</span>
</span></foreignobject></g></g></svg>
</div>
</section>
</section>
<section class="ltx_appendix" id="A4">
<h2 class="ltx_title ltx_title_appendix">
<span class="ltx_tag ltx_tag_appendix">Appendix D </span>Limitations</h2>
<div class="ltx_para" id="A4.p1">
<p class="ltx_p" id="A4.p1.1">While FLAME shows promising results, it also has several limitations that warrant further investigation:</p>
<ul class="ltx_itemize" id="A4.I1">
<li class="ltx_item" id="A4.I1.i1" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A4.I1.i1.p1">
<p class="ltx_p" id="A4.I1.i1.p1.1"><span class="ltx_text ltx_font_bold" id="A4.I1.i1.p1.1.1">Computational cost and deployment challenges:</span> The use of LLM introduces significant training and inference overhead. This can limit the practical deployment of the system in resource-constrained clinical settings, especially in real-time or on-device applications.</p>
</div>
</li>
<li class="ltx_item" id="A4.I1.i2" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A4.I1.i2.p1">
<p class="ltx_p" id="A4.I1.i2.p1.1"><span class="ltx_text ltx_font_bold" id="A4.I1.i2.p1.1.1">Lack of automated multi-modal data integration:</span> Although our framework incorporates both structured and unstructured patient data, it currently lacks an end-to-end automated mechanism for multi-modal data processing. In particular, the handling of unstructured patient narratives relies on manually invoking external APIs (e.g., GPT-4o), which limits scalability and consistency.</p>
</div>
</li>
<li class="ltx_item" id="A4.I1.i3" style="list-style-type:none;">
<span class="ltx_tag ltx_tag_item">•</span>
<div class="ltx_para" id="A4.I1.i3.p1">
<p class="ltx_p" id="A4.I1.i3.p1.1"><span class="ltx_text ltx_font_bold" id="A4.I1.i3.p1.1.1">Static evaluation setting:</span> Our model is trained and evaluated on static EHR datasets, which do not fully capture the dynamic nature of real-world clinical workflows. Bridging this gap requires further investigation into how such models can be adapted for continual learning or integration with live clinical decision support systems.</p>
</div>
</li>
</ul>
</div>
</section>
<section class="ltx_appendix" id="A5">
<h2 class="ltx_title ltx_title_appendix">
<span class="ltx_tag ltx_tag_appendix">Appendix E </span>Broader Impacts</h2>
<div class="ltx_para" id="A5.p1">
<p class="ltx_p" id="A5.p1.1">This work presents the potential for significant positive societal impact by advancing the integration of LLMs into clinical decision-making. By providing accurate, context-aware, and safe medication recommendations, our framework supports physicians rather than replacing them, offering interpretable suggestions that can complement and enhance clinical judgment. This human-in-the-loop design reinforces trust and accountability in medical AI systems, ensuring that final decisions remain under professional oversight. Furthermore, the model’s ability to handle both structured clinical data and unstructured free-text inputs aligns naturally with real-world clinical workflows, where critical patient information often resides in narrative form. This flexibility reduces the burden of data curation and enables more seamless adoption in practice. In addition, the model’s demonstrated generalizability across time and institutional boundaries opens avenues for deployment in under-resourced settings, where access to experienced clinicians and high-quality clinical decision support is limited. By bridging this gap, our work contributes toward improving the equity and reach of healthcare services. Ultimately, we envision this research as a step toward scalable, adaptive, and collaborative AI systems that respect clinical complexity while expanding access to safe and effective medical support across diverse populations.</p>
</div>
<div class="ltx_para" id="A5.p2">
<p class="ltx_p" id="A5.p2.1">However, despite its potential benefits, the deployment of FLAME also poses certain societal risks. First, the model’s performance may be affected by biases in the training data, which could lead to disparities in recommendation quality across different patient populations, particularly those underrepresented in historical records. Second, there is a risk of misuse if such systems are deployed without proper clinical oversight—for example, being used in unauthorized settings or for non-medical purposes, potentially leading to harmful or misleading recommendations. These concerns underscore the need for responsible deployment practices, transparency, and safeguards to ensure that FLAME is used ethically and equitably in real-world clinical environments.</p>
</div>
<div class="ltx_pagination ltx_role_newpage"></div>
</section>
</article>
</div>
<footer class="ltx_page_footer">
<div class="ltx_page_logo">Generated  on Mon May 26 16:44:42 2025 by <a class="ltx_LaTeXML_logo" href="http://dlmf.nist.gov/LaTeXML/"><span style="letter-spacing:-0.2em; margin-right:0.1em;">L<span class="ltx_font_smallcaps" style="position:relative; bottom:2.2pt;">a</span>T<span class="ltx_font_smallcaps" style="font-size:120%;position:relative; bottom:-0.2ex;">e</span></span><span style="font-size:90%; position:relative; bottom:-0.2ex;">XML</span><img alt="Mascot Sammy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAOCAYAAAD5YeaVAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9wKExQZLWTEaOUAAAAddEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIFRoZSBHSU1Q72QlbgAAAdpJREFUKM9tkL+L2nAARz9fPZNCKFapUn8kyI0e4iRHSR1Kb8ng0lJw6FYHFwv2LwhOpcWxTjeUunYqOmqd6hEoRDhtDWdA8ApRYsSUCDHNt5ul13vz4w0vWCgUnnEc975arX6ORqN3VqtVZbfbTQC4uEHANM3jSqXymFI6yWazP2KxWAXAL9zCUa1Wy2tXVxheKA9YNoR8Pt+aTqe4FVVVvz05O6MBhqUIBGk8Hn8HAOVy+T+XLJfLS4ZhTiRJgqIoVBRFIoric47jPnmeB1mW/9rr9ZpSSn3Lsmir1fJZlqWlUonKsvwWwD8ymc/nXwVBeLjf7xEKhdBut9Hr9WgmkyGEkJwsy5eHG5vN5g0AKIoCAEgkEkin0wQAfN9/cXPdheu6P33fBwB4ngcAcByHJpPJl+fn54mD3Gg0NrquXxeLRQAAwzAYj8cwTZPwPH9/sVg8PXweDAauqqr2cDjEer1GJBLBZDJBs9mE4zjwfZ85lAGg2+06hmGgXq+j3+/DsixYlgVN03a9Xu8jgCNCyIegIAgx13Vfd7vdu+FweG8YRkjXdWy329+dTgeSJD3ieZ7RNO0VAXAPwDEAO5VKndi2fWrb9jWl9Esul6PZbDY9Go1OZ7PZ9z/lyuD3OozU2wAAAABJRU5ErkJggg=="/></a>
</div></footer>
</div>
</body>
</html>
